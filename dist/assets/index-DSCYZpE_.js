import{getApps as pa,getApp as va,initializeApp as ha}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth as ga,setPersistence as ya,browserLocalPersistence as ba,GoogleAuthProvider as tn,signInWithPopup as nn,signOut as an,onAuthStateChanged as Sa}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getFirestore as Ea,enableIndexedDbPersistence as Ca,doc as E,onSnapshot as O,updateDoc as k,setDoc as K,query as V,collection as x,getDocs as D,deleteDoc as Q,arrayRemove as wa,getDoc as j,arrayUnion as La,orderBy as he,addDoc as Ie,where as xn,serverTimestamp as An,Timestamp as xa}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const Aa="modulepreload",Ma=function(e){return"/"+e},rn={},ee=function(t,n,a){let r=Promise.resolve();if(n&&n.length>0){let d=function(u){return Promise.all(u.map(m=>Promise.resolve(m).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),c=l?.nonce||l?.getAttribute("nonce");r=d(n.map(u=>{if(u=Ma(u),u in rn)return;rn[u]=!0;const m=u.endsWith(".css"),f=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${f}`))return;const p=document.createElement("link");if(p.rel=m?"stylesheet":Aa,m||(p.as="script"),p.crossOrigin="",p.href=u,c&&p.setAttribute("nonce",c),document.head.appendChild(p),m)return new Promise((g,b)=>{p.addEventListener("load",g),p.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${u}`)))})}))}function s(l){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=l,window.dispatchEvent(c),!c.defaultPrevented)throw l}return r.then(l=>{for(const c of l||[])c.status==="rejected"&&s(c.reason);return t().catch(s)})},Ua={apiKey:"AIzaSyB45g_2KRGlXH0iAPyBGuCnrFkhxCHadKs",authDomain:"nacholo.firebaseapp.com",projectId:"nacholo",storageBucket:"nacholo.appspot.com",messagingSenderId:"924503328068",appId:"1:924503328068:web:1f753ced7f47ec36750311"},Mn=pa().length?va():ha(Ua),Ee=ga(Mn);ya(Ee,ba).catch(()=>{});const h=Ea(Mn);setTimeout(()=>{Ca(h).catch(()=>{})},2e3);const i={currentUser:null,currentPairId:null,profileData:null,activeSemesterId:null,activeSemesterData:null,unsubscribeCourses:null,editingCourseId:null,pairOtherUid:null,shared:{horario:{semId:null},notas:{semId:null},malla:{enabled:!1},calendar:{semId:null}},DEBUG:(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&(new URLSearchParams(location.search).has("debug")||(window?.duoplannerDebug??!1))},o=e=>typeof e=="string"?document.getElementById(e):null;function Z(){if(!i.DEBUG)return;const e=o("state");e&&(e.textContent=JSON.stringify({uid:i.currentUser?.uid||null,pairId:i.currentPairId,pairOtherUid:i.pairOtherUid||null,profileData:i.profileData,activeSemesterId:i.activeSemesterId,editingCourseId:i.editingCourseId},null,2))}function sn(e,t){e&&(t?e.classList.add("hidden"):e.classList.remove("hidden"))}let se=null;function Ia(){se&&(se(),se=null),i.unsubscribeProfile=null}function $a(e){if(!e)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=/^(\d{2})-(\d{2})$/.exec(e);if(t){const n=t[1];return`2000-${t[2]}-${n}`}return""}async function on(e){const t=await new Promise((a,r)=>{const s=new FileReader;s.onload=()=>a(s.result),s.onerror=r,s.readAsDataURL(e)});return await new Promise((a,r)=>{const s=new Image;s.onload=()=>a(s),s.onerror=r,s.src=t})}function cn(e,t=256,n=.82){const a=document.createElement("canvas"),r=Math.min(e.width,e.height),s=(e.width-r)/2,l=(e.height-r)/2;return a.width=t,a.height=t,a.getContext("2d").drawImage(e,s,l,r,r,0,0,t,t),a.toDataURL("image/jpeg",n)}function Te(e){const t=document.getElementById("pfAvatarCircle");t&&(e&&!e.startsWith("emoji:")?(t.textContent="",t.style.backgroundImage=`url("${e}")`):(t.style.backgroundImage="none",t.textContent="üë®‚Äçüéì"))}function Ta(e,t){if(e&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const n=/^(\d{2})-(\d{2})$/.exec(t||"");if(n){const a=n[1];return`2000-${n[2]}-${a}`}return null}let qe=null;const Bt={UMAYOR:[{value:"MEDVET",label:"Medicina Veterinaria"}],USM:[{value:"ICTEL",label:"Ing. Civil Telem√°tica"}]};function Un(){se&&(se(),se=null);const e=i.currentUser?.uid;if(!e)return;const t=E(h,"users",e),n=E(h,"users",e,"profile","profile"),a=(d,u)=>{const m=d?.data()||{},f=u?.data()||{};i.profileData={...m,...f,name:f?.name||m?.name||m?.fullName||f?.fullName||""},delete i.profileData.fullName,m?.name&&!i.profileData.name&&(i.profileData.name=m.name),m?.fullName&&!i.profileData.name&&(i.profileData.name=m.fullName),f?.name&&(i.profileData.name=f.name),f?.fullName&&(i.profileData.name=f.fullName),_t(i.profileData),st(),Z(),document.dispatchEvent(new Event("profile:changed"))};let r=null,s=null;const l=O(t,d=>{r=d,a(r,s)}),c=O(n,d=>{s=d,a(r,s)});se=()=>{l(),c()},i.unsubscribeProfile=se}function In(){const e=(l,c="")=>{const d=o(l);d&&(d.value=c)};e("pfName"),e("pfGoogleEmail"),e("pfBirthday"),e("pfFavoriteColor","#22c55e");const t=o("pfColorPreview");t&&(t.style.background="#22c55e");const n=o("pfColorCode");n&&(n.textContent="#22C55E");const a=o("pfUniversity")||o("uniSel");a&&(a.value="");const r=o("pfCareer")||o("careerSel");r&&(r.value="",r.disabled=!0),e("pfEmailUni"),e("pfPhone"),Te(null);const s=o("pfBirthday");s&&delete s.dataset?.dirty}function _t(e){const t=o("pfName"),n=o("pfBirthday"),a=o("pfUniversity")||o("uniSel"),r=o("pfCustomUniWrap"),s=o("pfCustomUniversity"),l=o("pfCareer")||o("careerSel"),c=o("pfFavoriteColor"),d=o("pfColorPreview"),u=o("pfColorCode"),m=o("pfEmailUni")||o("pfEmail"),f=o("pfPhone")||o("pfTelefono"),p=o("pfGoogleEmail"),g=o("pfCancelBtn"),b=(v,y)=>{if(!l)return;l.innerHTML='<option value="">Selecciona tu carrera‚Ä¶</option>';const S=Bt[v]||[];for(const{value:C,label:M}of S){const q=document.createElement("option");q.value=C,q.textContent=M,l.appendChild(q)}l.disabled=S.length===0,y&&S.some(C=>C.value===y)?l.value=y:l.value=""};if(g&&!g.dataset.bound&&(g.onclick=()=>_t(i.profileData||null),g.dataset.bound="1"),p&&i.currentUser?.email&&(p.value=i.currentUser.email),m&&(m.value=e?.uniEmail||""),f&&(f.value=e?.phone||""),t&&(t.value=e?.fullName||e?.name||""),n){const v=$a(e?.birthday||""),y=document.activeElement===n,S=n.dataset.dirty==="1";!y&&!S&&(n.value=v||"",v?n.setAttribute("value",v):n.removeAttribute("value")),n.dataset.bound||(n.addEventListener("change",C=>{const M=C.target.value||"";n.dataset.dirty="1",n.value=M,M?n.setAttribute("value",M):n.removeAttribute("value"),i.profileData={...i.profileData||{},birthday:M}}),n.addEventListener("paste",C=>C.preventDefault()),n.addEventListener("drop",C=>C.preventDefault()),n.dataset.bound="1")}if(a){const v=e?.university||"";v==="Universidad Mayor"?a.value="UMAYOR":v==="UTFSM"||v==="USM"?a.value="USM":a.value=v}r&&r.classList.add("hidden"),s&&(s.value="");const w=a?.value==="OTRA";r&&r.classList.toggle("hidden",!w),w&&s&&(s.value=e?.customUniversity||"");const $=It(e?.favoriteColor)?e.favoriteColor:"#22c55e";c&&(c.value=$),d&&(d.style.background=$),u&&(u.textContent=$.toUpperCase()),b(a?.value,e?.career||""),a&&(a.onchange=()=>{const v=a.value==="OTRA";r&&r.classList.toggle("hidden",!v),!v&&s&&(s.value=""),b(a.value,null)}),c&&!c.dataset.bound&&(c.addEventListener("input",v=>{const y=v.target.value;It(y)&&(d&&(d.style.background=y),u&&(u.textContent=y.toUpperCase()))}),c.dataset.bound="1");const T=o("pfAvatarBtn"),N=o("pfAvatarFile");Te(e?.avatarData||"emoji:üë®‚Äçüéì");let B=document.getElementById("pfDeleteAvatarBtn");B||(B=document.createElement("button"),B.id="pfDeleteAvatarBtn",B.className="btn btn-secondary",B.textContent="Eliminar foto de perfil",T.insertAdjacentElement("afterend",B)),N&&!N.dataset.bound&&(N.addEventListener("change",async v=>{const y=v.target.files?.[0];if(y){if(!/^image\//.test(y.type)){alert("Elige una imagen v√°lida.");return}try{const S=await on(y),C=cn(S,256,.82);if(Te(C),!i.currentUser)return;await k(E(h,"users",i.currentUser.uid),{avatarData:C,avatarUpdatedAt:Date.now()}),T.textContent="Avatar actualizado ‚úì",setTimeout(()=>T.textContent="Cambiar avatar",1500)}catch(S){console.error(S),alert("No se pudo procesar la imagen.")}finally{v.target.value=""}}}),N.dataset.bound="1"),B.dataset.bound||(B.addEventListener("click",async()=>{if(i.currentUser&&confirm("¬øSeguro que deseas eliminar tu foto de perfil?"))try{await k(E(h,"users",i.currentUser.uid),{avatarData:null,avatarUrl:null,avatarUpdatedAt:Date.now()}),Te("emoji:üë®‚Äçüéì"),alert("Avatar eliminado. Se restaur√≥ el emoji predeterminado üë®‚Äçüéì.")}catch(v){console.error(v),alert("No se pudo eliminar el avatar.")}}),B.dataset.bound="1"),N&&!N.dataset.bound&&(N.addEventListener("change",async v=>{const y=v.target.files?.[0];if(y){if(!/^image\//.test(y.type)){alert("Elige una imagen.");return}try{const S=await on(y),C=cn(S,256,.82);if(Te(C),!i.currentUser)return;await k(E(h,"users",i.currentUser.uid),{avatarData:C,avatarUpdatedAt:Date.now()}),T&&(T.textContent="Avatar actualizado ‚úì",setTimeout(()=>T.textContent="Cambiar avatar",1500))}catch(S){console.error(S),alert("No se pudo procesar la imagen.")}finally{v.target.value=""}}}),N.dataset.bound="1");const L=o("pfSaveBtn");L&&!L.dataset.bound&&(L.onclick=()=>$n(),L.dataset.bound="1")}async function $n(){if(!i.currentUser)return;const e=o("pfUniversity")||o("uniSel"),t=o("pfCareer")||o("careerSel"),n=o("pfFavoriteColor")?.value||null,a=((o("pfEmailUni")||o("pfEmail"))?.value||"").trim(),r=((o("pfPhone")||o("pfTelefono"))?.value||"").trim(),s=i.currentUser.uid,l=e?.value||null;if(!(!a||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))){alert("Email universitario no es v√°lido.");return}if(!(!r||/^[+()\s0-9-]{6,}$/.test(r))){alert("Tel√©fono no es v√°lido.");return}const u=t&&Bt[l]?.some(N=>N.value===t.value)?t.value:null,m=o("pfBirthday")?.value||null,f=i.profileData?.birthday||null,p=Ta(m,f),b={name:o("pfName")?.value.trim()||null,birthday:p??null,university:l,customUniversity:l==="OTRA"&&o("pfCustomUniversity")&&o("pfCustomUniversity").value.trim()||null,career:u,favoriteColor:It(n)?n:null,uniEmail:a||null,phone:r||null,updatedAt:Date.now()};await k(E(h,"users",i.currentUser.uid),{avatarData:null,avatarUrl:null,avatarUpdatedAt:null});const w=E(h,"users",s,"profile","profile");await K(w,b,{merge:!0}),i.profileData={...i.profileData||{},...b};const $=document.getElementById("pfSaveBtn");if($){const N=$.textContent;$.textContent="Guardado ‚úì",$.disabled=!0,setTimeout(()=>{$.textContent=N,$.disabled=!1},1800)}const T=document.getElementById("pfBirthday");T&&delete T.dataset.dirty}function st(){const e=!!(i.profileData&&i.profileData.university&&(i.profileData.university!=="OTRA"||i.profileData.university==="OTRA"&&i.profileData.customUniversity?.trim()));o("semNoticeNoUni")?.classList.toggle("hidden",e),o("createSemesterBtn")&&(o("createSemesterBtn").disabled=!e||!i.currentUser),o("semesterLabel")&&(o("semesterLabel").disabled=!e),o("semesterUniFromProfile")&&(o("semesterUniFromProfile").value=e?Da(i.profileData):""),o("createPairBtn")&&(o("createPairBtn").disabled=!i.currentUser)}function Da(e){return!e||!e.university?"":e.university==="OTRA"?e.customUniversity||"Otra":e.university==="UMAYOR"?"Universidad Mayor":e.university==="USM"?"UTFSM":e.university}function It(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function Tn(){const e=o("page-perfil");if(!e)return;let t=o("partnerProfileCard");t||(t=document.createElement("div"),t.className="card",t.id="partnerProfileCard",t.innerHTML=`
      <h3 style="margin-top:0">Perfil de la otra persona</h3>
      <div id="pp-avatar" style="width:64px;height:64px;border-radius:50%;
        background:#444;background-size:cover;background-position:center;margin-bottom:8px;"></div>
      <div id="pp-name"><b>Nombre:</b> ‚Äî</div>
      <div id="pp-uni"><b>Universidad:</b> ‚Äî</div>
      <div id="pp-career"><b>Carrera:</b> ‚Äî</div>
      <div id="pp-bday" class="muted"><b>Nacimiento:</b> ‚Äî</div>
      <div id="pp-color"><b>Color favorito:</b>
        <span id="pp-color-swatch"
          style="display:inline-block;width:16px;height:16px;border-radius:4px;vertical-align:middle;margin:0 6px;background:#ff69b4;border:1px solid rgba(255,255,255,.25)">
        </span>
        <span id="pp-color-code">‚Äî</span>
      </div>
      <div id="pp-email"><b>Email universitario:</b> ‚Äî</div>
      <div id="pp-phone"><b>Tel√©fono:</b> ‚Äî</div>
    `,t.classList.add("hidden"),e.appendChild(t));const n=()=>{o("pp-name").innerHTML="<b>Nombre:</b> ‚Äî",o("pp-uni").innerHTML="<b>Universidad:</b> ‚Äî",o("pp-career").innerHTML="<b>Carrera:</b> ‚Äî",o("pp-bday").innerHTML="<b>Fecha de nacimiento:</b> ‚Äî",o("pp-email").innerHTML="<b>Email universitario:</b> ‚Äî",o("pp-phone").innerHTML="<b>Tel√©fono:</b> ‚Äî",o("pp-color-code").textContent="‚Äî";const p=o("pp-color-swatch");p&&(p.style.background="transparent",p.style.border="1px solid rgba(255,255,255,.25)")};if(qe&&(qe(),qe=null),!i.pairOtherUid){n(),t&&t.classList.add("hidden");return}const a=E(h,"users",i.pairOtherUid),r=E(h,"users",i.pairOtherUid,"profile","profile");t.classList.remove("hidden");let s=null,l=null;const c=()=>{const p={...s?.data()||{},...l?.data()||{}},g=o("pp-avatar");g&&(p.avatarData?(g.style.backgroundImage=`url("${p.avatarData}")`,g.textContent=""):(g.style.backgroundImage="none",g.textContent="üë®‚Äçüéì",g.style.display="flex",g.style.alignItems="center",g.style.justifyContent="center",g.style.fontSize="2rem")),o("pp-name").innerHTML=`<b>Nombre:</b> ${p.name||"‚Äî"}`,o("pp-uni").innerHTML=`<b>Universidad:</b> ${u(p)}`,o("pp-career").innerHTML=`<b>Carrera:</b> ${p.career?p.career==="ICTEL"?"Ing. Civil Telem√°tica":"Medicina Veterinaria":"‚Äî"}`,o("pp-bday").innerHTML=`<b>Fecha de nacimiento:</b> ${d(p.birthday)}`,o("pp-email").innerHTML=`<b>Email universitario:</b> ${p.uniEmail||"‚Äî"}`,o("pp-phone").innerHTML=`<b>Tel√©fono:</b> ${p.phone||"‚Äî"}`;const b=typeof p.favoriteColor=="string"&&/^#[0-9A-Fa-f]{6}$/.test(p.favoriteColor)?p.favoriteColor:"#ff69b4",w=o("pp-color-swatch");w&&(w.style.background=b);const $=o("pp-color-code");$&&($.textContent=b.toUpperCase())},d=p=>{if(!p)return"‚Äî";const g=/^(\d{4})-(\d{2})-(\d{2})$/.exec(p);return g?`${g[3]}/${g[2]}/${g[1]}`:p},u=p=>p?.university?p.university==="UMAYOR"?"Universidad Mayor":p.university==="USM"?"UTFSM":p.university==="OTRA"?p.customUniversity||"Otra":p.university:"‚Äî",m=O(a,p=>{s=p,c()}),f=O(r,p=>{l=p,c()});qe=()=>{m(),f()}}document.addEventListener("pair:ready",()=>{Tn()});function Na(){const e=document.getElementById("pfUniversity")||document.getElementById("uniSel"),t=document.getElementById("pfCareer")||document.getElementById("careerSel");if(!e||!t)return;const n=()=>{const a=Bt[e.value]||[];t.innerHTML='<option value="">Selecciona tu carrera‚Ä¶</option>';for(const{value:r,label:s}of a){const l=document.createElement("option");l.value=r,l.textContent=s,t.appendChild(l)}t.disabled=a.length===0};e.addEventListener("change",n),n()}const ka=Object.freeze(Object.defineProperty({__proto__:null,clearProfileUI:In,ensureCareerBindingOnLoad:Na,fillProfileForm:_t,listenProfile:Un,mountPartnerProfileCard:Tn,reflectProfileInSemestersUI:st,saveProfile:$n,stopProfileListener:Ia},Symbol.toStringTag,{value:"Module"}));let me=null;new URLSearchParams(location.search).has("debug")||window?.duoplannerDebug;function Pa(){const e=o("createPairBtn"),t=o("copyInviteBtn"),n=o("joinByCodeBtn"),a=o("joinCode"),r=o("deletePairBtn");e?.addEventListener("click",Ra),t?.addEventListener("click",Ba);const s=async()=>{const l=(a?.value||"").trim(),c=Ha(l);c?await ja(c):alert("Pega un ID v√°lido (o un link con ?pair=ID)."),a&&(a.value="")};n?.addEventListener("click",s),a?.addEventListener("keydown",l=>{l.key==="Enter"&&s()}),r?.addEventListener("click",qa)}async function Oa(){if(!i.currentUser)return;const e=V(x(h,"pairs")),t=await D(e),n=[];t.forEach(l=>{const c=l.data()||{};Array.isArray(c.members)&&c.members.includes(i.currentUser.uid)&&n.push({id:l.id,...c})}),n.sort((l,c)=>(Number(c.createdAt)||0)-(Number(l.createdAt)||0));const a=n[0]||null;i.currentPairId=a?.id||null,i.pairOtherUid=a&&(a.members||[]).find(l=>l!==i.currentUser.uid)||null;const r=o("pairId"),s=o("copyInviteBtn");r&&(r.textContent=i.currentPairId||"‚Äî"),s&&(s.disabled=!i.currentPairId),He(),Z(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}})),Ft(i.currentPairId)}async function Ra(){if(!i.currentUser)return;const e=E(x(h,"pairs"));await K(e,{members:[i.currentUser.uid],createdAt:Date.now(),visibility:{showCourseNames:!0,showOnlyBusyFree:!1}}),await Dn(e.id),i.currentPairId=e.id,i.pairOtherUid=null;const t=o("pairId"),n=o("copyInviteBtn");t&&(t.textContent=e.id),n&&(n.disabled=!1),He(),Z(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}})),Ft(e.id)}async function Ba(){if(!i.currentPairId)return;const e=i.currentPairId,t=o("copyInviteBtn");if(await _a(e)||Fa(e),t){const a=t.textContent;t.textContent="¬°ID copiado!",setTimeout(()=>{t.textContent=a||"Copiar ID"},1800)}}async function _a(e){try{return await navigator.clipboard.writeText(e),!0}catch{return!1}}function Fa(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch{}document.body.removeChild(t)}function Ha(e){if(!e)return"";const t=String(e).trim();try{const s=new URL(t).searchParams.get("pair");if(s)return s.trim()}catch{}const n=t.match(/[?&]pair=([A-Za-z0-9_-]+)/);return n?n[1]:t.replace(/[^A-Za-z0-9_-]/g,"")||""}async function ja(e){if(!i.currentUser)return;const t=E(h,"pairs",e),n=await j(t);if(!n.exists()){alert("El ID de party no existe");return}const a=n.data()||{},r=Array.isArray(a.members)?a.members:[];if(!r.includes(i.currentUser.uid)&&r.length>=2){alert("Esta party ya tiene 2 miembros.");return}r.includes(i.currentUser.uid)||await k(t,{members:La(i.currentUser.uid),updatedAt:Date.now()}),await Dn(e);const l=(await j(t)).data()||{};i.currentPairId=e,i.pairOtherUid=(l.members||[]).find(f=>f!==i.currentUser.uid)||null;const c=E(h,"users",i.currentUser.uid),d={pairUid:i.pairOtherUid||null,currentPairId:e};try{await k(c,d)}catch{await K(c,d,{merge:!0})}const u=o("pairId"),m=o("copyInviteBtn");u&&(u.textContent=e),m&&(m.disabled=!1),He(),Z(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}})),Ft(e)}function Ft(e){if(me&&(me(),me=null),!e)return;const t=E(h,"pairs",e),n=i.currentUser?.uid||null;me=O(t,async a=>{if(!a.exists()){Nn();return}const r=a.data()||{},l=(Array.isArray(r.members)?r.members:[]).find(u=>u!==n)||null;i.currentPairId=e,i.pairOtherUid=l;try{const u=E(h,"users",n);await K(u,{pairUid:l||null,currentPairId:e},{merge:!0})}catch{}const c=o("pairId"),d=o("copyInviteBtn");c&&(c.textContent=e),d&&(d.disabled=!1),He(),Z(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}}))})}async function qa(){if(!i.currentUser||!i.currentPairId)return;const e=i.currentPairId,t=E(h,"pairs",e);if(confirm("¬øQuieres eliminar la party para ambos? La otra persona tambi√©n se saldr√°.")){try{await Q(t)}catch{try{await k(t,{members:[]}),await Q(t)}catch{}}Nn(),alert("Party eliminada para ambos.")}}async function Dn(e){const t=V(x(h,"pairs")),n=await D(t),a=i.currentUser.uid,r=[];n.forEach(s=>{const l=s.data()||{};s.id!==e&&Array.isArray(l.members)&&l.members.includes(a)&&r.push(k(E(h,"pairs",s.id),{members:wa(a)}).then(async()=>{const c=await j(E(h,"pairs",s.id));if((c.exists()?c.data().members||[]:[]).length===0)try{await Q(E(h,"pairs",s.id))}catch{}}))}),await Promise.all(r)}function Nn(){me&&(me(),me=null),i.currentPairId=null,i.pairOtherUid=null;const e=o("pairId"),t=o("copyInviteBtn");e&&(e.textContent="‚Äî"),t&&(t.disabled=!0),He(),Z(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}}))}function He(){const e=!!(i.currentPairId&&i.pairOtherUid),t=o("subtabCompartido"),n=o("horarioCompartido");t?.setAttribute("aria-disabled",e?"false":"true"),t&&(t.disabled=!e),n&&(e?n.classList.remove("disabled"):(n.classList.add("disabled"),n.innerHTML='<div class="muted">Horario de la otra persona (debes emparejarte primero).</div>'))}let it="#22c55e",ot="#ff69b4",Ye=null,ln=!1,ct=!1,Ce=null;const Se=80,dn=28;let kn=[],$t=[];const Oe=["Lun","Mar","Mi√©","Jue","Vie"];function Ya(e){if(!ct)return;const t=e.clientY,n=window.innerHeight;let a=0;if(t<Se){const r=(Se-t)/Se;a=-Math.ceil(dn*r)}else if(t>n-Se){const r=(t-(n-Se))/Se;a=Math.ceil(dn*r)}a!==0&&Ce===null&&(Ce=requestAnimationFrame(()=>{window.scrollBy(0,a),Ce=null}))}function un(){ct=!1,Ce&&(cancelAnimationFrame(Ce),Ce=null)}const Le=[{label:"1/2",start:"08:15",end:"09:25",lines:[{n:"1",start:"08:15",end:"08:50"},{n:"2",start:"08:50",end:"09:25"}]},{label:"3/4",start:"09:40",end:"10:50",lines:[{n:"3",start:"09:40",end:"10:15"},{n:"4",start:"10:15",end:"10:50"}]},{label:"5/6",start:"11:05",end:"12:15",lines:[{n:"5",start:"11:05",end:"11:40"},{n:"6",start:"11:40",end:"12:15"}]},{label:"7/8",start:"12:30",end:"13:40",lines:[{n:"7",start:"12:30",end:"13:05"},{n:"8",start:"13:05",end:"13:40"}]},{label:"ALMUERZO",start:"13:40",end:"14:40",lunch:!0},{label:"9/10",start:"14:40",end:"15:50",lines:[{n:"9",start:"14:40",end:"15:15"},{n:"10",start:"15:15",end:"15:50"}]},{label:"11/12",start:"16:05",end:"17:15",lines:[{n:"11",start:"16:05",end:"16:40"},{n:"12",start:"16:40",end:"17:15"}]},{label:"13/14",start:"17:30",end:"18:40",lines:[{n:"13",start:"17:30",end:"18:05"},{n:"14",start:"18:05",end:"18:40"}]},{label:"15/16",start:"18:55",end:"20:05",lines:[{n:"15",start:"18:55",end:"19:30"},{n:"16",start:"19:30",end:"20:05"}]},{label:"17/18",start:"20:20",end:"21:30",lines:[{n:"17",start:"20:20",end:"20:55"},{n:"18",start:"20:55",end:"21:30"}]},{label:"19/20",start:"21:45",end:"22:55",lines:[{n:"19",start:"21:45",end:"22:20"},{n:"20",start:"22:20",end:"22:55"}]}],Ht=[X("1/2","08:30","09:40",["08:30-09:05","09:05-09:40"]),X("3/4","10:00","11:10",["10:00-10:35","10:35-11:10"]),X("5/6","11:30","12:40",["11:30-12:05","12:05-12:40"]),{label:"ALMUERZO",start:"12:40",end:"14:00",lunch:!0},X("7/8","14:00","15:10",["14:00-14:35","14:35-15:10"]),X("9/10","15:30","16:40",["15:30-16:05","16:05-16:40"]),X("11/12","17:00","18:10",["17:00-17:35","17:35-18:10"]),X("13/14","18:30","19:40",["18:30-19:05","19:05-19:40"]),X("15/16","20:00","21:10",["20:00-20:35","20:35-21:10"]),X("17/18","21:30","22:40",["21:30-22:05","22:05-22:40"])];function X(e,t,n,a){return{label:e,start:t,end:n,lines:a.map(r=>{const[s,l]=r.split("-");return{start:s,end:l}})}}function Pn(e){if(!e)return"";const t=String(e).toLowerCase();return t==="umayor"||t.includes("mayor")?"UMAYOR":t==="usm"||t==="utfsm"||t.includes("utfsm")||t.includes("santa mar√≠a")||t.includes("santa maria")?"USM":"OTRA"}function On(){const e=i.activeSemesterData?.universityAtThatTime||i.profileData?.university||"";return Pn(e)}function Tt(){return On()==="UMAYOR"?Ht:Le}function Rn(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function jt(e,t,n){const a=(e||[]).find(r=>r.id===t);return Rn(a?.color)?a.color:n||"#3B82F6"}function qt(e){try{const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return(t*299+n*587+a*114)/1e3>=160?"#111":"#fff"}catch{return"#0e0e0e"}}let ze=null,z=[];function za(){if(ln)return;ln=!0,Ga(),Ja(),Ka(),Qa(),Xa(),We(),document.addEventListener("pair:ready",u=>{if(u.detail?.otherUid)fn(),We();else{const f=o("sh-semSel");f&&(f.innerHTML="<option disabled selected>Sin compa√±ero</option>")}}),o("sh-semSel")?.addEventListener("change",u=>{i.shared.horario.semId=u.target.value||null,tt(i.shared.horario.semId)});const e=o("subtabPropio"),t=o("subtabCompartido"),n=o("subtabCombinado"),a=o("horarioPropio"),r=o("horarioCompartido"),s=o("horarioCombinado");function l(){e.classList.add("active"),t.classList.remove("active"),n.classList.remove("active"),a.classList.remove("hidden"),r.classList.add("hidden"),s.classList.add("hidden")}function c(){if(t.getAttribute("aria-disabled")==="true"){alert("Debes emparejarte primero para ver el horario de la otra persona.");return}t.classList.add("active"),e.classList.remove("active"),n.classList.remove("active"),r.classList.remove("hidden"),a.classList.add("hidden"),s.classList.add("hidden");const u=o("sh-semSel");if(u&&!u.value){const m=Array.from(u.options).find(f=>f.value);m&&(u.value=m.value),u?.value&&(i.shared.horario.semId=u.value)}i.shared?.horario?.semId?tt(i.shared.horario.semId):fn().then(()=>We())}function d(){n.classList.add("active"),e.classList.remove("active"),t.classList.remove("active"),s.classList.remove("hidden"),a.classList.add("hidden"),r.classList.add("hidden"),zt()}e.addEventListener("click",l),t.addEventListener("click",c),n.addEventListener("click",d),l(),document.addEventListener("courses:changed",()=>{Yt(),ge()}),document.addEventListener("click",async u=>{const m=u.target.closest(".block-del-btn");if(!m)return;const f=m.dataset.id;if(!(!f||!i.currentUser||!i.activeSemesterId)&&confirm("¬øEliminar este bloque del horario?"))try{await Q(E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",f))}catch(p){console.error(p),alert("No se pudo eliminar el bloque.")}}),setTimeout(async()=>{i.pairOtherUid&&i.activeSemesterData?.label&&(await We(),i.shared?.horario?.semId&&await tt(i.shared.horario.semId))},1500)}function bt(){if(ze&&(ze(),ze=null),z=[],ge(),!i.currentUser||!i.activeSemesterId)return;const e=x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule");ze=O(V(e),t=>{z=t.docs.map(n=>({id:n.id,...n.data()})),ge()})}function Ga(){const e=o("horarioPropio");e.innerHTML=`
  <div class="card" style="margin-bottom:12px">
    <h3 style="margin:0 0 10px">Paleta de ramos</h3>
    <div id="coursePalette" class="palette"></div>
    <div class="muted" style="margin-top:6px">
      <ul style="margin:4px 0 0 20px; padding:0; list-style:disc;">
        <li>Arrastra un ramo a un m√≥dulo.</li>
        <li>Puedes arrastrar ramos del mismo horario.</li>
        <li>La pre-vista indica <b>arriba</b>, <b>completo</b>, <b>abajo</b>, <b>izquierda</b> o <b>derecha</b>.</li>
        <li>Para eliminar un bloque, haz <b>click</b> en la X.</li>
        <li>Para editar un bloque, haz <b>click</b> sobre √©l.</li>
        <li>Para editar una sala, haz <b>click derecho</b> sobre √©l.</li>
        <li>Para ver su sala, pase el mouse por encima.</li>
      </ul>
    </div>
  </div>
  <div id="schedUSM" class="sched-usm card"></div>
`,Yt(),ge()}function Va(){Yt(),ge()}function Yt(){const e=o("coursePalette");if(!e)return;e.innerHTML="";const t=Array.isArray(i.courses)?i.courses:[];if(t.length===0){e.innerHTML='<div class="muted">No hay ramos en el semestre activo.</div>';return}t.forEach(n=>{const a=document.createElement("div");a.className="palette-chip",a.setAttribute("draggable","true"),a.dataset.courseId=n.id,a.textContent=n.name;const r=Rn(n.color)?n.color:"#3B82F6";a.style.borderColor=r,a.style.boxShadow="inset 0 0 0 2px rgba(0,0,0,.15)",e.appendChild(a)})}function ge(){const e=o("schedUSM");if(!e)return;const t=Tt();kn=t;const n=On()==="USM",a=n?"Bloque":"M√≥dulo";e.innerHTML=`
    <div class="usm-grid2">
      <div class="cell header">${a}</div>
      ${Oe.map(r=>`<div class="cell header">${r}</div>`).join("")}
      ${t.map((r,s)=>`
        <div class="cell mod ${r.lunch?"lunch":""}" data-slot="${s}">
          ${Bn(r,s,n?"USM":"UMAYOR")}
        </div>
        ${Oe.map((l,c)=>`
          <div class="cell slot ${r.lunch?"is-lunch":""}"
               data-day="${c}" data-slot="${s}"
               ${r.lunch?'aria-disabled="true"':""}>
            ${Wa(c,s)}
          </div>
        `).join("")}
      `).join("")}
    </div>
  `,_n(),e.querySelectorAll(".placed").forEach(r=>{if(!r.querySelector(".block-del-btn")){const s=document.createElement("button");s.className="block-del-btn",s.textContent="√ó",s.dataset.id=r.dataset.id,r.appendChild(s)}})}function Bn(e,t,n){if(e.lunch)return`
      <div class="mod-label">ALMUERZO</div>
      <div class="mod-time">${e.start}‚Äì${e.end}</div>
    `;const r=($t.length?$t:kn).slice(0,t).filter(s=>!s.lunch).length;if(n==="USM"){const s=r*2+1,l=s+1;return`
      <div class="mod-lines">
        <div class="line-num">${s}</div>
        <div class="line-time">${e.lines[0].start}‚Äì${e.lines[0].end}</div>
        <div class="line-num">${l}</div>
        <div class="line-time">${e.lines[1].start}‚Äì${e.lines[1].end}</div>
      </div>
    `}else return`
      <div class="mod-lines">
        <div class="line-num">${r+1}</div>
        <div class="line-time">${e.start}‚Äì${e.end}</div>
      </div>
    `}function Wa(e,t){const n=z.filter(r=>r.day===e&&r.slot===t);if(!n.length)return"";const a=r=>{const s=n.filter(c=>(c.pos||"full")===r);return s.length?s.sort((c,d)=>{const u={left:0,single:1,right:2};return(u[c.hpos||"single"]??1)-(u[d.hpos||"single"]??1)}).map(c=>Za(c,r)).join(""):""};return`
    ${a("top")}
    ${a("full")}
    ${a("bottom")}
  `}function Za(e,t){const a=(i.courses||[]).find(m=>m.id===e.courseId)?.name||"Ramo",r=typeof e.displayName=="string"&&e.displayName.trim()?e.displayName.trim():a,s=jt(i.courses,e.courseId,it),l=qt(s),c=typeof e.room=="string"&&e.room.trim()?e.room.trim():null,d=e.hpos||"single",u=`${r}${c?` ¬∑ Sala: ${c}`:""}`;return`
  <div class="placed pos-${t} h-${d}" data-id="${e.id}"
       draggable="true"
       title="${u}"
       style="background:${s}; border:1px solid rgba(0,0,0,0.25);">
    <div class="placed-title" style="color:${l}; font-weight:600;">${r}</div>
  </div>
`}function Ja(){window.addEventListener("dragover",Ya,{passive:!0}),document.addEventListener("drop",un),document.addEventListener("dragend",un),document.addEventListener("dragstart",e=>{const t=e.target;t&&t.classList.contains("palette-chip")&&(e.dataTransfer.setData("text/plain",t.dataset.courseId),e.dataTransfer.effectAllowed="copy",ct=!0)}),document.addEventListener("dragstart",e=>{const t=e.target.closest(".placed");t&&(e.dataTransfer.setData("text/plain",JSON.stringify({type:"move-block",id:t.dataset.id})),e.dataTransfer.effectAllowed="move",ct=!1)}),_n()}function Ka(){document.addEventListener("click",e=>{const t=e.target.closest(".placed-title");if(!t||!t.closest("#schedUSM")||document.querySelector("input.inline-rename"))return;const a=t.closest(".placed");if(!a)return;const r=a.dataset.id,s=z.find(p=>p.id===r);if(!s)return;const c=(i.courses||[]).find(p=>p.id===s.courseId)?.name||t.textContent.trim(),d=typeof s.displayName=="string"&&s.displayName.trim()?s.displayName.trim():c,u=document.createElement("input");u.type="text",u.className="inline-rename",u.value=d;const m=Math.max(t.offsetWidth,140);u.style.width=m+"px",t.replaceWith(u),u.focus(),u.select();const f=async p=>{const g=document.createElement("div");g.className="placed-title";const b=(u.value||"").trim();if(g.textContent=p?b||c:d,u.replaceWith(g),!!p&&b!==d&&!(!i.currentUser||!i.activeSemesterId))try{const w=E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",s.id);await k(w,b?{displayName:b}:{displayName:null});const T=z.findIndex(N=>N.id===s.id);T>=0&&(z[T].displayName=b||null)}catch(w){console.error("rename error",w),alert("No se pudo renombrar el bloque. Intenta nuevamente."),g.textContent=d}};u.addEventListener("keydown",p=>{p.key==="Enter"&&(p.preventDefault(),f(!0)),p.key==="Escape"&&(p.preventDefault(),f(!1))}),u.addEventListener("blur",()=>f(!0))})}function Qa(){document.addEventListener("contextmenu",async e=>{const t=e.target.closest(".placed");if(!t||!t.closest("#schedUSM"))return;e.preventDefault();const a=t.dataset.id,r=z.find(d=>d.id===a);if(!r||!i.currentUser||!i.activeSemesterId)return;const s=(r.room||"").trim(),l=prompt("Sala del ramo (deja vac√≠o para borrar):",s);if(l===null)return;const c=(l||"").trim();try{const d=E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",r.id);await k(d,{room:c||null});const u=z.findIndex(m=>m.id===r.id);u>=0&&(z[u].room=c||null),ge()}catch(d){console.error("room update error",d),alert("No se pudo actualizar la sala. Intenta nuevamente.")}})}function _n(){document.querySelectorAll(".cell.slot").forEach(e=>{e.classList.contains("is-lunch")||(e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect=t.dataTransfer.effectAllowed==="move"?"move":"copy";const n=e.getBoundingClientRect(),a=t.clientX-n.left,r=t.clientY-n.top,s=n.height/2;let l="full";r<s-10?l="top":r>s+10&&(l="bottom");let c="single";const d=a/n.width;d<.4?c="left":d>.6&&(c="right"),e.dataset.droppos=l,e.dataset.droph=c,e.classList.add("over"),e.classList.remove("hint-top","hint-full","hint-bottom","hint-left","hint-center","hint-right"),l==="top"&&e.classList.add("hint-top"),l==="full"&&e.classList.add("hint-full"),l==="bottom"&&e.classList.add("hint-bottom"),c==="left"&&e.classList.add("hint-left"),c==="single"&&e.classList.add("hint-center"),c==="right"&&e.classList.add("hint-right")}),e.addEventListener("dragleave",()=>ae(e)),e.addEventListener("drop",async t=>{t.preventDefault();const n=t.dataTransfer.getData("text/plain");if(!n)return;const a=parseInt(e.dataset.day,10),r=parseInt(e.dataset.slot,10),s=e.dataset.droppos||"full",l=e.dataset.droph||"single";let c=null;try{c=JSON.parse(n)}catch{}if(c&&c.type==="move-block"){const p=c.id;if(!z.find(b=>b.id===p))return;if(!i.currentUser||!i.activeSemesterId){alert("Selecciona un semestre activo antes de mover bloques."),ae(e);return}try{const b=E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",p),w=Tt()[r];await k(b,{day:a,slot:r,pos:s,hpos:l,start:w.start,end:w.end,updatedAt:Date.now()});const $=z.findIndex(T=>T.id===p);$>=0&&Object.assign(z[$],{day:a,slot:r,pos:s,hpos:l,start:w.start,end:w.end}),ge()}catch(b){console.error("move error",b),alert("No se pudo mover el bloque (error Firestore): "+(b?.message||b))}ae(e);return}const d=n;if(!i.currentUser||!i.activeSemesterId){alert("Selecciona un semestre."),ae(e);return}const m=z.filter(p=>p.day===a&&p.slot===r).filter(p=>(p.pos||"full")===s);if(m.length>=2){alert("Esta zona ya tiene dos ramos (izq/der)."),ae(e);return}if(m.length===1){const p=m[0],g=p.hpos||"single";if(s==="full"&&l==="single"){alert("Ya hay un ramo aqu√≠. Elige izquierda o derecha."),ae(e);return}if(g==="single"){const b=l==="left"?"right":"left";try{await k(E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",p.id),{hpos:b})}catch{}}else if(g===l){alert("Ese lado ya est√° ocupado. Prueba el otro lado."),ae(e);return}}const f=Tt()[r];await Ie(x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule"),{courseId:d,day:a,slot:r,start:f.start,end:f.end,pos:s,hpos:l,createdAt:Date.now()}),ae(e)}))})}function ae(e){e.classList.remove("over","hint-top","hint-full","hint-bottom","hint-left","hint-center","hint-right"),delete e.dataset.droppos,delete e.dataset.droph}let Ge=null,lt=[],Ve=null,dt=[],Dt=Le,Ne="USM";function Xa(){const e=o("horarioCompartido");e&&(e.innerHTML=`
    <div class="card" style="margin-bottom:12px">
      <div class="row" style="align-items:flex-end;gap:12px">
        <div>
          <label>Semestre de la otra persona</label><br/>
          <select id="sh-semSel"></select>
        </div>
        <div class="muted">Elige un semestre (ej. 2025-2) para ver el horario de la otra persona en vivo.</div>
      </div>
    </div>
    <div id="schedSharedUSM" class="sched-usm card"></div>
  `,De())}function De(){const e=o("schedSharedUSM");if(!e)return;const t=Dt||Le;$t=t;const n=Ne==="USM"?"Bloque":"M√≥dulo";e.innerHTML=`
    <div class="usm-grid2">
      <div class="cell header">${n}</div>
      ${Oe.map(a=>`<div class="cell header">${a}</div>`).join("")}
      ${t.map((a,r)=>`
        <div class="cell mod ${a.lunch?"lunch":""}" data-slot="${r}">
          ${Bn(a,r,Ne)}
        </div>
        ${Oe.map((s,l)=>`
          <div class="cell slot ${a.lunch?"is-lunch":""}"
               data-day="${l}" data-slot="${r}">
            ${er(l,r)}
          </div>
        `).join("")}
      `).join("")}
    </div>
  `}function er(e,t){const n=lt.filter(r=>r.day===e&&r.slot===t),a=r=>{const s=n.filter(c=>(c.pos||"full")===r);return s.length?s.sort((c,d)=>{const u={left:0,single:1,right:2};return(u[c.hpos||"single"]??1)-(u[d.hpos||"single"]??1)}).map(c=>tr(c,r)).join(""):""};return`
    ${a("top")}
    ${a("full")}
    ${a("bottom")}
  `}function tr(e,t,n,a){const r=dt||[],l=r.find(p=>p.id===e.courseId)?.name||"Ramo",c=typeof e.displayName=="string"&&e.displayName.trim()?e.displayName.trim():l,d=jt(r,e.courseId,ot),u=qt(d),m=typeof e.room=="string"&&e.room.trim()?e.room.trim():null,f=e.hpos||"single";return`
  <div class="placed pos-${t} h-${f}"
       title="${c}${m?` ¬∑ Sala: ${m}`:""}"
       style="background:${d}; border:1px solid rgba(0,0,0,0.25); margin:2px 0;">
    <div class="placed-title" style="color:${u}; font-weight:600;">${c}</div>
  </div>
`}async function tt(e){Ge&&(Ge(),Ge=null),Ve&&(Ve(),Ve=null),Ye&&(Ye(),Ye=null),lt=[],dt=[],Dt=Le,Ne="USM",De(),it=i.profileData?.favoriteColor||it;const t=i.pairOtherUid;if(!t||!e)return;const n=E(h,"users",t,"semesters",e),a=await j(n),r=a.exists()&&a.data().universityAtThatTime||"";Ne=Pn(r),Dt=Ne==="UMAYOR"?Ht:Le,Ye=O(E(h,"users",t),c=>{ot=(c.data()||{}).favoriteColor||ot,De()});const s=x(h,"users",t,"semesters",e,"courses");Ve=O(V(s,he("name")),c=>{dt=c.docs.map(d=>({id:d.id,...d.data()})),De()});const l=x(h,"users",t,"semesters",e,"schedule");Ge=O(V(l),c=>{lt=c.docs.map(d=>({id:d.id,...d.data()})),De()})}let mn=0;async function fn(){const e=o("sh-semSel");if(!e)return;const t=++mn,n=p=>String(p||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim(),a=p=>{const g=n(p),b=g.replace(/[^\d\-\/ ]+/g,"").match(/(\d{4})\D*([12])$/);return b?`${b[1]}-${b[2]}`:g.toLowerCase()},r=p=>{const g=/^(\d{4})-(1|2)$/.exec(a(p));return g?{y:parseInt(g[1],10),t:parseInt(g[2],10)}:{y:-1/0,t:-1/0}};e.innerHTML="";const s=document.createElement("option");if(s.value="",s.textContent="‚Äî seleccionar ‚Äî",e.appendChild(s),!i.pairOtherUid)return;const l=x(h,"users",i.pairOtherUid,"semesters"),c=await D(V(l));if(t!==mn)return;const d=new Map;c.forEach(p=>{const g=p.data()||{},b=n(g.label||p.id),w=a(b);if(!d.has(w)){const{y:$,t:T}=r(b);d.set(w,{id:p.id,labelToShow:b,y:$,t:T})}});const u=Array.from(d.values()).sort((p,g)=>p.y!==g.y?g.y-p.y:g.t-p.t),m=document.createDocumentFragment();for(const{id:p,labelToShow:g}of u){const b=document.createElement("option");b.value=p,b.textContent=g,m.appendChild(b)}e.appendChild(m);const f=i.shared?.horario?.semId||"";if(f&&Array.from(e.options).some(p=>p.value===f))e.value=f;else{const p=Array.from(e.options).find(g=>g.value);e.value=p?p.value:"",i.shared.horario.semId=e.value||null}}async function We(){if(!i.pairOtherUid)return;const e=i.activeSemesterData?.label||null;if(e)try{const t=x(h,"users",i.pairOtherUid,"semesters"),n=await D(t);let a=null;if(n.forEach(r=>{const s=(r.data()?.label||"").trim();s===e&&(a={id:r.id,label:s})}),a&&(i.shared=i.shared||{},i.shared.horario=i.shared.horario||{},i.shared.horario.semId!==a.id)){i.shared.horario.semId=a.id;const r=o("sh-semSel");r&&(r.innerHTML=`<option selected>${a.label}</option>`,r.disabled=!0,r.style.pointerEvents="none",r.style.opacity="0.7"),await tt(a.id),document.getElementById("horarioCombinado")&&zt()}}catch(t){console.warn("autoSelectPartnerSemesterForSchedule",t)}}async function nr({course:e,day:t,slot:n,room:a}){if(!i.currentUser||!i.activeSemesterId)throw new Error("No logueado");const r=i.activeSemesterId,s=i.currentUser.uid,l=(i.courses||[]).find(m=>(m.name||"").toLowerCase().includes(String(e).toLowerCase()));if(!l)throw new Error("Curso no encontrado");const c=x(h,"users",s,"semesters",r,"schedule"),u=(await D(c)).docs.find(m=>{const f=m.data();return f.courseId===l.id&&f.day===t&&f.slot===n});if(!u)throw new Error("No encontr√© el bloque en el horario");return await k(u.ref,{room:a||null,updatedAt:Date.now()}),{ok:!0,room:a}}async function ar(e=null){if(!i.currentUser)throw new Error("No logueado");const t=e||i.activeSemesterId;if(!t)throw new Error("No hay semestre activo");const n=x(h,"users",i.currentUser.uid,"semesters",t,"schedule");return(await D(n)).docs.map(r=>({id:r.id,...r.data()}))}async function rr(e=null){if(!i.currentUser)throw new Error("No logueado");const t=e||i.activeSemesterId;if(!t)throw new Error("No hay semestre activo");if(!i.pairOtherUid)return{items:[]};const n=x(h,"users",i.currentUser.uid,"semesters",t,"schedule"),r=(await D(n)).docs.map(u=>({...u.data()})),s=x(h,"users",i.pairOtherUid,"semesters",t,"schedule"),c=(await D(s)).docs.map(u=>({...u.data()})),d=[];for(const u of r)for(const m of c)u.day===m.day&&u.slot===m.slot&&d.push(`${["Lun","Mar","Mi√©","Jue","Vie"][u.day]} bloque ${u.slot} (${u.courseName} / ${m.courseName})`);return{items:d}}async function sr(e,t=null){if(!i.currentUser)throw new Error("No logueado");const n=t||i.activeSemesterId;return await Q(E(h,"users",i.currentUser.uid,"semesters",n,"schedule",e)),{ok:!0}}document.addEventListener("dragstart",e=>{const t=e.target.closest(".placed");t&&t.classList.add("dragging")});document.addEventListener("dragend",e=>{const t=e.target.closest(".placed");t&&t.classList.remove("dragging")});const pn=480,ir=1320;function vn(e){const[t,n]=e.split(":").map(Number);return t*60+n}function hn(e){return(e-pn)/(ir-pn)*100}function zt(){const e=o("horarioCombinado");e&&(e.innerHTML=`
    <div class="timeline">
      <div class="timeline-hours">
        ${Array.from({length:15},(t,n)=>`<div class="timeline-hour">${8+n}:00</div>`).join("")}
      </div>
      ${Oe.map((t,n)=>`
        <div class="timeline-day" data-day="${n}" title="${t}">
          ${or(n)}
        </div>
      `).join("")}
    </div>
  `)}function or(e){return[...(z||[]).map(a=>({...a,isMine:!0})),...(lt||[]).map(a=>({...a,isMine:!1}))].filter(a=>a.day===e).map(a=>{const r=vn(a.start),s=vn(a.end),l=hn(r),c=hn(s)-l,d=a.isMine?i.courses:dt,u=jt(d,a.courseId,a.isMine?it:ot),m=qt(u),f=d.find(w=>w.id===a.courseId),p=a.displayName||f?.name||"Ramo",g=a.room?` (${a.room})`:"",b=a.isMine?1:.6;return`
      <div class="timeline-block"
           style="top:${l}%;height:${c}%;
                  background:${u};opacity:${b};color:${m};">
        ${p}${g}
      </div>
    `}).join("")}document.addEventListener("DOMContentLoaded",()=>{const e=o("subtabCombinado"),t=o("subtabCompartido"),n=o("subtabPropio"),a=o("horarioCombinado"),r=o("horarioCompartido"),s=o("horarioPropio");e&&(e.classList.remove("hidden"),e.addEventListener("click",()=>{n?.classList.remove("active"),t?.classList.remove("active"),e.classList.add("active"),s?.classList.add("hidden"),r?.classList.add("hidden"),a?.classList.remove("hidden"),zt()}))});const cr=Object.freeze(Object.defineProperty({__proto__:null,MAYOR_SLOTS:Ht,USM_SLOTS:Le,getMySchedule:ar,initSchedule:za,onActiveSemesterChanged:bt,overlapWithPair:rr,refreshCourseOptions:Va,removeBlock:sr,setRoom:nr},Symbol.toStringTag,{value:"Module"}));let I=new Date,fe=null,ut=[],Nt=!1,kt=null,nt=null,at=null,pe=null,Re=[],mt=[],Be="#ff69b4";function lr(e){kt=e}function dr(){try{kt?.()}finally{kt=null}}function ur(){const e=o("page-calendario");if(e){e.classList.add("hidden");const t=e.querySelector("[data-cal-grid]")||e.querySelector(".cal-grid");t&&(t.innerHTML="")}}function mr(){o("page-calendario")?.classList.remove("hidden")}function Gt(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function Vt(e,t="#3B82F6"){const n=(i.courses||[]).find(a=>a.id===e);return Gt(n?.color)?n.color:t}function Fn(e,t=Be){const n=(mt||[]).find(a=>a.id===e);return Gt(n?.color)?n.color:t}function Wt(e){try{const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return(t*299+n*587+a*114)/1e3>=160?"#111":"#fff"}catch{return"#0e0e0e"}}function Hn(){Nt||(Nt=!0,pr(),vr(),Kt(),ke(),ce(),jn(),qn(),document.addEventListener("pair:ready",gn),gn(),ft(),hr())}function _e(){Nt||Hn()}function Zt(){_e(),fe&&(fe(),fe=null),jn(),qn(),ke(),ce(),ft()}function fr(){_e(),pt(),Fe()}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",_e):_e();document.addEventListener("route:calendario",_e);function pr(){const e=o("page-calendario");e&&(e.innerHTML=`
    <div class="card">
      <div class="cal-head">
        <div class="cal-left">
          <button id="calPrev" class="ghost" title="Mes anterior">‚óÄ</button>
          <button id="calToday" class="ghost" title="Ir a hoy">Hoy</button>
          <button id="calNext" class="ghost" title="Mes siguiente">‚ñ∂</button>
          <h3 id="calTitle" style="margin:0 0 0 10px">Calendario</h3>
        </div>
        <div class="cal-right muted">
          Semestre activo: <b id="calActiveSem">‚Äî</b>
        </div>
      </div>

      <div class="subtabs" style="margin-bottom:10px; display:flex; gap:8px;">
        <button id="cal-subtab-propio" class="tab small active">Propio</button>
        <button id="cal-subtab-compartido" class="tab small">Duo</button>
          <button id="cal-subtab-combinado" class="tab small">Combinado</button>

      </div>

      <div id="cal-propio">
        <div class="cal-grid" id="calGrid" aria-live="polite"></div>
        <div class="muted" style="margin-top:8px">
          Haz clic en un d√≠a para agregar un evento.
        </div>
      </div>

      <div id="cal-compartido" class="hidden">
        <div class="card" style="margin-bottom:12px">
          <div class="row" style="align-items:flex-end; gap:12px;">
            <div>
              <label>Semestre de tu duo</label><br/>
              <select id="shc-semSel"></select>
            </div>
         
          </div>
        </div>
        <div class="cal-grid" id="calSharedGrid"></div>
        <div class="muted" id="calSharedHint" style="margin-top:8px"></div>
      </div>

      <div id="cal-combinado" class="hidden">
  <div id="calCombinedGrid" class="cal-grid"></div>
</div>


    </div>
  `)}function vr(){o("calPrev")?.addEventListener("click",()=>{I=yn(I,-1),Ze(),ke(),ce()}),o("calNext")?.addEventListener("click",()=>{I=yn(I,1),Ze(),ke(),ce()}),o("calToday")?.addEventListener("click",()=>{I=new Date,Ze(),ke(),ce()}),Ze()}function Ze(){const e=I.getFullYear(),t=I.getMonth(),n=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],a=o("calTitle");a&&(a.textContent=`Calendario ¬∑ ${n[t][0].toUpperCase()}${n[t].slice(1)} ${e}`)}function jn(){const e=o("calActiveSem");e&&(e.textContent=i.activeSemesterData?.label||"‚Äî")}function hr(){const e=o("cal-subtab-propio"),t=o("cal-subtab-compartido"),n=o("cal-subtab-combinado"),a=o("cal-propio"),r=o("cal-compartido"),s=o("cal-combinado");function l(){e.classList.add("active"),t.classList.remove("active"),n.classList.remove("active"),a.classList.remove("hidden"),r.classList.add("hidden"),s.classList.add("hidden")}async function c(){if(t.classList.add("active"),e.classList.remove("active"),n.classList.remove("active"),r.classList.remove("hidden"),a.classList.add("hidden"),s.classList.add("hidden"),await ft(),ce(),!i.pairOtherUid){o("calSharedHint").textContent="Empareja tu cuenta para ver el calendario de tu duo.";return}o("calSharedHint").textContent="",await zn(),i.shared?.calendar?.semId&&Jt(i.shared.calendar.semId)}async function d(){await ft(),n.classList.add("active"),e.classList.remove("active"),t.classList.remove("active"),s.classList.remove("hidden"),a.classList.add("hidden"),r.classList.add("hidden"),br(),await Er()}e?.addEventListener("click",l),t?.addEventListener("click",c),n?.addEventListener("click",d),l()}function qn(){if(fe&&(fe(),fe=null),ut=[],pt(),!i.currentUser||!i.activeSemesterId)return;const e=x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"calendar");fe=O(V(e,he("date","asc")),t=>{ut=t.docs.map(n=>({id:n.id,...n.data()})),pt()})}async function gn(){if(Yn(),Re=[],mt=[],Be="#ff69b4",ce(),!i.pairOtherUid){const e=o("shc-semSel");e&&(e.innerHTML='<option value="">‚Äî</option>'),o("calSharedHint").textContent="Empareja tu cuenta para ver el calendario de tu duo.";return}o("calSharedHint").textContent="",await zn(),pe&&(pe(),pe=null),pe=O(E(h,"users",i.pairOtherUid),e=>{const t=e.data()||{};Be=Gt(t.favoriteColor)?t.favoriteColor:"#ff69b4",Fe()})}async function ft(){if(!i.pairOtherUid)return;const e=i.activeSemesterData?.label||null;if(e)try{const t=x(h,"users",i.pairOtherUid,"semesters"),n=await D(t);let a=null;if(n.forEach(r=>{const s=(r.data()?.label||"").trim();s===e&&(a={id:r.id,label:s})}),a&&(i.shared=i.shared||{},i.shared.calendar=i.shared.calendar||{},i.shared.calendar.semId!==a.id)){i.shared.calendar.semId=a.id;const r=o("shc-semSel");r&&(r.innerHTML=`<option selected>${a.label}</option>`,r.disabled=!0,r.style.pointerEvents="none",r.style.opacity="0.7"),Jt(a.id)}}catch(t){console.warn("autoSelectPartnerSemesterForCalendar",t)}}function Yn(){nt&&(nt(),nt=null),at&&(at(),at=null),pe&&(pe(),pe=null)}async function zn(){const e=o("shc-semSel");if(!e)return;e.innerHTML="<option selected disabled>Cargando‚Ä¶</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";const t=i.pairOtherUid;if(!t){e.innerHTML="<option selected>No disponible</option>";return}const n=i.activeSemesterData?.label||null;if(!n){e.innerHTML="<option selected>No disponible</option>";return}try{const a=x(h,"users",t,"semesters"),r=await D(a);let s=null;if(r.forEach(l=>{const c=(l.data()?.label||"").trim();c===n&&(s={id:l.id,label:c})}),s)e.innerHTML=`<option selected>${s.label}</option>`,i.shared.calendar=i.shared.calendar||{},i.shared.calendar.semId=s.id,Jt(s.id),o("calSharedHint").textContent="";else{e.innerHTML="<option selected>No disponible</option>",i.shared.calendar=i.shared.calendar||{},i.shared.calendar.semId=null;const l=o("calSharedGrid");l&&(l.innerHTML=`<div class="muted">Tu d√∫o no tiene el semestre <b>${n}</b> creado.</div>`),o("calSharedHint").textContent="Sincronizado con tu semestre activo."}e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7"}catch(a){console.error("populateSharedSemesters error",a),e.innerHTML="<option selected>Error al cargar</option>"}}async function Jt(e){Yn(),Re=[],mt=[],ce();const t=i.pairOtherUid;if(!t||!e)return;const n=x(h,"users",t,"semesters",e,"courses");at=O(V(n,he("name")),r=>{mt=r.docs.map(s=>({id:s.id,...s.data()})),Fe()});const a=x(h,"users",t,"semesters",e,"calendar");nt=O(V(a,he("date","asc")),r=>{Re=r.docs.map(s=>({id:s.id,...s.data()})),Fe()})}function Kt(){if(o("calModal"))return;const e=document.createElement("div");e.id="calModal",e.className="modal",e.innerHTML=`
    <div class="modal-backdrop" id="calModalBackdrop"></div>
    <div class="modal-content">
      <h3 id="calModalTitle" style="margin-top:0">Nuevo evento</h3>

      <div class="row" style="gap:10px">
        <div style="flex:1">
          <label>T√≠tulo</label>
          <input type="text" id="calEvtTitle" placeholder="Ej. Prueba 1 ELO212"/>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Fecha</label>
          <input type="date" id="calEvtDate"/>
        </div>
        <div style="flex:1">
          <label>Ramo</label>
          <select id="calEvtCourse">
            <option value="">(Sin asignar)</option>
          </select>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Inicio</label>
          <input type="time" id="calEvtStart"/>
        </div>
        <div style="flex:1">
          <label>T√©rmino</label>
          <input type="time" id="calEvtEnd"/>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Repetir cada</label>
          <select id="calEvtRepeat">
            <option value="">(Sin repetici√≥n)</option>
            <option value="day">D√≠a</option>
            <option value="month">Mes</option>
            <option value="year">A√±o</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Persistencia</label>
          <select id="calEvtPersistent">
            <option value="">Solo este semestre</option>
            <option value="true">Mantener en semestres futuros</option>
          </select>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end; gap:10px; margin-top:16px">
        <button class="ghost" id="calEvtCancel">Cancelar</button>
        <button class="primary" id="calEvtSave">Guardar</button>
      </div>
    </div>
  `,document.body.appendChild(e);const t=()=>e.classList.remove("active");o("calModalBackdrop").addEventListener("click",t),o("calEvtCancel").addEventListener("click",t),o("calEvtSave").addEventListener("click",async()=>{if(!i.currentUser||!i.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}const n=(o("calEvtTitle").value||"").trim(),a=o("calEvtDate").value||"",r=o("calEvtStart").value||null,s=o("calEvtEnd").value||null,l=o("calEvtCourse").value||null,c=o("calEvtRepeat").value||"",d=o("calEvtPersistent").value==="true",u=l?Vt(l):null;if(!n)return alert("Ingresa un t√≠tulo.");if(!a)return alert("Selecciona una fecha.");const m=e.dataset.editingId||null,f=x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"calendar");try{m?(await k(E(f,m),{title:n,date:a,start:r,end:s,courseId:l,color:u,repeat:c?{every:c,interval:1}:null,persistent:d,updatedAt:Date.now()}),console.log("[Calendar] Evento actualizado:",n)):(await Ie(f,{title:n,date:a,start:r,end:s,courseId:l,color:u,repeat:c?{every:c,interval:1}:null,persistent:d,createdAt:Date.now()}),console.log("[Calendar] Evento creado:",n)),t()}catch(p){console.error(p),alert("No se pudo guardar el evento.")}finally{e.dataset.editingId=""}})}function gr(e){if(!i.currentUser||!i.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}Kt();const t=o("calEvtDate");t&&(t.value=e);const n=o("calEvtTitle");n&&(n.value="");const a=o("calEvtStart");a&&(a.value="");const r=o("calEvtEnd");r&&(r.value="");const s=o("calEvtCourse");s&&(s.innerHTML='<option value="">(Sin asignar)</option>',(i.courses||[]).forEach(l=>{const c=document.createElement("option");c.value=l.id,c.textContent=l.name,s.appendChild(c)})),o("calModal").classList.add("active")}function ke(){const e=o("calGrid");if(!e)return;const n=(new Date(I.getFullYear(),I.getMonth(),1).getDay()+6)%7,a=new Date(I.getFullYear(),I.getMonth()+1,0).getDate(),r=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${r.map(s=>`<div class="cal-cell head">${s}</div>`).join("")}
    ${Array.from({length:n}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((s,l)=>{const c=l+1,d=St(I.getFullYear(),I.getMonth()+1,c);return`
        <div class="cal-cell day" data-date="${d}">
          <div class="cal-daynum">${c}</div>
          <div class="cal-events" id="ce-${d}"></div>
        </div>
      `}).join("")}
  `,e.querySelectorAll(".cal-cell.day").forEach(s=>{s.addEventListener("click",()=>gr(s.dataset.date))}),pt()}function yr(e){if(!i.currentUser||!i.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}Kt();const t=o("calModal"),n=o("calModalTitle"),a=o("calEvtSave");t.dataset.editingId=e.id,n.textContent="Editar evento",a.textContent="Guardar cambios",o("calEvtTitle").value=e.title||"",o("calEvtDate").value=e.date||"",o("calEvtStart").value=e.start||"",o("calEvtEnd").value=e.end||"",o("calEvtRepeat").value=e.repeat?.every||"",o("calEvtPersistent").value=e.persistent?"true":"";const r=o("calEvtCourse");r.innerHTML='<option value="">(Sin asignar)</option>',(i.courses||[]).forEach(s=>{const l=document.createElement("option");l.value=s.id,l.textContent=s.name,s.id===e.courseId&&(l.selected=!0),r.appendChild(l)}),t.classList.add("active")}function ce(){const e=o("calSharedGrid");if(!e)return;const n=(new Date(I.getFullYear(),I.getMonth(),1).getDay()+6)%7,a=new Date(I.getFullYear(),I.getMonth()+1,0).getDate(),r=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${r.map(s=>`<div class="cal-cell head">${s}</div>`).join("")}
    ${Array.from({length:n}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((s,l)=>{const c=l+1,d=St(I.getFullYear(),I.getMonth()+1,c);return`
        <div class="cal-cell day" data-date="${d}">
          <div class="cal-daynum">${c}</div>
          <div class="cal-events" id="sce-${d}"></div>
        </div>
      `}).join("")}
  `,Fe()}function br(){const e=o("calCombinedGrid");if(!e)return;const n=(new Date(I.getFullYear(),I.getMonth(),1).getDay()+6)%7,a=new Date(I.getFullYear(),I.getMonth()+1,0).getDate(),r=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${r.map(s=>`<div class="cal-cell head">${s}</div>`).join("")}
    ${Array.from({length:n}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((s,l)=>{const c=l+1,d=St(I.getFullYear(),I.getMonth()+1,c);return`
        <div class="cal-cell day" data-date="${d}">
          <div class="cal-daynum">${c}</div>
          <div class="cal-events" id="bce-${d}"></div>
        </div>
      `}).join("")}
  `,Sr()}function Sr(){document.querySelectorAll(".cal-events").forEach(n=>{n.id?.startsWith("bce-")&&(n.innerHTML="")});const e=`${I.getFullYear()}-${String(I.getMonth()+1).padStart(2,"0")}`;[...ut.filter(n=>String(n.date||"").startsWith(e)).map(n=>({...n,isMine:!0})),...Re.filter(n=>String(n.date||"").startsWith(e)).map(n=>({...n,isMine:!1}))].forEach(n=>{const a=o("bce-"+n.date);if(!a)return;const r=n.color||(n.isMine?Vt(n.courseId):Fn(n.courseId,Be)),s=Wt(r),l=n.start&&n.end?`${n.start}‚Äì${n.end} ¬∑ `:n.start?`${n.start} ¬∑ `:"",c=document.createElement("div");c.className="cal-evt",c.textContent=`${l}${n.title||"(sin t√≠tulo)"}`,c.style.background=r,c.style.color=s,c.style.opacity=n.isMine?1:.65,c.style.border="1px solid rgba(0,0,0,0.25)",a.appendChild(c)})}async function Er(){const e=o("calCombinedRemindersList");if(e){e.innerHTML='<div class="loading"></div>';try{const t=await Gn({range:"today"}),n=i.pairOtherUid?await Vn({range:"today"}):[],a=[...t.map(r=>({...r,owner:"T√∫"})),...n.map(r=>({...r,owner:"D√∫o"}))].sort((r,s)=>(r.datetime||0)-(s.datetime||0));e.innerHTML=a.length?a.map(r=>`
          <div class="grade-item">
            <div>
              <strong>${r.title||"(sin t√≠tulo)"}</strong>
              <div class="muted">${r.owner} ¬∑ ${r.datetime?.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})||""}</div>
            </div>
          </div>
        `).join(""):'<div class="muted">Sin recordatorios para hoy.</div>'}catch(t){console.error("loadCombinedReminders",t),e.innerHTML='<div class="muted">Error al cargar recordatorios.</div>'}}}function Cr(e){const t=[];for(const a of e)if(t.push(a),a.repeat?.every){const r=new Date(a.date);for(let s=1;s<=24;s++){const l=new Date(r);a.repeat.every==="day"?l.setDate(r.getDate()+s*(a.repeat.interval||1)):a.repeat.every==="month"?l.setMonth(r.getMonth()+s*(a.repeat.interval||1)):a.repeat.every==="year"&&l.setFullYear(r.getFullYear()+s*(a.repeat.interval||1));const c=St(l.getFullYear(),l.getMonth()+1,l.getDate());if(Math.abs(l-r)/(1e3*60*60*24)>365)break;t.push({...a,date:c})}}return t}function pt(){document.querySelectorAll(".cal-events").forEach(n=>{n.id?.startsWith("sce-")||(n.innerHTML="")});const e=`${I.getFullYear()}-${String(I.getMonth()+1).padStart(2,"0")}`;Cr(ut).filter(n=>String(n.date||"").startsWith(e)).forEach(n=>{const a=o("ce-"+n.date);if(!a)return;const r=n.color||Vt(n.courseId)||"#1f2937",s=Wt(r),l=n.start&&n.end?`${n.start}‚Äì${n.end} ¬∑ `:n.start?`${n.start} ¬∑ `:"",c=document.createElement("div");c.className="cal-evt",c.style.background=r,c.style.color=s,c.style.border="1px solid rgba(0,0,0,0.25)",c.style.position="relative",c.style.cursor="pointer";const d=document.createElement("span");d.textContent=`${l}${n.title||"(sin t√≠tulo)"}`,c.appendChild(d);const u=document.createElement("span");u.textContent="‚úï",u.className="cal-del",u.title="Eliminar evento",u.style.position="absolute",u.style.top="2px",u.style.right="4px",u.style.fontWeight="bold",u.style.color="#fff8",u.style.cursor="pointer",u.addEventListener("click",async m=>{if(m.stopPropagation(),!(!i.currentUser||!i.activeSemesterId||!n.id)&&confirm(`¬øEliminar evento "${n.title}"?`))try{await Q(E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"calendar",n.id))}catch(f){console.error(f)}}),c.appendChild(u),c.addEventListener("click",m=>{m.stopPropagation(),yr(n)}),a.appendChild(c)})}function Fe(){document.querySelectorAll(".cal-events").forEach(n=>{n.id?.startsWith("sce-")&&(n.innerHTML="")});const e=`${I.getFullYear()}-${String(I.getMonth()+1).padStart(2,"0")}`;Re.filter(n=>String(n.date||"").startsWith(e)).forEach(n=>{const a=o("sce-"+n.date);if(!a)return;const r=n.color||(n.courseId?Fn(n.courseId):Be),s=Wt(r),l=n.start&&n.end?`${n.start}‚Äì${n.end} ¬∑ `:n.start?`${n.start} ¬∑ `:"",c=document.createElement("div");c.className="cal-evt",c.textContent=`${l}${n.title||"(sin t√≠tulo)"}`,c.style.background=r,c.style.color=s,c.style.border="1px solid rgba(0,0,0,0.25)",a.appendChild(c)})}function yn(e,t){const n=new Date(e.getTime());return n.setMonth(n.getMonth()+t),n}function St(e,t,n){return`${e}-${String(t).padStart(2,"0")}-${String(n).padStart(2,"0")}`}async function Gn({range:e="today"}){if(!i.currentUser)throw new Error("No logueado");const t=x(h,"users",i.currentUser.uid,"reminders"),n=await D(t),a=new Date;let r=n.docs.map(s=>({id:s.id,...s.data()}));return r=r.filter(s=>!s.suspended),e==="today"?r=r.filter(s=>isToday(s.datetime,a)):e==="week"?r=r.filter(s=>isThisWeek(s.datetime,a)):e==="month"&&(r=r.filter(s=>isThisMonth(s.datetime,a))),r}async function wr(e){if(!i.currentUser)throw new Error("No logueado");const t=E(h,"users",i.currentUser.uid,"reminders",e);return await k(t,{suspended:!1,updatedAt:Date.now()}),{ok:!0}}async function Lr(){if(!i.currentUser)throw new Error("No logueado");const e=x(h,"users",i.currentUser.uid,"reminders"),t=V(e,xn("suspended","==",!0));return(await D(t)).docs.map(a=>({id:a.id,...a.data()}))}async function xr({reminderId:e}){if(!i.currentUser)throw new Error("No logueado");if(!e)throw new Error("Falta ID");const t=E(h,"users",i.currentUser.uid,"reminders",e);return await k(t,{suspended:!0,updatedAt:Date.now()}),{ok:!0}}async function Vn({range:e="today"}={}){if(!i.pairOtherUid)throw new Error("No tienes d√∫o");const t=x(h,"users",i.pairOtherUid,"reminders"),n=await D(t),a=l=>l?typeof l=="number"?new Date(l):l.toDate?l.toDate():new Date(l):null,r=n.docs.map(l=>{const c=l.data();return{id:l.id,...c,datetime:a(c.datetime)}}),s=new Date;if(e==="today"){const l=new Date(s.getFullYear(),s.getMonth(),s.getDate()),c=new Date(s.getFullYear(),s.getMonth(),s.getDate()+1);return r.filter(d=>d.datetime&&d.datetime>=l&&d.datetime<c)}if(e==="week"){const l=new Date(s.getFullYear(),s.getMonth(),s.getDate()-s.getDay()),c=new Date(l);return c.setDate(l.getDate()+7),r.filter(d=>d.datetime&&d.datetime>=l&&d.datetime<c)}return r}const Ar=Object.freeze(Object.defineProperty({__proto__:null,clearCalendarUI:ur,initCalendar:Hn,listPairReminders:Vn,listReminders:Gn,listSuspendedReminders:Lr,onActiveSemesterChanged:Zt,onCoursesChanged:fr,registerCalendarUnsub:lr,resumeReminder:wr,showCalendarUI:mr,stopCalendarSub:dr,suspendReminder:xr},Symbol.toStringTag,{value:"Module"}));let Je=null;function Mr(){if(!i.currentUser||!i.activeSemesterId)return;const e=x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses");O(e,t=>{const n=t.docs.filter(r=>r.data().asistencia),a=o("attCourseSel");a&&(a.innerHTML='<option value="" disabled selected>Elige un ramo‚Ä¶</option>',n.forEach(r=>{a.innerHTML+=`<option value="${r.id}">${r.data().name}</option>`})),a?.addEventListener("change",()=>{const r=a.value,s=n.find(l=>l.id===r);Ur(s?[s]:[])})})}function Ur(e){const t=o("asistenciaList");t&&(t.innerHTML="",e.forEach(n=>{const a=n.data(),r=document.createElement("div");r.className="card",r.innerHTML=`
      <h4>${a.name}</h4>
      <div class="att-days" data-id="${n.id}"></div>
      <div class="muted">Asistencia actual: <span class="att-percent" data-id="${n.id}">0%</span></div>
      <button class="btn btn-secondary add-att-btn" data-id="${n.id}" style="margin-top:8px;">+ Agregar asistencia</button>
    `,t.appendChild(r),Ir(n.id)}),t.querySelectorAll(".add-att-btn").forEach(n=>{n.addEventListener("click",()=>Tr(n.dataset.id))}))}async function Ir(e){const t=x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",e,"attendance");O(t,n=>{const a=n.docs.map(r=>({id:r.id,...r.data()}));$r(e,a)})}async function $r(e,t){const n=document.querySelector(`.att-days[data-id="${e}"]`);if(!n)return;n.innerHTML=t.map(c=>`
    <div class="att-record">
      <span>${new Date(c.date+"T00:00:00").toLocaleDateString("es-CL",{timeZone:"America/Santiago"})} :

        ${c.present?"‚úî Presente":c.absent?"‚úò Ausente":c.justified?"üü° Justificado":"‚Äî Sin clase"}

      </span>
      <button class="btn btn-secondary btn-del-att" data-cid="${e}" data-id="${c.id}">‚ùå</button>
    </div>
  `).join(""),n.querySelectorAll(".btn-del-att").forEach(c=>{c.addEventListener("click",()=>Dr(c.dataset.cid,c.dataset.id))});const a=t.filter(c=>!c.noClass),r=a.filter(c=>c.present||c.justified).length,s=a.length?Math.round(r/a.length*100):0,l=document.querySelector(`.att-percent[data-id="${e}"]`);l&&(l.textContent=s+"%"),window.courseAttendance||(window.courseAttendance={}),window.courseAttendance[e]=s}let vt=null;function Tr(e){vt=e;const t=new Date,n=new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().split("T")[0];o("attDate").value=n,o("attModal").classList.add("active")}function Wn(){o("attModal").classList.remove("active"),vt=null}document.addEventListener("DOMContentLoaded",()=>{o("attCancel")?.addEventListener("click",Wn),o("attPresente")?.addEventListener("click",()=>Ke("present")),o("attAusente")?.addEventListener("click",()=>Ke("absent")),o("attJustificado")?.addEventListener("click",()=>Ke("justified")),o("attNoClass")?.addEventListener("click",()=>Ke("noClass"))});async function Ke(e){if(!vt)return;const t=o("attDate").value;if(!t){alert("Selecciona una fecha");return}const[n,a,r]=t.split("-").map(Number),l=new Date(n,a-1,r).toISOString().split("T")[0],c=E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",vt,"attendance",l);await K(c,{date:l,present:e==="present",absent:e==="absent",justified:e==="justified",noClass:e==="noClass"}),Wn()}async function Dr(e,t){const n=E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",e,"attendance",t);await Q(n)}async function Zn(){if(!i.currentUser||!i.activeSemesterId)return;if(Je){try{Je()}catch{}Je=null}window.courseAttendance||(window.courseAttendance={});const e=x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses");try{const t=await D(e);for(const n of t.docs){if(!(n.data()||{}).asistencia)continue;const r=x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",n.id,"attendance"),c=(await D(r)).docs.map(m=>m.data()).filter(m=>!m.noClass),d=c.filter(m=>m.present||m.justified).length,u=c.length?Math.round(d/c.length*100):0;window.courseAttendance[n.id]=u}console.log("‚ö° Precarga inicial de asistencia:",window.courseAttendance),document.dispatchEvent(new CustomEvent("attendance:ready",{detail:{preload:!0}}))}catch(t){console.error("Error en precarga r√°pida de asistencia:",t)}return Je=O(e,t=>{t.docs.filter(a=>a.data()?.asistencia).forEach(a=>{const r=x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",a.id,"attendance");O(r,s=>{const c=s.docs.map(m=>m.data()).filter(m=>!m.noClass),d=c.filter(m=>m.present||m.justified).length,u=c.length?Math.round(d/c.length*100):0;window.courseAttendance[a.id]=u,document.dispatchEvent(new CustomEvent("attendance:ready",{detail:{courseId:a.id,percent:u}}))})})}),!0}const Nr=Object.freeze(Object.defineProperty({__proto__:null,initAttendance:Mr,preloadAttendanceData:Zn},Symbol.toStringTag,{value:"Module"}));let R=null,Qe=null,ie=[],A={scale:"USM",finalExpr:"",rulesText:""},ne={byName:{},byCode:{},byId:{}},Pe=null,we=null;function Jn(){return E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",R,"groups","meta")}async function kr(){if(we=null,!!de())try{const e=await j(Jn());we=e.exists()?e.data()||{}:{}}catch(e){console.error("Error cargando nombres de grupos:",e),we={}}}async function Pr(e,t){if(de())try{await K(Jn(),{[e]:t},{merge:!0}),we={...we||{},[e]:t}}catch(n){throw console.error("Error guardando nombre de grupo:",n),n}}function Or(e){Pe=e,i.unsubscribeGrades=()=>{try{Pe?.()}finally{Pe=null,i.unsubscribeGrades=null}}}function Rr(){try{Pe?.()}finally{Pe=null}i.unsubscribeGrades=null}function Br(){const e=o("gr-courseSel");e&&(e.innerHTML='<option value="" disabled selected>Selecciona un ramo‚Ä¶</option>');const t=o("gr-evalsList");t&&(t.innerHTML="");const n=o("gr-finalExpr");n&&(n.value="");const a=o("gr-rulesError");a&&(a.textContent="");const r=o("gr-currentAvg");r&&(r.textContent="‚Äî");const s=o("gr-neededToPass");s&&(s.textContent="‚Äî");const l=o("gr-status");l&&(l.textContent="‚Äî");const c=o("gr-partnerView");c&&c.classList.add("hidden");const d=o("gr-sh-semSel");d&&(d.innerHTML="");const u=o("gr-sh-list");u&&(u.innerHTML="")}function _r(){jr()}document.addEventListener("attendance:ready",e=>{console.log("üîÅ Asistencia actualizada para:",e.detail),G()});document.addEventListener("route:notas",()=>{setTimeout(()=>{const e=o("gr-courseSel"),t=o("gr-evalsCard"),n=o("gr-calcCard"),a=o("gr-summaryCard"),r=o("gr-rulesCard");(!e||!e.value)&&(t&&t.classList.add("hidden"),n&&n.classList.add("hidden"),a&&a.classList.add("hidden"),r&&r.classList.add("hidden"))},50)});function Kn(){Qn()}function Fr(){const e=o("gr-activeSemLabel");e&&(e.textContent=i.activeSemesterData?.label||"‚Äî"),Qn();const t=document.getElementById("gr-sh-semSel");t&&i.activeSemesterData?.label&&(t.innerHTML=`<option selected>${i.activeSemesterData.label}</option>`,t.disabled=!0,t.style.pointerEvents="none",t.style.opacity="0.7"),(async()=>{try{await Zn(),console.log("‚úÖ Asistencia precargada, ahora s√≠ recalculamos notas"),G()}catch(n){console.warn("‚ö†Ô∏è Error precargando asistencia:",n),G()}})()}function Hr(){return(ie||[]).map(e=>({code:e.key,name:e.name||e.key,grade:typeof e.score=="number"?e.score:null}))}function jr(){qr(),o("gr-saveExpr")?.addEventListener("click",$e),o("gr-finalExpr")?.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),$e())}),o("gr-courseSel")?.addEventListener("change",zr),o("gr-addEvalBtn")?.addEventListener("click",Jr),Yr();function e(){const n=o("page-notas");if(!n)return;const a=Array.from(n.querySelectorAll(".card h3")).find(c=>/c[a√°]lculo de notas/i.test(c.textContent))?.closest(".card");if(!a||(a.id||(a.id="gr-calcCard"),a.querySelector("#gr-openSim")))return;const r=a.querySelector("h3"),s=document.createElement("button");s.id="gr-openSim",s.className="ghost",s.textContent="Simulador de notas";let l=r?.closest(".row");l?l.classList.add("gr-calcHeader"):(l=document.createElement("div"),l.className="row gr-calcHeader",r&&l.appendChild(r),a.insertBefore(l,a.firstChild)),s.style.marginLeft="auto",l.appendChild(s),s.addEventListener("click",()=>{const c=as();if(!c){alert("Primero define la F√≥rmula final.");return}const d=Hr();if(!d.length){alert("Agrega al menos una evaluaci√≥n.");return}ls({formula:c,evals:d})})}e(),document.addEventListener("pair:ready",Pt);const t=o("gr-finalExpr");if(t){const n=rs(async()=>{await $e()},600);t.addEventListener("input",()=>{A.finalExpr=Ae(t.value||""),G(),n()}),t.addEventListener("blur",()=>$e()),t.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),$e())})}}function qr(){const e=o("gr-passThreshold");e&&e.closest("div")?.classList.add("hidden");const t=o("gr-saveHeader");t&&t.classList.add("hidden")}function Yr(){if(o("gr-rulesCard"))return;const e=o("page-notas");if(!e)return;const t=document.createElement("div");t.className="card",t.id="gr-rulesCard",t.style.marginTop="12px",t.innerHTML=`
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Reglas</h3>
      <div class="muted" id="gr-rulesHint">Una por l√≠nea. Ej.: <code>C1>=50</code>, <code>avg(Q1,Q2,Q3)>=60</code>,</code> finalCode("Codigo del ramo") >= 50</code>,</code>Asistencia >= 55%</code></div>
    </div>
    <div class="row" style="align-items:flex-start;margin-top:8px">
      <textarea id="gr-rulesText" rows="4" style="flex:1 1 520px;min-height:86px;background:#0e1120;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px"></textarea>
      <div id="gr-formulaError" class="muted" style="margin-top:6px;color:#fca5a5"></div>
      <button id="gr-saveRules" class="primary">Guardar reglas</button>
    </div>
    <div id="gr-rulesStatus" class="muted" style="margin-top:6px"></div>
  `;const n=Array.from(e.querySelectorAll(".card h3")).find(a=>/c[a√°]lculo de notas/i.test(a.textContent))?.closest(".card");n?e.insertBefore(t,n):e.appendChild(t),o("gr-saveRules")?.addEventListener("click",Wr)}async function Qn(){const e=o("gr-courseSel");if(e){if(e.innerHTML="",!i.courses||i.courses.length===0){e.innerHTML='<option value="">‚Äî</option>',R=null,le(),ea(null);return}i.courses.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)}),R=null,e.value="",e.selectedIndex=0,i.editingCourseId=null,o("gr-evalsCard")?.classList.add("hidden"),o("gr-calcCard")?.classList.add("hidden"),o("gr-summaryCard")?.classList.add("hidden")}}async function zr(e){if(R=e.target.value||null,i.editingCourseId=R,!R){o("gr-evalsCard")?.classList.add("hidden"),o("gr-calcCard")?.classList.add("hidden"),o("gr-summaryCard")?.classList.add("hidden"),o("gr-rulesCard")?.classList.add("hidden");return}o("gr-evalsCard")?.classList.remove("hidden"),o("gr-calcCard")?.classList.remove("hidden"),o("gr-summaryCard")?.classList.remove("hidden"),o("gr-rulesCard")?.classList.remove("hidden"),await Vr(),await kr(),await Zr(),await je(),G(),await Gr(R)}async function Gr(e){try{const t=x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",e,"attendance"),r=(await D(t)).docs.map(c=>c.data()).filter(c=>!c.noClass),s=r.filter(c=>c.present||c.justified).length,l=r.length?Math.round(s/r.length*100):0;window.courseAttendance||(window.courseAttendance={}),window.courseAttendance[e]=l,console.log(`‚úÖ Sincronizada asistencia directa de ${e}: ${l}%`),G()}catch(t){console.warn("‚ö†Ô∏è No se pudo sincronizar asistencia directa:",t)}}function Et(){return E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",R,"grading","meta")}function te(){return x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",R,"grading","meta","components")}async function Vr(){if(!de())return;const e=Et(),t=E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",R),n=await j(t),a=n.exists()&&n.data().scale||null,r=i.activeSemesterData?.universityAtThatTime||"",s=/mayor/i.test(r)?"MAYOR":(/usm|utfsm|santa\s*mar/i.test(r),"USM"),l=await j(e);l.exists()?A={finalExpr:"",rulesText:"",...l.data()}:(A={scale:a||s,finalExpr:"",rulesText:""},await K(e,A));let c=a||s;A.scale!==c&&(A.scale=c,await k(e,{scale:A.scale})),o("gr-activeSemLabel")&&(o("gr-activeSemLabel").textContent=i.activeSemesterData?.label||"‚Äî");const d=o("gr-scaleSel");d&&(d.value=A.scale||"USM");const u=o("gr-finalExpr");u&&(u.value=A.finalExpr||"");const m=o("gr-rulesText");m&&(m.value=A.rulesText||""),A.scale,le(),G()}async function $e(){if(!de())return;const e=o("gr-finalExpr"),n=((e?e.value:"")||"").trim(),a=Ae(n)||null;A.finalExpr=a,await k(Et(),{finalExpr:a}),await je(),G()}async function Wr(){if(!de())return;const e=(o("gr-rulesText").value||"").trim()||null;A.rulesText=e,await k(Et(),{rulesText:e}),await je(),G()}async function Zr(){if(Qe&&(Qe(),Qe=null),!de()){le([]);return}const e=te();Qe=O(V(e,he("createdAt","asc")),async t=>{let n=t.docs.map(r=>({id:r.id,...r.data()}));const a=n.filter(r=>typeof r.order!="number");if(a.length){const{writeBatch:r}=await ee(async()=>{const{writeBatch:c}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");return{writeBatch:c}},[]),s=r(h),l=Date.now();a.forEach((c,d)=>{s.update(E(te(),c.id),{order:l+d})});try{await s.commit()}catch{}}n.sort((r,s)=>{const l=typeof r.order=="number"?r.order:9e15,c=typeof s.order=="number"?s.order:9e15;if(l!==c)return l-c;const d=r.createdAt?.toMillis?.()??0,u=s.createdAt?.toMillis?.()??0;return d-u}),ie=n,await le(n),G(),je().then(()=>G())},t=>{console.error("watchComponents error:",t),le([])})}async function Jr(){if(!de()){alert("Selecciona un semestre y un ramo.");return}const e=o("gr-evalName"),t=o("gr-evalCode"),n=o("gr-evalScore"),a=(e?.value||"").trim();let r=(t?.value||"").trim();const s=n?.value??"";if(!a){alert("Escribe un nombre.");return}if(!r){alert("Escribe un c√≥digo (ej: C1, T1...).");return}if(r=r.replace(/\s+/g,"").replace(/[^A-Za-z0-9_]/g,"").slice(0,16),!r){alert("C√≥digo inv√°lido.");return}r=Kr(r,ie);const l=A.scale==="MAYOR",c=l?1:0,d=l?7:100,u=parseFloat(String(s).replace(",",".")),m=isNaN(u)?null:ht(u,c,d);await Ie(te(),{key:r,name:a,score:m,createdAt:An(),order:Date.now()}),e&&(e.value=""),t&&(t.value=""),n&&(n.value="")}function Xn(e){return(e||"").replace(/\s+/g,"").replace(/[^A-Za-z0-9_]/g,"").slice(0,16)}function Kr(e,t){const n=new Set((t||[]).map(s=>(s.key||"").toLowerCase()));let a=Xn(e)||"X";if(!n.has(a.toLowerCase()))return a;let r=2;for(;n.has((a+r).toLowerCase());)r++;return a+r}async function le(e=[]){const t=o("gr-evalsList");if(!t)return;const n={};t.querySelectorAll(".grade-item").forEach(f=>{const p=f.querySelector("code")?.textContent?.trim(),g=f.querySelector('[data-f="score"]');p&&g&&g.value&&(n[p]=g.value)});const a=new Set(Array.from(t.querySelectorAll("details.grade-group[open]")).map(f=>f.dataset.key));if(t.innerHTML="",!R){t.innerHTML='<div class="muted">Selecciona un ramo.</div>';return}if(!e.length){t.innerHTML='<div class="muted">A√∫n no hay evaluaciones. Usa ‚ÄúAgregar evaluaci√≥n‚Äù.</div>';return}const r=A.scale==="MAYOR",s=r?1:0,l=r?7:100,c=r?.1:1,d={certamenes:e.filter(f=>/^C\d*/i.test(f.key)||/certamen/i.test(f.name)),controles:e.filter(f=>/^CTRL/i.test(f.key)||/control/i.test(f.name)),tareas:e.filter(f=>/^T\d*/i.test(f.key)||/tarea/i.test(f.name)),proyecto:e.filter(f=>/proy/i.test(f.key)||/proyecto/i.test(f.name)),evaluaciones:e.filter(f=>/evaluaci[o√≥]n/i.test(f.name)),experiencias:e.filter(f=>/experien/i.test(f.name)),preinformes:e.filter(f=>/pre[\s-]?informe/i.test(f.name)),informes:e.filter(f=>/\binforme/i.test(f.name)&&!/pre[\s-]?informe/i.test(f.name)),laboratorios:e.filter(f=>/\blab/i.test(f.key)||/laboratorio/i.test(f.name)),otros:e.filter(f=>!(/^(C\d*|CTRL|T\d*|LAB)/i.test(f.key)||/certamen|control|tarea|proy|evaluaci[o√≥]n|experien|informe|laboratorio/i.test(f.name)))},u={certamenes:"Cert√°menes",controles:"Controles",tareas:"Tareas",proyecto:"Proyecto",evaluaciones:"Evaluaciones",experiencias:"Experiencias",preinformes:"Pre-informes",informes:"Informes",laboratorios:"Laboratorios",otros:"Otros"},m={...u,...we||{}};for(const[f,p]of Object.entries(d)){let B=function(L,v,y){if(!L)return L;const S=M=>M.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),C=new RegExp(`\\b${S(v)}\\b`,"g");return L.replace(C,y)};if(!p.length)continue;const g=document.createElement("details");g.className="grade-group",g.dataset.key=f,a.has(f)&&(g.open=!0);const b=document.createElement("summary");b.style.display="flex",b.style.alignItems="center",b.style.justifyContent="space-between",b.style.width="100%",b.style.cursor="pointer";const w=m[f]||u[f]||f,$=document.createElement("span");$.style.fontWeight="700",$.textContent=`${w} (${p.length})`;const T=document.createElement("button");T.dataset.rename=f,T.className="ghost",T.textContent="‚úé",Object.assign(T.style,{fontSize:"0.9em",opacity:"0.8",marginLeft:"8px",flexShrink:"0"}),b.appendChild($),b.appendChild(T),g.appendChild(b);const N=document.createElement("div");p.forEach(L=>{const v=document.createElement("div");v.className="grade-item",v.setAttribute("draggable","true"),v.dataset.id=L.id,v.draggable=!0,v.innerHTML=`
  <div style="flex:1">
    <div class="gr-name" style="font-weight:700">${_(L.name||L.key)}</div>
    <div class="muted">C√≥digo: <code class="gr-code">${_(L.key)}</code></div>
  </div>
  <div style="display:flex;align-items:center;gap:.5rem">
    <input data-f="score" type="number" step="${c}" min="${s}" max="${l}"
           value="${n[L.key]??L.score??""}" style="width:110px"/>
    <button data-act="save" class="btn btn-secondary">Guardar</button>
    <button data-act="edit" class="btn btn-secondary">Editar</button>
    <button data-act="cancelEdit" class="btn btn-secondary" style="display:none">Cancelar</button>
    <button data-act="del"  class="btn btn-secondary">Eliminar</button>
  </div>
`,v.addEventListener("click",async y=>{const S=y.target;if(S instanceof HTMLElement){if(S.dataset.act==="save"){const C=v.querySelector('[data-f="score"]');let M=parseFloat(C.value);const q=isNaN(M)?null:ht(M,s,l);await k(E(te(),L.id),{score:q}),S.textContent="Guardado ‚úì",G(),setTimeout(()=>S.textContent="Guardar",1200)}if(S.dataset.act==="del"){if(!confirm(`Eliminar ‚Äú${L.name||L.key}‚Äù?`))return;await Q(E(te(),L.id))}}}),v.addEventListener("click",async y=>{const S=y.target;if(S instanceof HTMLElement){if(S.dataset.act==="edit"){const C=v.querySelector(".gr-name"),M=v.querySelector(".gr-code"),q=C?.textContent?.trim()||L.name||"",Y=M?.textContent?.trim()||L.key||"";C.innerHTML=`<input data-f="edit-name" type="text" value="${_(q)}"
                         style="width:100%;max-width:320px">`,M.parentElement.innerHTML=`C√≥digo: <input data-f="edit-code" type="text" value="${_(Y)}"
                      style="width:120px">`,v.querySelector('[data-act="edit"]').style.display="none",v.querySelector('[data-act="cancelEdit"]').style.display="";return}if(S.dataset.act==="cancelEdit"){le(ie);return}if(S.dataset.act==="save"){const C=v.querySelector('[data-f="edit-name"]'),M=v.querySelector('[data-f="edit-code"]');if(C||M){const W=C?C.value:L.name||L.key,U=M?M.value:L.key,F=(W||"").trim();let H=(U||"").trim();if(!F){alert("Escribe un nombre.");return}if(H=Xn(H),!H){alert("C√≥digo inv√°lido. Usa A‚ÄìZ, 0‚Äì9 o _.");return}if(new Set(ie.filter(be=>be.id!==L.id).map(be=>(be.key||"").toLowerCase())).has(H.toLowerCase())){alert(`El c√≥digo ${H} ya existe en este ramo.`);return}const fa=E(te(),L.id);if(H!==L.key){const be=B(A.finalExpr||"",L.key,H),en=B(A.rulesText||"",L.key,H);await k(Et(),{finalExpr:be||null,rulesText:en||null}),A.finalExpr=be||"",A.rulesText=en||""}await k(fa,{name:F,key:H}),await je(),G(),le(ie);return}const q=v.querySelector('[data-f="score"]');let Y=parseFloat(q.value);const J=isNaN(Y)?null:ht(Y,s,l);await k(E(te(),L.id),{score:J}),S.textContent="Guardado ‚úì",G(),setTimeout(()=>S.textContent="Guardar",1200);return}if(S.dataset.act==="del"){if(!confirm(`Eliminar ‚Äú${L.name||L.key}‚Äù?`))return;await Q(E(te(),L.id));return}}}),N.appendChild(v)}),g.appendChild(N),t.appendChild(g),ta(N),T.addEventListener("click",async L=>{L.preventDefault(),L.stopPropagation();const v=m[f]||u[f]||f,y=prompt(`Nuevo nombre para ‚Äú${v}‚Äù:`,v);if(!(!y||y.trim()===v))try{await Pr(f,y.trim()),le(ie)}catch{alert("No se pudo guardar el nuevo nombre.")}})}}function G(){const e={},t=A.scale==="MAYOR"?1:0,n=A.scale==="MAYOR"?7:100;ie.forEach(m=>{typeof m.score=="number"&&(e[m.key]=ht(m.score,t,n))}),window.courseAttendance&&R in window.courseAttendance?e.Asistencia=window.courseAttendance[R]:e.Asistencia=0;let a=null,r="";if(A.finalExpr&&A.finalExpr.trim()!=="")try{a=ye(A.finalExpr,e,{avg:xe,min:Math.min,max:Math.max,final:m=>gt(m),finalCode:m=>yt(m),finalId:m=>Xt(m)}),typeof a=="number"&&isFinite(a)?a=Me(a,A.scale):a=null}catch(m){r=m?.message||String(m||""),a=null}o("gr-rulesStatus")&&(o("gr-rulesStatus").dataset.formulaError=r);const s=A.scale==="MAYOR"?3.95:54.5,l=Ct(A.rulesText||""),c=Qt(l,e);let d=null;a==null?c.allOk?d="‚Äî":d="Reprueba":d=a>=s&&c.allOk?"Aprueba":"Reprueba";let u="‚Äî";if(a==null)u="Ingresa notas o completa la f√≥rmula.";else if(d==="Aprueba")u="Nada m√°s. Ya alcanzas la nota y cumples las reglas.";else{const m=[];if(a<s){const f=s-a;m.push(A.scale==="MAYOR"?`Subir la nota final en ${f.toFixed(2)} pts.`:`Subir la nota final en ${f.toFixed(1)} pts.`)}if(!c.allOk){const f=c.unmet.map(p=>`Cumplir: ${p.text}.`);m.push(...f)}u=m.join(" ")}es(c),ea({final:a,status:d,needed:u})}async function je(){if(ne={byName:{},byCode:{},byId:{}},!i.currentUser||!i.activeSemesterId)return;const e=Array.isArray(i.courses)?i.courses:[];for(const t of e)try{const n=E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",t.id,"grading","meta"),a=await j(n),r=a.exists()?a.data():{scale:"USM",finalExpr:""},s=x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",t.id,"grading","meta","components"),c=(await D(s)).docs.map(b=>({id:b.id,...b.data()})),d={},u=r.scale==="MAYOR"?1:0,m=r.scale==="MAYOR"?7:100;for(const b of c)if(typeof b.score=="number"&&isFinite(b.score)){const w=Math.max(u,Math.min(m,b.score));d[b.key]=w}let f=null;if((r.finalExpr||"").trim())try{f=ye(r.finalExpr,d,{avg:xe,min:Math.min,max:Math.max,final:b=>NaN,finalCode:b=>NaN,finalId:b=>NaN}),typeof f=="number"&&isFinite(f)?f=Me(f,r.scale):f=null}catch{f=null}const p=oe(t.name),g=oe(t.code);p&&(ne.byName[p]={final:f,scale:r.scale,id:t.id}),g&&(ne.byCode[g]={final:f,scale:r.scale,id:t.id}),ne.byId[t.id]={final:f,scale:r.scale,id:t.id}}catch{}}function Ct(e){return(e||"").split(/\r?\n/).map(n=>n.trim()).filter(Boolean)}function Qt(e,t,n){const a={allOk:!0,items:[],unmet:[]};for(const r of e){const s=Qr(r);if(!s){a.items.push({text:r,ok:!1,reason:"inv√°lida"}),a.unmet.push({text:r,kind:"invalid"}),a.allOk=!1;continue}const{left:l,op:c,right:d}=s;let u=null,m=null,f=!1;try{const g={...{avg:xe,min:Math.min,max:Math.max,final:gt,finalCode:yt,finalId:Xt},...n||{}};window.courseAttendance&&R in window.courseAttendance?t.Asistencia=window.courseAttendance[R]:"Asistencia"in t||(t.Asistencia=0);const b=l.replace(/%/g,""),w=d.replace(/%/g,"");u=ye(b,t,g),m=ye(w,t,g),f=Xr(u,c,m)}catch{f=!1}a.items.push({text:r,ok:f,left:u,op:c,right:m}),f||(a.unmet.push({text:r,kind:"cmp",left:u,op:c,right:m}),a.allOk=!1)}return a}function Qr(e){const t=e.match(/^(.*?)(>=|<=|==|!=|>|<)(.*)$/);return t?{left:Ae(t[1].trim()),op:t[2],right:Ae(t[3].trim())}:null}function Xr(e,t,n){if(!(isFinite(e)&&isFinite(n)))return!1;const a=Math.round(Math.round(e*10)/10),r=Math.round(Math.round(n*10)/10);switch(t){case">=":return a>=r;case"<=":return a<=r;case">":return a>r;case"<":return a<r;case"==":return a===r;case"!=":return a!==r;default:return!1}}function xe(...e){const t=e.map(a=>typeof a=="number"&&isFinite(a)?a:Number(a)).filter(a=>!isNaN(a));return t.length?t.reduce((a,r)=>a+r,0)/t.length:NaN}function es(e){const t=o("gr-rulesStatus");if(!t)return;if(!e||!e.items.length){t.textContent="No hay reglas definidas.";return}const n=e.items.filter(r=>r.ok).length,a=e.items.map(r=>r.ok?`‚úÖ ${r.text}`:`‚ùå ${r.text}`);t.innerHTML=`<div><b>Reglas:</b> ${n}/${e.items.length} cumplidas</div><div style="margin-top:4px">${a.join("<br/>")}</div>`}function ea(e){const t=o("gr-currentFinal")||o("gr-currentAvg"),n=o("gr-status"),a=o("gr-needed")||o("gr-neededToPass");if(!t||!n||!a)return;if(!e){t.textContent="",n.textContent="",a.textContent="",delete t.dataset.base,delete n.dataset.base;return}const r=A?.scale||"USM",s=e.final==null?"":Me(e.final,r).toString();t.textContent=s,n.textContent=e.status??"",a.textContent=e.needed??""}let Lt={id:null,fromIndex:-1};function ta(e){e&&(e.querySelectorAll(".grade-item").forEach(t=>{t.draggable=!0,t.querySelectorAll("input,button,select,textarea").forEach(n=>{n.setAttribute("draggable","false")})}),e.addEventListener("dragstart",t=>{const n=t.target.closest(".grade-item");n&&(t.dataTransfer.setData("text/plain",n.dataset.id||""),t.dataTransfer.effectAllowed="move",n.classList.add("dragging"),Lt.id=n.dataset.id,Lt.fromIndex=[...e.children].indexOf(n))}),e.addEventListener("dragend",()=>{e.querySelector(".grade-item.dragging")?.classList.remove("dragging"),Lt={id:null,fromIndex:-1}}),e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="move";const n=e.querySelector(".grade-item.dragging");if(!n)return;const a=ts(e,t.clientY);a==null?e.appendChild(n):e.insertBefore(n,a)},{capture:!0}),e.addEventListener("drop",async t=>{t.preventDefault();const n=[...e.querySelectorAll(".grade-item")].map(a=>a.dataset.id);await ns(n)}))}function ts(e,t){return[...e.querySelectorAll(".grade-item:not(.dragging)")].reduce((a,r)=>{const s=r.getBoundingClientRect(),l=t-(s.top+s.height/2);return l<0&&l>a.offset?{offset:l,element:r}:a},{offset:Number.NEGATIVE_INFINITY,element:null}).element}async function ns(e){if(!de()||!Array.isArray(e)||!e.length)return;const{writeBatch:t}=await ee(async()=>{const{writeBatch:s}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");return{writeBatch:s}},[]),n=t(h);let a=Date.now();const r=1e3;e.forEach((s,l)=>{const c=E(te(),s);n.update(c,{order:a+l*r})});try{await n.commit()}catch(s){console.warn("Error al guardar orden:",s)}}function as(){return(document.getElementById("gr-finalExpr")?.value||"").trim()}function rs(e,t){let n=null;return(...a)=>{n&&clearTimeout(n),n=setTimeout(()=>e(...a),t)}}function de(){return!!(i.currentUser&&i.activeSemesterId&&R)}function _(e){return(e??"").toString().replace(/[<>&"]/g,t=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"})[t])}function ht(e,t,n){return Math.max(t,Math.min(n,e))}function Ae(e){if(!e)return"";let t=String(e).trim();return t=t.replace(/[‚Äú‚Äù]/g,'"').replace(/[‚Äò‚Äô]/g,"'"),t=t.replace(/\s+/g," "),t}function na(e){return e.replace(/\b(final|finalCode|finalId)\(\s*([^)]+?)\s*\)/g,(t,n,a)=>{const r=String(a).trim();if(/^["'].*["']$/.test(r))return`${n}(${r})`;if(/[(),]/.test(r))return`${n}(${r})`;const s=r.replace(/"/g,'\\"');return`${n}("${s}")`})}function ss(e){return e?e.replace(/(\d+(?:\.\d+)?)\s*%/g,(t,n)=>`(${n}/100)`):""}function ye(e,t,n={}){const a=Ae(e),r=na(a),s=r.replace(/"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'/g,"0");if(!/^[\w\s\.\+\-\*\/\(\),%<>!=]+$/.test(s))throw new Error("La f√≥rmula contiene caracteres no permitidos.");const l=ss(r),c=s.match(/\b[A-Za-z_][A-Za-z0-9_]*\b/g)||[],d=new Set(["avg","min","max","final","finalCode","finalId"]),u=new Set(["NaN","Infinity","Math","true","false"]),m=Object.keys(t),f=m.map(w=>t[w]??0),p=new Set([...m,...Object.keys(n)]);for(const w of c)d.has(w)||u.has(w)||p.has(w)||(m.push(w),f.push(0),p.add(w));const g=Object.keys(n),b=Object.values(n);return Function(...g,...m,`"use strict"; return (${l});`)(...b,...f)}function is(e){const t=Ae(e||""),n=na(t),r=n.replace(/"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'/g,"0").match(/\b[A-Za-z_][A-Za-z0-9_]*\b/g)||[],s=new Set(["avg","min","max","final","finalCode","finalId","NaN","Infinity","Math","true","false"]),l=new Set((n.match(/\b[A-Za-z_][A-Za-z0-9_]*\s*\(/g)||[]).map(d=>d.replace("(","").trim())),c=r.filter(d=>!s.has(d)&&!l.has(d));return[...new Set(c)]}function Me(e,t){return e==null||isNaN(e)?null:t==="MAYOR"?Math.trunc(e*100)/100:Math.trunc(e*10)/10}function oe(e){return(e||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toLowerCase()}function gt(e){const t=oe(e);if(!t)return NaN;const n=(i.courses||[]).find(c=>c.id===R);if(t===oe(n?.name))return NaN;const a=ne.byName[t];if(a&&typeof a.final=="number")return a.final;const r=Array.isArray(i.courses)?i.courses:[],s=r.filter(c=>oe(c.name).startsWith(t)&&c.id!==R);if(s.length===1){const c=ne.byId[s[0].id];if(c&&typeof c.final=="number")return c.final}const l=r.filter(c=>oe(c.name).includes(t)&&c.id!==R);if(l.length===1){const c=ne.byId[l[0].id];if(c&&typeof c.final=="number")return c.final}return NaN}function yt(e){const t=oe(e),n=(i.courses||[]).find(r=>r.id===R);if(t&&t===oe(n?.code))return NaN;const a=ne.byCode[t];return a&&typeof a.final=="number"?a.final:NaN}function Xt(e){if(!e||e===R)return NaN;const t=ne.byId[e];return t&&typeof t.final=="number"?t.final:NaN}(function(){const t=o("gr-togglePartner");if(!t)return;const n=[o("gr-courseSel")?.closest(".card"),o("gr-evalsList")?.closest(".card"),o("gr-finalExpr")?.closest(".card"),o("gr-currentFinal")?.closest(".card")||o("gr-currentAvg")?.closest(".card"),o("gr-rulesCard")].filter(Boolean),a=o("gr-partnerView");function r(s){t.setAttribute("aria-pressed",s?"true":"false"),t.textContent=s?"Volver a mis notas":"Notas de mi duo",n.forEach(l=>sn(l,s)),sn(a,!s),s&&Pt()}t.addEventListener("click",()=>{const s=t.getAttribute("aria-pressed")==="true";r(!s)}),document.addEventListener("pair:ready",Pt)})();let bn=0;async function Pt(){const e=o("gr-sh-semSel");if(!e)return;e.innerHTML="";const t=document.createElement("option");if(t.textContent="Cargando...",t.disabled=!0,t.selected=!0,e.appendChild(t),!i.pairOtherUid){e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";return}const n=++bn,a=x(h,"users",i.pairOtherUid,"semesters"),r=await D(a);if(n!==bn)return;const s=i.activeSemesterData?.label||null;if(!s){e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";return}let l=null;if(r.forEach(c=>{const d=(c.data()?.label||"").trim();d===s&&(l={id:c.id,label:d})}),l)e.innerHTML=`<option selected>${l.label}</option>`,e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7",i.shared.notas.semId=l.id,cs(l.id);else{e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7",i.shared.notas.semId=null;const c=o("gr-sh-list");c&&(c.innerHTML='<div class="muted">Tu d√∫o no tiene este semestre creado.</div>')}}let rt=null;function os(){rt&&(rt(),rt=null)}async function cs(e){os();const t=o("gr-sh-list");if(t&&(t.innerHTML=""),!i.pairOtherUid||!e)return;const n=await j(E(h,"users",i.pairOtherUid,"semesters",e)),a=n.exists()&&n.data().universityAtThatTime||"",r=/mayor/i.test(a)?"MAYOR":"USM",s=x(h,"users",i.pairOtherUid,"semesters",e,"courses");rt=O(V(s,he("name")),async l=>{if(!l.size){Sn([]);return}const c={},d=[];for(const m of l.docs){const f=m.data()||{},p=m.id,g=E(h,"users",i.pairOtherUid,"semesters",e,"courses",p,"grading","meta"),b=await j(g),w=b.exists()?b.data():{scale:r,finalExpr:"",rulesText:""},$=x(h,"users",i.pairOtherUid,"semesters",e,"courses",p,"grading","meta","components"),N=(await D($)).docs.map(C=>({id:C.id,...C.data()||{}})),B={},L=w.scale==="MAYOR",v=L?1:0,y=L?7:100;N.forEach(C=>{const M=typeof C.score=="number"?Math.max(v,Math.min(y,C.score)):null;M!=null&&C.key&&(B[C.key]=M)});let S=null;try{(w.finalExpr||"").trim()&&(S=ye(w.finalExpr,B,{avg:xe,min:Math.min,max:Math.max,final:()=>NaN,finalCode:()=>NaN,finalId:()=>NaN}),typeof S=="number"&&isFinite(S)?S=Me(S,w.scale):S=null)}catch{S=null}c[(f.code||"").toLowerCase()]=S,d.push({cData:f,comps:N,vals:B,meta:w,prelim:S})}const u=[];for(const m of d){let f=m.prelim;try{(m.meta.finalExpr||"").trim()&&(f=ye(m.meta.finalExpr,m.vals,{avg:xe,min:Math.min,max:Math.max,final:()=>NaN,finalCode:$=>{const T=($||"").toString().toLowerCase();return c[T]??NaN},finalId:()=>NaN}),typeof f=="number"&&isFinite(f)?f=Me(f,m.meta.scale):f=null)}catch{f=null}const p=m.meta.scale==="MAYOR"?3.95:54.5,g=Ct(m.meta.rulesText||""),b=Qt(g,m.vals),w=f!=null&&f>=p&&b.allOk?"Aprobado":f==null?"‚Äî":"Reprobado";u.push({name:m.cData.name||"Ramo",code:m.cData.code||"",final:f,scale:m.meta.scale||r,status:w})}Sn(u)})}function Sn(e){const t=o("gr-sh-list");if(t){if(t.innerHTML="",!e.length){t.innerHTML='<div class="muted">No hay ramos en ese semestre.</div>';return}e.forEach(n=>{const a=n.final==null?"‚Äî":n.scale==="MAYOR"?(Math.trunc(n.final*100)/100).toFixed(2):(Math.trunc(n.final*10)/10).toFixed(1),r=n.status==="Aprobado"?"#22c55e":n.status==="Reprobado"?"#ef4444":"#aaa",s=document.createElement("div");s.className="grade-item",s.innerHTML=`
      <div style="flex:1">
        <div style="font-weight:700">${_(n.name)}</div>
        <div class="muted">Nota final: <b>${a}</b></div>
      </div>
      <div style="font-weight:700;color:${r}">
        ${n.status}
      </div>
    `,t.appendChild(s)})}}function ls({formula:e,evals:t}){document.getElementById("gr-simDrawer")?.remove(),document.getElementById("gr-simBackdrop")?.remove();const n=document.createElement("div");n.id="gr-simBackdrop",Object.assign(n.style,{position:"fixed",inset:"0",zIndex:9998,background:"rgba(0,0,0,0.35)",backdropFilter:"blur(1px)"}),document.body.classList.add("sim-lock");const a=document.createElement("div");a.id="gr-simDrawer",Object.assign(a.style,{position:"fixed",top:"0",right:"0",height:"100vh",width:"420px",background:"rgba(18,18,30,.98)",backdropFilter:"blur(6px)",borderLeft:"1px solid rgba(255,255,255,.08)",boxShadow:"0 0 24px rgba(0,0,0,.45)",zIndex:9999,padding:"16px 16px 90px 16px",overflowY:"auto"}),a.addEventListener("click",v=>v.stopPropagation()),a.innerHTML=`
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
      <h3 style="margin:0">Simulador de notas</h3>
      <span class="muted" style="font-size:12px;opacity:.8">(${_(e)})</span>
    </div>

    <div class="card" style="margin-top:4px">
      <h4 style="margin:0 0 6px">Evaluaciones</h4>
      <div id="gr-simForm"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 6px">Resumen de la simulaci√≥n</h4>
      <div id="gr-simSummary" class="muted">‚Äî</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 6px">Reglas del ramo (simulaci√≥n)</h4>
      <div id="gr-simRules" class="muted">‚Äî</div>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px; padding-top:12px; border-top:1px solid rgba(255,255,255,.1)">
  <button id="gr-simSave" class="primary">Guardar simulaci√≥n</button>
  <button id="gr-simClose" class="ghost">Salir</button>
</div>

  `,document.body.appendChild(n),document.body.appendChild(a);const r=async()=>{const v=L();let y=null;try{y=await Cn()}catch{y=null}const S=(Y={})=>{const J={};for(const[W,U]of Object.entries(Y||{}))U==null||U===""||typeof U=="string"&&U.trim()===""?J[W.toUpperCase()]=null:isNaN(U)?J[W.toUpperCase()]=U:J[W.toUpperCase()]=Math.round(Number(U)*100)/100;return J},M=((Y,J)=>{const W=S(Y),U=S(J),F=new Set([...Object.keys(W),...Object.keys(U)]);for(const H of F)if((W[H]??null)!==(U[H]??null))return!1;return!0})(v.gradesMap,y);let q=!1;if(M||(q=confirm("¬øGuardar esta simulaci√≥n antes de salir?")),q)try{await En(v.gradesMap,e)}catch{}n.remove(),a.remove(),document.body.classList.remove("sim-lock")};n.addEventListener("click",r),a.addEventListener("keydown",v=>{v.key==="Escape"&&r()}),a.querySelector("#gr-simClose")?.addEventListener("click",r),ds(a);const s=a.querySelector("#gr-simForm"),l=new Map((t||[]).map(v=>[v.code,v.grade])),c=is(e),d=new Set((t||[]).map(v=>v.code)),u=[...new Set([...d,...c])],m={certamenes:[],controles:[],tareas:[],proyecto:[],evaluaciones:[],experiencias:[],preinformes:[],informes:[],laboratorios:[],otros:[]},f={certamenes:"Cert√°menes",controles:"Controles",tareas:"Tareas",proyecto:"Proyecto",evaluaciones:"Evaluaciones",experiencias:"Experiencias",preinformes:"Pre-informes",informes:"Informes",laboratorios:"Laboratorios",otros:"Otros"};function p(v,y){return/^C\d*/i.test(v)||/certamen/i.test(y)?"certamenes":/^Q\d*/i.test(v)||/control/i.test(y)?"controles":/^T\d*/i.test(v)||/tarea/i.test(y)?"tareas":/PF|PROY/i.test(v)||/proy/i.test(y)?"proyecto":/evaluaci[o√≥]n/i.test(y)?"evaluaciones":/experien/i.test(y)?"experiencias":/pre[\s-]?informe/i.test(y)?"preinformes":/\binforme/i.test(y)&&!/pre[\s-]?informe/i.test(y)?"informes":/^L\d*/i.test(v)||/laboratorio/i.test(y)?"laboratorios":"otros"}for(const v of u){const y=(t||[]).find(M=>M.code===v)||{name:v},S=l.get(v),C=p(v,y.name||v);m[C].push({code:v,name:y.name||v,value:S})}const g=[],b=A.scale==="MAYOR",w=b?1:0,$=b?7:100,T=b?.1:1;for(const[v,y]of Object.entries(m)){if(!y.length)continue;const S=f[v]||v;g.push(`
    <details open class="sim-group" data-key="${v}"
      style="margin-top:10px;border:1px solid rgba(255,255,255,.08);
             border-radius:8px;padding:6px 8px;background:rgba(0,0,0,0.15)">
      <summary style="cursor:pointer;font-weight:700;font-size:14px;
                      margin-bottom:6px">${S} (${y.length})</summary>
      <div class="sim-group-body">
        ${y.map(C=>`
          <div class="row" style="align-items:center;gap:8px;margin:4px 0"
               data-sim-code="${_(C.code)}">
            <div style="min-width:76px"><b>${_(C.code)}</b></div>
            <div style="flex:1">${_(C.name)}</div>
            <input type="number" step="${T}" min="${w}" max="${$}"
                   style="width:110px" placeholder="‚Äî"
                   value="${C.value??""}">
          </div>
        `).join("")}
      </div>
    </details>
  `)}s.innerHTML=g.join("");const N=[...e.matchAll(/finalCode\(["'](.+?)["']\)/g)];for(const v of N){const y=v[1],S=yt(y);isFinite(S)?g.push(`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.85" data-sim-ref="${_(y)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1">Nota final de ${_(y)}</div>
        <input type="number" readonly value="${S}" style="width:110px;opacity:.7;background:#222;border:none;color:#ccc">
      </div>
    `):g.push(`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.75" data-sim-ref="${_(y)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1;color:#aaa">Nota final de ${_(y)}</div>
        <div style="width:110px;text-align:center;color:#f87171">‚Äî</div>
      </div>
    `)}s.innerHTML=g.join("");const B=[...e.matchAll(/final\(["'](.+?)["']\)/g)];for(const v of B){const y=v[1],S=gt(y);isFinite(S)&&s.insertAdjacentHTML("beforeend",`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.85" data-sim-ref="${_(y)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1">Nota final de ${_(y)}</div>
        <input type="number" readonly value="${S}" style="width:110px;opacity:.7;background:#222;border:none;color:#ccc">
      </div>
    `)}const L=()=>{const v={};s.querySelectorAll("[data-sim-code]").forEach(U=>{const F=U.getAttribute("data-sim-code"),H=U.querySelector("input")?.value?.trim(),wt=H?Number(String(H).replace(",",".")):null;v[F]=Number.isFinite(wt)?wt:0});let y=null,S=null;try{y=ye(e,{...v},{avg:xe,min:Math.min,max:Math.max,final:U=>gt(U),finalCode:U=>yt(U),finalId:U=>Xt(U)}),typeof y=="number"&&isFinite(y)?y=Me(y,A.scale):y=null}catch(U){S=U?.message||String(U||""),y=null}const C=Ct(A.rulesText||""),M=Qt(C,v),q=A.scale==="MAYOR"?3.95:54.5;let Y="";if(S)Y="";else if(y==null)Y="Ingresa valores para simular.";else{const U=[];if(y<q){const F=q-y;U.push(A.scale==="MAYOR"?`Subir la nota final en ${F.toFixed(2)} pts.`:`Subir la nota final en ${F.toFixed(1)} pts.`)}if(!M.allOk){const F=M.unmet.map(H=>H.text);F.length&&U.push(`Cumplir reglas pendientes: ${F.map(_).join("; ")}.`)}Y=U.length?U.join(" "):"Nada m√°s. Ya apruebas."}const J=a.querySelector("#gr-simSummary");J.innerHTML=S?`<div style="color:#f87171">Error en f√≥rmula: ${_(S)}</div>`:`
    <div>Promedio simulado: <b>${y??"‚Äî"}</b></div>
    <div class="muted" style="margin-top:6px">(Usa tu f√≥rmula final actual)</div>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:10px 0">
    <div><b>Necesitas para aprobar</b></div>
    <div style="margin-top:4px">${Y}</div>
  `;const W=a.querySelector("#gr-simRules");if(!C.length)W.textContent="No hay reglas definidas.";else{const U=M.items.filter(F=>F.ok).length;W.innerHTML=`
        <div style="margin-bottom:6px">Cumplidas: <b>${U}/${C.length}</b></div>
        <ul style="margin:0 0 0 18px;padding:0;list-style:disc;">
          ${M.items.map(F=>`<li style="color:${F.ok?"#22c55e":"#ef4444"}">${_(F.text)}</li>`).join("")}
        </ul>
      `}return{gradesMap:v,result:y}};s.addEventListener("input",L),L(),a.querySelector("#gr-simSave")?.addEventListener("click",async()=>{const v=L();try{const y=await En(v.gradesMap,e);alert(y?.where==="cloud"?"Simulaci√≥n guardada en la nube.":"Simulaci√≥n guardada")}catch(y){console.error(y),alert("No se pudo guardar la simulaci√≥n.")}}),Cn().then(v=>{v&&(s.querySelectorAll("[data-sim-code]").forEach(y=>{const S=y.getAttribute("data-sim-code")||"",C=y.querySelector("input");if(!C)return;const M=v[S]??v[S.toUpperCase()]??v[S.toLowerCase()];M!=null&&(C.value=String(M))}),L())}).catch(()=>{})}function ds(e){const t=()=>Array.from(e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(r=>!r.hasAttribute("disabled")&&r.tabIndex!==-1),n=()=>t()[0],a=()=>t().slice(-1)[0];setTimeout(()=>n()?.focus(),0),e.addEventListener("keydown",r=>{if(r.key!=="Tab")return;const s=t();if(!s.length)return;const l=document.activeElement;r.shiftKey?l===s[0]&&(r.preventDefault(),a()?.focus()):l===s[s.length-1]&&(r.preventDefault(),n()?.focus())})}async function En(e,t){const n={};Object.keys(e||{}).forEach(s=>{n[String(s).toUpperCase()]=e[s]});const a={formula:t,grades:n,rules:Ct(A.rulesText||""),semId:i.activeSemesterId||null,courseId:i.editingCourseId||null,createdAt:An()};if(i.currentUser&&i.activeSemesterId&&i.editingCourseId)try{const s=["users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",i.editingCourseId,"simulations"];return await Ie(x(h,...s),a),await K(E(h,...s,"__last__"),a),{ok:!0,where:"cloud"}}catch(s){console.warn("Fallo Firestore, usando localStorage:",s)}const r=`sim:last:${i.activeSemesterId||"SEM"}:${i.editingCourseId||"COURSE"}`;return localStorage.setItem(r,JSON.stringify(a)),{ok:!0,where:"local"}}async function Cn(){const e=`sim:last:${i.activeSemesterId||"SEM"}:${i.editingCourseId||"COURSE"}`;if(i.currentUser&&i.activeSemesterId&&i.editingCourseId)try{const t=E(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",i.editingCourseId,"simulations","__last__"),n=await j(t);if(n.exists()){const a=n.data()?.grades||null;return a&&typeof a=="object"?a:null}}catch{}try{const t=localStorage.getItem(e);if(!t)return null;const a=JSON.parse(t)?.grades||null;return a&&typeof a=="object"?a:null}catch{return null}}function us(e){if(!e||!i.courses)return null;const t=a=>String(a||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),n=t(e);return i.courses.find(a=>t(a.name).includes(n)||t(a.code||"").includes(n))||null}async function aa(e){const t=x(e.ref,"rules"),n=await D(t);let a=0,r=0;for(const s of n.docs){const l=s.data(),c=Number(l.peso)||0,d=x(s.ref,"grades"),m=(await D(d)).docs.map(f=>Number(f.data().valor)).filter(f=>!isNaN(f));if(m.length>0){const f=m.reduce((p,g)=>p+g,0)/m.length;a+=f*(c/100),r+=c}}return r>0?+a.toFixed(2):null}async function ms(e){if(!i.currentUser)return null;const t=x(h,"users",i.currentUser.uid,"semesters",e,"courses"),n=await D(t);let a=0,r=0;for(const s of n.docs){const l=await aa(s);l!=null&&(a+=l,r++)}return r>0?+(a/r).toFixed(2):null}function fs(e){const n=(e.scale||"USM")==="MAYOR"?4:55;let a=0,r=0;for(const l of e.rules||[]){const c=Number(l.peso)||0;if(l.tipo.toLowerCase().includes("examen")){r=c;continue}if(l.notas?.length){const d=l.notas.reduce((u,m)=>u+m,0)/l.notas.length;a+=d*(c/100)}}return r===0?null:+((n-a)/(r/100)).toFixed(2)}function ps(e){const n=(e.scale||"USM")==="MAYOR"?4:55;return e.promedio>=n}function vs(e){const n=(e.scale||"USM")==="MAYOR"?4:55;return+Math.max(0,n-(e.promedio||0)).toFixed(2)}async function hs(e){if(!i.currentUser)return{best:null,worst:null};const t=x(h,"users",i.currentUser.uid,"semesters",e,"courses"),n=await D(t),a=[];for(const r of n.docs){const s=await aa(r);a.push({id:r.id,name:r.data().name,promedio:s})}return a.length?(a.sort((r,s)=>(s.promedio||0)-(r.promedio||0)),{best:a[0],worst:a[a.length-1]}):{best:null,worst:null}}document.addEventListener("route:change",e=>{const t=e.detail?.route||"",n=document.getElementById("gr-courseSel");function a(){if(n)if(n.value="",n.querySelector('option[value=""]'))n.selectedIndex=0;else{const l=document.createElement("option");l.value="",l.textContent="Selecciona un ramo‚Ä¶",l.disabled=!0,l.selected=!0,n.insertBefore(l,n.firstChild),n.selectedIndex=0}window.currentCourseId=null,window.state&&(window.state.editingCourseId=null);const r=(l,c="‚Äî")=>{const d=document.getElementById(l);d&&(d.textContent=c)};r("gr-currentAvg"),r("gr-neededToPass"),r("gr-status");const s=document.getElementById("gr-evalsList");s&&(s.innerHTML='<div class="muted">Selecciona un ramo.</div>'),["gr-evalsCard","gr-calcCard","gr-summaryCard","gr-rulesCard"].forEach(l=>document.getElementById(l)?.classList.add("hidden"))}t!=="#/notas"&&a(),t==="#/notas"&&setTimeout(a,120)});const gs=Object.freeze(Object.defineProperty({__proto__:null,bestWorst:hs,calcBrecha:vs,calcNotaMinima:fs,calcPromedioSemestre:ms,clearGradesUI:Br,enableDnDForGrades:ta,findCourse:us,initGrades:_r,isPassing:ps,onActiveSemesterChanged:Fr,onCoursesChanged:Kn,registerGradesUnsub:Or,stopGradesSub:Rr},Symbol.toStringTag,{value:"Module"}));let xt="USM";function ra(){ys()}function sa(){Ss()}function ia(e){xt=e==="UMAYOR"?"MAYOR":"USM";const t=o("sectParLabel");t&&(t.textContent=e==="USM"?"Paralelo":"Secci√≥n/Paralelo");const n=o("courseScale"),a=n?.closest?.(".form-field");a&&a.classList.add("hidden"),n&&(n.value=xt,n.disabled=!0);const r=o("scaleHint");r&&(r.textContent=xt==="MAYOR"?"Escala: UMayor (1‚Äì7) ¬∑ tomada desde tu Perfil":"Escala: USM (0‚Äì100) ¬∑ tomada desde tu Perfil")}let Xe=null;function ys(){if(Xe&&(Xe(),Xe=null),!i.currentUser||!i.activeSemesterId){i.courses=[],document.dispatchEvent(new Event("courses:changed"));return}const e=x(h,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses");function t(n,a){let r;return(...s)=>{clearTimeout(r),r=setTimeout(()=>n(...s),a)}}Xe=O(e,t(n=>{const a=n.docs.map(r=>{const s=r.data()||{};return{id:r.id,...s,createdAtMs:s.createdAt instanceof xa?s.createdAt.toMillis():typeof s.createdAt=="number"?s.createdAt:0}});a.sort((r,s)=>s.createdAtMs-r.createdAtMs),i.courses=a,bs(n),Kn?.(),document.dispatchEvent(new Event("courses:changed"))},300))}function bs(e){const t=o("coursesList");t&&(t.innerHTML="",e.forEach(n=>{const a=n.data(),r=document.createElement("div");r.className="course-item",r.innerHTML=`
      <div>
        <div><b>${At(a.name||"Sin nombre")}</b> <span class="course-meta">¬∑ ${At(a.code||"")}</span></div>
        <div class="course-meta">${At(a.professor||"")}</div>
      </div>
      <div class="inline">
        <button class="ghost course-edit" data-id="${n.id}">Editar</button>
        <button class="danger course-del"  data-id="${n.id}">Eliminar</button>
      </div>
    `,t.appendChild(r)}))}function Ss(){i.editingCourseId=null;const e=o("courseName");e&&(e.value="");const t=o("courseCode");t&&(t.value="");const n=o("courseProfessor");n&&(n.value="");const a=o("courseSectPar");a&&(a.value="");const r=o("courseColor");r&&(r.value="#3B82F6");const s=o("courseColorCode");s&&(s.textContent="#3B82F6");const l=o("saveCourseBtn");l&&(l.textContent="Agregar ramo"),o("cancelEditBtn")?.classList.add("hidden")}function At(e){return String(e).replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}let ve=null,wn=!1;function Es(){wn||(wn=!0,ws())}function Cs(){ve&&(ve(),ve=null);const e=o("semestersList");e&&(e.innerHTML=""),Ue()}function ws(){const e=o("createSemesterBtn");e&&e.addEventListener("click",async()=>{if(!i.currentUser){alert("Debes iniciar sesi√≥n.");return}const t=xs();if(!t){alert("Completa tu universidad en Perfil.");return}const n=(o("semesterLabel")?.value||"").trim();if(!Ls(n)){alert("Formato de semestre inv√°lido. Usa AAAA-1 o AAAA-2 (ej. 2025-2).");return}const a=x(h,"users",i.currentUser.uid,"semesters");if(!(await D(V(a,xn("label","==",n)))).empty){alert("Ya existe un semestre con ese nombre.");return}const s=await Ie(a,{label:n,universityAtThatTime:t,createdAt:Date.now()});o("semesterLabel")&&(o("semesterLabel").value="");const l=i.activeSemesterId||null;l&&await ca(l,s.id)}),document.addEventListener("click",async t=>{const n=t.target;if(n instanceof HTMLElement){if(n.matches(".sem-activate")){if(!i.currentUser){alert("Debes iniciar sesi√≥n.");return}const a=n.dataset.id;await la(a)}if(n.matches(".sem-delete")){if(!i.currentUser){alert("Debes iniciar sesi√≥n.");return}const a=n.dataset.id;if(!confirm("¬øEliminar este semestre?"))return;await Q(E(h,"users",i.currentUser.uid,"semesters",a)),i.activeSemesterId===a&&Ue()}}})}async function oa(){if(ve&&(ve(),ve=null),!i.currentUser)return;const e=i.profileData?.university?.trim()||"",t=i.profileData?.career?.trim()||"",n=o("semestersList");if(!e||!t){n&&(n.innerHTML=`
        <div class="card" style="padding:20px; text-align:center;">
          <h3>‚ö†Ô∏è Antes de agregar semestres necesitas configurar tu perfil</h3>
          <p>Completa tu <b>universidad</b> y <b>carrera</b> para poder crear y visualizar semestres.</p>
          <button id="goToProfileBtn" class="btn-primary" style="margin-top:10px;">
            Ir a Perfil ahora ‚Üí
          </button>
        </div>
      `,o("goToProfileBtn")?.addEventListener("click",()=>{const c=o("subtabPerfil")||document.querySelector('[data-tab="perfil"]'),d=o("perfilContainer")||document.getElementById("perfilContainer");c&&d&&(document.querySelectorAll(".subtab").forEach(u=>u.classList.remove("active")),document.querySelectorAll(".page").forEach(u=>u.classList.add("hidden")),c.classList.add("active"),d.classList.remove("hidden"))}));return}const a=i.currentUser.uid,r=await j(E(h,"users",a)),s=r.exists()&&r.data()?.activeSemester||null;if(s){i.activeSemesterId=s;const c=await j(E(h,"users",a,"semesters",s));i.activeSemesterData=c.exists()?c.data():null}if(i.activeSemesterId&&i.activeSemesterData){console.log("[Semesters] Restaurando semestre activo tras recarga:",i.activeSemesterData.label);const c=o("coursesSection");c&&c.classList.remove("hidden");const d=da(i.activeSemesterData.universityAtThatTime);ia(d),sa(),ra();const u=o("activeSemesterLabel");u&&(u.textContent=i.activeSemesterData.label||"‚Äî");const m=o("activeSemesterUni");m&&(m.textContent=i.activeSemesterData.universityAtThatTime||"‚Äî");const f=o("gr-activeSemLabel");f&&(f.textContent=i.activeSemesterData.label||"‚Äî");const p=o("gr-scaleSel"),g=o("gr-passThreshold");p&&(p.value=d==="UMAYOR"?"MAYOR":"USM",p.disabled=!0),g&&(g.value=d==="UMAYOR"?4:55),bt(),Zt?.(),Z()}const l=x(h,"users",a,"semesters");ve=O(V(l,he("createdAt","desc")),c=>{const d=o("semestersList");if(!d)return;if(d.innerHTML="",c.empty){Ue();return}if(c.forEach(m=>{const f=m.data(),p=document.createElement("div");p.className="course-item";const g=i.activeSemesterId===m.id;p.innerHTML=`
        <div>
          <div><b>${f.label}</b> <span class="course-meta">¬∑ ${f.universityAtThatTime}</span></div>
        </div>
        <div class="inline">
          ${g?'<span class="course-meta">Activo</span>':`<button class="ghost sem-activate" data-id="${m.id}">Activar</button>`}
          <button class="danger sem-delete" data-id="${m.id}">Eliminar</button>
        </div>
      `,d.appendChild(p)}),c.docs.some(m=>m.id===i.activeSemesterId)||Ue(),!i.activeSemesterId&&!c.empty){const m=c.docs[0].id;console.log("[Semesters] No hab√≠a activo guardado, usando el m√°s reciente:",m),la(m)}})}async function ca(e,t){const n=i.currentUser?.uid;if(!(!n||!e||!t))try{const a=x(h,"users",n,"semesters",e,"calendar"),r=x(h,"users",n,"semesters",t,"calendar"),s=await D(a);let l=0;for(const c of s.docs){const d=c.data();d.persistent&&(await Ie(r,{...d,createdAt:Date.now()}),l++)}console.log(`üîÅ [Semesters] ${l} eventos persistentes copiados de ${e} a ${t}`)}catch(a){console.error("‚ùå Error copiando eventos persistentes:",a)}}async function la(e){if(!i.currentUser||!e)return;i.activeSemesterId=e;const t=await j(E(h,"users",i.currentUser.uid,"semesters",e));i.activeSemesterData=t.exists()?t.data():null,await K(E(h,"users",i.currentUser.uid),{activeSemester:e},{merge:!0}),i.lastActiveSemesterId&&i.lastActiveSemesterId!==e&&await ca(i.lastActiveSemesterId,e),i.lastActiveSemesterId=e;const n=o("activeSemesterLabel");n&&(n.textContent=i.activeSemesterData?.label||"‚Äî");const a=o("activeSemesterUni");a&&(a.textContent=i.activeSemesterData?.universityAtThatTime||"‚Äî");const r=o("gr-activeSemLabel");r&&(r.textContent=i.activeSemesterData?.label||"‚Äî");const s=da(i.activeSemesterData?.universityAtThatTime),l=o("gr-scaleSel"),c=o("gr-passThreshold");l&&(l.value=s==="UMAYOR"?"MAYOR":"USM",l.disabled=!0),c&&(c.value=s==="UMAYOR"?4:55);const d=o("coursesSection");d&&d.classList.remove("hidden"),ia(s),sa(),ra(),bt(),Zt?.(),Z(),oa()}function Ue(){i.activeSemesterId=null,i.activeSemesterData=null;const e=o("activeSemesterLabel");e&&(e.textContent="‚Äî");const t=o("activeSemesterUni");t&&(t.textContent="‚Äî");const n=o("coursesSection");n&&n.classList.add("hidden");const a=o("gr-activeSemLabel");a&&(a.textContent="‚Äî");const r=o("gr-scaleSel");r&&(r.value="USM",r.disabled=!0);const s=o("gr-passThreshold");s&&(s.value=""),bt(),Z()}function Ls(e){return/^\d{4}-(1|2)$/.test(e||"")}function xs(){const e=i.profileData;return!e||!e.university?null:e.university==="OTRA"?(e.customUniversity||"").trim()||null:e.university==="UMAYOR"?"Universidad Mayor":e.university==="USM"?"UTFSM":e.university}function da(e){if(!e)return"";const t=e.toLowerCase();return t.includes("mayor")?"UMAYOR":t.includes("utfsm")||t.includes("santa mar√≠a")||t.includes("santa maria")?"USM":"OTRA"}function Ln(e){document.querySelectorAll(".nav-tab[data-route]").forEach(t=>{t.dataset.route!=="#/perfil"&&(t.toggleAttribute("disabled",e),t.setAttribute("aria-disabled",String(e)))})}function As(){if(window.__duoplannerAuthInit)return;window.__duoplannerAuthInit=!0;const e=o("signInBtn"),t=o("signOutBtn"),n=o("switchAccountBtn"),a=o("userBadge"),r=o("userName"),s=d=>{e&&(e.disabled=d),t&&(t.disabled=d),n&&(n.disabled=d)},l=d=>{a&&(a.classList.remove("hidden"),a.style.display="inline-flex"),e&&(e.classList.add("hidden"),e.style.display="none"),r&&(r.textContent=d||"‚Äî");const u=o("createPairBtn"),m=o("copyInviteBtn");u&&(u.disabled=!1),m&&(m.disabled=!1),Ln(!1)},c=()=>{a&&(a.classList.add("hidden"),a.style.display="none"),e&&(e.classList.remove("hidden"),e.style.display="inline-block");const d=o("pairId"),u=o("copyInviteBtn"),m=o("createPairBtn");d&&(d.textContent="‚Äî"),u&&(u.disabled=!0),m&&(m.disabled=!0),i.profileData=null,st(),Ue();const f=o("semestersList");f&&(f.innerHTML=""),Ln(!0),location.hash="#/perfil"};e&&e.addEventListener("click",async()=>{s(!0);const d=new tn;d.setCustomParameters({prompt:"select_account"});try{await nn(Ee,d)}catch(u){const m=u?.code||"";m==="auth/popup-blocked"||(m==="auth/popup-closed-by-user"||m==="auth/cancelled-popup-request"||m==="auth/user-cancelled"?console.log("Login cancelado por el usuario."):alert(`No se pudo iniciar sesi√≥n: ${m||u.message||u}`))}finally{s(!1)}}),n&&n.addEventListener("click",async()=>{s(!0);const d=new tn;d.setCustomParameters({prompt:"select_account"});try{await an(Ee),await nn(Ee,d)}catch(u){const m=u?.code||"";m==="auth/popup-blocked"||(m==="auth/popup-closed-by-user"||m==="auth/cancelled-popup-request"||m==="auth/user-cancelled"?console.log("Cambio de cuenta cancelado por el usuario."):alert(`No se pudo cambiar de cuenta: ${m||u.message||u}`))}finally{s(!1)}}),t&&t.addEventListener("click",async()=>{s(!0);try{await an(Ee),i.currentUser=null,i.profileData=null,i.unsubscribeProfile?.(),i.unsubscribeProfile=null,Cs?.(),Ue(),In(),c(),Z()}catch(d){console.error(d),alert(`No se pudo cerrar sesi√≥n: ${d.code||d.message||d}`)}finally{s(!1)}}),Sa(Ee,async d=>{if(i.currentUser=d||null,s(!1),d){l(d.displayName||d.email||d.uid);try{await Ms(d)}catch(u){console.error("ensureUserDoc failed:",u)}try{Un(),st()}catch(u){console.error("profile listen failed:",u)}setTimeout(()=>{Oa().catch(u=>console.error("loadMyPair failed:",u))},800),setTimeout(()=>{oa().catch(u=>console.error("refreshSemestersSub failed:",u))},1500),setTimeout(()=>{ee(()=>Promise.resolve().then(()=>ka),void 0).then(u=>u.mountPartnerProfileCard?.()).catch(()=>{})},2500),Z()}else c(),Z()})}async function Ms(e){const t=E(h,"users",e.uid);(await j(t)).exists()?await K(t,{email:e.email||null,displayName:e.displayName||null,photoURL:e.photoURL||null,providerId:e.providerData?.[0]?.providerId||"google",lastLoginAt:Date.now()},{merge:!0}):await K(t,{createdAt:Date.now(),email:e.email||null,displayName:e.displayName||null,photoURL:e.photoURL||null,providerId:e.providerData?.[0]?.providerId||"google",preferences:{showNamesInShared:!0,theme:"dark"},lastLoginAt:Date.now()},{merge:!0})}let P={},Ot=[];function ua(e){const t=(e||"#/perfil").trim();return new Set(["#/perfil","#/semestres","#/horario","#/notas","#/malla","#/calendario","#/progreso","#/asistencia","#/party","#/ayuda"]).has(t)?t:"#/perfil"}function Us(e){const t=ua(e);location.hash!==t&&(location.hash=t),Rt(t)}function Rt(e){const t=ua(e),n=document.getElementById("pfActions");n&&n.classList.toggle("hidden",t!=="#/perfil"),Ot.forEach(a=>a.classList.toggle("active",a.dataset.route===t)),Object.values(P).forEach(a=>a&&a.classList.add("hidden")),t==="#/perfil"&&P.perfil&&P.perfil.classList.remove("hidden"),t==="#/semestres"&&P.semestres&&P.semestres.classList.remove("hidden"),t==="#/horario"&&P.horario&&P.horario.classList.remove("hidden"),t==="#/notas"&&P.notas&&(P.notas.classList.remove("hidden"),document.dispatchEvent(new Event("route:notas"))),t==="#/malla"&&P.malla&&P.malla.classList.remove("hidden"),t==="#/progreso"&&P.progreso&&P.progreso.classList.remove("hidden"),t==="#/calendario"&&P.calendario&&(P.calendario.classList.remove("hidden"),document.dispatchEvent(new Event("route:calendario"))),t==="#/asistencia"&&P.asistencia&&P.asistencia.classList.remove("hidden"),t==="#/party"&&P.party&&P.party.classList.remove("hidden"),t==="#/ayuda"&&P.ayuda&&P.ayuda.classList.remove("hidden"),document.dispatchEvent(new CustomEvent("route:change",{detail:{route:t}}))}function Is(){P={perfil:o("page-perfil"),semestres:o("page-semestres"),horario:o("page-horario"),notas:o("page-notas"),malla:o("page-malla"),calendario:o("page-calendario"),progreso:o("page-progreso"),asistencia:o("page-asistencia"),party:o("page-party"),ayuda:o("page-ayuda")},Ot=Array.from(document.querySelectorAll(".tab[data-route]"))||[],Ot.forEach(e=>e.addEventListener("click",()=>Us(e.dataset.route))),window.addEventListener("hashchange",()=>Rt(location.hash)),Rt(location.hash||"#/perfil")}async function $s(){const e=await fetch("data/medvet_malla.csv").then(n=>n.text()).catch(()=>""),t=await fetch("data/ictel_malla.csv").then(n=>n.text()).catch(()=>"");return{MEDVET:e?Ts(e):[],ICTEL:t?Ds(t):[]}}function ma(e){const t=e.trim().split(/\r?\n/).filter(Boolean);if(!t.length)return[];const n=t[0],a=n.split(";").length>=n.split(",").length?";":",",r=n.split(a).map(s=>s.trim().replace(/^['\"]|['\"]$/g,""));return t.slice(1).map(s=>{const l=s.split(a).map(d=>d.trim().replace(/^['\"]|['\"]$/g,"")),c={};return r.forEach((d,u)=>c[d]=l[u]??""),c})}function Ts(e){return ma(e).map(n=>{let a=n["C√≥digo Asignatura"]||n["Codigo Asignatura"]||"";return a.includes(".")&&(a=a.split(".")[0]),{codigo:a,nivel:(n.Nivel||"").trim()}})}function Ds(e){return ma(e).map(n=>{const a={};for(const[l,c]of Object.entries(n)){const d=l.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();a[d]=(c||"").trim()}const r=(...l)=>{for(const c of l){const d=c.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();if(d in a&&a[d])return a[d]}return""};let s=r("Sigla","C√≥digo","Codigo","C√≥digo Asignatura","Codigo Asignatura");return s||(s=r("C√≥digo Asignatura","Codigo Asignatura","C√≥digo","Codigo")),{codigo:s||"",nivel:(r("Nivel","Semestre")||"").toUpperCase()}})}function Ns(){const e=i.profileData?.university||"GEN",t=i.profileData?.career||"GEN";try{return JSON.parse(localStorage.getItem(`mallaAprobados:${e}:${t}`)||"[]")}catch{return[]}}function Mt(e,t){return t?e/t*100:0}function Ut(e){return`${(Math.round(e*10)/10).toFixed(1)}%`}let re=null,et=null;async function ks(){re=await $s(),document.addEventListener("profile:changed",ue),document.addEventListener("malla:updated",ue),document.addEventListener("courses:changed",ue),document.addEventListener("pair:ready",ue),document.addEventListener("route:change",e=>{e.detail?.route==="#/progreso"&&ue()})}async function ue(){const e=o("prog-combinado");if(!e)return;e.classList.remove("hidden"),e.innerHTML='<h3 style="margin:0 0 8px">Progreso combinado</h3><div class="muted">Conectando‚Ä¶</div>';const t=i.profileData?.career||null;if(!t||!re){e.innerHTML=`<h3 style="margin:0 0 8px">Progreso combinado</h3>
    <div class="muted">Completa tu perfil antes de ver el progreso. üå±</div>`;return}const n=re&&re[t]?re[t].length:0,a=Ns(),r=n?Mt(a.length,n):0;et&&(et(),et=null);const s=i.pairOtherUid||null;if(!s){e.innerHTML=`<h3 style="margin:0 0 8px">Progreso combinado</h3>
    <div class="muted">A√∫n no est√°s conectado a un d√∫o. Crea o √∫nete a una party. üë•</div>`;return}const l=E(h,"users",s,"malla","state");et=O(l,async c=>{const d=c.data()||{};let u=d.career||null;if((u==="UMAYOR"||u==="USM")&&(u=null),!u)try{const g=await j(E(h,"users",s));if(g.exists()){const b=g.data()||{};b.career&&(u=b.career)}}catch{}const m=Array.isArray(d.approved)?d.approved.length:0,f=u&&re&&re[u]?re[u].length:0,p=n+f?Mt(a.length+m,n+f):0;e.innerHTML=`
      <h3 style="margin:0 0 8px">üèÅ Progreso combinado</h3>
      <div style="font-weight:600; margin-bottom:4px">Juntos llevan ${Ut(p)}</div>
      <div class="progress-outer small"><div class="progress-inner" style="width:${p}%;"></div></div>
      <div class="muted" style="margin-top:6px">T√∫: ${Ut(r)} ¬∑ Duo: ${Ut(Mt(m,f))}</div>
    `},c=>{e.innerHTML='<div class="muted">Error al conectar con el progreso del d√∫o.</div>'})}(function(){const t="prog-inline-styles";if(document.getElementById(t))return;const n=document.createElement("style");n.id=t,n.textContent=`
    .progress-outer{background:rgba(255,255,255,.08); border:1px solid rgba(0,0,0,.25);
      border-radius:10px; height:14px; margin-top:8px; overflow:hidden}
    .progress-outer.small{height:10px}
    .progress-inner{height:100%; background:linear-gradient(90deg, var(--primary), var(--accent));}
  `,document.head.appendChild(n)})();document.addEventListener("route:change",e=>{e.detail?.route==="#/party"&&ue()});const Ps=Object.freeze(Object.defineProperty({__proto__:null,initProgreso:ks,refreshProgreso:ue},Symbol.toStringTag,{value:"Module"}));window.addEventListener("DOMContentLoaded",()=>{As(),Is(),Pa(),Es(),document.addEventListener("route:change",async e=>{const t=e.detail.route;t.startsWith("#/notas")?(await ee(()=>Promise.resolve().then(()=>gs),void 0)).initGrades?.():t.startsWith("#/malla")?(await ee(()=>import("./malla-Dr0Yn5af.js"),[])).initMallaOnRoute?.():t.startsWith("#/asistencia")?(await ee(()=>Promise.resolve().then(()=>Nr),void 0)).initAttendance?.():t.startsWith("#/horario")?(await ee(()=>Promise.resolve().then(()=>cr),void 0)).initSchedule?.():t.startsWith("#/calendario")?(await ee(()=>Promise.resolve().then(()=>Ar),void 0)).initCalendar?.():t.startsWith("#/progreso")&&(await ee(()=>Promise.resolve().then(()=>Ps),void 0)).initProgreso?.()})});export{o as $,h as d,i as s};
