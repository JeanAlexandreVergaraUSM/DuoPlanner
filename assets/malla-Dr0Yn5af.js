import{s as c,$ as m,d as O}from"./index-DSCYZpE_.js";import{doc as U,setDoc as J,onSnapshot as X,getDoc as Y}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";const F={MEDVET:"Medicina Veterinaria",ICTEL:"Ing. Civil Telemática"},K={UMAYOR:["MEDVET"],USM:["ICTEL"]};let C={},S="";const P=["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"],$=e=>P.indexOf(e);B();window.addEventListener("hashchange",B);document.addEventListener("profile:changed",()=>{if(location.hash!=="#/malla")return;const e=m("malla-host");if(!e)return;(async()=>{e.dataset.ready||(R(e),await D(),e.dataset.ready="1"),k?.(),c.shared?.malla?.enabled&&c.pairOtherUid?q():(S="",L())})()});document.addEventListener("pair:ready",()=>{Q()});async function B(){if(location.hash!=="#/malla")return;const e=m("malla-host");if(!e)return;e.dataset.ready||(R(e),await D(),e.dataset.ready="1"),k?.();const a=m("malla-view-partner");if(a&&(c.shared.malla.enabled=!!a.checked),!c.profileData){c.shared?.malla?.enabled&&c.pairOtherUid&&q();return}c.shared?.malla?.enabled&&c.pairOtherUid?q():(S="",L())}async function Q(){if(location.hash!=="#/malla")return;const e=m("malla-host");e&&(e.dataset.ready||(R(e),await D(),e.dataset.ready="1"),k?.(),c.shared?.malla?.enabled&&c.pairOtherUid?q():(w(!1),S="",c.profileData&&L()))}function A(){return!!(c.shared?.malla?.enabled&&c.pairOtherUid)}function w(e){const a=m("malla-wrapper");a&&(a.dataset.readonly=e?"1":"0",a.style.cursor=e?"not-allowed":"")}function R(e){e.innerHTML=`
    <div id="malla-wrapper" class="malla-wrapper">
      <div class="grid-header" style="display:none"></div>
      <div class="malla-grid"></div>
    </div>

    <div id="malla-info" style="display:none">
      <div id="malla-caption" class="muted" style="text-align:center;margin:6px 0 2px"></div>
      <div id="malla-percentage" class="percentage-display"></div>
      <div class="legend"></div>
    </div>
  `,e.addEventListener("click",a=>{const t=a.target.closest(".grid-item");t&&(A()||m("malla-wrapper")?.dataset.readonly==="1"||(t.classList.toggle("aprobado"),N(e),x(e),I(e)))})}async function D(){if(C.MEDVET&&C.ICTEL)return;const e=await fetch("/data/medvet_malla.csv").then(a=>a.text());C.MEDVET=j(e);try{const a=await fetch("/data/ictel_malla.csv").then(t=>t.text());C.ICTEL=Z(a)}catch{C.ICTEL=[]}}function j(e){const a=z(e),t=[1,16,36,43,45,51,54,55,56,58,60],l=[2,3,4,5,6,9,10,11,17,18,24,30,49],n=[12,19,25,31,37],i=[7,13,15,20,21,22,28,32,33,34,39,40,41,42,44,46,47,48,52,53],s=[8,14,26,38],p=[23,29],f=[27,35,50,57],u=a.map(r=>parseInt(r["Código Asignatura"],10)).filter(r=>![...t,...l,...n,...i,...s,...p,...f].includes(r));return a.map(r=>{let o=r["Código Asignatura"];o.includes(".")&&(o=o.split(".")[0]);const E=["Prerrequisito 01 (Código)","Prerrequisito 02 (Código)","Prerrequisito 03 (Código)"].map(y=>r[y]).filter(y=>y&&y.toLowerCase()!=="ingreso").map(y=>y.includes(".")?y.split(".")[0]:y),d=parseInt(o,10);let g="";return t.includes(d)?g="integrativa":l.includes(d)?g="formacion-basica":n.includes(d)?g="electiva":i.includes(d)?g="salud-animal":s.includes(d)?g="produccion-animal":p.includes(d)?g="medio-ambiente":f.includes(d)?g="salud-publica":u.includes(d)&&(g="transversal"),{codigo:o,sigla:"",numero:null,creditos:null,nombre:r.Asignatura,nivel:r.Nivel.trim(),prerrequisitos:E,area:g}})}function Z(e){const a=z(e),t=n=>{const i=parseInt((n||"").trim(),10);return Number.isFinite(i)&&i>=1&&i<=P.length?P[i-1]:String(n||"").toUpperCase()},l=(n,i)=>{const s=(n||"").split("-")[0].toUpperCase(),p=(i||"").toLowerCase();return s==="MAT"||s==="QUI"?"Ciencias Básicas":s==="FIS"?"Física":s==="ELO"?"Electrónica":s==="HCW"?"Inglés":s==="DEW"?"Deportes":s==="INF"?"Software":s==="TEL"?p.includes("red")?"Redes":(p.includes("telecom"),"Telecomunicaciones"):s==="IWN"?"Formación General":s==="IWG"?"Industrias":""};return a.map(n=>{const i={};for(const[v,b]of Object.entries(n)){const h=v.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();i[h]=(b||"").trim()}const s=(...v)=>{for(const b of v){const h=b.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();if(h in i&&i[h])return i[h]}return""},p=s("Número","Numero","Nº","N°","num","n"),f=parseInt(p,10)||null;let u=s("Sigla","Código","Codigo","Código Asignatura","Codigo Asignatura"),r=s("Código Asignatura","Codigo Asignatura","Código","Codigo","Sigla");u||(u=r),r||(r=u);const o=s("Asignatura","Nombre","Nombre Asignatura","Ramo"),E=t(s("Nivel","Semestre","Periodo","Período","Romano"));let d=s("Área","Area","Línea","Linea","Linea/Área","Linea Area");d||(d=l(u,o));const g=parseInt(s("Créditos","Creditos","SCT","Créditos SCT","Sct","Cred"),10)||0,y=Object.keys(i).filter(v=>v.startsWith("prerrequisito")).flatMap(v=>String(i[v]||"").replace(/\b(ingreso|sin|na|n\/a|none)\b/ig,"").split(/[^\w-]+/g).map(b=>b.trim()).filter(Boolean).filter(b=>b!=="0"&&b!=="-"));return{codigo:r,sigla:u,numero:f,creditos:g,nombre:o,nivel:E,prerrequisitos:y,area:d}})}function z(e){const a=e.trim().split(/\r?\n/).filter(Boolean),t=(s,p)=>s.split(p).length,l=a[0],n=t(l,";")>=t(l,",")?";":",",i=l.split(n).map(s=>s.trim().replace(/^["']|["']$/g,""));return a.slice(1).map(s=>{const p=s.split(n).map(u=>u.trim().replace(/^["']|["']$/g,"")),f={};return i.forEach((u,r)=>{f[u]=p[r]??""}),f})}function L(){const e=c.profileData?.university||"",a=c.profileData?.career||"",t=document.querySelector("#page-malla .grid-header"),l=document.querySelector("#page-malla .malla-grid"),n=m("malla-info"),i=m("malla-caption");if(w(!1),!e||!a||!(K[e]||[]).includes(a)){S="",t.style.display="none",l.innerHTML='<div class="muted">Completa tu <b>Universidad</b> y <b>Carrera</b> en <b>Perfil</b> para ver la malla.</div>',n.style.display="none";return}const s=`${e}:${a}`;if(s===S){I(document.getElementById("malla-wrapper"));return}S=s,i.textContent=`${ee(e)} · ${F[a]||a}`,G(a)}function ee(e){return e==="UMAYOR"?"Universidad Mayor":e==="USM"?"UTFSM":e||"—"}function G(e){const a=m("page-malla");a.dataset.career=e;const t=a.querySelector(".grid-header"),l=a.querySelector(".malla-grid"),n=m("malla-info");if(l.innerHTML="",!e){t.style.display="none",n.style.display="none";return}const i=C[e]||[];if(!i.length){l.innerHTML='<div class="muted">Malla en preparación.</div>',t.style.display="none",n.style.display="none";return}const s=Array.from(new Set(i.map(r=>r.nivel))).sort((r,o)=>$(r)-$(o)),p=Math.ceil(s.length/2);t.style.gridTemplateColumns=`repeat(${s.length}, 1fr)`,l.style.gridTemplateColumns=`repeat(${s.length}, 1fr)`,t.innerHTML="";for(let r=1;r<=p;r++){const o=document.createElement("div");o.className="year",o.dataset.year=String(r),o.title=`Marcar Año ${r}`,o.style.cursor="pointer",o.textContent=`Año ${r}`,o.style.gridColumn=`${(r-1)*2+1} / span 2`,t.appendChild(o)}s.forEach(r=>{const o=document.createElement("div");o.className="sem",o.dataset.sem=r,o.title=`Marcar semestre ${r}`,o.style.cursor="pointer",o.textContent=r,t.appendChild(o)}),t.style.display="grid",t.querySelectorAll(".year").forEach(r=>{r.addEventListener("click",()=>{A()||m("malla-wrapper")?.dataset.readonly==="1"||ae(parseInt(r.dataset.year,10))})}),t.querySelectorAll(".sem").forEach(r=>{r.addEventListener("click",()=>{A()||m("malla-wrapper")?.dataset.readonly==="1"||te(r.dataset.sem)})});const f=a.querySelector(".legend");e==="ICTEL"?f.innerHTML=`
      <span><span class="legend-color cb"></span>Ciencias Básicas</span>
      <span><span class="legend-color software"></span>Software</span>
      <span><span class="legend-color fisica"></span>Física</span>
      <span><span class="legend-color transversal"></span>Transversal e Integración</span>
      <span><span class="legend-color fg"></span>Formación General</span>
      <span><span class="legend-color deportes"></span>Deportes</span>
      <span><span class="legend-color redes"></span>Redes</span>
      <span><span class="legend-color ingles"></span>Inglés</span>
      <span><span class="legend-color electronica"></span>Electrónica</span>
      <span><span class="legend-color telecom"></span>Telecomunicaciones</span>
      <span><span class="legend-color industrias"></span>Industrias</span>
      <span><span class="legend-color complementarios"></span>Complementarios</span>
    `:f.innerHTML=`
      <span><span class="legend-color integrativa"></span>Formación Integrativa</span>
      <span><span class="legend-color salud-animal"></span>Formación Salud Animal</span>
      <span><span class="legend-color produccion-animal"></span>Formación Producción Animal</span>
      <span><span class="legend-color salud-publica"></span>Formación Salud Pública</span>
      <span><span class="legend-color medio-ambiente"></span>Formación Medio Ambiente</span>
      <span><span class="legend-color formacion-basica"></span>Formación Básica</span>
      <span><span class="legend-color electiva"></span>Formación Electiva</span>
    `,n.style.display="block";const u=new Map;if(i.forEach(r=>{r.numero!=null&&u.set(String(r.numero),r.area),r.codigo&&u.set(String(r.codigo),r.area),r.sigla&&u.set(String(r.sigla),r.area)}),l.innerHTML="",i.forEach(r=>{let o=$(r.nivel);o<0&&(o=0);const E=o+1,d=document.createElement("div");d.className="grid-item"+(r.area?" area-"+_(r.area):""),d.style.gridColumn=String(E),d.dataset.codigo=r.codigo,d.dataset.key=String(r.numero??r.codigo),d.dataset.prereqs=JSON.stringify(r.prerrequisitos),d.dataset.sem=r.nivel,d.dataset.year=String(Math.ceil(E/2));const g=document.createElement("div");if(g.className="top-bar",d.appendChild(g),r.sigla){const h=document.createElement("span");h.className="sigla-label",h.textContent=r.sigla,g.appendChild(h)}const y=document.createElement("span");y.className="code-label",y.textContent=r.numero??r.codigo,g.appendChild(y);const v=document.createElement("div");v.className="course-name",v.textContent=r.nombre,d.appendChild(v);const b=document.createElement("div");if(b.className="bottom-bar",d.appendChild(b),(r.prerrequisitos||[]).forEach((h,W)=>{const V=String(h),M=document.createElement("span");M.className="prereq-label",M.textContent=V,M.style.left=`${4+W*22}px`;const H=u.get(V);H&&M.classList.add("area-"+_(H)),b.appendChild(M)}),r.creditos){const h=document.createElement("span");h.className="credits-badge",h.textContent=r.creditos,b.appendChild(h)}l.appendChild(d)}),re(a,e),N(a),I(a),!A())try{x(a)}catch{}}function _(e){const t=(e||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[-_]+/g," ").replace(/\s+/g," ").trim();return t.includes("integrativ")?"integrativa":t.includes("formacion basica")?"formacion-basica":t.includes("electiva")?"electiva":t.includes("salud animal")?"salud-animal":t.includes("produccion animal")?"produccion-animal":t.includes("medio ambiente")?"medio-ambiente":t.includes("salud publica")?"salud-publica":t.includes("ciencias basicas")?"cb":t.includes("software")?"software":t.includes("fisica")?"fisica":t.includes("transversal")?"transversal":t.includes("formacion general")?"fg":t.includes("deporte")?"deportes":t.includes("redes")?"redes":t.includes("ingles")?"ingles":t.includes("electronica")?"electronica":t.includes("telecom")?"telecom":t.includes("industri")?"industrias":t.includes("complement")?"complementarios":"transversal"}function ae(e){const a=m("malla-wrapper");if(!a||A()||a.dataset.readonly==="1")return;const t=a.querySelectorAll(`.grid-item[data-year="${e}"]`),l=Array.from(t).every(n=>n.classList.contains("aprobado"));t.forEach(n=>n.classList.toggle("aprobado",!l)),N(a),x(a),I(a)}function te(e){const a=m("malla-wrapper");if(!a||A()||a.dataset.readonly==="1")return;const t=a.querySelectorAll(`.grid-item[data-sem="${e}"]`),l=Array.from(t).every(n=>n.classList.contains("aprobado"));t.forEach(n=>n.classList.toggle("aprobado",!l)),N(a),x(a),I(a)}function N(e){const a=e.querySelectorAll(".grid-item"),t=document.getElementById("page-malla")?.dataset.career||"";let l=!0;if(t==="MEDVET"){const i=Array.from(a).filter(s=>{const p=parseInt(s.dataset.year||"0",10);return Number.isFinite(p)&&p>=1&&p<=4});l=i.length>0&&i.every(s=>s.classList.contains("aprobado"))}const n=i=>String(i||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");a.forEach(i=>{const p=JSON.parse(i.dataset.prereqs||"[]").every(r=>{const o=CSS.escape(String(r)),E=e.querySelector(`.grid-item[data-key="${o}"]`),d=e.querySelector(`.grid-item[data-codigo="${o}"]`),g=Array.from(e.querySelectorAll(".grid-item")).find(v=>v.querySelector(".sigla-label")?.textContent===String(r)),y=E||d||g;return y&&y.classList.contains("aprobado")});let f=!0;if(t==="MEDVET"){const r=n(i.querySelector(".course-name")?.textContent||"");r.includes("practica")&&r.includes("profesional")&&(f=l)}p&&f?i.classList.remove("bloqueado"):i.classList.add("bloqueado")})}async function x(e){const a=c.profileData?.university||"GEN",t=c.profileData?.career||"GEN",l=Array.from(e.querySelectorAll(".grid-item.aprobado")).map(n=>n.dataset.codigo);localStorage.setItem(`mallaAprobados:${a}:${t}`,JSON.stringify(l));try{document.dispatchEvent(new Event("malla:updated"))}catch{}if(c.currentUser){const n=U(O,"users",c.currentUser.uid,"malla","state");await J(n,{career:t,approved:l,updatedAt:Date.now()},{merge:!0});try{document.dispatchEvent(new Event("malla:updated"))}catch{}}}function re(e,a){const t=c.profileData?.university||"GEN";JSON.parse(localStorage.getItem(`mallaAprobados:${t}:${a}`)||"[]").forEach(n=>{const i=e.querySelector(`.grid-item[data-codigo="${CSS.escape(String(n))}"]`);i&&i.classList.add("aprobado")})}function I(e){const a=e.querySelectorAll(".grid-item").length,t=e.querySelectorAll(".grid-item.aprobado").length,l=a?(t/a*100).toFixed(1):"0.0";m("malla-percentage").textContent=`Total de ramos: ${l}%`}function k(){const e=m("malla-host");if(!e||m("malla-partner-toggle"))return;const a=document.createElement("div");a.id="malla-partner-toggle",a.className="row",a.style.margin="10px 0",a.innerHTML=`
    <label class="pill">
      <input type="checkbox" id="malla-view-partner" style="margin-right:8px"/>
      Ver malla de la otra persona
    </label>
  `,e.prepend(a);const t=m("malla-view-partner");t.checked=!!c.shared?.malla?.enabled,t.addEventListener("change",()=>{c.shared.malla.enabled=t.checked,L(),q()})}let T=null;function q(){if(T&&(T(),T=null),!document.getElementById("malla-wrapper"))return;if(!c.shared?.malla?.enabled||!c.pairOtherUid){w(!1),S="",c.profileData&&L();return}w(!0);const a=U(O,"users",c.pairOtherUid,"malla","state");T=X(a,async t=>{const l=t.data()||{};let n=l.career||null;const i=Array.isArray(l.approved)?l.approved:[];if((n==="UMAYOR"||n==="USM")&&(n=null),!n&&c.pairOtherUid)try{const f=await Y(U(O,"users",c.pairOtherUid));if(f.exists()){const u=f.data()||{};u?.career&&(n=u.career)}}catch{}n&&await ne(n);const s=m("malla-wrapper");if(!s)return;s.querySelectorAll(".grid-item.aprobado").forEach(f=>f.classList.remove("aprobado")),i.forEach(f=>{const u=s.querySelector(`.grid-item[data-codigo="${CSS.escape(String(f))}"]`);u&&u.classList.add("aprobado")}),N(s),I(s);const p=m("malla-caption");p&&n&&!p.textContent.includes("vista de la otra persona")&&(p.textContent=`${F[n]||n} · (vista de la otra persona)`)},t=>{w(!1),S="",c.profileData&&L()})}async function ne(e){const a=m("page-malla");if(!a)return;await D(),a.dataset.career=e,S=`FORCED:${e}`;const t=m("malla-caption");t.textContent=`${F[e]||e} · (vista de la otra persona)`,w(!0),G(e)}function ce(e){const a={};e.forEach(t=>{const l=t.codigo.trim(),n=(t.prerequisitos||"").split(/[,;]/).map(i=>i.trim()).filter(Boolean);a[l]=n}),c.malla={prereqMap:a,rows:e}}function de(e){const a=String(e||"").toUpperCase().trim();return window.MALLA_PREREQS&&window.MALLA_PREREQS[a]||[]}export{de as getPrereqs,ce as parseMalla};
