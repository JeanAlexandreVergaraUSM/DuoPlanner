import{$ as f,s as c,d as R}from"./index-DvfjAjSR.js";import{doc as P,onSnapshot as J,getDoc as X,setDoc as Y}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";const V={MEDVET:"Medicina Veterinaria",ICTEL:"Ing. Civil Telemática"},K={UMAYOR:["MEDVET"],USM:["ICTEL"]};let A={},E="";const k=["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"],F=e=>k.indexOf(e);$();window.addEventListener("hashchange",$);document.addEventListener("profile:changed",()=>{if(location.hash!=="#/malla")return;const e=f("malla-host");if(!e)return;(async()=>{var t,s;e.dataset.ready||(H(e),await O(),e.dataset.ready="1"),C==null||C(),(s=(t=c.shared)==null?void 0:t.malla)!=null&&s.enabled&&c.pairOtherUid?N():(E="",L())})()});document.addEventListener("pair:ready",()=>{Q()});async function $(){var t,s,l,o;if(location.hash!=="#/malla")return;const e=f("malla-host");if(!e)return;e.dataset.ready||(H(e),await O(),e.dataset.ready="1"),C==null||C();const a=f("malla-view-partner");if(a&&(c.shared.malla.enabled=!!a.checked),!c.profileData){(s=(t=c.shared)==null?void 0:t.malla)!=null&&s.enabled&&c.pairOtherUid&&N();return}(o=(l=c.shared)==null?void 0:l.malla)!=null&&o.enabled&&c.pairOtherUid?N():(E="",L())}async function Q(){var a,t;if(location.hash!=="#/malla")return;const e=f("malla-host");e&&(e.dataset.ready||(H(e),await O(),e.dataset.ready="1"),C==null||C(),(t=(a=c.shared)==null?void 0:a.malla)!=null&&t.enabled&&c.pairOtherUid?N():(I(!1),E="",c.profileData&&L()))}function w(){var e,a;return!!((a=(e=c.shared)==null?void 0:e.malla)!=null&&a.enabled&&c.pairOtherUid)}function I(e){const a=f("malla-wrapper");a&&(a.dataset.readonly=e?"1":"0",a.style.cursor=e?"not-allowed":"")}function H(e){e.innerHTML=`
    <div id="malla-wrapper" class="malla-wrapper">
      <div class="grid-header" style="display:none"></div>
      <div class="malla-grid"></div>
    </div>

    <div id="malla-info" style="display:none">
      <div id="malla-caption" class="muted" style="text-align:center;margin:6px 0 2px"></div>
      <div id="malla-percentage" class="percentage-display"></div>
      <div class="legend"></div>
    </div>
  `,e.addEventListener("click",a=>{var s;const t=a.target.closest(".grid-item");t&&(w()||((s=f("malla-wrapper"))==null?void 0:s.dataset.readonly)==="1"||(t.classList.toggle("aprobado"),D(e),U(e),M(e)))})}async function O(){if(A.MEDVET&&A.ICTEL)return;const e=await fetch("/DuoPlanner/data/medvet_malla.csv").then(a=>a.text());A.MEDVET=j(e);try{const a=await fetch("/DuoPlanner/data/ictel_malla.csv").then(t=>t.text());A.ICTEL=Z(a)}catch{A.ICTEL=[]}}function j(e){const a=G(e),t=[1,16,36,43,45,51,54,55,56,58,60],s=[2,3,4,5,6,9,10,11,17,18,24,30,49],l=[12,19,25,31,37],o=[7,13,15,20,21,22,28,32,33,34,39,40,41,42,44,46,47,48,52,53],r=[8,14,26,38],u=[23,29],p=[27,35,50,57],m=a.map(n=>parseInt(n["Código Asignatura"],10)).filter(n=>![...t,...s,...l,...o,...r,...u,...p].includes(n));return a.map(n=>{let i=n["Código Asignatura"];i.includes(".")&&(i=i.split(".")[0]);const S=["Prerrequisito 01 (Código)","Prerrequisito 02 (Código)","Prerrequisito 03 (Código)"].map(h=>n[h]).filter(h=>h&&h.toLowerCase()!=="ingreso").map(h=>h.includes(".")?h.split(".")[0]:h),d=parseInt(i,10);let g="";return t.includes(d)?g="integrativa":s.includes(d)?g="formacion-basica":l.includes(d)?g="electiva":o.includes(d)?g="salud-animal":r.includes(d)?g="produccion-animal":u.includes(d)?g="medio-ambiente":p.includes(d)?g="salud-publica":m.includes(d)&&(g="transversal"),{codigo:i,sigla:"",numero:null,creditos:null,nombre:n.Asignatura,nivel:n.Nivel.trim(),prerrequisitos:S,area:g}})}function Z(e){const a=G(e),t=l=>{const o=parseInt((l||"").trim(),10);return Number.isFinite(o)&&o>=1&&o<=k.length?k[o-1]:String(l||"").toUpperCase()},s=(l,o)=>{const r=(l||"").split("-")[0].toUpperCase(),u=(o||"").toLowerCase();return r==="MAT"||r==="QUI"?"Ciencias Básicas":r==="FIS"?"Física":r==="ELO"?"Electrónica":r==="HCW"?"Inglés":r==="DEW"?"Deportes":r==="INF"?"Software":r==="TEL"?u.includes("red")?"Redes":(u.includes("telecom"),"Telecomunicaciones"):r==="IWN"?"Formación General":r==="IWG"?"Industrias":""};return a.map(l=>{const o={};for(const[b,v]of Object.entries(l)){const y=b.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();o[y]=(v||"").trim()}const r=(...b)=>{for(const v of b){const y=v.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();if(y in o&&o[y])return o[y]}return""},u=r("Número","Numero","Nº","N°","num","n"),p=parseInt(u,10)||null;let m=r("Sigla","Código","Codigo","Código Asignatura","Codigo Asignatura"),n=r("Código Asignatura","Codigo Asignatura","Código","Codigo","Sigla");m||(m=n),n||(n=m);const i=r("Asignatura","Nombre","Nombre Asignatura","Ramo"),S=t(r("Nivel","Semestre","Periodo","Período","Romano"));let d=r("Área","Area","Línea","Linea","Linea/Área","Linea Area");d||(d=s(m,i));const g=parseInt(r("Créditos","Creditos","SCT","Créditos SCT","Sct","Cred"),10)||0,h=Object.keys(o).filter(b=>b.startsWith("prerrequisito")).flatMap(b=>String(o[b]||"").replace(/\b(ingreso|sin|na|n\/a|none)\b/ig,"").split(/[^\w-]+/g).map(v=>v.trim()).filter(Boolean).filter(v=>v!=="0"&&v!=="-"));return{codigo:n,sigla:m,numero:p,creditos:g,nombre:i,nivel:S,prerrequisitos:h,area:d}})}function G(e){const a=e.trim().split(/\r?\n/).filter(Boolean),t=(r,u)=>r.split(u).length,s=a[0],l=t(s,";")>=t(s,",")?";":",",o=s.split(l).map(r=>r.trim().replace(/^["']|["']$/g,""));return a.slice(1).map(r=>{const u=r.split(l).map(m=>m.trim().replace(/^["']|["']$/g,"")),p={};return o.forEach((m,n)=>{p[m]=u[n]??""}),p})}function L(){var u,p;const e=((u=c.profileData)==null?void 0:u.university)||"",a=((p=c.profileData)==null?void 0:p.career)||"",t=document.querySelector("#page-malla .grid-header"),s=document.querySelector("#page-malla .malla-grid"),l=f("malla-info"),o=f("malla-caption");if(I(!1),!e||!a||!(K[e]||[]).includes(a)){E="",t.style.display="none",s.innerHTML='<div class="muted">Completa tu <b>Universidad</b> y <b>Carrera</b> en <b>Perfil</b> para ver la malla.</div>',l.style.display="none";return}const r=`${e}:${a}`;if(r===E){M(document.getElementById("malla-wrapper"));return}E=r,o.textContent=`${ee(e)} · ${V[a]||a}`,W(a)}function ee(e){return e==="UMAYOR"?"Universidad Mayor":e==="USM"?"UTFSM":e||"—"}function W(e){const a=f("page-malla");a.dataset.career=e;const t=a.querySelector(".grid-header"),s=a.querySelector(".malla-grid"),l=f("malla-info");if(s.innerHTML="",!e){t.style.display="none",l.style.display="none";return}const o=A[e]||[];if(!o.length){s.innerHTML='<div class="muted">Malla en preparación.</div>',t.style.display="none",l.style.display="none";return}const r=Array.from(new Set(o.map(n=>n.nivel))).sort((n,i)=>F(n)-F(i)),u=Math.ceil(r.length/2);t.style.gridTemplateColumns=`repeat(${r.length}, 1fr)`,s.style.gridTemplateColumns=`repeat(${r.length}, 1fr)`,t.innerHTML="";for(let n=1;n<=u;n++){const i=document.createElement("div");i.className="year",i.dataset.year=String(n),i.title=`Marcar Año ${n}`,i.style.cursor="pointer",i.textContent=`Año ${n}`,i.style.gridColumn=`${(n-1)*2+1} / span 2`,t.appendChild(i)}r.forEach(n=>{const i=document.createElement("div");i.className="sem",i.dataset.sem=n,i.title=`Marcar semestre ${n}`,i.style.cursor="pointer",i.textContent=n,t.appendChild(i)}),t.style.display="grid",t.querySelectorAll(".year").forEach(n=>{n.addEventListener("click",()=>{var i;w()||((i=f("malla-wrapper"))==null?void 0:i.dataset.readonly)==="1"||ae(parseInt(n.dataset.year,10))})}),t.querySelectorAll(".sem").forEach(n=>{n.addEventListener("click",()=>{var i;w()||((i=f("malla-wrapper"))==null?void 0:i.dataset.readonly)==="1"||te(n.dataset.sem)})});const p=a.querySelector(".legend");e==="ICTEL"?p.innerHTML=`
      <span><span class="legend-color cb"></span>Ciencias Básicas</span>
      <span><span class="legend-color software"></span>Software</span>
      <span><span class="legend-color fisica"></span>Física</span>
      <span><span class="legend-color transversal"></span>Transversal e Integración</span>
      <span><span class="legend-color fg"></span>Formación General</span>
      <span><span class="legend-color deportes"></span>Deportes</span>
      <span><span class="legend-color redes"></span>Redes</span>
      <span><span class="legend-color ingles"></span>Inglés</span>
      <span><span class="legend-color electronica"></span>Electrónica</span>
      <span><span class="legend-color telecom"></span>Telecomunicaciones</span>
      <span><span class="legend-color industrias"></span>Industrias</span>
      <span><span class="legend-color complementarios"></span>Complementarios</span>
    `:p.innerHTML=`
      <span><span class="legend-color integrativa"></span>Formación Integrativa</span>
      <span><span class="legend-color salud-animal"></span>Formación Salud Animal</span>
      <span><span class="legend-color produccion-animal"></span>Formación Producción Animal</span>
      <span><span class="legend-color salud-publica"></span>Formación Salud Pública</span>
      <span><span class="legend-color medio-ambiente"></span>Formación Medio Ambiente</span>
      <span><span class="legend-color formacion-basica"></span>Formación Básica</span>
      <span><span class="legend-color electiva"></span>Formación Electiva</span>
    `,l.style.display="block";const m=new Map;if(o.forEach(n=>{n.numero!=null&&m.set(String(n.numero),n.area),n.codigo&&m.set(String(n.codigo),n.area),n.sigla&&m.set(String(n.sigla),n.area)}),s.innerHTML="",o.forEach(n=>{let i=F(n.nivel);i<0&&(i=0);const S=i+1,d=document.createElement("div");d.className="grid-item"+(n.area?" area-"+z(n.area):""),d.style.gridColumn=String(S),d.dataset.codigo=n.codigo,d.dataset.key=String(n.numero??n.codigo),d.dataset.prereqs=JSON.stringify(n.prerrequisitos),d.dataset.sem=n.nivel,d.dataset.year=String(Math.ceil(S/2));const g=document.createElement("div");if(g.className="top-bar",d.appendChild(g),n.sigla){const y=document.createElement("span");y.className="sigla-label",y.textContent=n.sigla,g.appendChild(y)}const h=document.createElement("span");h.className="code-label",h.textContent=n.numero??n.codigo,g.appendChild(h);const b=document.createElement("div");b.className="course-name",b.textContent=n.nombre,d.appendChild(b);const v=document.createElement("div");if(v.className="bottom-bar",d.appendChild(v),(n.prerrequisitos||[]).forEach((y,x)=>{const _=String(y),q=document.createElement("span");q.className="prereq-label",q.textContent=_,q.style.left=`${4+x*22}px`;const B=m.get(_);B&&q.classList.add("area-"+z(B)),v.appendChild(q)}),n.creditos){const y=document.createElement("span");y.className="credits-badge",y.textContent=n.creditos,v.appendChild(y)}s.appendChild(d)}),ne(a,e),D(a),M(a),!w())try{U(a)}catch{}}function z(e){const t=(e||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[-_]+/g," ").replace(/\s+/g," ").trim();return t.includes("integrativ")?"integrativa":t.includes("formacion basica")?"formacion-basica":t.includes("electiva")?"electiva":t.includes("salud animal")?"salud-animal":t.includes("produccion animal")?"produccion-animal":t.includes("medio ambiente")?"medio-ambiente":t.includes("salud publica")?"salud-publica":t.includes("ciencias basicas")?"cb":t.includes("software")?"software":t.includes("fisica")?"fisica":t.includes("transversal")?"transversal":t.includes("formacion general")?"fg":t.includes("deporte")?"deportes":t.includes("redes")?"redes":t.includes("ingles")?"ingles":t.includes("electronica")?"electronica":t.includes("telecom")?"telecom":t.includes("industri")?"industrias":t.includes("complement")?"complementarios":"transversal"}function ae(e){const a=f("malla-wrapper");if(!a||w()||a.dataset.readonly==="1")return;const t=a.querySelectorAll(`.grid-item[data-year="${e}"]`),s=Array.from(t).every(l=>l.classList.contains("aprobado"));t.forEach(l=>l.classList.toggle("aprobado",!s)),D(a),U(a),M(a)}function te(e){const a=f("malla-wrapper");if(!a||w()||a.dataset.readonly==="1")return;const t=a.querySelectorAll(`.grid-item[data-sem="${e}"]`),s=Array.from(t).every(l=>l.classList.contains("aprobado"));t.forEach(l=>l.classList.toggle("aprobado",!s)),D(a),U(a),M(a)}function D(e){var o;const a=e.querySelectorAll(".grid-item"),t=((o=document.getElementById("page-malla"))==null?void 0:o.dataset.career)||"";let s=!0;if(t==="MEDVET"){const r=Array.from(a).filter(u=>{const p=parseInt(u.dataset.year||"0",10);return Number.isFinite(p)&&p>=1&&p<=4});s=r.length>0&&r.every(u=>u.classList.contains("aprobado"))}const l=r=>String(r||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");a.forEach(r=>{var i;const p=JSON.parse(r.dataset.prereqs||"[]").every(S=>{const d=CSS.escape(String(S)),g=e.querySelector(`.grid-item[data-key="${d}"]`),h=e.querySelector(`.grid-item[data-codigo="${d}"]`),b=Array.from(e.querySelectorAll(".grid-item")).find(y=>{var x;return((x=y.querySelector(".sigla-label"))==null?void 0:x.textContent)===String(S)}),v=g||h||b;return v&&v.classList.contains("aprobado")});let m=!0;if(t==="MEDVET"){const S=l(((i=r.querySelector(".course-name"))==null?void 0:i.textContent)||"");S.includes("practica")&&S.includes("profesional")&&(m=s)}p&&m?r.classList.remove("bloqueado"):r.classList.add("bloqueado")})}async function U(e){var l,o;const a=((l=c.profileData)==null?void 0:l.university)||"GEN",t=((o=c.profileData)==null?void 0:o.career)||"GEN",s=Array.from(e.querySelectorAll(".grid-item.aprobado")).map(r=>r.dataset.codigo);localStorage.setItem(`mallaAprobados:${a}:${t}`,JSON.stringify(s));try{document.dispatchEvent(new Event("malla:updated"))}catch{}if(c.currentUser){const r=P(R,"users",c.currentUser.uid,"malla","state");await Y(r,{career:t,approved:s,updatedAt:Date.now()},{merge:!0});try{document.dispatchEvent(new Event("malla:updated"))}catch{}}}function ne(e,a){var l;const t=((l=c.profileData)==null?void 0:l.university)||"GEN";JSON.parse(localStorage.getItem(`mallaAprobados:${t}:${a}`)||"[]").forEach(o=>{const r=e.querySelector(`.grid-item[data-codigo="${CSS.escape(String(o))}"]`);r&&r.classList.add("aprobado")})}function M(e){const a=e.querySelectorAll(".grid-item").length,t=e.querySelectorAll(".grid-item.aprobado").length,s=a?(t/a*100).toFixed(1):"0.0";f("malla-percentage").textContent=`Total de ramos: ${s}%`}function C(){var s,l;const e=f("malla-host");if(!e||f("malla-partner-toggle"))return;const a=document.createElement("div");a.id="malla-partner-toggle",a.className="row",a.style.margin="10px 0",a.innerHTML=`
    <label class="pill">
      <input type="checkbox" id="malla-view-partner" style="margin-right:8px"/>
      Ver malla de la otra persona
    </label>
  `,e.prepend(a);const t=f("malla-view-partner");t.checked=!!((l=(s=c.shared)==null?void 0:s.malla)!=null&&l.enabled),t.addEventListener("change",()=>{c.shared.malla.enabled=t.checked,L(),N()})}let T=null;function N(){var t,s;if(T&&(T(),T=null),!document.getElementById("malla-wrapper"))return;if(!((s=(t=c.shared)==null?void 0:t.malla)!=null&&s.enabled)||!c.pairOtherUid){I(!1),E="",c.profileData&&L();return}I(!0);const a=P(R,"users",c.pairOtherUid,"malla","state");T=J(a,async l=>{const o=l.data()||{};let r=o.career||null;const u=Array.isArray(o.approved)?o.approved:[];if((r==="UMAYOR"||r==="USM")&&(r=null),!r&&c.pairOtherUid)try{const n=await X(P(R,"users",c.pairOtherUid));if(n.exists()){const i=n.data()||{};i!=null&&i.career&&(r=i.career)}}catch{}r&&await re(r);const p=f("malla-wrapper");if(!p)return;p.querySelectorAll(".grid-item.aprobado").forEach(n=>n.classList.remove("aprobado")),u.forEach(n=>{const i=p.querySelector(`.grid-item[data-codigo="${CSS.escape(String(n))}"]`);i&&i.classList.add("aprobado")}),D(p),M(p);const m=f("malla-caption");m&&r&&!m.textContent.includes("vista de la otra persona")&&(m.textContent=`${V[r]||r} · (vista de la otra persona)`)},l=>{I(!1),E="",c.profileData&&L()})}async function re(e){const a=f("page-malla");if(!a)return;await O(),a.dataset.career=e,E=`FORCED:${e}`;const t=f("malla-caption");t.textContent=`${V[e]||e} · (vista de la otra persona)`,I(!0),W(e)}function ce(e){const a={};e.forEach(t=>{const s=t.codigo.trim(),l=(t.prerequisitos||"").split(/[,;]/).map(o=>o.trim()).filter(Boolean);a[s]=l}),c.malla={prereqMap:a,rows:e}}function de(e){const a=String(e||"").toUpperCase().trim();return window.MALLA_PREREQS&&window.MALLA_PREREQS[a]||[]}document.addEventListener("auth:ready",()=>{setTimeout(()=>{console.log("[malla] auth:ready → initMallaOnRoute()"),$()},1e3)});document.addEventListener("semester:changed",()=>{console.log("[malla] semester:changed → initMallaOnRoute()"),$()});document.addEventListener("profile:ready",()=>{console.log("[malla] profile:ready → renderFromProfile()"),L()});export{de as getPrereqs,$ as initMallaOnRoute,ce as parseMalla};
