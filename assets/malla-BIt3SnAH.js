import{s as g,$ as C,d as $}from"./index-zTbFN562.js";import{doc as R,deleteDoc as $e,getDoc as Pe,getDocs as De,collection as _e,onSnapshot as Ve,setDoc as ne}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import"https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/+esm";import"https://cdn.jsdelivr.net/npm/jspdf@2.5.1/+esm";window.state=g;const be=new Map;function ve(e,a="{}"){try{return JSON.parse(localStorage.getItem(e)||a)}catch{return JSON.parse(a)}}function he(e,a){localStorage.setItem(e,JSON.stringify(a))}let ce=0;function Ge(){ce++,queueMicrotask(()=>{ce=Math.max(0,ce-1)})}function Je(e,a=1){const t=Number(e);return Number.isFinite(t)&&t>0?t:a}function me(){var d;const e=((d=g.currentUser)==null?void 0:d.uid)||"anon",a=`custom_mallas_${e}`,t="custom_mallas_anon",s=ve(a,"{}"),o=ve(t,"{}"),c=Object.keys(s).length===0,n=Object.keys(o).length>0;return e!=="anon"&&c&&n?(he(a,o),localStorage.removeItem(t),{data:o,key:a,migrated:!0}):{data:s,key:a,migrated:!1}}function oe(e){var n;const t=`custom_mallas_${((n=g.currentUser)==null?void 0:n.uid)||"anon"}`,s="custom_mallas_anon",o=ve(t,"{}"),c=e(o)||o;return he(t,c),he(s,c),c}async function Ee(e,a){var s;const t=(s=g.currentUser)==null?void 0:s.uid;if(t)try{await ne(R($,"users",t),{ultima_malla_seleccionada:e||null,ultima_malla_es_custom:!!a},{merge:!0})}catch(o){console.warn("[malla] No se pudo sincronizar ultima_malla_seleccionada",o)}}console.groupCollapsed("%c[MALLA INIT]","color:#6cf;font-weight:bold;");console.log("‚Üí Archivo malla.js cargado");console.log("state:",g);console.log("location.hash:",location.hash);console.groupEnd();window.__DEBUG_MALLA=!0;function k(...e){window.__DEBUG_MALLA&&console.log("[malla]",...e)}window.logMalla=k;const de={MEDVET:"Medicina Veterinaria",ICTEL:"Ing. Civil Telem√°tica"},Ne={UMAYOR:["MEDVET"],USM:["ICTEL"]};let Y=null,ee=null;document.addEventListener("profile:ready",()=>{var e,a;Y=((e=g.profileData)==null?void 0:e.university)||"",ee=((a=g.profileData)==null?void 0:a.career)||""});document.addEventListener("profile:changed",async()=>{var o,c;const e=((o=g.profileData)==null?void 0:o.university)||"",a=((c=g.profileData)==null?void 0:c.career)||"";Y&&ee&&(e!==Y||a!==ee)&&(console.log("[malla] profile:changed ‚Üí carrera/universidad cambiada",{from:{uni:Y,career:ee},to:{uni:e,career:a}}),await Ye(Y,ee),localStorage.removeItem("ultima_malla_seleccionada"),T=""),Y=e,ee=a});let ae={},T="",D=!1;const J=()=>D===!0,H=["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"],ye=e=>H.indexOf(e);pe();window.addEventListener("hashchange",pe);document.addEventListener("profile:ready",()=>{if(J())return;const e=document.getElementById("page-malla");if((e==null?void 0:e.dataset.custom)==="true"){B();return}const a=document.getElementById("malla-selector"),t=localStorage.getItem("ultima_malla_seleccionada"),s=a&&Array.from(a.options).find(o=>o.value===t);if(s&&s.dataset.oficial!=="1"){V(t);return}P()});document.addEventListener("profile:changed",()=>{if(J())return;const e=document.getElementById("page-malla");if(location.hash==="#/malla"){if((e==null?void 0:e.dataset.custom)==="true"){B();return}P()}});async function pe(){var t,s;if(location.hash!=="#/malla")return;g.profileData||(console.log("[malla] Esperando profileData‚Ä¶"),await new Promise(o=>{const c=()=>{document.removeEventListener("profile:ready",c),o()};document.addEventListener("profile:ready",c)}));const e=C("malla-host");if(!e)return;e.dataset.ready||(await Me(),Ce(e),e.dataset.ready="1"),await se(),B(),re==null||re();const a=C("malla-view-partner");a&&(g.shared.malla.enabled=a.checked),(s=(t=g.shared)==null?void 0:t.malla)!=null&&s.enabled&&g.pairOtherUid?ue():P()}async function je(){var a,t;if(location.hash!=="#/malla")return;const e=C("malla-host");e&&(e.dataset.ready||(Ce(e),await Me(),e.dataset.ready="1"),re==null||re(),(t=(a=g.shared)==null?void 0:a.malla)!=null&&t.enabled&&g.pairOtherUid?ue():(O(!1),T="",g.profileData&&P()))}function Se(e){const a=document.querySelector("#page-malla .legend");if(!a)return;const t=(Array.isArray(e)?e:[]).filter(s=>s&&(s.nombre||"").trim());a.innerHTML=t.map(s=>`
    <span>
      <span class="legend-color" style="background:${s.color||"#888"}"></span>
      ${s.nombre}
    </span>
  `).join("")}function te(){var e,a;return!!((a=(e=g.shared)==null?void 0:e.malla)!=null&&a.enabled&&g.pairOtherUid)}function O(e){const a=C("malla-wrapper");a&&(a.dataset.readonly=e?"1":"0",a.style.cursor=e?"not-allowed":"")}const we=new WeakSet;function Ce(e){we.has(e)||(we.add(e),console.log("[DEBUG] buildShell construido en el host"),e.innerHTML=`
    <div id="malla-wrapper" class="malla-wrapper">
      <div class="grid-header" style="display:none"></div>
      <div class="malla-grid"></div>
    </div>

    <div id="malla-info" style="display:none">
      <div id="malla-caption" class="muted" style="text-align:center;margin:6px 0 2px"></div>
      <div id="malla-percentage" class="percentage-display"></div>
      <div class="legend"></div>
    </div>
  `,e.addEventListener("click",a=>{if(a.target.closest("#malla-partner-toggle"))return;const t=a.target.closest(".grid-item");if(!t)return;if(Ge(),a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation&&a.stopImmediatePropagation(),console.log("--- CLICK DETECTADO ---"),console.log("Elemento clickeado:",a.target),!t){console.warn("‚ùå El click no fue sobre un .grid-item (o pointer-events:none lo bloque√≥)");return}console.log("‚úÖ Item encontrado:",t.dataset.codigo||t.querySelector(".course-name").textContent);const s=document.getElementById("malla-wrapper");if((s==null?void 0:s.dataset.readonly)==="1"){console.log("‚õî Bloqueado: El wrapper est√° en modo readonly");return}const o=document.getElementById("page-malla"),c=(o==null?void 0:o.dataset.custom)==="true";if(console.log("Es malla custom?",c),c&&typeof D<"u"&&D){console.log("‚ö†Ô∏è Estamos en modo edici√≥n, abriendo modal (no tachando)");return}if(console.log('üîÑ Ejecutando toggle de clase "aprobado"...'),t.classList.toggle("aprobado"),console.log("Clases actuales:",t.className),console.log("üîÑ Actualizando dependencias y porcentaje..."),X(s),G(s),c){const n=localStorage.getItem("ultima_malla_seleccionada")||"CUSTOM";Ie(s,n),setTimeout(()=>{He(s,n),X(s),G(s)},0)}else ge(s)}))}async function Me(){if(ae.MEDVET&&ae.ICTEL)return;const e=await fetch("/DuoPlanner/data/medvet_malla.csv").then(a=>a.text());ae.MEDVET=Ke(e);try{const a=await fetch("/DuoPlanner/data/ictel_malla.csv").then(t=>t.text());ae.ICTEL=We(a)}catch{ae.ICTEL=[]}}function Ke(e){const a=ke(e),t=[1,16,36,43,45,51,54,55,56,58,60],s=[2,3,4,5,6,9,10,11,17,18,24,30,49],o=[12,19,25,31,37],c=[7,13,15,20,21,22,28,32,33,34,39,40,41,42,44,46,47,48,52,53],n=[8,14,26,38],d=[23,29],i=[27,35,50,57],u=a.map(r=>parseInt(r["C√≥digo Asignatura"],10)).filter(r=>![...t,...s,...o,...c,...n,...d,...i].includes(r));return a.map(r=>{let l=r["C√≥digo Asignatura"];l.includes(".")&&(l=l.split(".")[0]);const m=["Prerrequisito 01 (C√≥digo)","Prerrequisito 02 (C√≥digo)","Prerrequisito 03 (C√≥digo)"].map(E=>r[E]).filter(E=>E&&E.toLowerCase()!=="ingreso").map(E=>E.includes(".")?E.split(".")[0]:E),f=parseInt(l,10);let p="";return t.includes(f)?p="integrativa":s.includes(f)?p="formacion-basica":o.includes(f)?p="electiva":c.includes(f)?p="salud-animal":n.includes(f)?p="produccion-animal":d.includes(f)?p="medio-ambiente":i.includes(f)?p="salud-publica":u.includes(f)&&(p="transversal"),{codigo:l,sigla:"",numero:null,creditos:null,nombre:r.Asignatura,nivel:r.Nivel.trim(),prerrequisitos:m,area:p}})}function We(e){const a=ke(e),t=o=>{const c=parseInt((o||"").trim(),10);return Number.isFinite(c)&&c>=1&&c<=H.length?H[c-1]:String(o||"").toUpperCase()},s=(o,c)=>{const n=(o||"").split("-")[0].toUpperCase(),d=(c||"").toLowerCase();return n==="MAT"||n==="QUI"?"Ciencias B√°sicas":n==="FIS"?"F√≠sica":n==="ELO"?"Electr√≥nica":n==="HCW"?"Ingl√©s":n==="DEW"?"Deportes":n==="INF"?"Software":n==="TEL"?d.includes("red")?"Redes":(d.includes("telecom"),"Telecomunicaciones"):n==="IWN"?"Formaci√≥n General":n==="IWG"?"Industrias":""};return a.map(o=>{const c={};for(const[h,I]of Object.entries(o)){const y=h.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();c[y]=(I||"").trim()}const n=(...h)=>{for(const I of h){const y=I.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();if(y in c&&c[y])return c[y]}return""},d=n("N√∫mero","Numero","N¬∫","N¬∞","num","n"),i=parseInt(d,10)||null;let u=n("Sigla","C√≥digo","Codigo","C√≥digo Asignatura","Codigo Asignatura"),r=n("C√≥digo Asignatura","Codigo Asignatura","C√≥digo","Codigo","Sigla");u||(u=r),r||(r=u);const l=n("Asignatura","Nombre","Nombre Asignatura","Ramo"),m=t(n("Nivel","Semestre","Periodo","Per√≠odo","Romano"));let f=n("√Årea","Area","L√≠nea","Linea","Linea/√Årea","Linea Area");f||(f=s(u,l));const p=parseInt(n("Cr√©ditos","Creditos","SCT","Cr√©ditos SCT","Sct","Cred"),10)||0,E=Object.keys(c).filter(h=>h.startsWith("prerrequisito")).flatMap(h=>String(c[h]||"").replace(/\b(ingreso|sin|na|n\/a|none)\b/ig,"").split(/[^\w-]+/g).map(I=>I.trim()).filter(Boolean).filter(I=>I!=="0"&&I!=="-"));return{codigo:r,sigla:u,numero:i,creditos:p,nombre:l,nivel:m,prerrequisitos:E,area:f}})}function ke(e){const a=e.trim().split(/\r?\n/).filter(Boolean),t=(n,d)=>n.split(d).length,s=a[0],o=t(s,";")>=t(s,",")?";":",",c=s.split(o).map(n=>n.trim().replace(/^["']|["']$/g,""));return a.slice(1).map(n=>{const d=n.split(o).map(u=>u.trim().replace(/^["']|["']$/g,"")),i={};return c.forEach((u,r)=>{i[u]=d[r]??""}),i})}function P(){var u,r;k("renderFromProfile()",g.profileData);const e=document.getElementById("page-malla");if(!e){k("renderFromProfile() abortado: #page-malla a√∫n no existe");return}if(e.dataset.custom==="true"){k("renderFromProfile() cancelado: vista personalizada activa");return}const a=((u=g.profileData)==null?void 0:u.university)||"",t=((r=g.profileData)==null?void 0:r.career)||"",s=e.querySelector(".grid-header"),o=e.querySelector(".malla-grid"),c=C("malla-info"),n=C("malla-caption");if(!s||!o||!c||!n){k("renderFromProfile() abortado: shell de malla a√∫n no construido");return}if(O(!1),!a||!t){T="",s.style.display="none",c.style.display="none",o.innerHTML='<div class="muted">Completa tu <b>Universidad</b> y <b>Carrera</b> en <b>Perfil</b> para ver la malla.</div>';return}if(!(Ne[a]||[]).includes(t)){T="",s.style.display="none",c.style.display="none";const l=de[t]||t,m=xe(a);o.innerHTML=`
      <div style="
          grid-column: 1 / -1; 
          display: flex; 
          flex-direction: column; 
          align-items: center; 
          text-align: center; 
          padding: 40px 20px; 
          color: var(--muted);
          min-height: 300px;
          justify-content: center;
      ">
        <div style="font-size: 3rem; margin-bottom: 16px;">üìÇ</div>
        
        <h3 style="color: #fff; margin-bottom: 10px; font-size: 1.4rem;">
          No hay malla oficial para esta carrera
        </h3>
        
        <p style="font-size: 1rem; margin-bottom: 24px; max-width: 500px; line-height: 1.5;">
          La carrera <strong style="color:var(--ink)">${l}</strong> en 
          <strong style="color:var(--ink)">${m}</strong> no tiene una estructura precargada.
        </p>
        
        <div style="
            background: rgba(99, 102, 241, 0.1); 
            border: 1px solid rgba(99, 102, 241, 0.3); 
            border-radius: 12px; 
            padding: 12px 20px;
        ">
          <p style="margin: 0; font-size: 0.9rem; color: #e0e7ff;">
            Usa el bot√≥n <b style="color: #a78bfa;">+ Crear Malla</b> (arriba a la derecha) <br>
            para crear tu propia malla personalizada.
          </p>
        </div>
      </div>
    `,n.textContent=`${m} ¬∑ ${l}`;return}const i=`${a}:${t}`;if(i===T){G(document.getElementById("malla-wrapper"));return}T=i,n.textContent=`${xe(a)} ¬∑ ${de[t]||t}`,k("renderFromProfile() renderizando oficial...",g.profileData),ie(t)}async function se(){var h,I;const e=document.querySelector("#page-malla");if(!e)return;const a="malla-selector-container";let t=document.getElementById(a);t&&t.remove();const s=((h=g.profileData)==null?void 0:h.university)||"",o=((I=g.profileData)==null?void 0:I.career)||"";if(!s||!o)return;const{data:c}=me(),n=`${L(s)}:${L(o)}`;let d=c[n]||[];d=d.filter(y=>(y==null?void 0:y.nombre)&&y.nombre.trim()!=="");const i=(Ne[s]||[]).includes(o),u=[];i&&u.push({nombre:`${de[o]} (Oficial)`,oficial:!0}),u.push(...d),t=document.createElement("div"),t.id=a,t.className="card",t.style="padding:10px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;gap:8px;",t.innerHTML=`
    <div>
      <label><b>Malla:</b></label>
      <select id="malla-selector" style="margin-left:8px;padding:4px;">
  ${u.length?u.map(y=>`
        <option value="${y.nombre}" ${y.oficial?'data-oficial="1"':""}>
          ${y.nombre}
        </option>`).join(""):"<option disabled selected>‚Äî No hay mallas disponibles ‚Äî</option>"}
</select>

    </div>
    <div>
      <button id="btnCrearMalla" class="btn violet">+ Crear Malla</button>
      ${d.length?`
        <button id="btnEditarMalla" class="btn violet-outline">Editar</button>
        <button id="btnEliminarMalla" class="btn red">Borrar</button>
      `:""}
    </div>
  `,e.prepend(t);const r=C("malla-selector"),l=C("btnCrearMalla"),m=C("btnEditarMalla"),f=C("btnEliminarMalla");let p=null;const E=localStorage.getItem("ultima_malla_seleccionada");if(r){if(E){const y=Array.from(r.options).find(q=>q.value===E);y&&(p=y)}!p&&r.options.length>0&&(p=r.options[0])}if(p&&r){r.value=p.value;const y=p.dataset.oficial==="1";y?ie(o):V(p.value),localStorage.setItem("ultima_malla_seleccionada",p.value),Ee(p.value,!y)}r==null||r.addEventListener("change",y=>{const q=y.target.value,A=r.selectedOptions[0],M=(A==null?void 0:A.dataset.oficial)==="1";if(te()){const w=C("malla-view-partner");w&&(w.checked=!1),g.shared.malla.enabled=!1,W&&(W(),W=null),O(!1)}localStorage.setItem("ultima_malla_seleccionada",q),Ee(q,!M),M?ie(o):V(q)}),l==null||l.addEventListener("click",()=>qe()),m==null||m.addEventListener("click",()=>{const y=r==null?void 0:r.value;y&&qe(y)}),f==null||f.addEventListener("click",async()=>{var w,b,v;const y=(r==null?void 0:r.value)||((v=(b=(w=r==null?void 0:r.selectedOptions)==null?void 0:w[0])==null?void 0:b.textContent)==null?void 0:v.trim());if(!y||y.includes("(Oficial)"))return alert("Selecciona una malla personalizada para borrar.");if(!confirm(`¬øSeguro que deseas borrar "${y}"?`))return;const q=d.findIndex(S=>S.nombre===y);q>=0&&d.splice(q,1),oe(S=>{const x=S||{};return x[n]=d,x});try{const S=R($,"users",g.currentUser.uid,"customMallas",y);await $e(S)}catch{}alert(`Malla "${y}" eliminada correctamente.`);const A=document.getElementById("page-malla");A&&(A.removeAttribute("data-custom"),A.removeAttribute("data-career"));const M=document.getElementById("malla-topbar");M&&M.remove(),D=!1,T="",localStorage.removeItem("ultima_malla_seleccionada"),se(),P()}),document.dispatchEvent(new Event("malla:selector-ready"))}async function qe(e=null){var h,I,y,q;const a=((h=g.currentUser)==null?void 0:h.uid)||"anon",t=((I=g.profileData)==null?void 0:I.university)||"",s=((y=g.profileData)==null?void 0:y.career)||"",o=`${L(t)}:${L(s)}`,{data:c}=me(),d=(c[o]||[]).find(A=>A.nombre===e);let i=document.getElementById("mallaModal");i&&i.remove(),i=document.createElement("div"),i.id="mallaModal",i.className="modal-overlay",i.innerHTML=`
  <div class="crear-malla-modal">
    <h2 class="modal-title">${e?"Editar Malla":"Crear Nueva Malla"}</h2>
    <div class="modal-body">
      <label>Nombre de la Malla:</label>
      <input id="malla-nombre" type="text" class="input" 
             placeholder="Ej: Mi Malla USM 2025" 
             value="${(d==null?void 0:d.nombre)||""}"/>

      <label>Cantidad de Semestres:</label>
      <input id="malla-semestres" type="number" class="input" min="1" max="12" value="${(d==null?void 0:d.semestres)||1}"/>

      <label>Cantidad de √Åreas de Formaci√≥n:</label>
      <input id="malla-num-areas" type="number" class="input" min="1" max="10" value="${((q=d==null?void 0:d.areas)==null?void 0:q.length)||1}"/>
      
      <div id="malla-areas-container" class="inner-card"></div>

      <h3 class="inner-subtitle">Cantidad de Ramos por Semestre</h3>
      <div id="malla-semestres-container" class="inner-card"></div>
    </div>

    <div class="modal-actions">
      <button id="malla-generate" class="btn violet">Generar</button>
      <button id="malla-cancel" class="btn violet-outline">Cancelar</button>
    </div>
  </div>
`,document.body.appendChild(i);const u=i.querySelector("#malla-nombre"),r=i.querySelector("#malla-semestres"),l=i.querySelector("#malla-num-areas"),m=i.querySelector("#malla-areas-container"),f=i.querySelector("#malla-semestres-container");function p(){var M;m.innerHTML="";const A=parseInt(l.value,10)||1;for(let w=1;w<=A;w++){const b=((M=d==null?void 0:d.areas)==null?void 0:M[w-1])||{};m.innerHTML+=`
        <div class="row" style="align-items:center;gap:6px;margin-top:4px;">
          <label>√Årea ${w}:</label>
          <input type="text" class="input area-name" placeholder="Nombre del √°rea" value="${b.nombre||""}" style="flex:1;"/>
          <input type="color" class="area-color" value="${b.color||"#22c55e"}"/>
        </div>`}}function E(){var M,w,b;f.innerHTML="";const A=parseInt(r.value,10)||1;for(let v=1;v<=A;v++){const S=((b=(w=(M=d==null?void 0:d.estructura)==null?void 0:M.find(x=>x.semestre===v))==null?void 0:w.ramos)==null?void 0:b.length)||3;f.innerHTML+=`
        <div class="row" style="align-items:center;gap:6px;margin-top:4px;">
          <label>Semestre ${v}:</label>
          <input type="number" class="input sem-count" min="1" max="15" value="${S}" data-sem="${v}" style="width:80px;"/>
        </div>`}}p(),E(),l.addEventListener("input",p),r.addEventListener("input",E),i.querySelector("#malla-cancel").onclick=()=>i.remove(),i.querySelector("#malla-generate").onclick=async()=>{const A=u.value.trim(),M=parseInt(r.value,10);if(!A||!M)return alert("Completa los campos b√°sicos.");const w=Array.from(m.querySelectorAll(".row")).map(S=>({nombre:S.querySelector(".area-name").value.trim(),color:S.querySelector(".area-color").value})),b=Array.from(f.querySelectorAll(".sem-count")).map(S=>({semestre:parseInt(S.dataset.sem,10),ramos:Array.from({length:parseInt(S.value,10)},(x,_)=>{var U;return{_id:`${A}::S${parseInt(S.dataset.sem,10)}-I${_}`,nombre:"",codigo:"",area:((U=w[0])==null?void 0:U.nombre)||"",prerrequisitos:[]}})})),v={nombre:A,carrera:s,universidad:t,semestres:M,areas:w,estructura:b,updatedAt:Date.now()};fe(v),oe(S=>{const x=S||{},_=Array.isArray(x[o])?x[o]:[],U=_.findIndex(F=>(F==null?void 0:F.nombre)===A);return U>=0?_[U]=v:_.push(v),x[o]=_,x}),g.currentUser&&await ne(R($,"users",a,"customMallas",A),v),i.remove(),Be(v),se()},D=!1}function Te(e){const a=new Map;let t=1;return(e.estructura||[]).forEach(s=>{(s.ramos||[]).forEach(o=>{var u;const c=((o==null?void 0:o.nombre)||"").trim(),n=((o==null?void 0:o.codigo)||"").trim();if(!c&&!n)return;const d=((u=e.areas.find(r=>r.nombre===o.area))==null?void 0:u.color)||"#999";n&&a.set(n,{n:t,color:d});const i=n.replace(/^[A-Za-z-]+/,"");i&&!a.has(i)&&a.set(i,{n:t,color:d}),t++})}),a}function Oe(e,a){return(e||[]).map(t=>{const s=String(t).trim(),o=a.get(s)||a.get(s.replace(/^[A-Za-z-]+/,""));return o?`<span class="prereq-label" style="background:${o.color}">${o.n}</span>`:`<span class="prereq-label">${s.replace(/^[A-Za-z-]+/,"")}</span>`}).join("")}function Be(e){fe(e);const a=document.getElementById("page-malla");a&&(a.dataset.custom="true"),D=!0;const t=document.querySelector("#page-malla .malla-grid"),s=document.querySelector("#page-malla .grid-header");C("malla-info"),t.innerHTML="",s.innerHTML="",s.style.display="grid",s.style.gridTemplateColumns=`repeat(${e.semestres}, 1fr)`;const o=Math.ceil(e.semestres/2);for(let u=1;u<=o;u++){const r=document.createElement("div");r.className="year",r.textContent=`A√±o ${u}`,r.style.gridColumn=`${(u-1)*2+1} / span 2`,s.appendChild(r)}for(let u=1;u<=e.semestres;u++){const r=document.createElement("div");r.className="sem",r.textContent=H[u-1]||u,s.appendChild(r)}let c=1;t.style.gridTemplateColumns=`repeat(${e.semestres}, 1fr)`;const n=Te(e);e.estructura.forEach(u=>{u.ramos.forEach((r,l)=>{var E;const m=document.createElement("div");m.className="grid-item",m.style.gridColumn=u.semestre,m.dataset.sem=String(H[(Number(u.semestre)-1)%H.length]||u.semestre),m.dataset.idx=String(l);const f=((E=e.areas.find(h=>h.nombre===r.area))==null?void 0:E.color)||"#666";m.style.background=f,m.dataset.codigo=r&&r._id||`${e.nombre}::S${u.semestre}-I${l}`,m.innerHTML=`
  <div class="top-bar">
    <span class="sigla-label">${(r.codigo||"").trim()}</span>
    <span class="num-label">${c}</span>
  </div>
  <div class="course-name">${r.nombre||""}</div>
  <div class="bottom-bar"></div>
`;const p=m.querySelector(".bottom-bar");p.innerHTML=Oe(r.prerrequisitos,n),m.onclick=h=>{h.stopPropagation(),Xe(m,e,u.semestre,l)},t.appendChild(m),c++})});const d=document.querySelector("#malla-topbar");d&&d.remove();const i=document.createElement("div");i.id="malla-topbar",i.className="card",i.style=`
  margin: 12px 0;
  padding: 10px 16px;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  align-items: center;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  backdrop-filter: blur(8px);
`,i.innerHTML=`
  <button class="btn violet-outline" id="editAreasBtn">Editar √Åreas</button>
  <button class="btn violet" id="saveCustomMallaBtn">Guardar Malla</button>
  <button class="btn gray" id="exitEditBtn">Salir del Modo Edici√≥n</button>
`,t.parentElement.prepend(i),C("editAreasBtn").onclick=()=>Ze(e),C("saveCustomMallaBtn").onclick=()=>Qe(e),C("exitEditBtn").onclick=()=>{D=!1,O(!1),V(e.nombre)},D=!0,Ae(document),Se(e.areas)}function Xe(e,a,t,s){var d,i,u,r;let o=document.getElementById("ramoModal");o&&o.remove(),o=document.createElement("div"),o.id="ramoModal",o.className="modal-overlay";const c=((i=(d=a.estructura.find(l=>l.semestre===t))==null?void 0:d.ramos)==null?void 0:i[s])||{},n=a.areas.map(l=>`<option value="${l.nombre}">${l.nombre}</option>`).join("");o.innerHTML=`
    <div class="card modal-card" style="max-width:460px;">
      <h3>Editar Ramo</h3>
      <div class="modal-body">
        <label>Nombre:</label>
        <input id="ramo-nombre" class="input" placeholder="Ej: Matem√°ticas I"/>

        <label>C√≥digo:</label>
        <input id="ramo-codigo" class="input" placeholder="Ej: MAT101"/>

        <label>√Årea:</label>
        <select id="ramo-area" class="input">${n}</select>

        <label>Prerrequisitos:</label>
        <input id="ramo-prereq" class="input" placeholder="Ej: MAT100, FIS100"/>
      </div>
      <div class="modal-actions">
        <button id="ramo-save" class="btn violet">Guardar</button>
        <button id="ramo-cancel" class="btn gray">Cancelar</button>
      </div>
    </div>
  `,document.body.appendChild(o),C("ramo-nombre").value=(c.nombre||"").trim(),C("ramo-codigo").value=(c.codigo||"").trim(),C("ramo-area").value=c.area||((r=(u=a.areas)==null?void 0:u[0])==null?void 0:r.nombre)||"",C("ramo-prereq").value=Array.isArray(c.prerrequisitos)?c.prerrequisitos.join(", "):"",C("ramo-cancel").onclick=()=>o.remove(),C("ramo-save").onclick=()=>{var l,m;try{const f=C("ramo-nombre").value.trim();if(!f)return alert("Falta el nombre del ramo.");const p=C("ramo-codigo").value.trim(),E=C("ramo-area").value,h=C("ramo-prereq").value.split(",").map(x=>x.trim()).filter(Boolean),I=a.estructura.find(x=>x.semestre===t),y=((l=I==null?void 0:I.ramos)==null?void 0:l[s])||{},q=y._id||`${a.nombre}::S${t}-I${s}`;I.ramos[s]={...y,_id:q,nombre:f,codigo:p,area:E,prerrequisitos:h};const A=((m=a.areas.find(x=>x.nombre===E))==null?void 0:m.color)||"#ccc";e.style.background=A,e.dataset.codigo=q;let M=e.querySelector(".top-bar");M||(M=document.createElement("div"),M.className="top-bar",e.prepend(M));let w=M.querySelector(".sigla-label");w||(w=document.createElement("span"),w.className="sigla-label",M.prepend(w)),w.textContent=p||"";let b=e.querySelector(".course-name");b||(b=document.createElement("div"),b.className="course-name",M.insertAdjacentElement("afterend",b)),b.textContent=f;let v=e.querySelector(".bottom-bar");v||(v=document.createElement("div"),v.className="bottom-bar",b.insertAdjacentElement("afterend",v));const S=Te(a);v.innerHTML=Oe(h,S),Ae(document),oe(x=>{var le,K;const _=a.universidad||((le=g.profileData)==null?void 0:le.university)||"",U=a.carrera||((K=g.profileData)==null?void 0:K.career)||"",F=`${L(_)}:${L(U)}`,j=x||{},N=Array.isArray(j[F])?j[F]:[],z=N.findIndex(Q=>(Q==null?void 0:Q.nombre)===a.nombre),Z=JSON.parse(JSON.stringify(a));return z>=0?N[z]=Z:N.push(Z),j[F]=N,j}),o.remove()}catch(f){console.error(f),alert("Ocurri√≥ un error al guardar. Revisa la consola.")}}}function Ze(e){let a=document.getElementById("areasModal");a&&a.remove(),a=document.createElement("div"),a.id="areasModal",a.className="modal-overlay",a.innerHTML=`
    <div class="card modal-card" style="max-width:500px; display:flex; flex-direction:column; max-height:90vh;">
      <h3>Editar √Åreas Formativas</h3>
      
      <div id="areasList" class="modal-body" style="overflow-y:auto; padding-right:5px; margin-bottom:10px;">
        </div>

      <div style="text-align:right; margin-bottom:12px;">
        <button id="btn-add-area" class="btn violet-outline" style="font-size:0.85rem; padding:6px 12px;">
          + Agregar nueva √°rea
        </button>
      </div>

      <div class="modal-actions" style="border-top:1px solid rgba(255,255,255,0.1); padding-top:16px; margin-top:auto;">
        <button id="areas-save" class="btn violet">Guardar Cambios</button>
        <button id="areas-cancel" class="btn gray">Cerrar</button>
      </div>
    </div>
  `,document.body.appendChild(a);const t=a.querySelector("#areasList"),s=(o="",c="#6366f1")=>{const n=document.createElement("div");n.className="row area-row",n.style="align-items:center; gap:8px; margin-top:8px; display:flex;",n.innerHTML=`
      <input type="text" class="input area-name" value="${o}" placeholder="Nombre" style="flex:1;"/>
      <input type="color" class="area-color" value="${c}" style="width:40px; height:36px; padding:0; border:none; background:transparent; cursor:pointer;"/>
      <button class="btn-del-area" title="Eliminar" style="
          background:rgba(239,68,68,0.15); color:#fca5a5; border:none; 
          border-radius:8px; width:36px; height:36px; cursor:pointer; 
          display:flex; align-items:center; justify-content:center;">
        ‚úï
      </button>
    `,n.querySelector(".btn-del-area").onclick=()=>{confirm("¬øBorrar esta √°rea?")&&n.remove()},t.appendChild(n)};(e.areas||[]).forEach(o=>s(o.nombre,o.color)),a.querySelector("#btn-add-area").onclick=()=>{const o="#"+Math.floor(Math.random()*16777215).toString(16);s("",o),t.scrollTop=t.scrollHeight},a.querySelector("#areas-cancel").onclick=()=>a.remove(),a.querySelector("#areas-save").onclick=()=>{const c=Array.from(t.querySelectorAll(".area-row")).map(n=>({nombre:n.querySelector(".area-name").value.trim(),color:n.querySelector(".area-color").value})).filter(n=>n.nombre!=="");e.areas=c,Se(e.areas),document.querySelectorAll("#page-malla .malla-grid .grid-item").forEach(n=>{let d="";for(const u of e.estructura){const r=u.ramos.find(l=>{var m;return l._id&&l._id===n.dataset.codigo||l.nombre&&l.nombre===((m=n.querySelector(".course-name"))==null?void 0:m.textContent)});if(r){d=r.area;break}}const i=e.areas.find(u=>u.nombre===d);n.style.background=i?i.color:"#333"}),oe(n=>{var f,p;const d=e.universidad||((f=g.profileData)==null?void 0:f.university)||"",i=e.carrera||((p=g.profileData)==null?void 0:p.career)||"",u=`${L(d)}:${L(i)}`,r=n||{},l=Array.isArray(r[u])?r[u]:[],m=l.findIndex(E=>(E==null?void 0:E.nombre)===e.nombre);return m>=0?l[m]=e:l.push(e),r[u]=l,r}),a.remove()}}async function Qe(e){var u,r,l;console.group("saveCustomMalla DEBUG"),console.log("Entrada malla:",e),console.log("state.currentUser:",g.currentUser),console.log("state.profileData:",g.profileData),console.groupEnd(),fe(e);const a=((u=g.currentUser)==null?void 0:u.uid)||"anon",t=e.universidad||((r=g.profileData)==null?void 0:r.university)||"",s=e.carrera||((l=g.profileData)==null?void 0:l.career)||"";if(!t||!s){alert("Error: faltan datos de universidad o carrera."),console.error("saveCustomMalla ‚Üí universidad/carrera indefinidas:",{uni:t,carrera:s});return}const o=`custom_mallas_${a}`,c=`${L(t)}:${L(s)}`;JSON.parse(localStorage.getItem(o)||"{}");const n=[];if((e.estructura||[]).forEach((m,f)=>{(m.ramos||[]).forEach((p,E)=>{const h=((p==null?void 0:p.nombre)||"").trim(),I=((p==null?void 0:p.codigo)||"").trim();(h||I)&&n.push({...p,_id:p._id||`${e.nombre}::S${m.semestre}-I${E}`,nombre:h,codigo:I,semestre:m.semestre,index:E+1+f*100})})}),n.length===0){const m=document.querySelector("#page-malla .malla-grid");m&&m.querySelectorAll(".grid-item").forEach(p=>{var q,A,M,w,b,v;const E=parseInt(p.dataset.sem,10),h=parseInt(p.dataset.idx,10),I=(((q=p.querySelector(".course-name"))==null?void 0:q.textContent)||"").trim(),y=(((A=p.querySelector(".sigla-label"))==null?void 0:A.textContent)||"").trim();if((I||y)&&Number.isFinite(E)&&Number.isFinite(h)){n.push({_id:p.dataset.codigo||`${e.nombre}::S${E}-I${h}`,nombre:I,codigo:y,area:((w=(M=e.areas)==null?void 0:M[0])==null?void 0:w.nombre)||"",prerrequisitos:[],semestre:E,index:h+1+(E-1)*100});const S=(e.estructura||[]).find(x=>x.semestre===E);S&&S.ramos&&S.ramos[h]&&(S.ramos[h]={...S.ramos[h]||{},_id:p.dataset.codigo||`${e.nombre}::S${E}-I${h}`,nombre:I,codigo:y,area:S.ramos[h].area||((v=(b=e.areas)==null?void 0:b[0])==null?void 0:v.nombre)||"",prerrequisitos:Array.isArray(S.ramos[h].prerrequisitos)?S.ramos[h].prerrequisitos:[]})}})}if(n.length===0){alert("No hay ramos con nombre o c√≥digo. No se guard√≥.");return}const d={...e,universidad:t,carrera:s,ramos:n,updatedAt:Date.now()},i=JSON.parse(JSON.stringify(d));if(oe(m=>{const f=m||{},p=Array.isArray(f[c])?f[c]:[],E=p.findIndex(h=>(h==null?void 0:h.nombre)===e.nombre);return E>=0?p[E]=i:p.push(i),f[c]=p,f}),g.currentUser)try{await ne(R($,"users",a,"customMallas",e.nombre),i,{merge:!0})}catch(m){console.error("Error guardando en Firestore:",m)}alert("Malla guardada."),D=!1,document.getElementById("page-malla").dataset.custom="true",localStorage.setItem("ultima_malla_seleccionada",e.nombre),Ee(e.nombre,!0),V(e.nombre),se()}function L(e){return String(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"_").toUpperCase()}async function Ye(e,a){var d;if(!e||!a)return;const t=((d=g.currentUser)==null?void 0:d.uid)||"anon",s=`${L(e)}:${L(a)}`;console.log("[malla] wipeCareerData()",{oldUni:e,oldCareer:a,careerKey:s}),localStorage.removeItem(`mallaAprobados:${e}:${a}`);const{data:o}=me(),c=Array.isArray(o[s])?o[s]:[];c.forEach(i=>{if(!(i!=null&&i.nombre))return;const u=`mallaCustomAprobados:${t}:${i.nombre}`;localStorage.removeItem(u)}),oe(i=>{const r={...i||{}};return delete r[s],r});const n=localStorage.getItem("ultima_malla_seleccionada");if(n&&c.some(i=>(i==null?void 0:i.nombre)===n)&&localStorage.removeItem("ultima_malla_seleccionada"),g.currentUser)try{await ne(R($,"users",t),{ultima_malla_seleccionada:null,ultima_malla_es_custom:!1},{merge:!0});const i=await De(_e($,"users",t,"customMallas")),u=[];i.forEach(r=>{const l=r.data();(l==null?void 0:l.carrera)===a&&(l==null?void 0:l.universidad)===e&&u.push(r.ref)});for(const r of u)await $e(r);console.log("[malla] wipeCareerData() ‚Üí Firestore limpiado para",e,a)}catch(i){console.warn("[malla] No se pudo limpiar Firestore al cambiar de carrera",i)}}function fe(e){(e.estructura||[]).forEach(a=>{(a.ramos||[]).forEach((t,s)=>{t&&(!t._id||typeof t._id!="string"||!t._id.trim())&&(t._id=`${e.nombre}::S${a.semestre}-I${s}`)})})}function V(e,a={}){var M,w;const t=!!a.isDuo,s=C("malla-host");s&&!s.dataset.ready&&(Ce(s),s.dataset.ready="1");const o=((M=g.profileData)==null?void 0:M.university)||"",c=((w=g.profileData)==null?void 0:w.career)||"",n=`${L(o)}:${L(c)}`,{data:d}=me();let i=be.get(e);if(i||(i=(d[n]||[]).find(b=>(b==null?void 0:b.nombre)===e),i||(i=Object.values(d).flat().find(v=>v&&v.nombre===e))),!i){alert("No se encontr√≥ la malla personalizada.");return}const u=document.getElementById("page-malla");u&&(u.dataset.custom="true"),D=!1,O(t),fe(i);let r=i.ramos||[];!r.length&&Array.isArray(i.estructura)&&i.estructura.forEach((b,v)=>{(b.ramos||[]).forEach((S,x)=>{((S.nombre||"").trim()||(S.codigo||"").trim())&&r.push({...S,semestre:b.semestre,_id:S._id||`${i.nombre}::S${b.semestre}-I${x}`})})});const l=document.querySelector("#page-malla .malla-grid"),m=document.querySelector("#page-malla .grid-header"),f=C("malla-info");if(!l)return;l.innerHTML="",m.innerHTML="";const p=`repeat(${i.semestres}, 1fr)`;m.style.display="grid",m.style.gridTemplateColumns=p,l.style.gridTemplateColumns=p;const E=Math.ceil(i.semestres/2);for(let b=1;b<=E;b++){const v=document.createElement("div");v.className="year",v.textContent=`A√±o ${b}`,v.style.gridColumn=`${(b-1)*2+1} / span 2`,v.dataset.year=String(b),v.style.cursor="pointer",v.onclick=()=>Ue(b),m.appendChild(v)}for(let b=1;b<=i.semestres;b++){const v=document.createElement("div");v.className="sem";const S=H[b-1]||b;v.textContent=S,v.dataset.sem=S,v.style.cursor="pointer",v.onclick=()=>Fe(S),m.appendChild(v)}let h=1;r.forEach(b=>{var j;const v=document.createElement("div");v.className="grid-item";const S=Je(b.semestre,1);v.style.gridColumn=S>=1&&S<=12?String(S):"auto";const x=(j=i.areas)==null?void 0:j.find(N=>N.nombre===b.area);v.style.background=(x==null?void 0:x.color)||"#444";const _=(b._id||b.codigo||"").trim();v.dataset.codigo=_,v.dataset.key=(b.codigo||"").trim(),v.dataset.prereqs=JSON.stringify(Array.isArray(b.prerrequisitos)?b.prerrequisitos:[]);const U=H[(S-1)%H.length]||String(S);v.dataset.sem=U,v.dataset.year=String(Math.ceil(S/2)),v.innerHTML=`
      <div class="top-bar">
        <span class="sigla-label">${b.codigo||""}</span>
        <span class="num-label">${h}</span>
      </div>
      <div class="course-name">${b.nombre||""}</div>
      <div class="bottom-bar"></div>
    `;const F=v.querySelector(".bottom-bar");(b.prerrequisitos||[]).forEach(N=>{var le;const z=document.createElement("span");z.className="prereq-label";const Z=r.find(K=>K.codigo===N||K._id===N);if(Z){const K=r.indexOf(Z)+1;z.textContent=K;const Q=(le=i.areas)==null?void 0:le.find(ze=>ze.nombre===Z.area);Q&&(z.style.background=Q.color)}else z.textContent=String(N).replace(/^[A-Za-z-]+/,"");F.appendChild(z)}),l.appendChild(v),h++}),Ae(document),f.style.display="block",Se(i.areas);const I=C("malla-caption");I&&(I.textContent=t?`${i.nombre} ¬∑ (vista de la otra persona)`:`${i.nombre} ¬∑ Personalizada`);const y=document.querySelector("#malla-topbar");y&&y.remove();const q=document.createElement("div");q.id="malla-topbar",q.className="card",q.style=`
    margin: 12px 0;
    padding: 10px 16px;
    display: flex;
    justify-content: flex-end;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    backdrop-filter: blur(8px);
  `,t?l.parentElement.prepend(q):(q.innerHTML='<button class="btn violet-outline" id="configurarMallaBtn">Configurar Malla</button>',l.parentElement.prepend(q),C("configurarMallaBtn").onclick=()=>Be(i));const A=document.querySelector("#malla-wrapper");!t&&A&&(He(A,i.nombre),X(A),G(A)),console.log("Malla personalizada cargada, l√≥gica activa. isDuoView=",t)}document.addEventListener("profile:ready",se);document.addEventListener("profile:changed",se);function xe(e){return e==="UMAYOR"?"Universidad Mayor":e==="USM"?"UTFSM":e||"‚Äî"}function ie(e){k("renderMalla()",e);const a=C("page-malla");if(!a){k("renderMalla() abortado: #page-malla a√∫n no existe");return}const t=a.querySelector(".grid-header"),s=a.querySelector(".malla-grid"),o=C("malla-info");if(!t||!s||!o){k("renderMalla() abortado: shell de malla a√∫n no construido");return}if(D=!1,O(te()),a.removeAttribute("data-custom"),a.dataset.career=e,s.innerHTML="",!e){t.style.display="none",o.style.display="none";return}const c=ae[e]||[];if(!c.length){s.innerHTML='<div class="muted">Malla en preparaci√≥n.</div>',t.style.display="none",o.style.display="none";return}const n=Array.from(new Set(c.map(r=>r.nivel))).sort((r,l)=>ye(r)-ye(l)),d=Math.ceil(n.length/2);t.style.gridTemplateColumns=`repeat(${n.length}, 1fr)`,s.style.gridTemplateColumns=`repeat(${n.length}, 1fr)`,t.innerHTML="";for(let r=1;r<=d;r++){const l=document.createElement("div");l.className="year",l.dataset.year=String(r),l.title=`Marcar A√±o ${r}`,l.style.cursor="pointer",l.textContent=`A√±o ${r}`,l.style.gridColumn=`${(r-1)*2+1} / span 2`,t.appendChild(l)}n.forEach(r=>{const l=document.createElement("div");l.className="sem",l.dataset.sem=r,l.title=`Marcar semestre ${r}`,l.style.cursor="pointer",l.textContent=r,t.appendChild(l)}),t.style.display="grid",t.querySelectorAll(".year").forEach(r=>{r.addEventListener("click",()=>{var l;te()||((l=C("malla-wrapper"))==null?void 0:l.dataset.readonly)==="1"||Ue(parseInt(r.dataset.year,10))})}),t.querySelectorAll(".sem").forEach(r=>{r.addEventListener("click",()=>{var l;te()||((l=C("malla-wrapper"))==null?void 0:l.dataset.readonly)==="1"||Fe(r.dataset.sem)})});const i=a.querySelector(".legend");e==="ICTEL"?i.innerHTML=`
      <span><span class="legend-color cb"></span>Ciencias B√°sicas</span>
      <span><span class="legend-color software"></span>Software</span>
      <span><span class="legend-color fisica"></span>F√≠sica</span>
      <span><span class="legend-color transversal"></span>Transversal e Integraci√≥n</span>
      <span><span class="legend-color fg"></span>Formaci√≥n General</span>
      <span><span class="legend-color deportes"></span>Deportes</span>
      <span><span class="legend-color redes"></span>Redes</span>
      <span><span class="legend-color ingles"></span>Ingl√©s</span>
      <span><span class="legend-color electronica"></span>Electr√≥nica</span>
      <span><span class="legend-color telecom"></span>Telecomunicaciones</span>
      <span><span class="legend-color industrias"></span>Industrias</span>
      <span><span class="legend-color complementarios"></span>Complementarios</span>
    `:i.innerHTML=`
      <span><span class="legend-color integrativa"></span>Formaci√≥n Integrativa</span>
      <span><span class="legend-color salud-animal"></span>Formaci√≥n Salud Animal</span>
      <span><span class="legend-color produccion-animal"></span>Formaci√≥n Producci√≥n Animal</span>
      <span><span class="legend-color salud-publica"></span>Formaci√≥n Salud P√∫blica</span>
      <span><span class="legend-color medio-ambiente"></span>Formaci√≥n Medio Ambiente</span>
      <span><span class="legend-color formacion-basica"></span>Formaci√≥n B√°sica</span>
      <span><span class="legend-color electiva"></span>Formaci√≥n Electiva</span>
    `,o.style.display="block";const u=new Map;c.forEach(r=>{r.numero!=null&&u.set(String(r.numero),r.area),r.codigo&&u.set(String(r.codigo),r.area),r.sigla&&u.set(String(r.sigla),r.area)}),s.innerHTML="",c.forEach(r=>{let l=ye(r.nivel);l<0&&(l=0);const m=l+1,f=document.createElement("div");f.className="grid-item"+(r.area?" area-"+Le(r.area):""),f.style.gridColumn=String(m),f.dataset.codigo=r.codigo,f.dataset.key=String(r.numero??r.codigo),f.dataset.prereqs=JSON.stringify(r.prerrequisitos),f.dataset.sem=r.nivel,f.dataset.year=String(Math.ceil(m/2));const p=document.createElement("div");if(p.className="top-bar",f.appendChild(p),r.sigla){const y=document.createElement("span");y.className="sigla-label",y.textContent=r.sigla,p.appendChild(y)}const E=document.createElement("span");E.className="code-label",E.textContent=r.numero??r.codigo,p.appendChild(E);const h=document.createElement("div");h.className="course-name",h.textContent=r.nombre,f.appendChild(h);const I=document.createElement("div");if(I.className="bottom-bar",f.appendChild(I),(r.prerrequisitos||[]).forEach((y,q)=>{const A=String(y),M=document.createElement("span");M.className="prereq-label",M.textContent=A,M.style.left=`${4+q*22}px`;const w=u.get(A);w&&M.classList.add("area-"+Le(w)),I.appendChild(M)}),r.creditos){const y=document.createElement("span");y.className="credits-badge",y.textContent=r.creditos,I.appendChild(y)}s.appendChild(f)}),ea(a,e),X(a),G(a),!te()&&a.dataset.custom!=="true"&&ge(a),k("renderMalla()",e)}function Le(e){const t=(e||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[-_]+/g," ").replace(/\s+/g," ").trim();return t.includes("integrativ")?"integrativa":t.includes("formacion basica")?"formacion-basica":t.includes("electiva")?"electiva":t.includes("salud animal")?"salud-animal":t.includes("produccion animal")?"produccion-animal":t.includes("medio ambiente")?"medio-ambiente":t.includes("salud publica")?"salud-publica":t.includes("ciencias basicas")?"cb":t.includes("software")?"software":t.includes("fisica")?"fisica":t.includes("transversal")?"transversal":t.includes("formacion general")?"fg":t.includes("deporte")?"deportes":t.includes("redes")?"redes":t.includes("ingles")?"ingles":t.includes("electronica")?"electronica":t.includes("telecom")?"telecom":t.includes("industri")?"industrias":t.includes("complement")?"complementarios":"transversal"}function Ue(e){const a=document.querySelector("#malla-wrapper");if(!a||a.dataset.readonly==="1")return;const t=a.querySelectorAll(`.grid-item[data-year="${e}"]`),s=Array.from(t),o=s.every(n=>n.classList.contains("aprobado"));s.forEach(n=>n.classList.toggle("aprobado",!o)),X(a),G(a);const c=document.getElementById("page-malla");if((c==null?void 0:c.dataset.custom)==="true"){const n=localStorage.getItem("ultima_malla_seleccionada");Ie(a,n)}else ge(a)}function Fe(e){const a=document.querySelector("#malla-wrapper");if(!a||a.dataset.readonly==="1")return;const t=a.querySelectorAll(`.grid-item[data-sem="${e}"]`),s=Array.from(t),o=s.every(n=>n.classList.contains("aprobado"));s.forEach(n=>n.classList.toggle("aprobado",!o)),X(a),G(a);const c=document.getElementById("page-malla");if((c==null?void 0:c.dataset.custom)==="true"){const n=localStorage.getItem("ultima_malla_seleccionada");Ie(a,n)}else ge(a)}function X(e){const a=Array.from(e.querySelectorAll(".grid-item")),t=document.getElementById("page-malla"),s=(t==null?void 0:t.dataset.career)||"",o=(t==null?void 0:t.dataset.custom)==="true",c=new Set;a.forEach(i=>{var u,r,l,m;if(i.classList.contains("aprobado")){i.dataset.codigo&&c.add(i.dataset.codigo),i.dataset.key&&c.add(i.dataset.key);const f=(r=(u=i.querySelector(".course-name"))==null?void 0:u.textContent)==null?void 0:r.trim(),p=(m=(l=i.querySelector(".sigla-label"))==null?void 0:l.textContent)==null?void 0:m.trim();f&&c.add(f),p&&c.add(p)}});let n=!0;if(!o&&s==="MEDVET"){const i=a.filter(u=>{const r=parseInt(u.dataset.year||"0",10);return Number.isFinite(r)&&r>=1&&r<=4});n=i.length>0&&i.every(u=>u.classList.contains("aprobado"))}const d=i=>String(i||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");a.forEach(i=>{var m;if(i.classList.contains("aprobado")){i.classList.remove("bloqueado");return}let u=[];try{u=JSON.parse(i.dataset.prereqs||"[]")}catch{}const r=u.every(f=>{const p=String(f).trim();return c.has(p)});let l=!0;if(!o&&s==="MEDVET"){const f=d(((m=i.querySelector(".course-name"))==null?void 0:m.textContent)||"");f.includes("practica")&&f.includes("profesional")&&(l=n)}r&&l?i.classList.remove("bloqueado"):i.classList.add("bloqueado")})}async function ge(e){var o,c;const a=((o=g.profileData)==null?void 0:o.university)||"GEN",t=((c=g.profileData)==null?void 0:c.career)||"GEN",s=Array.from(e.querySelectorAll(".grid-item.aprobado")).map(n=>{var d,i,u,r,l,m;return n.dataset.codigo||((i=(d=n.querySelector(".sigla-label"))==null?void 0:d.textContent)==null?void 0:i.trim())||((r=(u=n.querySelector(".code-label"))==null?void 0:u.textContent)==null?void 0:r.trim())||((m=(l=n.querySelector(".course-name"))==null?void 0:l.textContent)==null?void 0:m.trim())||null}).filter(n=>typeof n=="string"&&n.length>0);localStorage.setItem(`mallaAprobados:${a}:${t}`,JSON.stringify(s));try{document.dispatchEvent(new Event("malla:updated"))}catch{}if(g.currentUser)try{const n=R($,"users",g.currentUser.uid,"malla","state");await ne(n,{career:t,approved:s,updatedAt:Date.now()},{merge:!0});try{document.dispatchEvent(new Event("malla:updated"))}catch{}}catch(n){console.error("saveState ‚Üí Firestore setDoc fall√≥:",n,{approved:s})}}function ea(e,a){var o;const t=((o=g.profileData)==null?void 0:o.university)||"GEN";JSON.parse(localStorage.getItem(`mallaAprobados:${t}:${a}`)||"[]").forEach(c=>{const n=e.querySelector(`.grid-item[data-codigo="${CSS.escape(String(c))}"]`);n&&n.classList.add("aprobado")})}function G(e){const a=e.querySelectorAll(".grid-item").length,t=e.querySelectorAll(".grid-item.aprobado").length,s=a?(t/a*100).toFixed(1):"0.0";C("malla-percentage").textContent=`Total de ramos: ${s}%`}function Ie(e,a){var c,n,d;const s=`mallaCustomAprobados:${((c=g.currentUser)==null?void 0:c.uid)||"anon"}:${a}`,o=Array.from(e.querySelectorAll(".grid-item.aprobado")).map(i=>{var u,r,l,m;return i.dataset.codigo||((r=(u=i.querySelector(".sigla-label"))==null?void 0:u.textContent)==null?void 0:r.trim())||((m=(l=i.querySelector(".course-name"))==null?void 0:l.textContent)==null?void 0:m.trim())||null}).filter(i=>typeof i=="string"&&i.length>0);if(localStorage.setItem(s,JSON.stringify(o)),g.currentUser)try{const i=((n=g.profileData)==null?void 0:n.university)||"GEN",u=((d=g.profileData)==null?void 0:d.career)||"GEN",r=R($,"users",g.currentUser.uid,"malla","state");ne(r,{career:u,isCustom:!0,customName:a,approved:o,updatedAt:Date.now()},{merge:!0}).catch(l=>{console.error("[malla] saveStateCustom ‚Üí Firestore setDoc fall√≥:",l)})}catch(i){console.error("[malla] saveStateCustom ‚Üí error general",i)}}function He(e,a){var c;const s=`mallaCustomAprobados:${((c=g.currentUser)==null?void 0:c.uid)||"anon"}:${a}`;JSON.parse(localStorage.getItem(s)||"[]").forEach(n=>{const d=e.querySelector(`.grid-item[data-codigo="${CSS.escape(String(n))}"]`);d&&d.classList.add("aprobado")})}function re(){var s,o;const e=C("malla-host");if(!e||C("malla-partner-toggle"))return;const a=document.createElement("div");a.id="malla-partner-toggle",a.className="row",a.style.margin="10px 0",a.innerHTML=`
    <label class="pill">
      <input type="checkbox" id="malla-view-partner" style="margin-right:8px"/>
      Ver malla de la otra persona
    </label>
  `,e.prepend(a);const t=C("malla-view-partner");t.checked=!!((o=(s=g.shared)==null?void 0:s.malla)!=null&&o.enabled),t.addEventListener("change",()=>{var n,d;if(J()){t.checked=!!((d=(n=g.shared)==null?void 0:n.malla)!=null&&d.enabled);return}g.shared.malla.enabled=t.checked;const c=document.getElementById("page-malla");if((c==null?void 0:c.dataset.custom)==="true"){t.checked?ue():B();return}P(),ue()})}let W=null;async function ue(){var u,r;if(W&&(W(),W=null),!document.getElementById("malla-wrapper"))return;if(!((r=(u=g.shared)==null?void 0:u.malla)!=null&&r.enabled)||!g.pairOtherUid){O(!1),T="",B();const l=document.getElementById("malla-selector");(!l||!l.value)&&g.profileData&&P();return}const a=g.pairOtherUid;O(!0);let t=null;try{const l=await Pe(R($,"users",a));l.exists()&&(t=l.data())}catch(l){console.warn("[DUO] error leyendo perfil del par",l)}const s=(t==null?void 0:t.university)||null;let o=ta(t==null?void 0:t.career);const c=(t==null?void 0:t.ultima_malla_seleccionada)||null;let n=!!(t!=null&&t.ultima_malla_es_custom);if(c&&!n){const l=c.toLowerCase();l.includes("veterinaria")?o="MEDVET":(l.includes("telematica")||l.includes("telemaÃÅtica")||l.includes("ictel"))&&(o="ICTEL")}let d=[];try{(await De(_e($,"users",a,"customMallas"))).forEach(m=>{const f=m.data();f&&f.nombre&&d.push(f)})}catch(l){console.warn("[DUO] error leyendo customMallas",l)}if(c&&!n&&d.some(l=>l.nombre===c)&&(n=!0),be.clear(),d.forEach(l=>be.set(l.nombre,l)),console.log("[DUO] perfil par",{partnerUni:s,partnerCareer:o,partnerLast:c,partnerLastIsCustom:n,customCount:d.length}),c&&n){let l=d.find(m=>m.nombre===c)||d[0];l&&(console.log("[DUO] Vista de d√∫o ‚Üí malla personalizada activa:",l.nombre),V(l.nombre,{isDuo:!0}))}else if(o)console.log("[DUO] Vista de d√∫o ‚Üí usando malla OFICIAL:",o),await aa(o);else if(d.length>0)console.log("[DUO] Carrera no soportada pero tiene custom, usando:",d[0].nombre),V(d[0].nombre,{isDuo:!0});else{console.log("[DUO] La otra persona no tiene malla configurada todav√≠a.");const l=document.querySelector("#page-malla .malla-grid");l&&(l.innerHTML=`
        <div class="muted">
          La otra persona todav√≠a no ha configurado su malla.<br/>
          P√≠dele que entre a <b>Malla</b> y la guarde al menos una vez.
        </div>`);return}const i=R($,"users",a,"malla","state");W=Ve(i,l=>{const m=l.data()||{},f=Array.isArray(m.approved)?m.approved:[],p=document.getElementById("malla-wrapper");if(!p)return;const E=new Set(f.map(String));p.querySelectorAll(".grid-item").forEach(h=>{var y,q,A,M,w,b;const I=h.dataset.codigo||((q=(y=h.querySelector(".sigla-label"))==null?void 0:y.textContent)==null?void 0:q.trim())||((M=(A=h.querySelector(".code-label"))==null?void 0:A.textContent)==null?void 0:M.trim())||((b=(w=h.querySelector(".course-name"))==null?void 0:w.textContent)==null?void 0:b.trim())||"";E.has(String(I))?h.classList.add("aprobado"):h.classList.remove("aprobado")}),X(p),G(p)},l=>{console.warn("[DUO] onSnapshot error",l),O(!1),T="",g.profileData&&P()})}async function aa(e){const a=C("page-malla");if(!a)return;await Me();const t=a.dataset.custom==="true";a.dataset._wasCustom=t?"1":"0",a.removeAttribute("data-custom"),a.dataset.career=e,T=`FORCED:${e}`;const s=C("malla-caption");s.textContent=`${de[e]||e} ¬∑ (vista de la otra persona)`,O(!0),ie(e),delete a.dataset._wasCustom,a.removeAttribute("data-custom")}function ta(e){const a=String(e||"").toLowerCase().trim();return a?a.includes("medvet")||a.includes("medicina veterinaria")?"MEDVET":a.includes("ictel")||a.includes("telematica")||a.includes("telemaÃÅtica")?"ICTEL":null:null}function ca(e){const a={};e.forEach(t=>{const s=t.codigo.trim(),o=(t.prerequisitos||"").split(/[,;]/).map(c=>c.trim()).filter(Boolean);a[s]=o}),g.malla={prereqMap:a,rows:e}}function da(e){const a=String(e||"").toUpperCase().trim();return window.MALLA_PREREQS&&window.MALLA_PREREQS[a]||[]}document.addEventListener("auth:ready",()=>{setTimeout(()=>{console.log("[malla] auth:ready ‚Üí initMallaOnRoute()"),pe()},1e3)});document.addEventListener("semester:changed",()=>{if(ce>0||J()||location.hash!=="#/malla")return;const e=document.getElementById("page-malla");e&&e.dataset.custom!=="true"&&(console.log("[malla] semester:changed ‚Üí initMallaOnRoute()"),pe())});function Ae(e){let a=1;e.querySelectorAll('#page-malla[data-custom="true"] .malla-grid .grid-item').forEach(s=>{let o=s.querySelector(".top-bar");o||(o=document.createElement("div"),o.className="top-bar",s.prepend(o));let c=o.querySelector(".sigla-label");if(c||(c=document.createElement("span"),c.className="sigla-label",o.prepend(c)),!c.textContent.trim()){const i=(s.dataset.codigo||"").trim();i&&!i.includes("::")&&(c.textContent=i)}let n=o.querySelector(".num-label");n||(n=document.createElement("span"),n.className="num-label",o.appendChild(n)),n.textContent=a++;const d=s.querySelector(".code-label");d&&d.remove()})}function B(){var o,c;if(J()||te()||location.hash!=="#/malla")return;const e=localStorage.getItem("ultima_malla_seleccionada");if(!e)return;const a=document.getElementById("malla-selector");(o=g.profileData)!=null&&o.university;const t=((c=g.profileData)==null?void 0:c.career)||"";if(!a)return;const s=Array.from(a.options).find(n=>n.value===e);s&&(a.value=e,s.dataset.oficial==="1"?ie(t):V(e))}document.addEventListener("visibilitychange",()=>{J()||document.visibilityState==="visible"&&B()});document.addEventListener("DOMContentLoaded",()=>{J()||B()});document.addEventListener("malla:selector-ready",B);async function Re(){if(J()||location.hash!=="#/malla")return;let e=0;for(;!document.getElementById("malla-selector")&&e<10;)await new Promise(a=>setTimeout(a,200)),e++;document.getElementById("malla-selector")&&B()}document.addEventListener("profile:ready",Re);document.addEventListener("profile:changed",Re);document.addEventListener("malla:selector-ready",B);document.addEventListener("pair:changed",()=>{je()});export{da as getPrereqs,pe as initMallaOnRoute,ca as parseMalla};
