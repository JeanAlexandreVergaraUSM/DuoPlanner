import{getApps as fr,getApp as vr,initializeApp as hr}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth as gr,setPersistence as yr,browserLocalPersistence as br,GoogleAuthProvider as aa,signInWithPopup as ra,signOut as na,onAuthStateChanged as wr}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getFirestore as Sr,enableIndexedDbPersistence as Er,updateDoc as I,doc as w,setDoc as Z,collection as C,getDocs as $,query as J,getDoc as Y,onSnapshot as D,orderBy as he,deleteDoc as Q,addDoc as $e,where as Ma,serverTimestamp as Ua,arrayRemove as Lr,arrayUnion as xr,Timestamp as Cr}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function a(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=a(r);fetch(r.href,s)}})();const Mr="modulepreload",Ur=function(e){return"/DuoPlanner/"+e},sa={},Rt=function(t,a,n){let r=Promise.resolve();if(a&&a.length>0){let d=function(m){return Promise.all(m.map(u=>Promise.resolve(u).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),c=l?.nonce||l?.getAttribute("nonce");r=d(a.map(m=>{if(m=Ur(m),m in sa)return;sa[m]=!0;const u=m.endsWith(".css"),p=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${p}`))return;const f=document.createElement("link");if(f.rel=u?"stylesheet":Mr,u||(f.as="script"),f.crossOrigin="",f.href=m,c&&f.setAttribute("nonce",c),document.head.appendChild(f),u)return new Promise((v,S)=>{f.addEventListener("load",v),f.addEventListener("error",()=>S(new Error(`Unable to preload CSS for ${m}`)))})}))}function s(l){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=l,window.dispatchEvent(c),!c.defaultPrevented)throw l}return r.then(l=>{for(const c of l||[])c.status==="rejected"&&s(c.reason);return t().catch(s)})};(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();const Ar="modulepreload",$r=function(e){return"/"+e},ia={},ee=function(e,t,a){let n=Promise.resolve();if(t&&t.length>0){let s=function(d){return Promise.all(d.map(m=>Promise.resolve(m).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),c=l?.nonce||l?.getAttribute("nonce");n=s(t.map(d=>{if(d=$r(d),d in ia)return;ia[d]=!0;const m=d.endsWith(".css"),u=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${u}`))return;const p=document.createElement("link");if(p.rel=m?"stylesheet":Ar,m||(p.as="script"),p.crossOrigin="",p.href=d,c&&p.setAttribute("nonce",c),document.head.appendChild(p),m)return new Promise((f,v)=>{p.addEventListener("load",f),p.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${d}`)))})}))}function r(s){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=s,window.dispatchEvent(l),!l.defaultPrevented)throw s}return n.then(s=>{for(const l of s||[])l.status==="rejected"&&r(l.reason);return e().catch(r)})},Ir={apiKey:"AIzaSyB45g_2KRGlXH0iAPyBGuCnrFkhxCHadKs",authDomain:"nacholo.firebaseapp.com",projectId:"nacholo",storageBucket:"nacholo.appspot.com",messagingSenderId:"924503328068",appId:"1:924503328068:web:1f753ced7f47ec36750311"},Aa=fr().length?vr():hr(Ir),Se=gr(Aa);yr(Se,br).catch(()=>{});const g=Sr(Aa);setTimeout(()=>{Er(g).catch(()=>{})},2e3);const i={currentUser:null,currentPairId:null,profileData:null,activeSemesterId:null,activeSemesterData:null,unsubscribeCourses:null,editingCourseId:null,pairOtherUid:null,shared:{horario:{semId:null},notas:{semId:null},malla:{enabled:!1},calendar:{semId:null}},DEBUG:(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&(new URLSearchParams(location.search).has("debug")||(window?.duoplannerDebug??!1))},o=e=>typeof e=="string"?document.getElementById(e):null;function V(){if(!i.DEBUG)return;const e=o("state");e&&(e.textContent=JSON.stringify({uid:i.currentUser?.uid||null,pairId:i.currentPairId,pairOtherUid:i.pairOtherUid||null,profileData:i.profileData,activeSemesterId:i.activeSemesterId,editingCourseId:i.editingCourseId},null,2))}function oa(e,t){e&&(t?e.classList.add("hidden"):e.classList.remove("hidden"))}let se=null;function Tr(){se&&(se(),se=null),i.unsubscribeProfile=null}function Nr(e){if(!e)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=/^(\d{2})-(\d{2})$/.exec(e);if(t){const a=t[1];return`2000-${t[2]}-${a}`}return""}async function la(e){const t=await new Promise((a,n)=>{const r=new FileReader;r.onload=()=>a(r.result),r.onerror=n,r.readAsDataURL(e)});return await new Promise((a,n)=>{const r=new Image;r.onload=()=>a(r),r.onerror=n,r.src=t})}function ca(e,t=256,a=.82){const n=document.createElement("canvas"),r=Math.min(e.width,e.height),s=(e.width-r)/2,l=(e.height-r)/2;return n.width=t,n.height=t,n.getContext("2d").drawImage(e,s,l,r,r,0,0,t,t),n.toDataURL("image/jpeg",a)}function Te(e){const t=document.getElementById("pfAvatarCircle");t&&(e&&!e.startsWith("emoji:")?(t.textContent="",t.style.backgroundImage=`url("${e}")`):(t.style.backgroundImage="none",t.textContent="üë®‚Äçüéì"))}function Dr(e,t){if(e&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const a=/^(\d{2})-(\d{2})$/.exec(t||"");if(a){const n=a[1];return`2000-${a[2]}-${n}`}return null}let _e=null;const Ft={UMAYOR:[{value:"MEDVET",label:"Medicina Veterinaria"}],USM:[{value:"ICTEL",label:"Ing. Civil Telem√°tica"}]};function $a(){se&&(se(),se=null);const e=i.currentUser?.uid;if(!e)return;const t=w(g,"users",e),a=w(g,"users",e,"profile","profile"),n=(d,m)=>{const u=d?.data()||{},p=m?.data()||{};i.profileData={...u,...p,name:p?.name||u?.name||u?.fullName||p?.fullName||""},delete i.profileData.fullName,u?.name&&!i.profileData.name&&(i.profileData.name=u.name),u?.fullName&&!i.profileData.name&&(i.profileData.name=u.fullName),p?.name&&(i.profileData.name=p.name),p?.fullName&&(i.profileData.name=p.fullName),Bt(i.profileData),it(),V(),document.dispatchEvent(new Event("profile:changed"))};let r=null,s=null;const l=D(t,d=>{r=d,n(r,s)}),c=D(a,d=>{s=d,n(r,s)});se=()=>{l(),c()},i.unsubscribeProfile=se}function Ia(){const e=(l,c="")=>{const d=o(l);d&&(d.value=c)};e("pfName"),e("pfGoogleEmail"),e("pfBirthday"),e("pfFavoriteColor","#22c55e");const t=o("pfColorPreview");t&&(t.style.background="#22c55e");const a=o("pfColorCode");a&&(a.textContent="#22C55E");const n=o("pfUniversity")||o("uniSel");n&&(n.value="");const r=o("pfCareer")||o("careerSel");r&&(r.value="",r.disabled=!0),e("pfEmailUni"),e("pfPhone"),Te(null);const s=o("pfBirthday");s&&delete s.dataset?.dirty}function Bt(e){const t=o("pfName"),a=o("pfBirthday"),n=o("pfUniversity")||o("uniSel"),r=o("pfCustomUniWrap"),s=o("pfCustomUniversity"),l=o("pfCareer")||o("careerSel"),c=o("pfFavoriteColor"),d=o("pfColorPreview"),m=o("pfColorCode"),u=o("pfEmailUni")||o("pfEmail"),p=o("pfPhone")||o("pfTelefono"),f=o("pfGoogleEmail"),v=o("pfCancelBtn"),S=(h,y)=>{if(!l)return;l.innerHTML='<option value="">Selecciona tu carrera‚Ä¶</option>';const b=Ft[h]||[];for(const{value:E,label:U}of b){const j=document.createElement("option");j.value=E,j.textContent=U,l.appendChild(j)}l.disabled=b.length===0,y&&b.some(E=>E.value===y)?l.value=y:l.value=""};if(v&&!v.dataset.bound&&(v.onclick=()=>Bt(i.profileData||null),v.dataset.bound="1"),f&&i.currentUser?.email&&(f.value=i.currentUser.email),u&&(u.value=e?.uniEmail||""),p&&(p.value=e?.phone||""),t&&(t.value=e?.fullName||e?.name||""),a){const h=Nr(e?.birthday||""),y=document.activeElement===a,b=a.dataset.dirty==="1";!y&&!b&&(a.value=h||"",h?a.setAttribute("value",h):a.removeAttribute("value")),a.dataset.bound||(a.addEventListener("change",E=>{const U=E.target.value||"";a.dataset.dirty="1",a.value=U,U?a.setAttribute("value",U):a.removeAttribute("value"),i.profileData={...i.profileData||{},birthday:U}}),a.addEventListener("paste",E=>E.preventDefault()),a.addEventListener("drop",E=>E.preventDefault()),a.dataset.bound="1")}if(n){const h=e?.university||"";h==="Universidad Mayor"?n.value="UMAYOR":h==="UTFSM"||h==="USM"?n.value="USM":n.value=h}r&&r.classList.add("hidden"),s&&(s.value="");const x=n?.value==="OTRA";r&&r.classList.toggle("hidden",!x),x&&s&&(s.value=e?.customUniversity||"");const B=$t(e?.favoriteColor)?e.favoriteColor:"#22c55e";c&&(c.value=B),d&&(d.style.background=B),m&&(m.textContent=B.toUpperCase()),S(n?.value,e?.career||""),n&&(n.onchange=()=>{const h=n.value==="OTRA";r&&r.classList.toggle("hidden",!h),!h&&s&&(s.value=""),S(n.value,null)}),c&&!c.dataset.bound&&(c.addEventListener("input",h=>{const y=h.target.value;$t(y)&&(d&&(d.style.background=y),m&&(m.textContent=y.toUpperCase()))}),c.dataset.bound="1");const P=o("pfAvatarBtn"),k=o("pfAvatarFile");Te(e?.avatarData||"emoji:üë®‚Äçüéì");let H=document.getElementById("pfDeleteAvatarBtn");H||(H=document.createElement("button"),H.id="pfDeleteAvatarBtn",H.className="btn btn-secondary",H.textContent="Eliminar foto de perfil",P.insertAdjacentElement("afterend",H)),k&&!k.dataset.bound&&(k.addEventListener("change",async h=>{const y=h.target.files?.[0];if(y){if(!/^image\//.test(y.type)){alert("Elige una imagen v√°lida.");return}try{const b=await la(y),E=ca(b,256,.82);if(Te(E),!i.currentUser)return;await I(w(g,"users",i.currentUser.uid),{avatarData:E,avatarUpdatedAt:Date.now()}),P.textContent="Avatar actualizado ‚úì",setTimeout(()=>P.textContent="Cambiar avatar",1500)}catch(b){console.error(b),alert("No se pudo procesar la imagen.")}finally{h.target.value=""}}}),k.dataset.bound="1"),H.dataset.bound||(H.addEventListener("click",async()=>{if(i.currentUser&&confirm("¬øSeguro que deseas eliminar tu foto de perfil?"))try{await I(w(g,"users",i.currentUser.uid),{avatarData:null,avatarUrl:null,avatarUpdatedAt:Date.now()}),Te("emoji:üë®‚Äçüéì"),alert("Avatar eliminado. Se restaur√≥ el emoji predeterminado üë®‚Äçüéì.")}catch(h){console.error(h),alert("No se pudo eliminar el avatar.")}}),H.dataset.bound="1"),k&&!k.dataset.bound&&(k.addEventListener("change",async h=>{const y=h.target.files?.[0];if(y){if(!/^image\//.test(y.type)){alert("Elige una imagen.");return}try{const b=await la(y),E=ca(b,256,.82);if(Te(E),!i.currentUser)return;await I(w(g,"users",i.currentUser.uid),{avatarData:E,avatarUpdatedAt:Date.now()}),P&&(P.textContent="Avatar actualizado ‚úì",setTimeout(()=>P.textContent="Cambiar avatar",1500))}catch(b){console.error(b),alert("No se pudo procesar la imagen.")}finally{h.target.value=""}}}),k.dataset.bound="1");const L=o("pfSaveBtn");L&&!L.dataset.bound&&(L.onclick=()=>Ta(),L.dataset.bound="1")}async function Ta(){if(!i.currentUser)return;const e=o("pfUniversity")||o("uniSel"),t=o("pfCareer")||o("careerSel"),a=o("pfFavoriteColor")?.value||null,n=((o("pfEmailUni")||o("pfEmail"))?.value||"").trim(),r=((o("pfPhone")||o("pfTelefono"))?.value||"").trim(),s=i.currentUser.uid,l=e?.value||null;if(!(!n||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n))){alert("Email universitario no es v√°lido.");return}if(!(!r||/^[+()\s0-9-]{6,}$/.test(r))){alert("Tel√©fono no es v√°lido.");return}const c=t&&Ft[l]?.some(x=>x.value===t.value)?t.value:null,d=o("pfBirthday")?.value||null,m=i.profileData?.birthday||null,u=Dr(d,m),p={name:o("pfName")?.value.trim()||null,birthday:u??null,university:l,customUniversity:l==="OTRA"&&o("pfCustomUniversity")&&o("pfCustomUniversity").value.trim()||null,career:c,favoriteColor:$t(a)?a:null,uniEmail:n||null,phone:r||null,updatedAt:Date.now()};await I(w(g,"users",i.currentUser.uid),{avatarData:null,avatarUrl:null,avatarUpdatedAt:null});const f=w(g,"users",s,"profile","profile");await Z(f,p,{merge:!0}),i.profileData={...i.profileData||{},...p};const v=document.getElementById("pfSaveBtn");if(v){const x=v.textContent;v.textContent="Guardado ‚úì",v.disabled=!0,setTimeout(()=>{v.textContent=x,v.disabled=!1},1800)}const S=document.getElementById("pfBirthday");S&&delete S.dataset.dirty}function it(){const e=!!(i.profileData&&i.profileData.university&&(i.profileData.university!=="OTRA"||i.profileData.university==="OTRA"&&i.profileData.customUniversity?.trim()));o("semNoticeNoUni")?.classList.toggle("hidden",e),o("createSemesterBtn")&&(o("createSemesterBtn").disabled=!e||!i.currentUser),o("semesterLabel")&&(o("semesterLabel").disabled=!e),o("semesterUniFromProfile")&&(o("semesterUniFromProfile").value=e?kr(i.profileData):""),o("createPairBtn")&&(o("createPairBtn").disabled=!i.currentUser)}function kr(e){return!e||!e.university?"":e.university==="OTRA"?e.customUniversity||"Otra":e.university==="UMAYOR"?"Universidad Mayor":e.university==="USM"?"UTFSM":e.university}function $t(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function Na(){const e=o("page-perfil");if(!e)return;let t=o("partnerProfileCard");t||(t=document.createElement("div"),t.className="card",t.id="partnerProfileCard",t.innerHTML=`
      <h3 style="margin-top:0">Perfil de la otra persona</h3>
      <div id="pp-avatar" style="width:64px;height:64px;border-radius:50%;
        background:#444;background-size:cover;background-position:center;margin-bottom:8px;"></div>
      <div id="pp-name"><b>Nombre:</b> ‚Äî</div>
      <div id="pp-uni"><b>Universidad:</b> ‚Äî</div>
      <div id="pp-career"><b>Carrera:</b> ‚Äî</div>
      <div id="pp-bday" class="muted"><b>Nacimiento:</b> ‚Äî</div>
      <div id="pp-color"><b>Color favorito:</b>
        <span id="pp-color-swatch"
          style="display:inline-block;width:16px;height:16px;border-radius:4px;vertical-align:middle;margin:0 6px;background:#ff69b4;border:1px solid rgba(255,255,255,.25)">
        </span>
        <span id="pp-color-code">‚Äî</span>
      </div>
      <div id="pp-email"><b>Email universitario:</b> ‚Äî</div>
      <div id="pp-phone"><b>Tel√©fono:</b> ‚Äî</div>
    `,t.classList.add("hidden"),e.appendChild(t));const a=()=>{o("pp-name").innerHTML="<b>Nombre:</b> ‚Äî",o("pp-uni").innerHTML="<b>Universidad:</b> ‚Äî",o("pp-career").innerHTML="<b>Carrera:</b> ‚Äî",o("pp-bday").innerHTML="<b>Fecha de nacimiento:</b> ‚Äî",o("pp-email").innerHTML="<b>Email universitario:</b> ‚Äî",o("pp-phone").innerHTML="<b>Tel√©fono:</b> ‚Äî",o("pp-color-code").textContent="‚Äî";const f=o("pp-color-swatch");f&&(f.style.background="transparent",f.style.border="1px solid rgba(255,255,255,.25)")};if(_e&&(_e(),_e=null),!i.pairOtherUid){a(),t&&t.classList.add("hidden");return}const n=w(g,"users",i.pairOtherUid),r=w(g,"users",i.pairOtherUid,"profile","profile");t.classList.remove("hidden");let s=null,l=null;const c=()=>{const f={...s?.data()||{},...l?.data()||{}},v=o("pp-avatar");v&&(f.avatarData?(v.style.backgroundImage=`url("${f.avatarData}")`,v.textContent=""):(v.style.backgroundImage="none",v.textContent="üë®‚Äçüéì",v.style.display="flex",v.style.alignItems="center",v.style.justifyContent="center",v.style.fontSize="2rem")),o("pp-name").innerHTML=`<b>Nombre:</b> ${f.name||"‚Äî"}`,o("pp-uni").innerHTML=`<b>Universidad:</b> ${m(f)}`,o("pp-career").innerHTML=`<b>Carrera:</b> ${f.career?f.career==="ICTEL"?"Ing. Civil Telem√°tica":"Medicina Veterinaria":"‚Äî"}`,o("pp-bday").innerHTML=`<b>Fecha de nacimiento:</b> ${d(f.birthday)}`,o("pp-email").innerHTML=`<b>Email universitario:</b> ${f.uniEmail||"‚Äî"}`,o("pp-phone").innerHTML=`<b>Tel√©fono:</b> ${f.phone||"‚Äî"}`;const S=typeof f.favoriteColor=="string"&&/^#[0-9A-Fa-f]{6}$/.test(f.favoriteColor)?f.favoriteColor:"#ff69b4",x=o("pp-color-swatch");x&&(x.style.background=S);const B=o("pp-color-code");B&&(B.textContent=S.toUpperCase())},d=f=>{if(!f)return"‚Äî";const v=/^(\d{4})-(\d{2})-(\d{2})$/.exec(f);return v?`${v[3]}/${v[2]}/${v[1]}`:f},m=f=>f?.university?f.university==="UMAYOR"?"Universidad Mayor":f.university==="USM"?"UTFSM":f.university==="OTRA"?f.customUniversity||"Otra":f.university:"‚Äî",u=D(n,f=>{s=f,c()}),p=D(r,f=>{l=f,c()});_e=()=>{u(),p()}}document.addEventListener("pair:ready",()=>{Na()});function Or(){const e=document.getElementById("pfUniversity")||document.getElementById("uniSel"),t=document.getElementById("pfCareer")||document.getElementById("careerSel");if(!e||!t)return;const a=()=>{const n=Ft[e.value]||[];t.innerHTML='<option value="">Selecciona tu carrera‚Ä¶</option>';for(const{value:r,label:s}of n){const l=document.createElement("option");l.value=r,l.textContent=s,t.appendChild(l)}t.disabled=n.length===0};e.addEventListener("change",a),a()}const Pr=Object.freeze(Object.defineProperty({__proto__:null,clearProfileUI:Ia,ensureCareerBindingOnLoad:Or,fillProfileForm:Bt,listenProfile:$a,mountPartnerProfileCard:Na,reflectProfileInSemestersUI:it,saveProfile:Ta,stopProfileListener:Tr},Symbol.toStringTag,{value:"Module"}));let me=null;new URLSearchParams(location.search).has("debug")||window?.duoplannerDebug;function Hr(){const e=o("createPairBtn"),t=o("copyInviteBtn"),a=o("joinByCodeBtn"),n=o("joinCode"),r=o("deletePairBtn");e?.addEventListener("click",Fr),t?.addEventListener("click",Br);const s=async()=>{const l=(n?.value||"").trim(),c=Yr(l);c?await _r(c):alert("Pega un ID v√°lido (o un link con ?pair=ID)."),n&&(n.value="")};a?.addEventListener("click",s),n?.addEventListener("keydown",l=>{l.key==="Enter"&&s()}),r?.addEventListener("click",zr)}async function Rr(){if(!i.currentUser)return;const e=J(C(g,"pairs")),t=await $(e),a=[];t.forEach(l=>{const c=l.data()||{};Array.isArray(c.members)&&c.members.includes(i.currentUser.uid)&&a.push({id:l.id,...c})}),a.sort((l,c)=>(Number(c.createdAt)||0)-(Number(l.createdAt)||0));const n=a[0]||null;i.currentPairId=n?.id||null,i.pairOtherUid=n&&(n.members||[]).find(l=>l!==i.currentUser.uid)||null;const r=o("pairId"),s=o("copyInviteBtn");r&&(r.textContent=i.currentPairId||"‚Äî"),s&&(s.disabled=!i.currentPairId),je(),V(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}})),jt(i.currentPairId)}async function Fr(){if(!i.currentUser)return;const e=w(C(g,"pairs"));await Z(e,{members:[i.currentUser.uid],createdAt:Date.now(),visibility:{showCourseNames:!0,showOnlyBusyFree:!1}}),await Da(e.id),i.currentPairId=e.id,i.pairOtherUid=null;const t=o("pairId"),a=o("copyInviteBtn");t&&(t.textContent=e.id),a&&(a.disabled=!1),je(),V(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}})),jt(e.id)}async function Br(){if(!i.currentPairId)return;const e=i.currentPairId,t=o("copyInviteBtn");if(await jr(e)||qr(e),t){const a=t.textContent;t.textContent="¬°ID copiado!",setTimeout(()=>{t.textContent=a||"Copiar ID"},1800)}}async function jr(e){try{return await navigator.clipboard.writeText(e),!0}catch{return!1}}function qr(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch{}document.body.removeChild(t)}function Yr(e){if(!e)return"";const t=String(e).trim();try{const n=new URL(t).searchParams.get("pair");if(n)return n.trim()}catch{}const a=t.match(/[?&]pair=([A-Za-z0-9_-]+)/);return a?a[1]:t.replace(/[^A-Za-z0-9_-]/g,"")||""}async function _r(e){if(!i.currentUser)return;const t=w(g,"pairs",e),a=await Y(t);if(!a.exists()){alert("El ID de party no existe");return}const n=a.data()||{},r=Array.isArray(n.members)?n.members:[];if(!r.includes(i.currentUser.uid)&&r.length>=2){alert("Esta party ya tiene 2 miembros.");return}r.includes(i.currentUser.uid)||await I(t,{members:xr(i.currentUser.uid),updatedAt:Date.now()}),await Da(e);const s=(await Y(t)).data()||{};i.currentPairId=e,i.pairOtherUid=(s.members||[]).find(u=>u!==i.currentUser.uid)||null;const l=w(g,"users",i.currentUser.uid),c={pairUid:i.pairOtherUid||null,currentPairId:e};try{await I(l,c)}catch{await Z(l,c,{merge:!0})}const d=o("pairId"),m=o("copyInviteBtn");d&&(d.textContent=e),m&&(m.disabled=!1),je(),V(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}})),jt(e)}function jt(e){if(me&&(me(),me=null),!e)return;const t=w(g,"pairs",e),a=i.currentUser?.uid||null;me=D(t,async n=>{if(!n.exists()){ka();return}const r=n.data()||{},s=(Array.isArray(r.members)?r.members:[]).find(d=>d!==a)||null;i.currentPairId=e,i.pairOtherUid=s;try{const d=w(g,"users",a);await Z(d,{pairUid:s||null,currentPairId:e},{merge:!0})}catch{}const l=o("pairId"),c=o("copyInviteBtn");l&&(l.textContent=e),c&&(c.disabled=!1),je(),V(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}}))})}async function zr(){if(!i.currentUser||!i.currentPairId)return;const e=i.currentPairId,t=w(g,"pairs",e);if(confirm("¬øQuieres eliminar la party para ambos? La otra persona tambi√©n se saldr√°.")){try{await Q(t)}catch{try{await I(t,{members:[]}),await Q(t)}catch{}}ka(),alert("Party eliminada para ambos.")}}async function Da(e){const t=J(C(g,"pairs")),a=await $(t),n=i.currentUser.uid,r=[];a.forEach(s=>{const l=s.data()||{};s.id!==e&&Array.isArray(l.members)&&l.members.includes(n)&&r.push(I(w(g,"pairs",s.id),{members:Lr(n)}).then(async()=>{const c=await Y(w(g,"pairs",s.id));if((c.exists()?c.data().members||[]:[]).length===0)try{await Q(w(g,"pairs",s.id))}catch{}}))}),await Promise.all(r)}function ka(){me&&(me(),me=null),i.currentPairId=null,i.pairOtherUid=null;const e=o("pairId"),t=o("copyInviteBtn");e&&(e.textContent="‚Äî"),t&&(t.disabled=!0),je(),V(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}}))}function je(){const e=!!(i.currentPairId&&i.pairOtherUid),t=o("subtabCompartido"),a=o("horarioCompartido");t?.setAttribute("aria-disabled",e?"false":"true"),t&&(t.disabled=!e),a&&(e?a.classList.remove("disabled"):(a.classList.add("disabled"),a.innerHTML='<div class="muted">Horario de la otra persona (debes emparejarte primero).</div>'))}let ot="#22c55e",lt="#ff69b4",ze=null,da=!1,ct=!1,Ee=null;const we=80,ua=28;let Oa=[],It=[];const Pe=["Lun","Mar","Mi√©","Jue","Vie"];function Gr(e){if(!ct)return;const t=e.clientY,a=window.innerHeight;let n=0;if(t<we){const r=(we-t)/we;n=-Math.ceil(ua*r)}else if(t>a-we){const r=(t-(a-we))/we;n=Math.ceil(ua*r)}n!==0&&Ee===null&&(Ee=requestAnimationFrame(()=>{window.scrollBy(0,n),Ee=null}))}function ma(){ct=!1,Ee&&(cancelAnimationFrame(Ee),Ee=null)}const xe=[{label:"1/2",start:"08:15",end:"09:25",lines:[{n:"1",start:"08:15",end:"08:50"},{n:"2",start:"08:50",end:"09:25"}]},{label:"3/4",start:"09:40",end:"10:50",lines:[{n:"3",start:"09:40",end:"10:15"},{n:"4",start:"10:15",end:"10:50"}]},{label:"5/6",start:"11:05",end:"12:15",lines:[{n:"5",start:"11:05",end:"11:40"},{n:"6",start:"11:40",end:"12:15"}]},{label:"7/8",start:"12:30",end:"13:40",lines:[{n:"7",start:"12:30",end:"13:05"},{n:"8",start:"13:05",end:"13:40"}]},{label:"ALMUERZO",start:"13:40",end:"14:40",lunch:!0},{label:"9/10",start:"14:40",end:"15:50",lines:[{n:"9",start:"14:40",end:"15:15"},{n:"10",start:"15:15",end:"15:50"}]},{label:"11/12",start:"16:05",end:"17:15",lines:[{n:"11",start:"16:05",end:"16:40"},{n:"12",start:"16:40",end:"17:15"}]},{label:"13/14",start:"17:30",end:"18:40",lines:[{n:"13",start:"17:30",end:"18:05"},{n:"14",start:"18:05",end:"18:40"}]},{label:"15/16",start:"18:55",end:"20:05",lines:[{n:"15",start:"18:55",end:"19:30"},{n:"16",start:"19:30",end:"20:05"}]},{label:"17/18",start:"20:20",end:"21:30",lines:[{n:"17",start:"20:20",end:"20:55"},{n:"18",start:"20:55",end:"21:30"}]},{label:"19/20",start:"21:45",end:"22:55",lines:[{n:"19",start:"21:45",end:"22:20"},{n:"20",start:"22:20",end:"22:55"}]}],qt=[X("1/2","08:30","09:40",["08:30-09:05","09:05-09:40"]),X("3/4","10:00","11:10",["10:00-10:35","10:35-11:10"]),X("5/6","11:30","12:40",["11:30-12:05","12:05-12:40"]),{label:"ALMUERZO",start:"12:40",end:"14:00",lunch:!0},X("7/8","14:00","15:10",["14:00-14:35","14:35-15:10"]),X("9/10","15:30","16:40",["15:30-16:05","16:05-16:40"]),X("11/12","17:00","18:10",["17:00-17:35","17:35-18:10"]),X("13/14","18:30","19:40",["18:30-19:05","19:05-19:40"]),X("15/16","20:00","21:10",["20:00-20:35","20:35-21:10"]),X("17/18","21:30","22:40",["21:30-22:05","22:05-22:40"])];function X(e,t,a,n){return{label:e,start:t,end:a,lines:n.map(r=>{const[s,l]=r.split("-");return{start:s,end:l}})}}function Pa(e){if(!e)return"";const t=String(e).toLowerCase();return t==="umayor"||t.includes("mayor")?"UMAYOR":t==="usm"||t==="utfsm"||t.includes("utfsm")||t.includes("santa mar√≠a")||t.includes("santa maria")?"USM":"OTRA"}function Ha(){const e=i.activeSemesterData?.universityAtThatTime||i.profileData?.university||"";return Pa(e)}function Tt(){return Ha()==="UMAYOR"?qt:xe}function Ra(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function Yt(e,t,a){const n=(e||[]).find(r=>r.id===t);return Ra(n?.color)?n.color:a||"#3B82F6"}function _t(e){try{const t=parseInt(e.slice(1,3),16),a=parseInt(e.slice(3,5),16),n=parseInt(e.slice(5,7),16);return(t*299+a*587+n*114)/1e3>=160?"#111":"#fff"}catch{return"#0e0e0e"}}let Ge=null,G=[];function Wr(){if(da)return;da=!0,Jr(),Qr(),Xr(),en(),tn(),Ve(),document.addEventListener("pair:ready",m=>{if(m.detail?.otherUid)fa(),Ve();else{const u=o("sh-semSel");u&&(u.innerHTML="<option disabled selected>Sin compa√±ero</option>")}}),o("sh-semSel")?.addEventListener("change",m=>{i.shared.horario.semId=m.target.value||null,at(i.shared.horario.semId)});const e=o("subtabPropio"),t=o("subtabCompartido"),a=o("subtabCombinado"),n=o("horarioPropio"),r=o("horarioCompartido"),s=o("horarioCombinado");function l(){e.classList.add("active"),t.classList.remove("active"),a.classList.remove("active"),n.classList.remove("hidden"),r.classList.add("hidden"),s.classList.add("hidden")}function c(){if(t.getAttribute("aria-disabled")==="true"){alert("Debes emparejarte primero para ver el horario de la otra persona.");return}t.classList.add("active"),e.classList.remove("active"),a.classList.remove("active"),r.classList.remove("hidden"),n.classList.add("hidden"),s.classList.add("hidden");const m=o("sh-semSel");if(m&&!m.value){const u=Array.from(m.options).find(p=>p.value);u&&(m.value=u.value),m?.value&&(i.shared.horario.semId=m.value)}i.shared?.horario?.semId?at(i.shared.horario.semId):fa().then(()=>Ve())}function d(){a.classList.add("active"),e.classList.remove("active"),t.classList.remove("active"),s.classList.remove("hidden"),n.classList.add("hidden"),r.classList.add("hidden"),Gt()}e.addEventListener("click",l),t.addEventListener("click",c),a.addEventListener("click",d),l(),document.addEventListener("courses:changed",()=>{zt(),ge()}),document.addEventListener("click",async m=>{const u=m.target.closest(".block-del-btn");if(!u)return;const p=u.dataset.id;if(!(!p||!i.currentUser||!i.activeSemesterId)&&confirm("¬øEliminar este bloque del horario?"))try{await Q(w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",p))}catch(f){console.error(f),alert("No se pudo eliminar el bloque.")}}),setTimeout(async()=>{i.pairOtherUid&&i.activeSemesterData?.label&&(await Ve(),i.shared?.horario?.semId&&await at(i.shared.horario.semId))},1500)}function wt(){if(Ge&&(Ge(),Ge=null),G=[],ge(),!i.currentUser||!i.activeSemesterId)return;const e=C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule");Ge=D(J(e),t=>{G=t.docs.map(a=>({id:a.id,...a.data()})),ge()})}function Jr(){const e=o("horarioPropio");e.innerHTML=`
  <div class="card" style="margin-bottom:12px">
    <h3 style="margin:0 0 10px">Paleta de ramos</h3>
    <div id="coursePalette" class="palette"></div>
    <div class="muted" style="margin-top:6px">
      <ul style="margin:4px 0 0 20px; padding:0; list-style:disc;">
        <li>Arrastra un ramo a un m√≥dulo.</li>
        <li>Puedes arrastrar ramos del mismo horario.</li>
        <li>La pre-vista indica <b>arriba</b>, <b>completo</b>, <b>abajo</b>, <b>izquierda</b> o <b>derecha</b>.</li>
        <li>Para eliminar un bloque, haz <b>click</b> en la X.</li>
        <li>Para editar un bloque, haz <b>click</b> sobre √©l.</li>
        <li>Para editar una sala, haz <b>click derecho</b> sobre √©l.</li>
        <li>Para ver su sala, pase el mouse por encima.</li>
      </ul>
    </div>
  </div>
  <div id="schedUSM" class="sched-usm card"></div>
`,zt(),ge()}function Vr(){zt(),ge()}function zt(){const e=o("coursePalette");if(!e)return;e.innerHTML="";const t=Array.isArray(i.courses)?i.courses:[];if(t.length===0){e.innerHTML='<div class="muted">No hay ramos en el semestre activo.</div>';return}t.forEach(a=>{const n=document.createElement("div");n.className="palette-chip",n.setAttribute("draggable","true"),n.dataset.courseId=a.id,n.textContent=a.name;const r=Ra(a.color)?a.color:"#3B82F6";n.style.borderColor=r,n.style.boxShadow="inset 0 0 0 2px rgba(0,0,0,.15)",e.appendChild(n)})}function ge(){const e=o("schedUSM");if(!e)return;const t=Tt();Oa=t;const a=Ha()==="USM",n=a?"Bloque":"M√≥dulo";e.innerHTML=`
    <div class="usm-grid2">
      <div class="cell header">${n}</div>
      ${Pe.map(r=>`<div class="cell header">${r}</div>`).join("")}
      ${t.map((r,s)=>`
        <div class="cell mod ${r.lunch?"lunch":""}" data-slot="${s}">
          ${Fa(r,s,a?"USM":"UMAYOR")}
        </div>
        ${Pe.map((l,c)=>`
          <div class="cell slot ${r.lunch?"is-lunch":""}"
               data-day="${c}" data-slot="${s}"
               ${r.lunch?'aria-disabled="true"':""}>
            ${Zr(c,s)}
          </div>
        `).join("")}
      `).join("")}
    </div>
  `,Ba(),e.querySelectorAll(".placed").forEach(r=>{if(!r.querySelector(".block-del-btn")){const s=document.createElement("button");s.className="block-del-btn",s.textContent="√ó",s.dataset.id=r.dataset.id,r.appendChild(s)}})}function Fa(e,t,a){if(e.lunch)return`
      <div class="mod-label">ALMUERZO</div>
      <div class="mod-time">${e.start}‚Äì${e.end}</div>
    `;const n=(It.length?It:Oa).slice(0,t).filter(r=>!r.lunch).length;if(a==="USM"){const r=n*2+1,s=r+1;return`
      <div class="mod-lines">
        <div class="line-num">${r}</div>
        <div class="line-time">${e.lines[0].start}‚Äì${e.lines[0].end}</div>
        <div class="line-num">${s}</div>
        <div class="line-time">${e.lines[1].start}‚Äì${e.lines[1].end}</div>
      </div>
    `}else return`
      <div class="mod-lines">
        <div class="line-num">${n+1}</div>
        <div class="line-time">${e.start}‚Äì${e.end}</div>
      </div>
    `}function Zr(e,t){const a=G.filter(r=>r.day===e&&r.slot===t);if(!a.length)return"";const n=r=>{const s=a.filter(l=>(l.pos||"full")===r);return s.length?s.sort((l,c)=>{const d={left:0,single:1,right:2};return(d[l.hpos||"single"]??1)-(d[c.hpos||"single"]??1)}).map(l=>Kr(l,r)).join(""):""};return`
    ${n("top")}
    ${n("full")}
    ${n("bottom")}
  `}function Kr(e,t){const a=(i.courses||[]).find(m=>m.id===e.courseId)?.name||"Ramo",n=typeof e.displayName=="string"&&e.displayName.trim()?e.displayName.trim():a,r=Yt(i.courses,e.courseId,ot),s=_t(r),l=typeof e.room=="string"&&e.room.trim()?e.room.trim():null,c=e.hpos||"single",d=`${n}${l?` ¬∑ Sala: ${l}`:""}`;return`
  <div class="placed pos-${t} h-${c}" data-id="${e.id}"
       draggable="true"
       title="${d}"
       style="background:${r}; border:1px solid rgba(0,0,0,0.25);">
    <div class="placed-title" style="color:${s}; font-weight:600;">${n}</div>
  </div>
`}function Qr(){window.addEventListener("dragover",Gr,{passive:!0}),document.addEventListener("drop",ma),document.addEventListener("dragend",ma),document.addEventListener("dragstart",e=>{const t=e.target;t&&t.classList.contains("palette-chip")&&(e.dataTransfer.setData("text/plain",t.dataset.courseId),e.dataTransfer.effectAllowed="copy",ct=!0)}),document.addEventListener("dragstart",e=>{const t=e.target.closest(".placed");t&&(e.dataTransfer.setData("text/plain",JSON.stringify({type:"move-block",id:t.dataset.id})),e.dataTransfer.effectAllowed="move",ct=!1)}),Ba()}function Xr(){document.addEventListener("click",e=>{const t=e.target.closest(".placed-title");if(!t||!t.closest("#schedUSM")||document.querySelector("input.inline-rename"))return;const a=t.closest(".placed");if(!a)return;const n=a.dataset.id,r=G.find(u=>u.id===n);if(!r)return;const s=(i.courses||[]).find(u=>u.id===r.courseId)?.name||t.textContent.trim(),l=typeof r.displayName=="string"&&r.displayName.trim()?r.displayName.trim():s,c=document.createElement("input");c.type="text",c.className="inline-rename",c.value=l;const d=Math.max(t.offsetWidth,140);c.style.width=d+"px",t.replaceWith(c),c.focus(),c.select();const m=async u=>{const p=document.createElement("div");p.className="placed-title";const f=(c.value||"").trim();if(p.textContent=u?f||s:l,c.replaceWith(p),!!u&&f!==l&&!(!i.currentUser||!i.activeSemesterId))try{const v=w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",r.id);await I(v,f?{displayName:f}:{displayName:null});const S=G.findIndex(x=>x.id===r.id);S>=0&&(G[S].displayName=f||null)}catch(v){console.error("rename error",v),alert("No se pudo renombrar el bloque. Intenta nuevamente."),p.textContent=l}};c.addEventListener("keydown",u=>{u.key==="Enter"&&(u.preventDefault(),m(!0)),u.key==="Escape"&&(u.preventDefault(),m(!1))}),c.addEventListener("blur",()=>m(!0))})}function en(){document.addEventListener("contextmenu",async e=>{const t=e.target.closest(".placed");if(!t||!t.closest("#schedUSM"))return;e.preventDefault();const a=t.dataset.id,n=G.find(c=>c.id===a);if(!n||!i.currentUser||!i.activeSemesterId)return;const r=(n.room||"").trim(),s=prompt("Sala del ramo (deja vac√≠o para borrar):",r);if(s===null)return;const l=(s||"").trim();try{const c=w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",n.id);await I(c,{room:l||null});const d=G.findIndex(m=>m.id===n.id);d>=0&&(G[d].room=l||null),ge()}catch(c){console.error("room update error",c),alert("No se pudo actualizar la sala. Intenta nuevamente.")}})}function Ba(){document.querySelectorAll(".cell.slot").forEach(e=>{e.classList.contains("is-lunch")||(e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect=t.dataTransfer.effectAllowed==="move"?"move":"copy";const a=e.getBoundingClientRect(),n=t.clientX-a.left,r=t.clientY-a.top,s=a.height/2;let l="full";r<s-10?l="top":r>s+10&&(l="bottom");let c="single";const d=n/a.width;d<.4?c="left":d>.6&&(c="right"),e.dataset.droppos=l,e.dataset.droph=c,e.classList.add("over"),e.classList.remove("hint-top","hint-full","hint-bottom","hint-left","hint-center","hint-right"),l==="top"&&e.classList.add("hint-top"),l==="full"&&e.classList.add("hint-full"),l==="bottom"&&e.classList.add("hint-bottom"),c==="left"&&e.classList.add("hint-left"),c==="single"&&e.classList.add("hint-center"),c==="right"&&e.classList.add("hint-right")}),e.addEventListener("dragleave",()=>re(e)),e.addEventListener("drop",async t=>{t.preventDefault();const a=t.dataTransfer.getData("text/plain");if(!a)return;const n=parseInt(e.dataset.day,10),r=parseInt(e.dataset.slot,10),s=e.dataset.droppos||"full",l=e.dataset.droph||"single";let c=null;try{c=JSON.parse(a)}catch{}if(c&&c.type==="move-block"){const p=c.id;if(!G.find(f=>f.id===p))return;if(!i.currentUser||!i.activeSemesterId){alert("Selecciona un semestre activo antes de mover bloques."),re(e);return}try{const f=w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",p),v=Tt()[r];await I(f,{day:n,slot:r,pos:s,hpos:l,start:v.start,end:v.end,updatedAt:Date.now()});const S=G.findIndex(x=>x.id===p);S>=0&&Object.assign(G[S],{day:n,slot:r,pos:s,hpos:l,start:v.start,end:v.end}),ge()}catch(f){console.error("move error",f),alert("No se pudo mover el bloque (error Firestore): "+(f?.message||f))}re(e);return}const d=a;if(!i.currentUser||!i.activeSemesterId){alert("Selecciona un semestre."),re(e);return}const m=G.filter(p=>p.day===n&&p.slot===r).filter(p=>(p.pos||"full")===s);if(m.length>=2){alert("Esta zona ya tiene dos ramos (izq/der)."),re(e);return}if(m.length===1){const p=m[0],f=p.hpos||"single";if(s==="full"&&l==="single"){alert("Ya hay un ramo aqu√≠. Elige izquierda o derecha."),re(e);return}if(f==="single"){const v=l==="left"?"right":"left";try{await I(w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",p.id),{hpos:v})}catch{}}else if(f===l){alert("Ese lado ya est√° ocupado. Prueba el otro lado."),re(e);return}}const u=Tt()[r];await $e(C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule"),{courseId:d,day:n,slot:r,start:u.start,end:u.end,pos:s,hpos:l,createdAt:Date.now()}),re(e)}))})}function re(e){e.classList.remove("over","hint-top","hint-full","hint-bottom","hint-left","hint-center","hint-right"),delete e.dataset.droppos,delete e.dataset.droph}let We=null,dt=[],Je=null,ut=[],Nt=xe,De="USM";function tn(){const e=o("horarioCompartido");e&&(e.innerHTML=`
    <div class="card" style="margin-bottom:12px">
      <div class="row" style="align-items:flex-end;gap:12px">
        <div>
          <label>Semestre de la otra persona</label><br/>
          <select id="sh-semSel"></select>
        </div>
        <div class="muted">Elige un semestre (ej. 2025-2) para ver el horario de la otra persona en vivo.</div>
      </div>
    </div>
    <div id="schedSharedUSM" class="sched-usm card"></div>
  `,Ne())}function Ne(){const e=o("schedSharedUSM");if(!e)return;const t=Nt||xe;It=t;const a=De==="USM"?"Bloque":"M√≥dulo";e.innerHTML=`
    <div class="usm-grid2">
      <div class="cell header">${a}</div>
      ${Pe.map(n=>`<div class="cell header">${n}</div>`).join("")}
      ${t.map((n,r)=>`
        <div class="cell mod ${n.lunch?"lunch":""}" data-slot="${r}">
          ${Fa(n,r,De)}
        </div>
        ${Pe.map((s,l)=>`
          <div class="cell slot ${n.lunch?"is-lunch":""}"
               data-day="${l}" data-slot="${r}">
            ${an(l,r)}
          </div>
        `).join("")}
      `).join("")}
    </div>
  `}function an(e,t){const a=dt.filter(r=>r.day===e&&r.slot===t),n=r=>{const s=a.filter(l=>(l.pos||"full")===r);return s.length?s.sort((l,c)=>{const d={left:0,single:1,right:2};return(d[l.hpos||"single"]??1)-(d[c.hpos||"single"]??1)}).map(l=>rn(l,r)).join(""):""};return`
    ${n("top")}
    ${n("full")}
    ${n("bottom")}
  `}function rn(e,t,a,n){const r=ut||[],s=r.find(p=>p.id===e.courseId)?.name||"Ramo",l=typeof e.displayName=="string"&&e.displayName.trim()?e.displayName.trim():s,c=Yt(r,e.courseId,lt),d=_t(c),m=typeof e.room=="string"&&e.room.trim()?e.room.trim():null,u=e.hpos||"single";return`
  <div class="placed pos-${t} h-${u}"
       title="${l}${m?` ¬∑ Sala: ${m}`:""}"
       style="background:${c}; border:1px solid rgba(0,0,0,0.25); margin:2px 0;">
    <div class="placed-title" style="color:${d}; font-weight:600;">${l}</div>
  </div>
`}async function at(e){We&&(We(),We=null),Je&&(Je(),Je=null),ze&&(ze(),ze=null),dt=[],ut=[],Nt=xe,De="USM",Ne(),ot=i.profileData?.favoriteColor||ot;const t=i.pairOtherUid;if(!t||!e)return;const a=w(g,"users",t,"semesters",e),n=await Y(a),r=n.exists()&&n.data().universityAtThatTime||"";De=Pa(r),Nt=De==="UMAYOR"?qt:xe,ze=D(w(g,"users",t),c=>{lt=(c.data()||{}).favoriteColor||lt,Ne()});const s=C(g,"users",t,"semesters",e,"courses");Je=D(J(s,he("name")),c=>{ut=c.docs.map(d=>({id:d.id,...d.data()})),Ne()});const l=C(g,"users",t,"semesters",e,"schedule");We=D(J(l),c=>{dt=c.docs.map(d=>({id:d.id,...d.data()})),Ne()})}let pa=0;async function fa(){const e=o("sh-semSel");if(!e)return;const t=++pa,a=f=>String(f||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim(),n=f=>{const v=a(f),S=v.replace(/[^\d\-\/ ]+/g,"").match(/(\d{4})\D*([12])$/);return S?`${S[1]}-${S[2]}`:v.toLowerCase()},r=f=>{const v=/^(\d{4})-(1|2)$/.exec(n(f));return v?{y:parseInt(v[1],10),t:parseInt(v[2],10)}:{y:-1/0,t:-1/0}};e.innerHTML="";const s=document.createElement("option");if(s.value="",s.textContent="‚Äî seleccionar ‚Äî",e.appendChild(s),!i.pairOtherUid)return;const l=C(g,"users",i.pairOtherUid,"semesters"),c=await $(J(l));if(t!==pa)return;const d=new Map;c.forEach(f=>{const v=f.data()||{},S=a(v.label||f.id),x=n(S);if(!d.has(x)){const{y:B,t:P}=r(S);d.set(x,{id:f.id,labelToShow:S,y:B,t:P})}});const m=Array.from(d.values()).sort((f,v)=>f.y!==v.y?v.y-f.y:v.t-f.t),u=document.createDocumentFragment();for(const{id:f,labelToShow:v}of m){const S=document.createElement("option");S.value=f,S.textContent=v,u.appendChild(S)}e.appendChild(u);const p=i.shared?.horario?.semId||"";if(p&&Array.from(e.options).some(f=>f.value===p))e.value=p;else{const f=Array.from(e.options).find(v=>v.value);e.value=f?f.value:"",i.shared.horario.semId=e.value||null}}async function Ve(){if(!i.pairOtherUid)return;const e=i.activeSemesterData?.label||null;if(e)try{const t=C(g,"users",i.pairOtherUid,"semesters"),a=await $(t);let n=null;if(a.forEach(r=>{const s=(r.data()?.label||"").trim();s===e&&(n={id:r.id,label:s})}),n&&(i.shared=i.shared||{},i.shared.horario=i.shared.horario||{},i.shared.horario.semId!==n.id)){i.shared.horario.semId=n.id;const r=o("sh-semSel");r&&(r.innerHTML=`<option selected>${n.label}</option>`,r.disabled=!0,r.style.pointerEvents="none",r.style.opacity="0.7"),await at(n.id),document.getElementById("horarioCombinado")&&Gt()}}catch(t){console.warn("autoSelectPartnerSemesterForSchedule",t)}}async function nn({course:e,day:t,slot:a,room:n}){if(!i.currentUser||!i.activeSemesterId)throw new Error("No logueado");const r=i.activeSemesterId,s=i.currentUser.uid,l=(i.courses||[]).find(m=>(m.name||"").toLowerCase().includes(String(e).toLowerCase()));if(!l)throw new Error("Curso no encontrado");const c=C(g,"users",s,"semesters",r,"schedule"),d=(await $(c)).docs.find(m=>{const u=m.data();return u.courseId===l.id&&u.day===t&&u.slot===a});if(!d)throw new Error("No encontr√© el bloque en el horario");return await I(d.ref,{room:n||null,updatedAt:Date.now()}),{ok:!0,room:n}}async function sn(e=null){if(!i.currentUser)throw new Error("No logueado");const t=e||i.activeSemesterId;if(!t)throw new Error("No hay semestre activo");const a=C(g,"users",i.currentUser.uid,"semesters",t,"schedule");return(await $(a)).docs.map(n=>({id:n.id,...n.data()}))}async function on(e=null){if(!i.currentUser)throw new Error("No logueado");const t=e||i.activeSemesterId;if(!t)throw new Error("No hay semestre activo");if(!i.pairOtherUid)return{items:[]};const a=C(g,"users",i.currentUser.uid,"semesters",t,"schedule"),n=(await $(a)).docs.map(c=>({...c.data()})),r=C(g,"users",i.pairOtherUid,"semesters",t,"schedule"),s=(await $(r)).docs.map(c=>({...c.data()})),l=[];for(const c of n)for(const d of s)c.day===d.day&&c.slot===d.slot&&l.push(`${["Lun","Mar","Mi√©","Jue","Vie"][c.day]} bloque ${c.slot} (${c.courseName} / ${d.courseName})`);return{items:l}}async function ln(e,t=null){if(!i.currentUser)throw new Error("No logueado");const a=t||i.activeSemesterId;return await Q(w(g,"users",i.currentUser.uid,"semesters",a,"schedule",e)),{ok:!0}}document.addEventListener("dragstart",e=>{const t=e.target.closest(".placed");t&&t.classList.add("dragging")});document.addEventListener("dragend",e=>{const t=e.target.closest(".placed");t&&t.classList.remove("dragging")});const va=480,cn=1320;function ha(e){const[t,a]=e.split(":").map(Number);return t*60+a}function ga(e){return(e-va)/(cn-va)*100}function Gt(){const e=o("horarioCombinado");e&&(e.innerHTML=`
    <div class="timeline">
      <div class="timeline-hours">
        ${Array.from({length:15},(t,a)=>`<div class="timeline-hour">${8+a}:00</div>`).join("")}
      </div>
      ${Pe.map((t,a)=>`
        <div class="timeline-day" data-day="${a}" title="${t}">
          ${dn(a)}
        </div>
      `).join("")}
    </div>
  `)}function dn(e){return[...(G||[]).map(t=>({...t,isMine:!0})),...(dt||[]).map(t=>({...t,isMine:!1}))].filter(t=>t.day===e).map(t=>{const a=ha(t.start),n=ha(t.end),r=ga(a),s=ga(n)-r,l=t.isMine?i.courses:ut,c=Yt(l,t.courseId,t.isMine?ot:lt),d=_t(c),m=l.find(v=>v.id===t.courseId),u=t.displayName||m?.name||"Ramo",p=t.room?` (${t.room})`:"",f=t.isMine?1:.6;return`
      <div class="timeline-block"
           style="top:${r}%;height:${s}%;
                  background:${c};opacity:${f};color:${d};">
        ${u}${p}
      </div>
    `}).join("")}document.addEventListener("DOMContentLoaded",()=>{const e=o("subtabCombinado"),t=o("subtabCompartido"),a=o("subtabPropio"),n=o("horarioCombinado"),r=o("horarioCompartido"),s=o("horarioPropio");e&&(e.classList.remove("hidden"),e.addEventListener("click",()=>{a?.classList.remove("active"),t?.classList.remove("active"),e.classList.add("active"),s?.classList.add("hidden"),r?.classList.add("hidden"),n?.classList.remove("hidden"),Gt()}))});const un=Object.freeze(Object.defineProperty({__proto__:null,MAYOR_SLOTS:qt,USM_SLOTS:xe,getMySchedule:sn,initSchedule:Wr,onActiveSemesterChanged:wt,overlapWithPair:on,refreshCourseOptions:Vr,removeBlock:ln,setRoom:nn},Symbol.toStringTag,{value:"Module"}));let A=new Date,pe=null,mt=[],Dt=!1,kt=null,rt=null,nt=null,fe=null,He=[],pt=[],Re="#ff69b4";function mn(e){kt=e}function pn(){try{kt?.()}finally{kt=null}}function fn(){const e=o("page-calendario");if(e){e.classList.add("hidden");const t=e.querySelector("[data-cal-grid]")||e.querySelector(".cal-grid");t&&(t.innerHTML="")}}function vn(){o("page-calendario")?.classList.remove("hidden")}function Wt(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function Jt(e,t="#3B82F6"){const a=(i.courses||[]).find(n=>n.id===e);return Wt(a?.color)?a.color:t}function ja(e,t=Re){const a=(pt||[]).find(n=>n.id===e);return Wt(a?.color)?a.color:t}function Vt(e){try{const t=parseInt(e.slice(1,3),16),a=parseInt(e.slice(3,5),16),n=parseInt(e.slice(5,7),16);return(t*299+a*587+n*114)/1e3>=160?"#111":"#fff"}catch{return"#0e0e0e"}}function qa(){Dt||(Dt=!0,gn(),yn(),Qt(),ke(),le(),Ya(),_a(),document.addEventListener("pair:ready",ya),ya(),ft(),bn())}function Fe(){Dt||qa()}function Zt(){Fe(),pe&&(pe(),pe=null),Ya(),_a(),ke(),le(),ft()}function hn(){Fe(),vt(),Be()}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",Fe):Fe();document.addEventListener("route:calendario",Fe);function gn(){const e=o("page-calendario");e&&(e.innerHTML=`
    <div class="card">
      <div class="cal-head">
        <div class="cal-left">
          <button id="calPrev" class="ghost" title="Mes anterior">‚óÄ</button>
          <button id="calToday" class="ghost" title="Ir a hoy">Hoy</button>
          <button id="calNext" class="ghost" title="Mes siguiente">‚ñ∂</button>
          <h3 id="calTitle" style="margin:0 0 0 10px">Calendario</h3>
        </div>
        <div class="cal-right muted">
          Semestre activo: <b id="calActiveSem">‚Äî</b>
        </div>
      </div>

      <div class="subtabs" style="margin-bottom:10px; display:flex; gap:8px;">
        <button id="cal-subtab-propio" class="tab small active">Propio</button>
        <button id="cal-subtab-compartido" class="tab small">Duo</button>
          <button id="cal-subtab-combinado" class="tab small">Combinado</button>

      </div>

      <div id="cal-propio">
        <div class="cal-grid" id="calGrid" aria-live="polite"></div>
        <div class="muted" style="margin-top:8px">
          Haz clic en un d√≠a para agregar un evento.
        </div>
      </div>

      <div id="cal-compartido" class="hidden">
        <div class="card" style="margin-bottom:12px">
          <div class="row" style="align-items:flex-end; gap:12px;">
            <div>
              <label>Semestre de tu duo</label><br/>
              <select id="shc-semSel"></select>
            </div>
         
          </div>
        </div>
        <div class="cal-grid" id="calSharedGrid"></div>
        <div class="muted" id="calSharedHint" style="margin-top:8px"></div>
      </div>

      <div id="cal-combinado" class="hidden">
  <div id="calCombinedGrid" class="cal-grid"></div>
</div>


    </div>
  `)}function yn(){o("calPrev")?.addEventListener("click",()=>{A=ba(A,-1),Ze(),ke(),le()}),o("calNext")?.addEventListener("click",()=>{A=ba(A,1),Ze(),ke(),le()}),o("calToday")?.addEventListener("click",()=>{A=new Date,Ze(),ke(),le()}),Ze()}function Ze(){const e=A.getFullYear(),t=A.getMonth(),a=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],n=o("calTitle");n&&(n.textContent=`Calendario ¬∑ ${a[t][0].toUpperCase()}${a[t].slice(1)} ${e}`)}function Ya(){const e=o("calActiveSem");e&&(e.textContent=i.activeSemesterData?.label||"‚Äî")}function bn(){const e=o("cal-subtab-propio"),t=o("cal-subtab-compartido"),a=o("cal-subtab-combinado"),n=o("cal-propio"),r=o("cal-compartido"),s=o("cal-combinado");function l(){e.classList.add("active"),t.classList.remove("active"),a.classList.remove("active"),n.classList.remove("hidden"),r.classList.add("hidden"),s.classList.add("hidden")}async function c(){if(t.classList.add("active"),e.classList.remove("active"),a.classList.remove("active"),r.classList.remove("hidden"),n.classList.add("hidden"),s.classList.add("hidden"),await ft(),le(),!i.pairOtherUid){o("calSharedHint").textContent="Empareja tu cuenta para ver el calendario de tu duo.";return}o("calSharedHint").textContent="",await Ga(),i.shared?.calendar?.semId&&Kt(i.shared.calendar.semId)}async function d(){await ft(),a.classList.add("active"),e.classList.remove("active"),t.classList.remove("active"),s.classList.remove("hidden"),n.classList.add("hidden"),r.classList.add("hidden"),En(),await xn()}e?.addEventListener("click",l),t?.addEventListener("click",c),a?.addEventListener("click",d),l()}function _a(){if(pe&&(pe(),pe=null),mt=[],vt(),!i.currentUser||!i.activeSemesterId)return;const e=C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"calendar");pe=D(J(e,he("date","asc")),t=>{mt=t.docs.map(a=>({id:a.id,...a.data()})),vt()})}async function ya(){if(za(),He=[],pt=[],Re="#ff69b4",le(),!i.pairOtherUid){const e=o("shc-semSel");e&&(e.innerHTML='<option value="">‚Äî</option>'),o("calSharedHint").textContent="Empareja tu cuenta para ver el calendario de tu duo.";return}o("calSharedHint").textContent="",await Ga(),fe&&(fe(),fe=null),fe=D(w(g,"users",i.pairOtherUid),e=>{const t=e.data()||{};Re=Wt(t.favoriteColor)?t.favoriteColor:"#ff69b4",Be()})}async function ft(){if(!i.pairOtherUid)return;const e=i.activeSemesterData?.label||null;if(e)try{const t=C(g,"users",i.pairOtherUid,"semesters"),a=await $(t);let n=null;if(a.forEach(r=>{const s=(r.data()?.label||"").trim();s===e&&(n={id:r.id,label:s})}),n&&(i.shared=i.shared||{},i.shared.calendar=i.shared.calendar||{},i.shared.calendar.semId!==n.id)){i.shared.calendar.semId=n.id;const r=o("shc-semSel");r&&(r.innerHTML=`<option selected>${n.label}</option>`,r.disabled=!0,r.style.pointerEvents="none",r.style.opacity="0.7"),Kt(n.id)}}catch(t){console.warn("autoSelectPartnerSemesterForCalendar",t)}}function za(){rt&&(rt(),rt=null),nt&&(nt(),nt=null),fe&&(fe(),fe=null)}async function Ga(){const e=o("shc-semSel");if(!e)return;e.innerHTML="<option selected disabled>Cargando‚Ä¶</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";const t=i.pairOtherUid;if(!t){e.innerHTML="<option selected>No disponible</option>";return}const a=i.activeSemesterData?.label||null;if(!a){e.innerHTML="<option selected>No disponible</option>";return}try{const n=C(g,"users",t,"semesters"),r=await $(n);let s=null;if(r.forEach(l=>{const c=(l.data()?.label||"").trim();c===a&&(s={id:l.id,label:c})}),s)e.innerHTML=`<option selected>${s.label}</option>`,i.shared.calendar=i.shared.calendar||{},i.shared.calendar.semId=s.id,Kt(s.id),o("calSharedHint").textContent="";else{e.innerHTML="<option selected>No disponible</option>",i.shared.calendar=i.shared.calendar||{},i.shared.calendar.semId=null;const l=o("calSharedGrid");l&&(l.innerHTML=`<div class="muted">Tu d√∫o no tiene el semestre <b>${a}</b> creado.</div>`),o("calSharedHint").textContent="Sincronizado con tu semestre activo."}e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7"}catch(n){console.error("populateSharedSemesters error",n),e.innerHTML="<option selected>Error al cargar</option>"}}async function Kt(e){za(),He=[],pt=[],le();const t=i.pairOtherUid;if(!t||!e)return;const a=C(g,"users",t,"semesters",e,"courses");nt=D(J(a,he("name")),r=>{pt=r.docs.map(s=>({id:s.id,...s.data()})),Be()});const n=C(g,"users",t,"semesters",e,"calendar");rt=D(J(n,he("date","asc")),r=>{He=r.docs.map(s=>({id:s.id,...s.data()})),Be()})}function Qt(){if(o("calModal"))return;const e=document.createElement("div");e.id="calModal",e.className="modal",e.innerHTML=`
    <div class="modal-backdrop" id="calModalBackdrop"></div>
    <div class="modal-content">
      <h3 id="calModalTitle" style="margin-top:0">Nuevo evento</h3>

      <div class="row" style="gap:10px">
        <div style="flex:1">
          <label>T√≠tulo</label>
          <input type="text" id="calEvtTitle" placeholder="Ej. Prueba 1 ELO212"/>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Fecha</label>
          <input type="date" id="calEvtDate"/>
        </div>
        <div style="flex:1">
          <label>Ramo</label>
          <select id="calEvtCourse">
            <option value="">(Sin asignar)</option>
          </select>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Inicio</label>
          <input type="time" id="calEvtStart"/>
        </div>
        <div style="flex:1">
          <label>T√©rmino</label>
          <input type="time" id="calEvtEnd"/>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Repetir cada</label>
          <select id="calEvtRepeat">
            <option value="">(Sin repetici√≥n)</option>
            <option value="day">D√≠a</option>
            <option value="month">Mes</option>
            <option value="year">A√±o</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Persistencia</label>
          <select id="calEvtPersistent">
            <option value="">Solo este semestre</option>
            <option value="true">Mantener en semestres futuros</option>
          </select>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end; gap:10px; margin-top:16px">
        <button class="ghost" id="calEvtCancel">Cancelar</button>
        <button class="primary" id="calEvtSave">Guardar</button>
      </div>
    </div>
  `,document.body.appendChild(e);const t=()=>e.classList.remove("active");o("calModalBackdrop").addEventListener("click",t),o("calEvtCancel").addEventListener("click",t),o("calEvtSave").addEventListener("click",async()=>{if(!i.currentUser||!i.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}const a=(o("calEvtTitle").value||"").trim(),n=o("calEvtDate").value||"",r=o("calEvtStart").value||null,s=o("calEvtEnd").value||null,l=o("calEvtCourse").value||null,c=o("calEvtRepeat").value||"",d=o("calEvtPersistent").value==="true",m=l?Jt(l):null;if(!a)return alert("Ingresa un t√≠tulo.");if(!n)return alert("Selecciona una fecha.");const u=e.dataset.editingId||null,p=C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"calendar");try{u?(await I(w(p,u),{title:a,date:n,start:r,end:s,courseId:l,color:m,repeat:c?{every:c,interval:1}:null,persistent:d,updatedAt:Date.now()}),console.log("[Calendar] Evento actualizado:",a)):(await $e(p,{title:a,date:n,start:r,end:s,courseId:l,color:m,repeat:c?{every:c,interval:1}:null,persistent:d,createdAt:Date.now()}),console.log("[Calendar] Evento creado:",a)),t()}catch(f){console.error(f),alert("No se pudo guardar el evento.")}finally{e.dataset.editingId=""}})}function wn(e){if(!i.currentUser||!i.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}Qt();const t=o("calEvtDate");t&&(t.value=e);const a=o("calEvtTitle");a&&(a.value="");const n=o("calEvtStart");n&&(n.value="");const r=o("calEvtEnd");r&&(r.value="");const s=o("calEvtCourse");s&&(s.innerHTML='<option value="">(Sin asignar)</option>',(i.courses||[]).forEach(l=>{const c=document.createElement("option");c.value=l.id,c.textContent=l.name,s.appendChild(c)})),o("calModal").classList.add("active")}function ke(){const e=o("calGrid");if(!e)return;const t=(new Date(A.getFullYear(),A.getMonth(),1).getDay()+6)%7,a=new Date(A.getFullYear(),A.getMonth()+1,0).getDate(),n=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${n.map(r=>`<div class="cal-cell head">${r}</div>`).join("")}
    ${Array.from({length:t}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((r,s)=>{const l=s+1,c=St(A.getFullYear(),A.getMonth()+1,l);return`
        <div class="cal-cell day" data-date="${c}">
          <div class="cal-daynum">${l}</div>
          <div class="cal-events" id="ce-${c}"></div>
        </div>
      `}).join("")}
  `,e.querySelectorAll(".cal-cell.day").forEach(r=>{r.addEventListener("click",()=>wn(r.dataset.date))}),vt()}function Sn(e){if(!i.currentUser||!i.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}Qt();const t=o("calModal"),a=o("calModalTitle"),n=o("calEvtSave");t.dataset.editingId=e.id,a.textContent="Editar evento",n.textContent="Guardar cambios",o("calEvtTitle").value=e.title||"",o("calEvtDate").value=e.date||"",o("calEvtStart").value=e.start||"",o("calEvtEnd").value=e.end||"",o("calEvtRepeat").value=e.repeat?.every||"",o("calEvtPersistent").value=e.persistent?"true":"";const r=o("calEvtCourse");r.innerHTML='<option value="">(Sin asignar)</option>',(i.courses||[]).forEach(s=>{const l=document.createElement("option");l.value=s.id,l.textContent=s.name,s.id===e.courseId&&(l.selected=!0),r.appendChild(l)}),t.classList.add("active")}function le(){const e=o("calSharedGrid");if(!e)return;const t=(new Date(A.getFullYear(),A.getMonth(),1).getDay()+6)%7,a=new Date(A.getFullYear(),A.getMonth()+1,0).getDate(),n=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${n.map(r=>`<div class="cal-cell head">${r}</div>`).join("")}
    ${Array.from({length:t}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((r,s)=>{const l=s+1,c=St(A.getFullYear(),A.getMonth()+1,l);return`
        <div class="cal-cell day" data-date="${c}">
          <div class="cal-daynum">${l}</div>
          <div class="cal-events" id="sce-${c}"></div>
        </div>
      `}).join("")}
  `,Be()}function En(){const e=o("calCombinedGrid");if(!e)return;const t=(new Date(A.getFullYear(),A.getMonth(),1).getDay()+6)%7,a=new Date(A.getFullYear(),A.getMonth()+1,0).getDate(),n=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${n.map(r=>`<div class="cal-cell head">${r}</div>`).join("")}
    ${Array.from({length:t}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((r,s)=>{const l=s+1,c=St(A.getFullYear(),A.getMonth()+1,l);return`
        <div class="cal-cell day" data-date="${c}">
          <div class="cal-daynum">${l}</div>
          <div class="cal-events" id="bce-${c}"></div>
        </div>
      `}).join("")}
  `,Ln()}function Ln(){document.querySelectorAll(".cal-events").forEach(t=>{t.id?.startsWith("bce-")&&(t.innerHTML="")});const e=`${A.getFullYear()}-${String(A.getMonth()+1).padStart(2,"0")}`;[...mt.filter(t=>String(t.date||"").startsWith(e)).map(t=>({...t,isMine:!0})),...He.filter(t=>String(t.date||"").startsWith(e)).map(t=>({...t,isMine:!1}))].forEach(t=>{const a=o("bce-"+t.date);if(!a)return;const n=t.color||(t.isMine?Jt(t.courseId):ja(t.courseId,Re)),r=Vt(n),s=t.start&&t.end?`${t.start}‚Äì${t.end} ¬∑ `:t.start?`${t.start} ¬∑ `:"",l=document.createElement("div");l.className="cal-evt",l.textContent=`${s}${t.title||"(sin t√≠tulo)"}`,l.style.background=n,l.style.color=r,l.style.opacity=t.isMine?1:.65,l.style.border="1px solid rgba(0,0,0,0.25)",a.appendChild(l)})}async function xn(){const e=o("calCombinedRemindersList");if(e){e.innerHTML='<div class="loading"></div>';try{const t=await Wa({range:"today"}),a=i.pairOtherUid?await Ja({range:"today"}):[],n=[...t.map(r=>({...r,owner:"T√∫"})),...a.map(r=>({...r,owner:"D√∫o"}))].sort((r,s)=>(r.datetime||0)-(s.datetime||0));e.innerHTML=n.length?n.map(r=>`
          <div class="grade-item">
            <div>
              <strong>${r.title||"(sin t√≠tulo)"}</strong>
              <div class="muted">${r.owner} ¬∑ ${r.datetime?.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})||""}</div>
            </div>
          </div>
        `).join(""):'<div class="muted">Sin recordatorios para hoy.</div>'}catch(t){console.error("loadCombinedReminders",t),e.innerHTML='<div class="muted">Error al cargar recordatorios.</div>'}}}function Cn(e){const t=[];for(const a of e)if(t.push(a),a.repeat?.every){const n=new Date(a.date);for(let r=1;r<=24;r++){const s=new Date(n);a.repeat.every==="day"?s.setDate(n.getDate()+r*(a.repeat.interval||1)):a.repeat.every==="month"?s.setMonth(n.getMonth()+r*(a.repeat.interval||1)):a.repeat.every==="year"&&s.setFullYear(n.getFullYear()+r*(a.repeat.interval||1));const l=St(s.getFullYear(),s.getMonth()+1,s.getDate());if(Math.abs(s-n)/(1e3*60*60*24)>365)break;t.push({...a,date:l})}}return t}function vt(){document.querySelectorAll(".cal-events").forEach(t=>{t.id?.startsWith("sce-")||(t.innerHTML="")});const e=`${A.getFullYear()}-${String(A.getMonth()+1).padStart(2,"0")}`;Cn(mt).filter(t=>String(t.date||"").startsWith(e)).forEach(t=>{const a=o("ce-"+t.date);if(!a)return;const n=t.color||Jt(t.courseId)||"#1f2937",r=Vt(n),s=t.start&&t.end?`${t.start}‚Äì${t.end} ¬∑ `:t.start?`${t.start} ¬∑ `:"",l=document.createElement("div");l.className="cal-evt",l.style.background=n,l.style.color=r,l.style.border="1px solid rgba(0,0,0,0.25)",l.style.position="relative",l.style.cursor="pointer";const c=document.createElement("span");c.textContent=`${s}${t.title||"(sin t√≠tulo)"}`,l.appendChild(c);const d=document.createElement("span");d.textContent="‚úï",d.className="cal-del",d.title="Eliminar evento",d.style.position="absolute",d.style.top="2px",d.style.right="4px",d.style.fontWeight="bold",d.style.color="#fff8",d.style.cursor="pointer",d.addEventListener("click",async m=>{if(m.stopPropagation(),!(!i.currentUser||!i.activeSemesterId||!t.id)&&confirm(`¬øEliminar evento "${t.title}"?`))try{await Q(w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"calendar",t.id))}catch(u){console.error(u)}}),l.appendChild(d),l.addEventListener("click",m=>{m.stopPropagation(),Sn(t)}),a.appendChild(l)})}function Be(){document.querySelectorAll(".cal-events").forEach(t=>{t.id?.startsWith("sce-")&&(t.innerHTML="")});const e=`${A.getFullYear()}-${String(A.getMonth()+1).padStart(2,"0")}`;He.filter(t=>String(t.date||"").startsWith(e)).forEach(t=>{const a=o("sce-"+t.date);if(!a)return;const n=t.color||(t.courseId?ja(t.courseId):Re),r=Vt(n),s=t.start&&t.end?`${t.start}‚Äì${t.end} ¬∑ `:t.start?`${t.start} ¬∑ `:"",l=document.createElement("div");l.className="cal-evt",l.textContent=`${s}${t.title||"(sin t√≠tulo)"}`,l.style.background=n,l.style.color=r,l.style.border="1px solid rgba(0,0,0,0.25)",a.appendChild(l)})}function ba(e,t){const a=new Date(e.getTime());return a.setMonth(a.getMonth()+t),a}function St(e,t,a){return`${e}-${String(t).padStart(2,"0")}-${String(a).padStart(2,"0")}`}async function Wa({range:e="today"}){if(!i.currentUser)throw new Error("No logueado");const t=C(g,"users",i.currentUser.uid,"reminders"),a=await $(t),n=new Date;let r=a.docs.map(s=>({id:s.id,...s.data()}));return r=r.filter(s=>!s.suspended),e==="today"?r=r.filter(s=>isToday(s.datetime,n)):e==="week"?r=r.filter(s=>isThisWeek(s.datetime,n)):e==="month"&&(r=r.filter(s=>isThisMonth(s.datetime,n))),r}async function Mn(e){if(!i.currentUser)throw new Error("No logueado");const t=w(g,"users",i.currentUser.uid,"reminders",e);return await I(t,{suspended:!1,updatedAt:Date.now()}),{ok:!0}}async function Un(){if(!i.currentUser)throw new Error("No logueado");const e=C(g,"users",i.currentUser.uid,"reminders"),t=J(e,Ma("suspended","==",!0));return(await $(t)).docs.map(a=>({id:a.id,...a.data()}))}async function An({reminderId:e}){if(!i.currentUser)throw new Error("No logueado");if(!e)throw new Error("Falta ID");const t=w(g,"users",i.currentUser.uid,"reminders",e);return await I(t,{suspended:!0,updatedAt:Date.now()}),{ok:!0}}async function Ja({range:e="today"}={}){if(!i.pairOtherUid)throw new Error("No tienes d√∫o");const t=C(g,"users",i.pairOtherUid,"reminders"),a=await $(t),n=l=>l?typeof l=="number"?new Date(l):l.toDate?l.toDate():new Date(l):null,r=a.docs.map(l=>{const c=l.data();return{id:l.id,...c,datetime:n(c.datetime)}}),s=new Date;if(e==="today"){const l=new Date(s.getFullYear(),s.getMonth(),s.getDate()),c=new Date(s.getFullYear(),s.getMonth(),s.getDate()+1);return r.filter(d=>d.datetime&&d.datetime>=l&&d.datetime<c)}if(e==="week"){const l=new Date(s.getFullYear(),s.getMonth(),s.getDate()-s.getDay()),c=new Date(l);return c.setDate(l.getDate()+7),r.filter(d=>d.datetime&&d.datetime>=l&&d.datetime<c)}return r}const $n=Object.freeze(Object.defineProperty({__proto__:null,clearCalendarUI:fn,initCalendar:qa,listPairReminders:Ja,listReminders:Wa,listSuspendedReminders:Un,onActiveSemesterChanged:Zt,onCoursesChanged:hn,registerCalendarUnsub:mn,resumeReminder:Mn,showCalendarUI:vn,stopCalendarSub:pn,suspendReminder:An},Symbol.toStringTag,{value:"Module"}));let Ke=null;function In(){if(!i.currentUser||!i.activeSemesterId)return;const e=C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses");D(e,t=>{const a=t.docs.filter(r=>r.data().asistencia),n=o("attCourseSel");n&&(n.innerHTML='<option value="" disabled selected>Elige un ramo‚Ä¶</option>',a.forEach(r=>{n.innerHTML+=`<option value="${r.id}">${r.data().name}</option>`})),n?.addEventListener("change",()=>{const r=n.value,s=a.find(l=>l.id===r);Tn(s?[s]:[])})})}function Tn(e){const t=o("asistenciaList");t&&(t.innerHTML="",e.forEach(a=>{const n=a.data(),r=document.createElement("div");r.className="card",r.innerHTML=`
      <h4>${n.name}</h4>
      <div class="att-days" data-id="${a.id}"></div>
      <div class="muted">Asistencia actual: <span class="att-percent" data-id="${a.id}">0%</span></div>
      <button class="btn btn-secondary add-att-btn" data-id="${a.id}" style="margin-top:8px;">+ Agregar asistencia</button>
    `,t.appendChild(r),Nn(a.id)}),t.querySelectorAll(".add-att-btn").forEach(a=>{a.addEventListener("click",()=>kn(a.dataset.id))}))}async function Nn(e){const t=C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",e,"attendance");D(t,a=>{const n=a.docs.map(r=>({id:r.id,...r.data()}));Dn(e,n)})}async function Dn(e,t){const a=document.querySelector(`.att-days[data-id="${e}"]`);if(!a)return;a.innerHTML=t.map(c=>`
    <div class="att-record">
      <span>${new Date(c.date+"T00:00:00").toLocaleDateString("es-CL",{timeZone:"America/Santiago"})} :

        ${c.present?"‚úî Presente":c.absent?"‚úò Ausente":c.justified?"üü° Justificado":"‚Äî Sin clase"}

      </span>
      <button class="btn btn-secondary btn-del-att" data-cid="${e}" data-id="${c.id}">‚ùå</button>
    </div>
  `).join(""),a.querySelectorAll(".btn-del-att").forEach(c=>{c.addEventListener("click",()=>On(c.dataset.cid,c.dataset.id))});const n=t.filter(c=>!c.noClass),r=n.filter(c=>c.present||c.justified).length,s=n.length?Math.round(r/n.length*100):0,l=document.querySelector(`.att-percent[data-id="${e}"]`);l&&(l.textContent=s+"%"),window.courseAttendance||(window.courseAttendance={}),window.courseAttendance[e]=s}let ht=null;function kn(e){ht=e;const t=new Date,a=new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().split("T")[0];o("attDate").value=a,o("attModal").classList.add("active")}function Va(){o("attModal").classList.remove("active"),ht=null}document.addEventListener("DOMContentLoaded",()=>{o("attCancel")?.addEventListener("click",Va),o("attPresente")?.addEventListener("click",()=>Qe("present")),o("attAusente")?.addEventListener("click",()=>Qe("absent")),o("attJustificado")?.addEventListener("click",()=>Qe("justified")),o("attNoClass")?.addEventListener("click",()=>Qe("noClass"))});async function Qe(e){if(!ht)return;const t=o("attDate").value;if(!t){alert("Selecciona una fecha");return}const[a,n,r]=t.split("-").map(Number),s=new Date(a,n-1,r).toISOString().split("T")[0],l=w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",ht,"attendance",s);await Z(l,{date:s,present:e==="present",absent:e==="absent",justified:e==="justified",noClass:e==="noClass"}),Va()}async function On(e,t){const a=w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",e,"attendance",t);await Q(a)}async function Za(){if(!i.currentUser||!i.activeSemesterId)return;if(Ke){try{Ke()}catch{}Ke=null}window.courseAttendance||(window.courseAttendance={});const e=C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses");try{const t=await $(e);for(const a of t.docs){if(!(a.data()||{}).asistencia)continue;const n=C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",a.id,"attendance"),r=(await $(n)).docs.map(c=>c.data()).filter(c=>!c.noClass),s=r.filter(c=>c.present||c.justified).length,l=r.length?Math.round(s/r.length*100):0;window.courseAttendance[a.id]=l}console.log("‚ö° Precarga inicial de asistencia:",window.courseAttendance),document.dispatchEvent(new CustomEvent("attendance:ready",{detail:{preload:!0}}))}catch(t){console.error("Error en precarga r√°pida de asistencia:",t)}return Ke=D(e,t=>{t.docs.filter(a=>a.data()?.asistencia).forEach(a=>{const n=C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",a.id,"attendance");D(n,r=>{const s=r.docs.map(d=>d.data()).filter(d=>!d.noClass),l=s.filter(d=>d.present||d.justified).length,c=s.length?Math.round(l/s.length*100):0;window.courseAttendance[a.id]=c,document.dispatchEvent(new CustomEvent("attendance:ready",{detail:{courseId:a.id,percent:c}}))})})}),!0}const Pn=Object.freeze(Object.defineProperty({__proto__:null,initAttendance:In,preloadAttendanceData:Za},Symbol.toStringTag,{value:"Module"}));let O=null,Xe=null,ie=[],M={scale:"USM",finalExpr:"",rulesText:""},ae={byName:{},byCode:{},byId:{}},Oe=null,Le=null;function Ka(){return w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",O,"groups","meta")}async function Hn(){if(Le=null,!!de())try{const e=await Y(Ka());Le=e.exists()?e.data()||{}:{}}catch(e){console.error("Error cargando nombres de grupos:",e),Le={}}}async function Rn(e,t){if(de())try{await Z(Ka(),{[e]:t},{merge:!0}),Le={...Le||{},[e]:t}}catch(a){throw console.error("Error guardando nombre de grupo:",a),a}}function Fn(e){Oe=e,i.unsubscribeGrades=()=>{try{Oe?.()}finally{Oe=null,i.unsubscribeGrades=null}}}function Bn(){try{Oe?.()}finally{Oe=null}i.unsubscribeGrades=null}function jn(){const e=o("gr-courseSel");e&&(e.innerHTML='<option value="" disabled selected>Selecciona un ramo‚Ä¶</option>');const t=o("gr-evalsList");t&&(t.innerHTML="");const a=o("gr-finalExpr");a&&(a.value="");const n=o("gr-rulesError");n&&(n.textContent="");const r=o("gr-currentAvg");r&&(r.textContent="‚Äî");const s=o("gr-neededToPass");s&&(s.textContent="‚Äî");const l=o("gr-status");l&&(l.textContent="‚Äî");const c=o("gr-partnerView");c&&c.classList.add("hidden");const d=o("gr-sh-semSel");d&&(d.innerHTML="");const m=o("gr-sh-list");m&&(m.innerHTML="")}function qn(){zn()}document.addEventListener("attendance:ready",e=>{console.log("üîÅ Asistencia actualizada para:",e.detail),W()});document.addEventListener("route:notas",()=>{setTimeout(()=>{const e=o("gr-courseSel"),t=o("gr-evalsCard"),a=o("gr-calcCard"),n=o("gr-summaryCard"),r=o("gr-rulesCard");(!e||!e.value)&&(t&&t.classList.add("hidden"),a&&a.classList.add("hidden"),n&&n.classList.add("hidden"),r&&r.classList.add("hidden"))},50)});function Qa(){Xa()}function Yn(){const e=o("gr-activeSemLabel");e&&(e.textContent=i.activeSemesterData?.label||"‚Äî"),Xa();const t=document.getElementById("gr-sh-semSel");t&&i.activeSemesterData?.label&&(t.innerHTML=`<option selected>${i.activeSemesterData.label}</option>`,t.disabled=!0,t.style.pointerEvents="none",t.style.opacity="0.7"),(async()=>{try{await Za(),console.log("‚úÖ Asistencia precargada, ahora s√≠ recalculamos notas"),W()}catch(a){console.warn("‚ö†Ô∏è Error precargando asistencia:",a),W()}})()}function _n(){return(ie||[]).map(e=>({code:e.key,name:e.name||e.key,grade:typeof e.score=="number"?e.score:null}))}function zn(){Gn(),o("gr-saveExpr")?.addEventListener("click",Ie),o("gr-finalExpr")?.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),Ie())}),o("gr-courseSel")?.addEventListener("change",Jn),o("gr-addEvalBtn")?.addEventListener("click",Xn),Wn();function e(){const a=o("page-notas");if(!a)return;const n=Array.from(a.querySelectorAll(".card h3")).find(c=>/c[a√°]lculo de notas/i.test(c.textContent))?.closest(".card");if(!n||(n.id||(n.id="gr-calcCard"),n.querySelector("#gr-openSim")))return;const r=n.querySelector("h3"),s=document.createElement("button");s.id="gr-openSim",s.className="ghost",s.textContent="Simulador de notas";let l=r?.closest(".row");l?l.classList.add("gr-calcHeader"):(l=document.createElement("div"),l.className="row gr-calcHeader",r&&l.appendChild(r),n.insertBefore(l,n.firstChild)),s.style.marginLeft="auto",l.appendChild(s),s.addEventListener("click",()=>{const c=is();if(!c){alert("Primero define la F√≥rmula final.");return}const d=_n();if(!d.length){alert("Agrega al menos una evaluaci√≥n.");return}ms({formula:c,evals:d})})}e(),document.addEventListener("pair:ready",Ot);const t=o("gr-finalExpr");if(t){const a=os(async()=>{await Ie()},600);t.addEventListener("input",()=>{M.finalExpr=Me(t.value||""),W(),a()}),t.addEventListener("blur",()=>Ie()),t.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),Ie())})}}function Gn(){const e=o("gr-passThreshold");e&&e.closest("div")?.classList.add("hidden");const t=o("gr-saveHeader");t&&t.classList.add("hidden")}function Wn(){if(o("gr-rulesCard"))return;const e=o("page-notas");if(!e)return;const t=document.createElement("div");t.className="card",t.id="gr-rulesCard",t.style.marginTop="12px",t.innerHTML=`
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Reglas</h3>
      <div class="muted" id="gr-rulesHint">Una por l√≠nea. Ej.: <code>C1>=50</code>, <code>avg(Q1,Q2,Q3)>=60</code>,</code> finalCode("Codigo del ramo") >= 50</code>,</code>Asistencia >= 55%</code></div>
    </div>
    <div class="row" style="align-items:flex-start;margin-top:8px">
      <textarea id="gr-rulesText" rows="4" style="flex:1 1 520px;min-height:86px;background:#0e1120;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px"></textarea>
      <div id="gr-formulaError" class="muted" style="margin-top:6px;color:#fca5a5"></div>
      <button id="gr-saveRules" class="primary">Guardar reglas</button>
    </div>
    <div id="gr-rulesStatus" class="muted" style="margin-top:6px"></div>
  `;const a=Array.from(e.querySelectorAll(".card h3")).find(n=>/c[a√°]lculo de notas/i.test(n.textContent))?.closest(".card");a?e.insertBefore(t,a):e.appendChild(t),o("gr-saveRules")?.addEventListener("click",Kn)}async function Xa(){const e=o("gr-courseSel");if(e){if(e.innerHTML="",!i.courses||i.courses.length===0){e.innerHTML='<option value="">‚Äî</option>',O=null,ce(),tr(null);return}i.courses.forEach(t=>{const a=document.createElement("option");a.value=t.id,a.textContent=t.name,e.appendChild(a)}),O=null,e.value="",e.selectedIndex=0,i.editingCourseId=null,o("gr-evalsCard")?.classList.add("hidden"),o("gr-calcCard")?.classList.add("hidden"),o("gr-summaryCard")?.classList.add("hidden")}}async function Jn(e){if(O=e.target.value||null,i.editingCourseId=O,!O){o("gr-evalsCard")?.classList.add("hidden"),o("gr-calcCard")?.classList.add("hidden"),o("gr-summaryCard")?.classList.add("hidden"),o("gr-rulesCard")?.classList.add("hidden");return}o("gr-evalsCard")?.classList.remove("hidden"),o("gr-calcCard")?.classList.remove("hidden"),o("gr-summaryCard")?.classList.remove("hidden"),o("gr-rulesCard")?.classList.remove("hidden"),await Zn(),await Hn(),await Qn(),await qe(),W(),await Vn(O)}async function Vn(e){try{const t=C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",e,"attendance"),a=(await $(t)).docs.map(s=>s.data()).filter(s=>!s.noClass),n=a.filter(s=>s.present||s.justified).length,r=a.length?Math.round(n/a.length*100):0;window.courseAttendance||(window.courseAttendance={}),window.courseAttendance[e]=r,console.log(`‚úÖ Sincronizada asistencia directa de ${e}: ${r}%`),W()}catch(t){console.warn("‚ö†Ô∏è No se pudo sincronizar asistencia directa:",t)}}function Et(){return w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",O,"grading","meta")}function te(){return C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",O,"grading","meta","components")}async function Zn(){if(!de())return;const e=Et(),t=w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",O),a=await Y(t),n=a.exists()&&a.data().scale||null,r=i.activeSemesterData?.universityAtThatTime||"",s=/mayor/i.test(r)?"MAYOR":"USM",l=await Y(e);l.exists()?M={finalExpr:"",rulesText:"",...l.data()}:(M={scale:n||s,finalExpr:"",rulesText:""},await Z(e,M));let c=n||s;M.scale!==c&&(M.scale=c,await I(e,{scale:M.scale})),o("gr-activeSemLabel")&&(o("gr-activeSemLabel").textContent=i.activeSemesterData?.label||"‚Äî");const d=o("gr-scaleSel");d&&(d.value=M.scale||"USM");const m=o("gr-finalExpr");m&&(m.value=M.finalExpr||"");const u=o("gr-rulesText");u&&(u.value=M.rulesText||""),M.scale,ce(),W()}async function Ie(){if(!de())return;const e=o("gr-finalExpr"),t=((e?e.value:"")||"").trim(),a=Me(t)||null;M.finalExpr=a,await I(Et(),{finalExpr:a}),await qe(),W()}async function Kn(){if(!de())return;const e=(o("gr-rulesText").value||"").trim()||null;M.rulesText=e,await I(Et(),{rulesText:e}),await qe(),W()}async function Qn(){if(Xe&&(Xe(),Xe=null),!de()){ce([]);return}const e=te();Xe=D(J(e,he("createdAt","asc")),async t=>{let a=t.docs.map(r=>({id:r.id,...r.data()}));const n=a.filter(r=>typeof r.order!="number");if(n.length){const{writeBatch:r}=await ee(async()=>{const{writeBatch:c}=await Rt(()=>import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"),[]);return{writeBatch:c}},[]),s=r(g),l=Date.now();n.forEach((c,d)=>{s.update(w(te(),c.id),{order:l+d})});try{await s.commit()}catch{}}a.sort((r,s)=>{const l=typeof r.order=="number"?r.order:9e15,c=typeof s.order=="number"?s.order:9e15;if(l!==c)return l-c;const d=r.createdAt?.toMillis?.()??0,m=s.createdAt?.toMillis?.()??0;return d-m}),ie=a,await ce(a),W(),qe().then(()=>W())},t=>{console.error("watchComponents error:",t),ce([])})}async function Xn(){if(!de()){alert("Selecciona un semestre y un ramo.");return}const e=o("gr-evalName"),t=o("gr-evalCode"),a=o("gr-evalScore"),n=(e?.value||"").trim();let r=(t?.value||"").trim();const s=a?.value??"";if(!n){alert("Escribe un nombre.");return}if(!r){alert("Escribe un c√≥digo (ej: C1, T1...).");return}if(r=r.replace(/\s+/g,"").replace(/[^A-Za-z0-9_]/g,"").slice(0,16),!r){alert("C√≥digo inv√°lido.");return}r=es(r,ie);const l=M.scale==="MAYOR",c=l?1:0,d=l?7:100,m=parseFloat(String(s).replace(",",".")),u=isNaN(m)?null:gt(m,c,d);await $e(te(),{key:r,name:n,score:u,createdAt:Ua(),order:Date.now()}),e&&(e.value=""),t&&(t.value=""),a&&(a.value="")}function er(e){return(e||"").replace(/\s+/g,"").replace(/[^A-Za-z0-9_]/g,"").slice(0,16)}function es(e,t){const a=new Set((t||[]).map(s=>(s.key||"").toLowerCase()));let n=er(e)||"X";if(!a.has(n.toLowerCase()))return n;let r=2;for(;a.has((n+r).toLowerCase());)r++;return n+r}async function ce(e=[]){const t=o("gr-evalsList");if(!t)return;const a={};t.querySelectorAll(".grade-item").forEach(p=>{const f=p.querySelector("code")?.textContent?.trim(),v=p.querySelector('[data-f="score"]');f&&v&&v.value&&(a[f]=v.value)});const n=new Set(Array.from(t.querySelectorAll("details.grade-group[open]")).map(p=>p.dataset.key));if(t.innerHTML="",!O){t.innerHTML='<div class="muted">Selecciona un ramo.</div>';return}if(!e.length){t.innerHTML='<div class="muted">A√∫n no hay evaluaciones. Usa ‚ÄúAgregar evaluaci√≥n‚Äù.</div>';return}const r=M.scale==="MAYOR",s=r?1:0,l=r?7:100,c=r?.1:1,d={certamenes:e.filter(p=>/^C\d*/i.test(p.key)||/certamen/i.test(p.name)),controles:e.filter(p=>/^CTRL/i.test(p.key)||/control/i.test(p.name)),tareas:e.filter(p=>/^T\d*/i.test(p.key)||/tarea/i.test(p.name)),proyecto:e.filter(p=>/proy/i.test(p.key)||/proyecto/i.test(p.name)),evaluaciones:e.filter(p=>/evaluaci[o√≥]n/i.test(p.name)),experiencias:e.filter(p=>/experien/i.test(p.name)),preinformes:e.filter(p=>/pre[\s-]?informe/i.test(p.name)),informes:e.filter(p=>/\binforme/i.test(p.name)&&!/pre[\s-]?informe/i.test(p.name)),laboratorios:e.filter(p=>/\blab/i.test(p.key)||/laboratorio/i.test(p.name)),otros:e.filter(p=>!(/^(C\d*|CTRL|T\d*|LAB)/i.test(p.key)||/certamen|control|tarea|proy|evaluaci[o√≥]n|experien|informe|laboratorio/i.test(p.name)))},m={certamenes:"Cert√°menes",controles:"Controles",tareas:"Tareas",proyecto:"Proyecto",evaluaciones:"Evaluaciones",experiencias:"Experiencias",preinformes:"Pre-informes",informes:"Informes",laboratorios:"Laboratorios",otros:"Otros"},u={...m,...Le||{}};for(const[p,f]of Object.entries(d)){let v=function(L,h,y){if(!L)return L;const b=U=>U.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),E=new RegExp(`\\b${b(h)}\\b`,"g");return L.replace(E,y)};if(!f.length)continue;const S=document.createElement("details");S.className="grade-group",S.dataset.key=p,n.has(p)&&(S.open=!0);const x=document.createElement("summary");x.style.display="flex",x.style.alignItems="center",x.style.justifyContent="space-between",x.style.width="100%",x.style.cursor="pointer";const B=u[p]||m[p]||p,P=document.createElement("span");P.style.fontWeight="700",P.textContent=`${B} (${f.length})`;const k=document.createElement("button");k.dataset.rename=p,k.className="ghost",k.textContent="‚úé",Object.assign(k.style,{fontSize:"0.9em",opacity:"0.8",marginLeft:"8px",flexShrink:"0"}),x.appendChild(P),x.appendChild(k),S.appendChild(x);const H=document.createElement("div");f.forEach(L=>{const h=document.createElement("div");h.className="grade-item",h.setAttribute("draggable","true"),h.dataset.id=L.id,h.draggable=!0,h.innerHTML=`
  <div style="flex:1">
    <div class="gr-name" style="font-weight:700">${F(L.name||L.key)}</div>
    <div class="muted">C√≥digo: <code class="gr-code">${F(L.key)}</code></div>
  </div>
  <div style="display:flex;align-items:center;gap:.5rem">
    <input data-f="score" type="number" step="${c}" min="${s}" max="${l}"
           value="${a[L.key]??L.score??""}" style="width:110px"/>
    <button data-act="save" class="btn btn-secondary">Guardar</button>
    <button data-act="edit" class="btn btn-secondary">Editar</button>
    <button data-act="cancelEdit" class="btn btn-secondary" style="display:none">Cancelar</button>
    <button data-act="del"  class="btn btn-secondary">Eliminar</button>
  </div>
`,h.addEventListener("click",async y=>{const b=y.target;if(b instanceof HTMLElement){if(b.dataset.act==="save"){const E=h.querySelector('[data-f="score"]');let U=parseFloat(E.value);const j=isNaN(U)?null:gt(U,s,l);await I(w(te(),L.id),{score:j}),b.textContent="Guardado ‚úì",W(),setTimeout(()=>b.textContent="Guardar",1200)}if(b.dataset.act==="del"){if(!confirm(`Eliminar ‚Äú${L.name||L.key}‚Äù?`))return;await Q(w(te(),L.id))}}}),h.addEventListener("click",async y=>{const b=y.target;if(b instanceof HTMLElement){if(b.dataset.act==="edit"){const E=h.querySelector(".gr-name"),U=h.querySelector(".gr-code"),j=E?.textContent?.trim()||L.name||"",q=U?.textContent?.trim()||L.key||"";E.innerHTML=`<input data-f="edit-name" type="text" value="${F(j)}"
                         style="width:100%;max-width:320px">`,U.parentElement.innerHTML=`C√≥digo: <input data-f="edit-code" type="text" value="${F(q)}"
                      style="width:120px">`,h.querySelector('[data-act="edit"]').style.display="none",h.querySelector('[data-act="cancelEdit"]').style.display="";return}if(b.dataset.act==="cancelEdit"){ce(ie);return}if(b.dataset.act==="save"){const E=h.querySelector('[data-f="edit-name"]'),U=h.querySelector('[data-f="edit-code"]');if(E||U){const _=E?E.value:L.name||L.key,T=U?U.value:L.key,R=(_||"").trim();let z=(T||"").trim();if(!R){alert("Escribe un nombre.");return}if(z=er(z),!z){alert("C√≥digo inv√°lido. Usa A‚ÄìZ, 0‚Äì9 o _.");return}if(new Set(ie.filter(be=>be.id!==L.id).map(be=>(be.key||"").toLowerCase())).has(z.toLowerCase())){alert(`El c√≥digo ${z} ya existe en este ramo.`);return}const Ye=w(te(),L.id);if(z!==L.key){const be=v(M.finalExpr||"",L.key,z),ta=v(M.rulesText||"",L.key,z);await I(Et(),{finalExpr:be||null,rulesText:ta||null}),M.finalExpr=be||"",M.rulesText=ta||""}await I(Ye,{name:R,key:z}),await qe(),W(),ce(ie);return}const j=h.querySelector('[data-f="score"]');let q=parseFloat(j.value);const K=isNaN(q)?null:gt(q,s,l);await I(w(te(),L.id),{score:K}),b.textContent="Guardado ‚úì",W(),setTimeout(()=>b.textContent="Guardar",1200);return}if(b.dataset.act==="del"){if(!confirm(`Eliminar ‚Äú${L.name||L.key}‚Äù?`))return;await Q(w(te(),L.id));return}}}),H.appendChild(h)}),S.appendChild(H),t.appendChild(S),ar(H),k.addEventListener("click",async L=>{L.preventDefault(),L.stopPropagation();const h=u[p]||m[p]||p,y=prompt(`Nuevo nombre para ‚Äú${h}‚Äù:`,h);if(!(!y||y.trim()===h))try{await Rn(p,y.trim()),ce(ie)}catch{alert("No se pudo guardar el nuevo nombre.")}})}}function W(){const e={},t=M.scale==="MAYOR"?1:0,a=M.scale==="MAYOR"?7:100;ie.forEach(u=>{typeof u.score=="number"&&(e[u.key]=gt(u.score,t,a))}),window.courseAttendance&&O in window.courseAttendance?e.Asistencia=window.courseAttendance[O]:e.Asistencia=0;let n=null,r="";if(M.finalExpr&&M.finalExpr.trim()!=="")try{n=ye(M.finalExpr,e,{avg:Ce,min:Math.min,max:Math.max,final:u=>yt(u),finalCode:u=>bt(u),finalId:u=>ea(u)}),typeof n=="number"&&isFinite(n)?n=Ue(n,M.scale):n=null}catch(u){r=u?.message||String(u||""),n=null}o("gr-rulesStatus")&&(o("gr-rulesStatus").dataset.formulaError=r);const s=M.scale==="MAYOR"?3.95:54.5,l=Lt(M.rulesText||""),c=Xt(l,e);let d=null;n==null?c.allOk?d="‚Äî":d="Reprueba":d=n>=s&&c.allOk?"Aprueba":"Reprueba";let m="‚Äî";if(n==null)m="Ingresa notas o completa la f√≥rmula.";else if(d==="Aprueba")m="Nada m√°s. Ya alcanzas la nota y cumples las reglas.";else{const u=[];if(n<s){const p=s-n;u.push(M.scale==="MAYOR"?`Subir la nota final en ${p.toFixed(2)} pts.`:`Subir la nota final en ${p.toFixed(1)} pts.`)}if(!c.allOk){const p=c.unmet.map(f=>`Cumplir: ${f.text}.`);u.push(...p)}m=u.join(" ")}rs(c),tr({final:n,status:d,needed:m})}async function qe(){if(ae={byName:{},byCode:{},byId:{}},!i.currentUser||!i.activeSemesterId)return;const e=Array.isArray(i.courses)?i.courses:[];for(const t of e)try{const a=w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",t.id,"grading","meta"),n=await Y(a),r=n.exists()?n.data():{scale:"USM",finalExpr:""},s=C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",t.id,"grading","meta","components"),l=(await $(s)).docs.map(v=>({id:v.id,...v.data()})),c={},d=r.scale==="MAYOR"?1:0,m=r.scale==="MAYOR"?7:100;for(const v of l)if(typeof v.score=="number"&&isFinite(v.score)){const S=Math.max(d,Math.min(m,v.score));c[v.key]=S}let u=null;if((r.finalExpr||"").trim())try{u=ye(r.finalExpr,c,{avg:Ce,min:Math.min,max:Math.max,final:v=>NaN,finalCode:v=>NaN,finalId:v=>NaN}),typeof u=="number"&&isFinite(u)?u=Ue(u,r.scale):u=null}catch{u=null}const p=oe(t.name),f=oe(t.code);p&&(ae.byName[p]={final:u,scale:r.scale,id:t.id}),f&&(ae.byCode[f]={final:u,scale:r.scale,id:t.id}),ae.byId[t.id]={final:u,scale:r.scale,id:t.id}}catch{}}function Lt(e){return(e||"").split(/\r?\n/).map(t=>t.trim()).filter(Boolean)}function Xt(e,t,a){const n={allOk:!0,items:[],unmet:[]};for(const r of e){const s=ts(r);if(!s){n.items.push({text:r,ok:!1,reason:"inv√°lida"}),n.unmet.push({text:r,kind:"invalid"}),n.allOk=!1;continue}const{left:l,op:c,right:d}=s;let m=null,u=null,p=!1;try{const f={avg:Ce,min:Math.min,max:Math.max,final:yt,finalCode:bt,finalId:ea,...a||{}};window.courseAttendance&&O in window.courseAttendance?t.Asistencia=window.courseAttendance[O]:"Asistencia"in t||(t.Asistencia=0);const v=l.replace(/%/g,""),S=d.replace(/%/g,"");m=ye(v,t,f),u=ye(S,t,f),p=as(m,c,u)}catch{p=!1}n.items.push({text:r,ok:p,left:m,op:c,right:u}),p||(n.unmet.push({text:r,kind:"cmp",left:m,op:c,right:u}),n.allOk=!1)}return n}function ts(e){const t=e.match(/^(.*?)(>=|<=|==|!=|>|<)(.*)$/);return t?{left:Me(t[1].trim()),op:t[2],right:Me(t[3].trim())}:null}function as(e,t,a){if(!(isFinite(e)&&isFinite(a)))return!1;const n=Math.round(Math.round(e*10)/10),r=Math.round(Math.round(a*10)/10);switch(t){case">=":return n>=r;case"<=":return n<=r;case">":return n>r;case"<":return n<r;case"==":return n===r;case"!=":return n!==r;default:return!1}}function Ce(...e){const t=e.map(a=>typeof a=="number"&&isFinite(a)?a:Number(a)).filter(a=>!isNaN(a));return t.length?t.reduce((a,n)=>a+n,0)/t.length:NaN}function rs(e){const t=o("gr-rulesStatus");if(!t)return;if(!e||!e.items.length){t.textContent="No hay reglas definidas.";return}const a=e.items.filter(r=>r.ok).length,n=e.items.map(r=>r.ok?`‚úÖ ${r.text}`:`‚ùå ${r.text}`);t.innerHTML=`<div><b>Reglas:</b> ${a}/${e.items.length} cumplidas</div><div style="margin-top:4px">${n.join("<br/>")}</div>`}function tr(e){const t=o("gr-currentFinal")||o("gr-currentAvg"),a=o("gr-status"),n=o("gr-needed")||o("gr-neededToPass");if(!t||!a||!n)return;if(!e){t.textContent="",a.textContent="",n.textContent="",delete t.dataset.base,delete a.dataset.base;return}const r=M?.scale||"USM",s=e.final==null?"":Ue(e.final,r).toString();t.textContent=s,a.textContent=e.status??"",n.textContent=e.needed??""}let xt={id:null,fromIndex:-1};function ar(e){e&&(e.querySelectorAll(".grade-item").forEach(t=>{t.draggable=!0,t.querySelectorAll("input,button,select,textarea").forEach(a=>{a.setAttribute("draggable","false")})}),e.addEventListener("dragstart",t=>{const a=t.target.closest(".grade-item");a&&(t.dataTransfer.setData("text/plain",a.dataset.id||""),t.dataTransfer.effectAllowed="move",a.classList.add("dragging"),xt.id=a.dataset.id,xt.fromIndex=[...e.children].indexOf(a))}),e.addEventListener("dragend",()=>{e.querySelector(".grade-item.dragging")?.classList.remove("dragging"),xt={id:null,fromIndex:-1}}),e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="move";const a=e.querySelector(".grade-item.dragging");if(!a)return;const n=ns(e,t.clientY);n==null?e.appendChild(a):e.insertBefore(a,n)},{capture:!0}),e.addEventListener("drop",async t=>{t.preventDefault();const a=[...e.querySelectorAll(".grade-item")].map(n=>n.dataset.id);await ss(a)}))}function ns(e,t){return[...e.querySelectorAll(".grade-item:not(.dragging)")].reduce((a,n)=>{const r=n.getBoundingClientRect(),s=t-(r.top+r.height/2);return s<0&&s>a.offset?{offset:s,element:n}:a},{offset:Number.NEGATIVE_INFINITY,element:null}).element}async function ss(e){if(!de()||!Array.isArray(e)||!e.length)return;const{writeBatch:t}=await ee(async()=>{const{writeBatch:s}=await Rt(()=>import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"),[]);return{writeBatch:s}},[]),a=t(g);let n=Date.now();const r=1e3;e.forEach((s,l)=>{const c=w(te(),s);a.update(c,{order:n+l*r})});try{await a.commit()}catch(s){console.warn("Error al guardar orden:",s)}}function is(){return(document.getElementById("gr-finalExpr")?.value||"").trim()}function os(e,t){let a=null;return(...n)=>{a&&clearTimeout(a),a=setTimeout(()=>e(...n),t)}}function de(){return!!(i.currentUser&&i.activeSemesterId&&O)}function F(e){return(e??"").toString().replace(/[<>&"]/g,t=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"})[t])}function gt(e,t,a){return Math.max(t,Math.min(a,e))}function Me(e){if(!e)return"";let t=String(e).trim();return t=t.replace(/[‚Äú‚Äù]/g,'"').replace(/[‚Äò‚Äô]/g,"'"),t=t.replace(/\s+/g," "),t}function rr(e){return e.replace(/\b(final|finalCode|finalId)\(\s*([^)]+?)\s*\)/g,(t,a,n)=>{const r=String(n).trim();if(/^["'].*["']$/.test(r))return`${a}(${r})`;if(/[(),]/.test(r))return`${a}(${r})`;const s=r.replace(/"/g,'\\"');return`${a}("${s}")`})}function ls(e){return e?e.replace(/(\d+(?:\.\d+)?)\s*%/g,(t,a)=>`(${a}/100)`):""}function ye(e,t,a={}){const n=Me(e),r=rr(n),s=r.replace(/"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'/g,"0");if(!/^[\w\s\.\+\-\*\/\(\),%<>!=]+$/.test(s))throw new Error("La f√≥rmula contiene caracteres no permitidos.");const l=ls(r),c=s.match(/\b[A-Za-z_][A-Za-z0-9_]*\b/g)||[],d=new Set(["avg","min","max","final","finalCode","finalId"]),m=new Set(["NaN","Infinity","Math","true","false"]),u=Object.keys(t),p=u.map(x=>t[x]??0),f=new Set([...u,...Object.keys(a)]);for(const x of c)d.has(x)||m.has(x)||f.has(x)||(u.push(x),p.push(0),f.add(x));const v=Object.keys(a),S=Object.values(a);return Function(...v,...u,`"use strict"; return (${l});`)(...S,...p)}function cs(e){const t=Me(e||""),a=rr(t),n=a.replace(/"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'/g,"0").match(/\b[A-Za-z_][A-Za-z0-9_]*\b/g)||[],r=new Set(["avg","min","max","final","finalCode","finalId","NaN","Infinity","Math","true","false"]),s=new Set((a.match(/\b[A-Za-z_][A-Za-z0-9_]*\s*\(/g)||[]).map(c=>c.replace("(","").trim())),l=n.filter(c=>!r.has(c)&&!s.has(c));return[...new Set(l)]}function Ue(e,t){return e==null||isNaN(e)?null:t==="MAYOR"?Math.trunc(e*100)/100:Math.trunc(e*10)/10}function oe(e){return(e||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toLowerCase()}function yt(e){const t=oe(e);if(!t)return NaN;const a=(i.courses||[]).find(c=>c.id===O);if(t===oe(a?.name))return NaN;const n=ae.byName[t];if(n&&typeof n.final=="number")return n.final;const r=Array.isArray(i.courses)?i.courses:[],s=r.filter(c=>oe(c.name).startsWith(t)&&c.id!==O);if(s.length===1){const c=ae.byId[s[0].id];if(c&&typeof c.final=="number")return c.final}const l=r.filter(c=>oe(c.name).includes(t)&&c.id!==O);if(l.length===1){const c=ae.byId[l[0].id];if(c&&typeof c.final=="number")return c.final}return NaN}function bt(e){const t=oe(e),a=(i.courses||[]).find(r=>r.id===O);if(t&&t===oe(a?.code))return NaN;const n=ae.byCode[t];return n&&typeof n.final=="number"?n.final:NaN}function ea(e){if(!e||e===O)return NaN;const t=ae.byId[e];return t&&typeof t.final=="number"?t.final:NaN}(function(){const e=o("gr-togglePartner");if(!e)return;const t=[o("gr-courseSel")?.closest(".card"),o("gr-evalsList")?.closest(".card"),o("gr-finalExpr")?.closest(".card"),o("gr-currentFinal")?.closest(".card")||o("gr-currentAvg")?.closest(".card"),o("gr-rulesCard")].filter(Boolean),a=o("gr-partnerView");function n(r){e.setAttribute("aria-pressed",r?"true":"false"),e.textContent=r?"Volver a mis notas":"Notas de mi duo",t.forEach(s=>oa(s,r)),oa(a,!r),r&&Ot()}e.addEventListener("click",()=>{const r=e.getAttribute("aria-pressed")==="true";n(!r)}),document.addEventListener("pair:ready",Ot)})();let wa=0;async function Ot(){const e=o("gr-sh-semSel");if(!e)return;e.innerHTML="";const t=document.createElement("option");if(t.textContent="Cargando...",t.disabled=!0,t.selected=!0,e.appendChild(t),!i.pairOtherUid){e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";return}const a=++wa,n=C(g,"users",i.pairOtherUid,"semesters"),r=await $(n);if(a!==wa)return;const s=i.activeSemesterData?.label||null;if(!s){e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";return}let l=null;if(r.forEach(c=>{const d=(c.data()?.label||"").trim();d===s&&(l={id:c.id,label:d})}),l)e.innerHTML=`<option selected>${l.label}</option>`,e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7",i.shared.notas.semId=l.id,us(l.id);else{e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7",i.shared.notas.semId=null;const c=o("gr-sh-list");c&&(c.innerHTML='<div class="muted">Tu d√∫o no tiene este semestre creado.</div>')}}let st=null;function ds(){st&&(st(),st=null)}async function us(e){ds();const t=o("gr-sh-list");if(t&&(t.innerHTML=""),!i.pairOtherUid||!e)return;const a=await Y(w(g,"users",i.pairOtherUid,"semesters",e)),n=a.exists()&&a.data().universityAtThatTime||"",r=/mayor/i.test(n)?"MAYOR":"USM",s=C(g,"users",i.pairOtherUid,"semesters",e,"courses");st=D(J(s,he("name")),async l=>{if(!l.size){Sa([]);return}const c={},d=[];for(const u of l.docs){const p=u.data()||{},f=u.id,v=w(g,"users",i.pairOtherUid,"semesters",e,"courses",f,"grading","meta"),S=await Y(v),x=S.exists()?S.data():{scale:r,finalExpr:"",rulesText:""},B=C(g,"users",i.pairOtherUid,"semesters",e,"courses",f,"grading","meta","components"),P=(await $(B)).docs.map(b=>({id:b.id,...b.data()||{}})),k={},H=x.scale==="MAYOR",L=H?1:0,h=H?7:100;P.forEach(b=>{const E=typeof b.score=="number"?Math.max(L,Math.min(h,b.score)):null;E!=null&&b.key&&(k[b.key]=E)});let y=null;try{(x.finalExpr||"").trim()&&(y=ye(x.finalExpr,k,{avg:Ce,min:Math.min,max:Math.max,final:()=>NaN,finalCode:()=>NaN,finalId:()=>NaN}),typeof y=="number"&&isFinite(y)?y=Ue(y,x.scale):y=null)}catch{y=null}c[(p.code||"").toLowerCase()]=y,d.push({cData:p,comps:P,vals:k,meta:x,prelim:y})}const m=[];for(const u of d){let p=u.prelim;try{(u.meta.finalExpr||"").trim()&&(p=ye(u.meta.finalExpr,u.vals,{avg:Ce,min:Math.min,max:Math.max,final:()=>NaN,finalCode:B=>{const P=(B||"").toString().toLowerCase();return c[P]??NaN},finalId:()=>NaN}),typeof p=="number"&&isFinite(p)?p=Ue(p,u.meta.scale):p=null)}catch{p=null}const f=u.meta.scale==="MAYOR"?3.95:54.5,v=Lt(u.meta.rulesText||""),S=Xt(v,u.vals),x=p!=null&&p>=f&&S.allOk?"Aprobado":p==null?"‚Äî":"Reprobado";m.push({name:u.cData.name||"Ramo",code:u.cData.code||"",final:p,scale:u.meta.scale||r,status:x})}Sa(m)})}function Sa(e){const t=o("gr-sh-list");if(t){if(t.innerHTML="",!e.length){t.innerHTML='<div class="muted">No hay ramos en ese semestre.</div>';return}e.forEach(a=>{const n=a.final==null?"‚Äî":a.scale==="MAYOR"?(Math.trunc(a.final*100)/100).toFixed(2):(Math.trunc(a.final*10)/10).toFixed(1),r=a.status==="Aprobado"?"#22c55e":a.status==="Reprobado"?"#ef4444":"#aaa",s=document.createElement("div");s.className="grade-item",s.innerHTML=`
      <div style="flex:1">
        <div style="font-weight:700">${F(a.name)}</div>
        <div class="muted">Nota final: <b>${n}</b></div>
      </div>
      <div style="font-weight:700;color:${r}">
        ${a.status}
      </div>
    `,t.appendChild(s)})}}function ms({formula:e,evals:t}){document.getElementById("gr-simDrawer")?.remove(),document.getElementById("gr-simBackdrop")?.remove();const a=document.createElement("div");a.id="gr-simBackdrop",Object.assign(a.style,{position:"fixed",inset:"0",zIndex:9998,background:"rgba(0,0,0,0.35)",backdropFilter:"blur(1px)"}),document.body.classList.add("sim-lock");const n=document.createElement("div");n.id="gr-simDrawer",Object.assign(n.style,{position:"fixed",top:"0",right:"0",height:"100vh",width:"420px",background:"rgba(18,18,30,.98)",backdropFilter:"blur(6px)",borderLeft:"1px solid rgba(255,255,255,.08)",boxShadow:"0 0 24px rgba(0,0,0,.45)",zIndex:9999,padding:"16px 16px 90px 16px",overflowY:"auto"}),n.addEventListener("click",h=>h.stopPropagation()),n.innerHTML=`
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
      <h3 style="margin:0">Simulador de notas</h3>
      <span class="muted" style="font-size:12px;opacity:.8">(${F(e)})</span>
    </div>

    <div class="card" style="margin-top:4px">
      <h4 style="margin:0 0 6px">Evaluaciones</h4>
      <div id="gr-simForm"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 6px">Resumen de la simulaci√≥n</h4>
      <div id="gr-simSummary" class="muted">‚Äî</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 6px">Reglas del ramo (simulaci√≥n)</h4>
      <div id="gr-simRules" class="muted">‚Äî</div>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px; padding-top:12px; border-top:1px solid rgba(255,255,255,.1)">
  <button id="gr-simSave" class="primary">Guardar simulaci√≥n</button>
  <button id="gr-simClose" class="ghost">Salir</button>
</div>

  `,document.body.appendChild(a),document.body.appendChild(n);const r=async()=>{const h=L();let y=null;try{y=await La()}catch{y=null}const b=(j={})=>{const q={};for(const[K,_]of Object.entries(j||{}))_==null||_===""||typeof _=="string"&&_.trim()===""?q[K.toUpperCase()]=null:isNaN(_)?q[K.toUpperCase()]=_:q[K.toUpperCase()]=Math.round(Number(_)*100)/100;return q},E=((j,q)=>{const K=b(j),_=b(q),T=new Set([...Object.keys(K),...Object.keys(_)]);for(const R of T)if((K[R]??null)!==(_[R]??null))return!1;return!0})(h.gradesMap,y);let U=!1;if(E||(U=confirm("¬øGuardar esta simulaci√≥n antes de salir?")),U)try{await Ea(h.gradesMap,e)}catch{}a.remove(),n.remove(),document.body.classList.remove("sim-lock")};a.addEventListener("click",r),n.addEventListener("keydown",h=>{h.key==="Escape"&&r()}),n.querySelector("#gr-simClose")?.addEventListener("click",r),ps(n);const s=n.querySelector("#gr-simForm"),l=new Map((t||[]).map(h=>[h.code,h.grade])),c=cs(e),d=new Set((t||[]).map(h=>h.code)),m=[...new Set([...d,...c])],u={certamenes:[],controles:[],tareas:[],proyecto:[],evaluaciones:[],experiencias:[],preinformes:[],informes:[],laboratorios:[],otros:[]},p={certamenes:"Cert√°menes",controles:"Controles",tareas:"Tareas",proyecto:"Proyecto",evaluaciones:"Evaluaciones",experiencias:"Experiencias",preinformes:"Pre-informes",informes:"Informes",laboratorios:"Laboratorios",otros:"Otros"};function f(h,y){return/^C\d*/i.test(h)||/certamen/i.test(y)?"certamenes":/^Q\d*/i.test(h)||/control/i.test(y)?"controles":/^T\d*/i.test(h)||/tarea/i.test(y)?"tareas":/PF|PROY/i.test(h)||/proy/i.test(y)?"proyecto":/evaluaci[o√≥]n/i.test(y)?"evaluaciones":/experien/i.test(y)?"experiencias":/pre[\s-]?informe/i.test(y)?"preinformes":/\binforme/i.test(y)&&!/pre[\s-]?informe/i.test(y)?"informes":/^L\d*/i.test(h)||/laboratorio/i.test(y)?"laboratorios":"otros"}for(const h of m){const y=(t||[]).find(U=>U.code===h)||{name:h},b=l.get(h),E=f(h,y.name||h);u[E].push({code:h,name:y.name||h,value:b})}const v=[],S=M.scale==="MAYOR",x=S?1:0,B=S?7:100,P=S?.1:1;for(const[h,y]of Object.entries(u)){if(!y.length)continue;const b=p[h]||h;v.push(`
    <details open class="sim-group" data-key="${h}"
      style="margin-top:10px;border:1px solid rgba(255,255,255,.08);
             border-radius:8px;padding:6px 8px;background:rgba(0,0,0,0.15)">
      <summary style="cursor:pointer;font-weight:700;font-size:14px;
                      margin-bottom:6px">${b} (${y.length})</summary>
      <div class="sim-group-body">
        ${y.map(E=>`
          <div class="row" style="align-items:center;gap:8px;margin:4px 0"
               data-sim-code="${F(E.code)}">
            <div style="min-width:76px"><b>${F(E.code)}</b></div>
            <div style="flex:1">${F(E.name)}</div>
            <input type="number" step="${P}" min="${x}" max="${B}"
                   style="width:110px" placeholder="‚Äî"
                   value="${E.value??""}">
          </div>
        `).join("")}
      </div>
    </details>
  `)}s.innerHTML=v.join("");const k=[...e.matchAll(/finalCode\(["'](.+?)["']\)/g)];for(const h of k){const y=h[1],b=bt(y);isFinite(b)?v.push(`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.85" data-sim-ref="${F(y)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1">Nota final de ${F(y)}</div>
        <input type="number" readonly value="${b}" style="width:110px;opacity:.7;background:#222;border:none;color:#ccc">
      </div>
    `):v.push(`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.75" data-sim-ref="${F(y)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1;color:#aaa">Nota final de ${F(y)}</div>
        <div style="width:110px;text-align:center;color:#f87171">‚Äî</div>
      </div>
    `)}s.innerHTML=v.join("");const H=[...e.matchAll(/final\(["'](.+?)["']\)/g)];for(const h of H){const y=h[1],b=yt(y);isFinite(b)&&s.insertAdjacentHTML("beforeend",`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.85" data-sim-ref="${F(y)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1">Nota final de ${F(y)}</div>
        <input type="number" readonly value="${b}" style="width:110px;opacity:.7;background:#222;border:none;color:#ccc">
      </div>
    `)}const L=()=>{const h={};s.querySelectorAll("[data-sim-code]").forEach(T=>{const R=T.getAttribute("data-sim-code"),z=T.querySelector("input")?.value?.trim(),Ye=z?Number(String(z).replace(",",".")):null;h[R]=Number.isFinite(Ye)?Ye:0});let y=null,b=null;try{y=ye(e,{...h},{avg:Ce,min:Math.min,max:Math.max,final:T=>yt(T),finalCode:T=>bt(T),finalId:T=>ea(T)}),typeof y=="number"&&isFinite(y)?y=Ue(y,M.scale):y=null}catch(T){b=T?.message||String(T||""),y=null}const E=Lt(M.rulesText||""),U=Xt(E,h),j=M.scale==="MAYOR"?3.95:54.5;let q="";if(b)q="";else if(y==null)q="Ingresa valores para simular.";else{const T=[];if(y<j){const R=j-y;T.push(M.scale==="MAYOR"?`Subir la nota final en ${R.toFixed(2)} pts.`:`Subir la nota final en ${R.toFixed(1)} pts.`)}if(!U.allOk){const R=U.unmet.map(z=>z.text);R.length&&T.push(`Cumplir reglas pendientes: ${R.map(F).join("; ")}.`)}q=T.length?T.join(" "):"Nada m√°s. Ya apruebas."}const K=n.querySelector("#gr-simSummary");K.innerHTML=b?`<div style="color:#f87171">Error en f√≥rmula: ${F(b)}</div>`:`
    <div>Promedio simulado: <b>${y??"‚Äî"}</b></div>
    <div class="muted" style="margin-top:6px">(Usa tu f√≥rmula final actual)</div>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:10px 0">
    <div><b>Necesitas para aprobar</b></div>
    <div style="margin-top:4px">${q}</div>
  `;const _=n.querySelector("#gr-simRules");if(!E.length)_.textContent="No hay reglas definidas.";else{const T=U.items.filter(R=>R.ok).length;_.innerHTML=`
        <div style="margin-bottom:6px">Cumplidas: <b>${T}/${E.length}</b></div>
        <ul style="margin:0 0 0 18px;padding:0;list-style:disc;">
          ${U.items.map(R=>`<li style="color:${R.ok?"#22c55e":"#ef4444"}">${F(R.text)}</li>`).join("")}
        </ul>
      `}return{gradesMap:h,result:y}};s.addEventListener("input",L),L(),n.querySelector("#gr-simSave")?.addEventListener("click",async()=>{const h=L();try{const y=await Ea(h.gradesMap,e);alert(y?.where==="cloud"?"Simulaci√≥n guardada en la nube.":"Simulaci√≥n guardada")}catch(y){console.error(y),alert("No se pudo guardar la simulaci√≥n.")}}),La().then(h=>{h&&(s.querySelectorAll("[data-sim-code]").forEach(y=>{const b=y.getAttribute("data-sim-code")||"",E=y.querySelector("input");if(!E)return;const U=h[b]??h[b.toUpperCase()]??h[b.toLowerCase()];U!=null&&(E.value=String(U))}),L())}).catch(()=>{})}function ps(e){const t=()=>Array.from(e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(r=>!r.hasAttribute("disabled")&&r.tabIndex!==-1),a=()=>t()[0],n=()=>t().slice(-1)[0];setTimeout(()=>a()?.focus(),0),e.addEventListener("keydown",r=>{if(r.key!=="Tab")return;const s=t();if(!s.length)return;const l=document.activeElement;r.shiftKey?l===s[0]&&(r.preventDefault(),n()?.focus()):l===s[s.length-1]&&(r.preventDefault(),a()?.focus())})}async function Ea(e,t){const a={};Object.keys(e||{}).forEach(s=>{a[String(s).toUpperCase()]=e[s]});const n={formula:t,grades:a,rules:Lt(M.rulesText||""),semId:i.activeSemesterId||null,courseId:i.editingCourseId||null,createdAt:Ua()};if(i.currentUser&&i.activeSemesterId&&i.editingCourseId)try{const s=["users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",i.editingCourseId,"simulations"];return await $e(C(g,...s),n),await Z(w(g,...s,"__last__"),n),{ok:!0,where:"cloud"}}catch(s){console.warn("Fallo Firestore, usando localStorage:",s)}const r=`sim:last:${i.activeSemesterId||"SEM"}:${i.editingCourseId||"COURSE"}`;return localStorage.setItem(r,JSON.stringify(n)),{ok:!0,where:"local"}}async function La(){const e=`sim:last:${i.activeSemesterId||"SEM"}:${i.editingCourseId||"COURSE"}`;if(i.currentUser&&i.activeSemesterId&&i.editingCourseId)try{const t=w(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",i.editingCourseId,"simulations","__last__"),a=await Y(t);if(a.exists()){const n=a.data()?.grades||null;return n&&typeof n=="object"?n:null}}catch{}try{const t=localStorage.getItem(e);if(!t)return null;const a=JSON.parse(t)?.grades||null;return a&&typeof a=="object"?a:null}catch{return null}}function fs(e){if(!e||!i.courses)return null;const t=n=>String(n||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),a=t(e);return i.courses.find(n=>t(n.name).includes(a)||t(n.code||"").includes(a))||null}async function nr(e){const t=C(e.ref,"rules"),a=await $(t);let n=0,r=0;for(const s of a.docs){const l=s.data(),c=Number(l.peso)||0,d=C(s.ref,"grades"),m=(await $(d)).docs.map(u=>Number(u.data().valor)).filter(u=>!isNaN(u));if(m.length>0){const u=m.reduce((p,f)=>p+f,0)/m.length;n+=u*(c/100),r+=c}}return r>0?+n.toFixed(2):null}async function vs(e){if(!i.currentUser)return null;const t=C(g,"users",i.currentUser.uid,"semesters",e,"courses"),a=await $(t);let n=0,r=0;for(const s of a.docs){const l=await nr(s);l!=null&&(n+=l,r++)}return r>0?+(n/r).toFixed(2):null}function hs(e){const t=(e.scale||"USM")==="MAYOR"?4:55;let a=0,n=0;for(const r of e.rules||[]){const s=Number(r.peso)||0;if(r.tipo.toLowerCase().includes("examen")){n=s;continue}if(r.notas?.length){const l=r.notas.reduce((c,d)=>c+d,0)/r.notas.length;a+=l*(s/100)}}return n===0?null:+((t-a)/(n/100)).toFixed(2)}function gs(e){const t=(e.scale||"USM")==="MAYOR"?4:55;return e.promedio>=t}function ys(e){const t=(e.scale||"USM")==="MAYOR"?4:55;return+Math.max(0,t-(e.promedio||0)).toFixed(2)}async function bs(e){if(!i.currentUser)return{best:null,worst:null};const t=C(g,"users",i.currentUser.uid,"semesters",e,"courses"),a=await $(t),n=[];for(const r of a.docs){const s=await nr(r);n.push({id:r.id,name:r.data().name,promedio:s})}return n.length?(n.sort((r,s)=>(s.promedio||0)-(r.promedio||0)),{best:n[0],worst:n[n.length-1]}):{best:null,worst:null}}document.addEventListener("route:change",e=>{const t=e.detail?.route||"",a=document.getElementById("gr-courseSel");function n(){if(a)if(a.value="",a.querySelector('option[value=""]'))a.selectedIndex=0;else{const l=document.createElement("option");l.value="",l.textContent="Selecciona un ramo‚Ä¶",l.disabled=!0,l.selected=!0,a.insertBefore(l,a.firstChild),a.selectedIndex=0}window.currentCourseId=null,window.state&&(window.state.editingCourseId=null);const r=(l,c="‚Äî")=>{const d=document.getElementById(l);d&&(d.textContent=c)};r("gr-currentAvg"),r("gr-neededToPass"),r("gr-status");const s=document.getElementById("gr-evalsList");s&&(s.innerHTML='<div class="muted">Selecciona un ramo.</div>'),["gr-evalsCard","gr-calcCard","gr-summaryCard","gr-rulesCard"].forEach(l=>document.getElementById(l)?.classList.add("hidden"))}t!=="#/notas"&&n(),t==="#/notas"&&setTimeout(n,120)});const ws=Object.freeze(Object.defineProperty({__proto__:null,bestWorst:bs,calcBrecha:ys,calcNotaMinima:hs,calcPromedioSemestre:vs,clearGradesUI:jn,enableDnDForGrades:ar,findCourse:fs,initGrades:qn,isPassing:gs,onActiveSemesterChanged:Yn,onCoursesChanged:Qa,registerGradesUnsub:Fn,stopGradesSub:Bn},Symbol.toStringTag,{value:"Module"}));let Ct="USM";function sr(){Ss()}function ir(){Ls()}function or(e){Ct=e==="UMAYOR"?"MAYOR":"USM";const t=o("sectParLabel");t&&(t.textContent=e==="USM"?"Paralelo":"Secci√≥n/Paralelo");const a=o("courseScale"),n=a?.closest?.(".form-field");n&&n.classList.add("hidden"),a&&(a.value=Ct,a.disabled=!0);const r=o("scaleHint");r&&(r.textContent=Ct==="MAYOR"?"Escala: UMayor (1‚Äì7) ¬∑ tomada desde tu Perfil":"Escala: USM (0‚Äì100) ¬∑ tomada desde tu Perfil")}let et=null;function Ss(){if(et&&(et(),et=null),!i.currentUser||!i.activeSemesterId){i.courses=[],document.dispatchEvent(new Event("courses:changed"));return}const e=C(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses");function t(a,n){let r;return(...s)=>{clearTimeout(r),r=setTimeout(()=>a(...s),n)}}et=D(e,t(a=>{const n=a.docs.map(r=>{const s=r.data()||{};return{id:r.id,...s,createdAtMs:s.createdAt instanceof Cr?s.createdAt.toMillis():typeof s.createdAt=="number"?s.createdAt:0}});n.sort((r,s)=>s.createdAtMs-r.createdAtMs),i.courses=n,Es(a),Qa?.(),document.dispatchEvent(new Event("courses:changed"))},300))}function Es(e){const t=o("coursesList");t&&(t.innerHTML="",e.forEach(a=>{const n=a.data(),r=document.createElement("div");r.className="course-item",r.innerHTML=`
      <div>
        <div><b>${Mt(n.name||"Sin nombre")}</b> <span class="course-meta">¬∑ ${Mt(n.code||"")}</span></div>
        <div class="course-meta">${Mt(n.professor||"")}</div>
      </div>
      <div class="inline">
        <button class="ghost course-edit" data-id="${a.id}">Editar</button>
        <button class="danger course-del"  data-id="${a.id}">Eliminar</button>
      </div>
    `,t.appendChild(r)}))}function Ls(){i.editingCourseId=null;const e=o("courseName");e&&(e.value="");const t=o("courseCode");t&&(t.value="");const a=o("courseProfessor");a&&(a.value="");const n=o("courseSectPar");n&&(n.value="");const r=o("courseColor");r&&(r.value="#3B82F6");const s=o("courseColorCode");s&&(s.textContent="#3B82F6");const l=o("saveCourseBtn");l&&(l.textContent="Agregar ramo"),o("cancelEditBtn")?.classList.add("hidden")}function Mt(e){return String(e).replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}let ve=null,xa=!1;function xs(){xa||(xa=!0,Ms())}function Cs(){ve&&(ve(),ve=null);const e=o("semestersList");e&&(e.innerHTML=""),Ae()}function Ms(){const e=o("createSemesterBtn");e&&e.addEventListener("click",async()=>{if(!i.currentUser){alert("Debes iniciar sesi√≥n.");return}const t=As();if(!t){alert("Completa tu universidad en Perfil.");return}const a=(o("semesterLabel")?.value||"").trim();if(!Us(a)){alert("Formato de semestre inv√°lido. Usa AAAA-1 o AAAA-2 (ej. 2025-2).");return}const n=C(g,"users",i.currentUser.uid,"semesters");if(!(await $(J(n,Ma("label","==",a)))).empty){alert("Ya existe un semestre con ese nombre.");return}const r=await $e(n,{label:a,universityAtThatTime:t,createdAt:Date.now()});o("semesterLabel")&&(o("semesterLabel").value="");const s=i.activeSemesterId||null;s&&await cr(s,r.id)}),document.addEventListener("click",async t=>{const a=t.target;if(a instanceof HTMLElement){if(a.matches(".sem-activate")){if(!i.currentUser){alert("Debes iniciar sesi√≥n.");return}const n=a.dataset.id;await dr(n)}if(a.matches(".sem-delete")){if(!i.currentUser){alert("Debes iniciar sesi√≥n.");return}const n=a.dataset.id;if(!confirm("¬øEliminar este semestre?"))return;await Q(w(g,"users",i.currentUser.uid,"semesters",n)),i.activeSemesterId===n&&Ae()}}})}async function lr(){if(ve&&(ve(),ve=null),!i.currentUser)return;const e=i.profileData?.university?.trim()||"",t=i.profileData?.career?.trim()||"",a=o("semestersList");if(!e||!t){a&&(a.innerHTML=`
        <div class="card" style="padding:20px; text-align:center;">
          <h3>‚ö†Ô∏è Antes de agregar semestres necesitas configurar tu perfil</h3>
          <p>Completa tu <b>universidad</b> y <b>carrera</b> para poder crear y visualizar semestres.</p>
          <button id="goToProfileBtn" class="btn-primary" style="margin-top:10px;">
            Ir a Perfil ahora ‚Üí
          </button>
        </div>
      `,o("goToProfileBtn")?.addEventListener("click",()=>{const c=o("subtabPerfil")||document.querySelector('[data-tab="perfil"]'),d=o("perfilContainer")||document.getElementById("perfilContainer");c&&d&&(document.querySelectorAll(".subtab").forEach(m=>m.classList.remove("active")),document.querySelectorAll(".page").forEach(m=>m.classList.add("hidden")),c.classList.add("active"),d.classList.remove("hidden"))}));return}const n=i.currentUser.uid,r=await Y(w(g,"users",n)),s=r.exists()&&r.data()?.activeSemester||null;if(s){i.activeSemesterId=s;const c=await Y(w(g,"users",n,"semesters",s));i.activeSemesterData=c.exists()?c.data():null}if(i.activeSemesterId&&i.activeSemesterData){console.log("[Semesters] Restaurando semestre activo tras recarga:",i.activeSemesterData.label);const c=o("coursesSection");c&&c.classList.remove("hidden");const d=ur(i.activeSemesterData.universityAtThatTime);or(d),ir(),sr();const m=o("activeSemesterLabel");m&&(m.textContent=i.activeSemesterData.label||"‚Äî");const u=o("activeSemesterUni");u&&(u.textContent=i.activeSemesterData.universityAtThatTime||"‚Äî");const p=o("gr-activeSemLabel");p&&(p.textContent=i.activeSemesterData.label||"‚Äî");const f=o("gr-scaleSel"),v=o("gr-passThreshold");f&&(f.value=d==="UMAYOR"?"MAYOR":"USM",f.disabled=!0),v&&(v.value=d==="UMAYOR"?4:55),wt(),Zt?.(),V()}const l=C(g,"users",n,"semesters");ve=D(J(l,he("createdAt","desc")),c=>{const d=o("semestersList");if(d){if(d.innerHTML="",c.empty){Ae();return}if(c.forEach(m=>{const u=m.data(),p=document.createElement("div");p.className="course-item";const f=i.activeSemesterId===m.id;p.innerHTML=`
        <div>
          <div><b>${u.label}</b> <span class="course-meta">¬∑ ${u.universityAtThatTime}</span></div>
        </div>
        <div class="inline">
          ${f?'<span class="course-meta">Activo</span>':`<button class="ghost sem-activate" data-id="${m.id}">Activar</button>`}
          <button class="danger sem-delete" data-id="${m.id}">Eliminar</button>
        </div>
      `,d.appendChild(p)}),c.docs.some(m=>m.id===i.activeSemesterId)||Ae(),!i.activeSemesterId&&!c.empty){const m=c.docs[0].id;console.log("[Semesters] No hab√≠a activo guardado, usando el m√°s reciente:",m),dr(m)}}})}async function cr(e,t){const a=i.currentUser?.uid;if(!(!a||!e||!t))try{const n=C(g,"users",a,"semesters",e,"calendar"),r=C(g,"users",a,"semesters",t,"calendar"),s=await $(n);let l=0;for(const c of s.docs){const d=c.data();d.persistent&&(await $e(r,{...d,createdAt:Date.now()}),l++)}console.log(`üîÅ [Semesters] ${l} eventos persistentes copiados de ${e} a ${t}`)}catch(n){console.error("‚ùå Error copiando eventos persistentes:",n)}}async function dr(e){if(!i.currentUser||!e)return;i.activeSemesterId=e;const t=await Y(w(g,"users",i.currentUser.uid,"semesters",e));i.activeSemesterData=t.exists()?t.data():null,await Z(w(g,"users",i.currentUser.uid),{activeSemester:e},{merge:!0}),i.lastActiveSemesterId&&i.lastActiveSemesterId!==e&&await cr(i.lastActiveSemesterId,e),i.lastActiveSemesterId=e;const a=o("activeSemesterLabel");a&&(a.textContent=i.activeSemesterData?.label||"‚Äî");const n=o("activeSemesterUni");n&&(n.textContent=i.activeSemesterData?.universityAtThatTime||"‚Äî");const r=o("gr-activeSemLabel");r&&(r.textContent=i.activeSemesterData?.label||"‚Äî");const s=ur(i.activeSemesterData?.universityAtThatTime),l=o("gr-scaleSel"),c=o("gr-passThreshold");l&&(l.value=s==="UMAYOR"?"MAYOR":"USM",l.disabled=!0),c&&(c.value=s==="UMAYOR"?4:55);const d=o("coursesSection");d&&d.classList.remove("hidden"),or(s),ir(),sr(),wt(),Zt?.(),V(),lr()}function Ae(){i.activeSemesterId=null,i.activeSemesterData=null;const e=o("activeSemesterLabel");e&&(e.textContent="‚Äî");const t=o("activeSemesterUni");t&&(t.textContent="‚Äî");const a=o("coursesSection");a&&a.classList.add("hidden");const n=o("gr-activeSemLabel");n&&(n.textContent="‚Äî");const r=o("gr-scaleSel");r&&(r.value="USM",r.disabled=!0);const s=o("gr-passThreshold");s&&(s.value=""),wt(),V()}function Us(e){return/^\d{4}-(1|2)$/.test(e||"")}function As(){const e=i.profileData;return!e||!e.university?null:e.university==="OTRA"?(e.customUniversity||"").trim()||null:e.university==="UMAYOR"?"Universidad Mayor":e.university==="USM"?"UTFSM":e.university}function ur(e){if(!e)return"";const t=e.toLowerCase();return t.includes("mayor")?"UMAYOR":t.includes("utfsm")||t.includes("santa mar√≠a")||t.includes("santa maria")?"USM":"OTRA"}function Ca(e){document.querySelectorAll(".nav-tab[data-route]").forEach(t=>{t.dataset.route!=="#/perfil"&&(t.toggleAttribute("disabled",e),t.setAttribute("aria-disabled",String(e)))})}function $s(){if(window.__duoplannerAuthInit)return;window.__duoplannerAuthInit=!0;const e=o("signInBtn"),t=o("signOutBtn"),a=o("switchAccountBtn"),n=o("userBadge"),r=o("userName"),s=d=>{e&&(e.disabled=d),t&&(t.disabled=d),a&&(a.disabled=d)},l=d=>{n&&(n.classList.remove("hidden"),n.style.display="inline-flex"),e&&(e.classList.add("hidden"),e.style.display="none"),r&&(r.textContent=d||"‚Äî");const m=o("createPairBtn"),u=o("copyInviteBtn");m&&(m.disabled=!1),u&&(u.disabled=!1),Ca(!1)},c=()=>{n&&(n.classList.add("hidden"),n.style.display="none"),e&&(e.classList.remove("hidden"),e.style.display="inline-block");const d=o("pairId"),m=o("copyInviteBtn"),u=o("createPairBtn");d&&(d.textContent="‚Äî"),m&&(m.disabled=!0),u&&(u.disabled=!0),i.profileData=null,it(),Ae();const p=o("semestersList");p&&(p.innerHTML=""),Ca(!0),location.hash="#/perfil"};e&&e.addEventListener("click",async()=>{s(!0);const d=new aa;d.setCustomParameters({prompt:"select_account"});try{await ra(Se,d)}catch(m){const u=m?.code||"";u==="auth/popup-blocked"||(u==="auth/popup-closed-by-user"||u==="auth/cancelled-popup-request"||u==="auth/user-cancelled"?console.log("Login cancelado por el usuario."):alert(`No se pudo iniciar sesi√≥n: ${u||m.message||m}`))}finally{s(!1)}}),a&&a.addEventListener("click",async()=>{s(!0);const d=new aa;d.setCustomParameters({prompt:"select_account"});try{await na(Se),await ra(Se,d)}catch(m){const u=m?.code||"";u==="auth/popup-blocked"||(u==="auth/popup-closed-by-user"||u==="auth/cancelled-popup-request"||u==="auth/user-cancelled"?console.log("Cambio de cuenta cancelado por el usuario."):alert(`No se pudo cambiar de cuenta: ${u||m.message||m}`))}finally{s(!1)}}),t&&t.addEventListener("click",async()=>{s(!0);try{await na(Se),i.currentUser=null,i.profileData=null,i.unsubscribeProfile?.(),i.unsubscribeProfile=null,Cs?.(),Ae(),Ia(),c(),V()}catch(d){console.error(d),alert(`No se pudo cerrar sesi√≥n: ${d.code||d.message||d}`)}finally{s(!1)}}),wr(Se,async d=>{if(i.currentUser=d||null,s(!1),d){l(d.displayName||d.email||d.uid);try{await Is(d)}catch(m){console.error("ensureUserDoc failed:",m)}try{$a(),it()}catch(m){console.error("profile listen failed:",m)}setTimeout(()=>{Rr().catch(m=>console.error("loadMyPair failed:",m))},800),setTimeout(()=>{lr().catch(m=>console.error("refreshSemestersSub failed:",m))},1500),setTimeout(()=>{ee(()=>Promise.resolve().then(()=>Pr),void 0).then(m=>m.mountPartnerProfileCard?.()).catch(()=>{})},2500),V()}else c(),V()})}async function Is(e){const t=w(g,"users",e.uid);(await Y(t)).exists()?await Z(t,{email:e.email||null,displayName:e.displayName||null,photoURL:e.photoURL||null,providerId:e.providerData?.[0]?.providerId||"google",lastLoginAt:Date.now()},{merge:!0}):await Z(t,{createdAt:Date.now(),email:e.email||null,displayName:e.displayName||null,photoURL:e.photoURL||null,providerId:e.providerData?.[0]?.providerId||"google",preferences:{showNamesInShared:!0,theme:"dark"},lastLoginAt:Date.now()},{merge:!0})}let N={},Pt=[];function mr(e){const t=(e||"#/perfil").trim();return new Set(["#/perfil","#/semestres","#/horario","#/notas","#/malla","#/calendario","#/progreso","#/asistencia","#/party","#/ayuda"]).has(t)?t:"#/perfil"}function Ts(e){const t=mr(e);location.hash!==t&&(location.hash=t),Ht(t)}function Ht(e){const t=mr(e),a=document.getElementById("pfActions");a&&a.classList.toggle("hidden",t!=="#/perfil"),Pt.forEach(n=>n.classList.toggle("active",n.dataset.route===t)),Object.values(N).forEach(n=>n&&n.classList.add("hidden")),t==="#/perfil"&&N.perfil&&N.perfil.classList.remove("hidden"),t==="#/semestres"&&N.semestres&&N.semestres.classList.remove("hidden"),t==="#/horario"&&N.horario&&N.horario.classList.remove("hidden"),t==="#/notas"&&N.notas&&(N.notas.classList.remove("hidden"),document.dispatchEvent(new Event("route:notas"))),t==="#/malla"&&N.malla&&N.malla.classList.remove("hidden"),t==="#/progreso"&&N.progreso&&N.progreso.classList.remove("hidden"),t==="#/calendario"&&N.calendario&&(N.calendario.classList.remove("hidden"),document.dispatchEvent(new Event("route:calendario"))),t==="#/asistencia"&&N.asistencia&&N.asistencia.classList.remove("hidden"),t==="#/party"&&N.party&&N.party.classList.remove("hidden"),t==="#/ayuda"&&N.ayuda&&N.ayuda.classList.remove("hidden"),document.dispatchEvent(new CustomEvent("route:change",{detail:{route:t}}))}function Ns(){N={perfil:o("page-perfil"),semestres:o("page-semestres"),horario:o("page-horario"),notas:o("page-notas"),malla:o("page-malla"),calendario:o("page-calendario"),progreso:o("page-progreso"),asistencia:o("page-asistencia"),party:o("page-party"),ayuda:o("page-ayuda")},Pt=Array.from(document.querySelectorAll(".tab[data-route]"))||[],Pt.forEach(e=>e.addEventListener("click",()=>Ts(e.dataset.route))),window.addEventListener("hashchange",()=>Ht(location.hash)),Ht(location.hash||"#/perfil")}async function Ds(){const e=await fetch("data/medvet_malla.csv").then(a=>a.text()).catch(()=>""),t=await fetch("data/ictel_malla.csv").then(a=>a.text()).catch(()=>"");return{MEDVET:e?ks(e):[],ICTEL:t?Os(t):[]}}function pr(e){const t=e.trim().split(/\r?\n/).filter(Boolean);if(!t.length)return[];const a=t[0],n=a.split(";").length>=a.split(",").length?";":",",r=a.split(n).map(s=>s.trim().replace(/^['\"]|['\"]$/g,""));return t.slice(1).map(s=>{const l=s.split(n).map(d=>d.trim().replace(/^['\"]|['\"]$/g,"")),c={};return r.forEach((d,m)=>c[d]=l[m]??""),c})}function ks(e){return pr(e).map(t=>{let a=t["C√≥digo Asignatura"]||t["Codigo Asignatura"]||"";return a.includes(".")&&(a=a.split(".")[0]),{codigo:a,nivel:(t.Nivel||"").trim()}})}function Os(e){return pr(e).map(t=>{const a={};for(const[s,l]of Object.entries(t)){const c=s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();a[c]=(l||"").trim()}const n=(...s)=>{for(const l of s){const c=l.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();if(c in a&&a[c])return a[c]}return""};let r=n("Sigla","C√≥digo","Codigo","C√≥digo Asignatura","Codigo Asignatura");return r||(r=n("C√≥digo Asignatura","Codigo Asignatura","C√≥digo","Codigo")),{codigo:r||"",nivel:(n("Nivel","Semestre")||"").toUpperCase()}})}function Ps(){const e=i.profileData?.university||"GEN",t=i.profileData?.career||"GEN";try{return JSON.parse(localStorage.getItem(`mallaAprobados:${e}:${t}`)||"[]")}catch{return[]}}function Ut(e,t){return t?e/t*100:0}function At(e){return`${(Math.round(e*10)/10).toFixed(1)}%`}let ne=null,tt=null;async function Hs(){ne=await Ds(),document.addEventListener("profile:changed",ue),document.addEventListener("malla:updated",ue),document.addEventListener("courses:changed",ue),document.addEventListener("pair:ready",ue),document.addEventListener("route:change",e=>{e.detail?.route==="#/progreso"&&ue()})}async function ue(){const e=o("prog-combinado");if(!e)return;e.classList.remove("hidden"),e.innerHTML='<h3 style="margin:0 0 8px">Progreso combinado</h3><div class="muted">Conectando‚Ä¶</div>';const t=i.profileData?.career||null;if(!t||!ne){e.innerHTML=`<h3 style="margin:0 0 8px">Progreso combinado</h3>
    <div class="muted">Completa tu perfil antes de ver el progreso. üå±</div>`;return}const a=ne&&ne[t]?ne[t].length:0,n=Ps(),r=a?Ut(n.length,a):0;tt&&(tt(),tt=null);const s=i.pairOtherUid||null;if(!s){e.innerHTML=`<h3 style="margin:0 0 8px">Progreso combinado</h3>
    <div class="muted">A√∫n no est√°s conectado a un d√∫o. Crea o √∫nete a una party. üë•</div>`;return}const l=w(g,"users",s,"malla","state");tt=D(l,async c=>{const d=c.data()||{};let m=d.career||null;if((m==="UMAYOR"||m==="USM")&&(m=null),!m)try{const v=await Y(w(g,"users",s));if(v.exists()){const S=v.data()||{};S.career&&(m=S.career)}}catch{}const u=Array.isArray(d.approved)?d.approved.length:0,p=m&&ne&&ne[m]?ne[m].length:0,f=a+p?Ut(n.length+u,a+p):0;e.innerHTML=`
      <h3 style="margin:0 0 8px">üèÅ Progreso combinado</h3>
      <div style="font-weight:600; margin-bottom:4px">Juntos llevan ${At(f)}</div>
      <div class="progress-outer small"><div class="progress-inner" style="width:${f}%;"></div></div>
      <div class="muted" style="margin-top:6px">T√∫: ${At(r)} ¬∑ Duo: ${At(Ut(u,p))}</div>
    `},c=>{e.innerHTML='<div class="muted">Error al conectar con el progreso del d√∫o.</div>'})}(function(){const e="prog-inline-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent=`
    .progress-outer{background:rgba(255,255,255,.08); border:1px solid rgba(0,0,0,.25);
      border-radius:10px; height:14px; margin-top:8px; overflow:hidden}
    .progress-outer.small{height:10px}
    .progress-inner{height:100%; background:linear-gradient(90deg, var(--primary), var(--accent));}
  `,document.head.appendChild(t)})();document.addEventListener("route:change",e=>{e.detail?.route==="#/party"&&ue()});const Rs=Object.freeze(Object.defineProperty({__proto__:null,initProgreso:Hs,refreshProgreso:ue},Symbol.toStringTag,{value:"Module"}));window.addEventListener("DOMContentLoaded",()=>{$s(),Ns(),Hr(),xs(),document.addEventListener("route:change",async e=>{const t=e.detail.route;t.startsWith("#/notas")?(await ee(()=>Promise.resolve().then(()=>ws),void 0)).initGrades?.():t.startsWith("#/malla")?(await ee(()=>Rt(()=>import("./malla-Dr0Yn5af-DX2P6GsJ.js"),[]),[])).initMallaOnRoute?.():t.startsWith("#/asistencia")?(await ee(()=>Promise.resolve().then(()=>Pn),void 0)).initAttendance?.():t.startsWith("#/horario")?(await ee(()=>Promise.resolve().then(()=>un),void 0)).initSchedule?.():t.startsWith("#/calendario")?(await ee(()=>Promise.resolve().then(()=>$n),void 0)).initCalendar?.():t.startsWith("#/progreso")&&(await ee(()=>Promise.resolve().then(()=>Rs),void 0)).initProgreso?.()})});export{g as h,i,o};
