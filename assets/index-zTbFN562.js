import{getApps as er,getApp as tr,initializeApp as nr}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth as ar,setPersistence as rr,browserLocalPersistence as sr,GoogleAuthProvider as $n,signInWithPopup as Dn,signOut as kn,onAuthStateChanged as or}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{initializeFirestore as ir,persistentLocalCache as cr,deleteDoc as oe,doc as L,collection as M,onSnapshot as Y,query as te,getDoc as J,updateDoc as z,addDoc as Ae,getDocs as H,orderBy as Pe,setDoc as X,where as ma,serverTimestamp as fa,Timestamp as lr,arrayRemove as dr,arrayUnion as ur}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import mr from"https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/+esm";import{jsPDF as fr}from"https://cdn.jsdelivr.net/npm/jspdf@2.5.1/+esm";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const pr="modulepreload",vr=function(e){return"/DuoPlanner/"+e},Nn={},Q=function(t,n,a){let r=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),i=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));r=Promise.allSettled(n.map(u=>{if(u=vr(u),u in Nn)return;Nn[u]=!0;const d=u.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${m}`))return;const f=document.createElement("link");if(f.rel=d?"stylesheet":pr,d||(f.as="script"),f.crossOrigin="",f.href=u,i&&f.setAttribute("nonce",i),document.head.appendChild(f),d)return new Promise((p,g)=>{f.addEventListener("load",p),f.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${u}`)))})}))}function s(l){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=l,window.dispatchEvent(i),!i.defaultPrevented)throw l}return r.then(l=>{for(const i of l||[])i.status==="rejected"&&s(i.reason);return t().catch(s)})},hr={apiKey:"AIzaSyB45g_2KRGlXH0iAPyBGuCnrFkhxCHadKs",authDomain:"nacholo.firebaseapp.com",projectId:"nacholo",storageBucket:"nacholo.appspot.com",messagingSenderId:"924503328068",appId:"1:924503328068:web:1f753ced7f47ec36750311"},pa=er().length?tr():nr(hr),b=ir(pa,{localCache:cr()}),Fe=ar(pa);rr(Fe,sr).catch(()=>{});const o={currentUser:null,currentPairId:null,profileData:null,activeSemesterId:null,activeSemesterData:null,unsubscribeCourses:null,editingCourseId:null,pairOtherUid:null,shared:{horario:{semId:null},notas:{semId:null},malla:{enabled:!1},calendar:{semId:null}},DEBUG:(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&(new URLSearchParams(location.search).has("debug")||((window==null?void 0:window.PartyPlannerDebug)??!1))},c=e=>typeof e=="string"?document.getElementById(e):null;function re(){var t;if(!o.DEBUG)return;const e=c("state");e&&(e.textContent=JSON.stringify({uid:((t=o.currentUser)==null?void 0:t.uid)||null,pairId:o.currentPairId,pairOtherUid:o.pairOtherUid||null,profileData:o.profileData,activeSemesterId:o.activeSemesterId,editingCourseId:o.editingCourseId},null,2))}function Pn(e,t){e&&(t?e.classList.add("hidden"):e.classList.remove("hidden"))}window.__state=o;function ut(e,t,n,a){if(!e)return;const r=`bound_${a||t}`;e.dataset[r]!=="1"&&(e.addEventListener(t,n),e.dataset[r]="1")}function va(e){return(e||"").replace(/[^\w\s.-]+/g,"").replace(/\s+/g,"_")||"export"}function On(){var e;return((e=o.activeSemesterData)==null?void 0:e.label)||"semestre"}async function ha(e,t=2){const n=e.style.backgroundColor;n||(e.style.backgroundColor=getComputedStyle(document.body).backgroundColor||"#111");const a=await mr(e,{scale:t,backgroundColor:null,useCORS:!0,allowTaint:!0,windowWidth:document.documentElement.scrollWidth,windowHeight:document.documentElement.scrollHeight});return n||(e.style.backgroundColor=""),a}async function Rn(e,t){try{const n=await ha(e,2),a=document.createElement("a");a.href=n.toDataURL("image/png"),a.download=`${va(t)}.png`,a.click()}catch(n){console.error("[exportNodeAsPNG]",n)}}async function _n(e,t){try{const n=await ha(e,2),a=n.toDataURL("image/png"),r=n.width,s=n.height,l=r>=s?"l":"p",i=new fr({unit:"pt",format:"a4",orientation:l}),u=i.internal.pageSize.getWidth(),d=i.internal.pageSize.getHeight(),m=Math.min(u/r,d/s),f=r*m,p=s*m;i.addImage(a,"PNG",(u-f)/2,(d-p)/2,f,p),i.save(`${va(t)}.pdf`)}catch(n){console.error("[exportNodeAsPDF]",n)}}function gr(){const e=c("btn-export-malla-png"),t=c("btn-export-malla-pdf");if(e||t){const r=document.querySelector("#page-malla .malla-wrapper")||c("page-malla"),s=`malla_${On()}`;ut(e,"click",()=>Rn(r,s),"malla_png"),ut(t,"click",()=>_n(r,s),"malla_pdf")}const n=c("btn-export-horario-png"),a=c("btn-export-horario-pdf");if(n||a){const r=document.querySelector("#horarioCombinado:not(.hidden)")||document.querySelector("#schedUSM")||c("horarioPropio")||c("page-horario"),s=`horario_${On()}`;ut(n,"click",()=>Rn(r,s),"horario_png"),ut(a,"click",()=>_n(r,s),"horario_pdf")}}let Tt="#22c55e",$t="#ff69b4",mt=null,Bn=!1,Dt=!1,je=null;const He=80,Hn=28;let Ue=[],en=[];const nt=["Lun","Mar","Mi√©","Jue","Vie"];function yr(e){if(!Dt)return;const t=e.clientY,n=window.innerHeight;let a=0;if(t<He){const r=(He-t)/He;a=-Math.ceil(Hn*r)}else if(t>n-He){const r=(t-(n-He))/He;a=Math.ceil(Hn*r)}a!==0&&je===null&&(je=requestAnimationFrame(()=>{window.scrollBy(0,a),je=null}))}function Fn(){Dt=!1,je&&(cancelAnimationFrame(je),je=null)}let ue={};const me=[{label:"1/2",start:"08:15",end:"09:25",lines:[{n:"1",start:"08:15",end:"08:50"},{n:"2",start:"08:50",end:"09:25"}]},{label:"3/4",start:"09:40",end:"10:50",lines:[{n:"3",start:"09:40",end:"10:15"},{n:"4",start:"10:15",end:"10:50"}]},{label:"5/6",start:"11:05",end:"12:15",lines:[{n:"5",start:"11:05",end:"11:40"},{n:"6",start:"11:40",end:"12:15"}]},{label:"7/8",start:"12:30",end:"13:40",lines:[{n:"7",start:"12:30",end:"13:05"},{n:"8",start:"13:05",end:"13:40"}]},{label:"ALMUERZO",start:"13:40",end:"14:40",lunch:!0},{label:"9/10",start:"14:40",end:"15:50",lines:[{n:"9",start:"14:40",end:"15:15"},{n:"10",start:"15:15",end:"15:50"}]},{label:"11/12",start:"16:05",end:"17:15",lines:[{n:"11",start:"16:05",end:"16:40"},{n:"12",start:"16:40",end:"17:15"}]},{label:"13/14",start:"17:30",end:"18:40",lines:[{n:"13",start:"17:30",end:"18:05"},{n:"14",start:"18:05",end:"18:40"}]},{label:"15/16",start:"18:55",end:"20:05",lines:[{n:"15",start:"18:55",end:"19:30"},{n:"16",start:"19:30",end:"20:05"}]},{label:"17/18",start:"20:20",end:"21:30",lines:[{n:"17",start:"20:20",end:"20:55"},{n:"18",start:"20:55",end:"21:30"}]},{label:"19/20",start:"21:45",end:"22:55",lines:[{n:"19",start:"21:45",end:"22:20"},{n:"20",start:"22:20",end:"22:55"}]}],Oe=[ve("1/2","08:30","09:40",["08:30-09:05","09:05-09:40"]),ve("3/4","10:00","11:10",["10:00-10:35","10:35-11:10"]),ve("5/6","11:30","12:40",["11:30-12:05","12:05-12:40"]),{label:"ALMUERZO",start:"12:40",end:"14:00",lunch:!0},ve("7/8","14:00","15:10",["14:00-14:35","14:35-15:10"]),ve("9/10","15:30","16:40",["15:30-16:05","16:05-16:40"]),ve("11/12","17:00","18:10",["17:00-17:35","17:35-18:10"]),ve("13/14","18:30","19:40",["18:30-19:05","19:05-19:40"]),ve("15/16","20:00","21:10",["20:00-20:35","20:35-21:10"]),ve("17/18","21:30","22:40",["21:30-22:05","22:05-22:40"])];function ve(e,t,n,a){return{label:e,start:t,end:n,lines:a.map(r=>{const[s,l]=r.split("-");return{start:s,end:l}})}}function ga(e){if(!e)return"";const t=String(e).toLowerCase();return t==="umayor"||t.includes("mayor")?"UMAYOR":t==="usm"||t==="utfsm"||t.includes("utfsm")||t.includes("santa mar√≠a")||t.includes("santa maria")?"USM":"OTRA"}function Yt(){var t,n;const e=((t=o.activeSemesterData)==null?void 0:t.universityAtThatTime)||((n=o.profileData)==null?void 0:n.university)||"";return ga(e)}async function br(){var r,s;const e=Yt();if(e==="UMAYOR")return Oe;if(e==="USM")return me;if(ue[e])return ue[e];if(o.currentUser){const l=L(b,"users",o.currentUser.uid,"custom_schedules",e),i=await J(l);if(i.exists()){const u=((r=i.data())==null?void 0:r.slots)||[];return ue[e]=u,u}}const t=`custom_slots_${e}_${(s=o.currentUser)==null?void 0:s.uid}`,n=localStorage.getItem(t);if(n)try{const l=JSON.parse(n);return ue[e]=l,l}catch{}return e==="USM"||e==="UMAYOR"?e==="USM"?me:Oe:null}function ya(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function dn(e,t,n){const a=(e||[]).find(r=>r.id===t);return ya(a==null?void 0:a.color)?a.color:n||"#3B82F6"}function un(e){try{const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return(t*299+n*587+a*114)/1e3>=160?"#111":"#fff"}catch{return"#0e0e0e"}}let ft=null,ee=[];function ba(){var d;if(Bn)return;Bn=!0,Sr(),Lr(),xr(),Ar(),Mr(),Ke(),document.addEventListener("pair:ready",m=>{var p;if((p=m.detail)==null?void 0:p.otherUid)nn(),Ke();else{const g=c("sh-semSel");g&&(g.innerHTML="<option disabled selected>Sin compa√±ero</option>")}}),(d=c("sh-semSel"))==null||d.addEventListener("change",m=>{o.shared.horario.semId=m.target.value||null,Xe(o.shared.horario.semId)});const e=c("subtabPropio"),t=c("subtabCompartido"),n=c("subtabCombinado"),a=c("horarioPropio"),r=c("horarioCompartido"),s=c("horarioCombinado");function l(){e.classList.add("active"),t.classList.remove("active"),n.classList.remove("active"),a.classList.remove("hidden"),r.classList.add("hidden"),s.classList.add("hidden")}function i(){var f,p;if(t.getAttribute("aria-disabled")==="true"){alert("Debes emparejarte primero para ver el horario de la otra persona.");return}t.classList.add("active"),e.classList.remove("active"),n.classList.remove("active"),r.classList.remove("hidden"),a.classList.add("hidden"),s.classList.add("hidden");const m=c("sh-semSel");if(m&&!m.value){const g=Array.from(m.options).find(v=>v.value);g&&(m.value=g.value),m!=null&&m.value&&(o.shared.horario.semId=m.value)}(p=(f=o.shared)==null?void 0:f.horario)!=null&&p.semId?Xe(o.shared.horario.semId):nn().then(()=>Ke())}function u(){n.classList.add("active"),e.classList.remove("active"),t.classList.remove("active"),s.classList.remove("hidden"),a.classList.add("hidden"),r.classList.add("hidden"),fn()}e.addEventListener("click",l),t.addEventListener("click",i),n.addEventListener("click",u),l(),document.addEventListener("courses:changed",()=>{mn(),ie()}),document.addEventListener("click",async m=>{const f=m.target.closest(".block-del-btn");if(!f)return;const p=f.dataset.id;if(!(!p||!o.currentUser||!o.activeSemesterId)&&confirm("¬øEliminar este bloque del horario?"))try{await oe(L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"schedule",p))}catch(g){console.error(g),alert("No se pudo eliminar el bloque.")}}),setTimeout(async()=>{var m,f,p;o.pairOtherUid&&((m=o.activeSemesterData)!=null&&m.label)&&(await Ke(),(p=(f=o.shared)==null?void 0:f.horario)!=null&&p.semId&&await Xe(o.shared.horario.semId))},1500),gr()}function We(){if(ft&&(ft(),ft=null),ee=[],ie(),o.pairOtherUid&&nn().then(()=>{Ke().then(()=>{var t,n;(n=(t=o.shared)==null?void 0:t.horario)!=null&&n.semId&&Xe(o.shared.horario.semId)})}),!o.currentUser||!o.activeSemesterId)return;const e=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"schedule");ft=Y(te(e),t=>{ee=t.docs.map(n=>({id:n.id,...n.data()})),ie()})}function Sr(){const e=c("horarioPropio");e.innerHTML=`
  <div class="card" style="margin-bottom:12px">
    <h3 style="margin:0 0 10px">Paleta de ramos</h3>
    <div id="coursePalette" class="palette"></div>
    <div class="muted" style="margin-top:6px">
      <ul style="margin:4px 0 0 20px; padding:0; list-style:disc;">
        <li>Arrastra un ramo a un m√≥dulo.</li>
        <li>Puedes arrastrar ramos del mismo horario.</li>
        <li>La pre-vista indica <b>arriba</b>, <b>completo</b>, <b>abajo</b>, <b>izquierda</b> o <b>derecha</b>.</li>
        <li>Para eliminar un bloque, haz <b>click</b> en la X.</li>
        <li>Para editar un bloque, haz <b>click</b> sobre √©l.</li>
        <li>Para editar una sala, haz <b>click derecho</b> sobre √©l.</li>
        <li>Para ver su sala, pase el mouse por encima.</li>
        <li>En horario personalizado, haz <b>click</b> sobre los horarios de los m√≥dulos para modificarlos.</li>
      </ul>
    </div>
  </div>
  <div id="schedUSM" class="sched-usm card"></div>
`,mn(),ie()}function wr(){mn(),ie()}function mn(){const e=c("coursePalette");if(!e)return;e.innerHTML="";const t=Array.isArray(o.courses)?o.courses:[];if(t.length===0){e.innerHTML='<div class="muted">No hay ramos en el semestre activo.</div>';return}t.forEach(n=>{const a=document.createElement("div");a.className="palette-chip",a.setAttribute("draggable","true"),a.dataset.courseId=n.id,a.textContent=n.name;const r=ya(n.color)?n.color:"#3B82F6";a.style.borderColor=r,a.style.boxShadow="inset 0 0 0 2px rgba(0,0,0,.15)",e.appendChild(a)})}async function ie(){var d,m,f,p,g,v;const e=c("schedUSM");if(!e)return;let t=await br();Ue=t;const n=Yt(),a=n==="USM"||n==="UMAYOR",r=`custom_slots_${n}_${(d=o.currentUser)==null?void 0:d.uid}`,s=!!localStorage.getItem(r);if(document.querySelectorAll(".schedule-controls").forEach(y=>y.remove()),!t){e.innerHTML=`
      <div class="card" style="padding:20px;text-align:center;">
        <p style="margin-bottom:15px;font-size:1.1em">
          No hay un horario definido para esta universidad.
        </p>
        <button id="btnCreateCustomSched" class="btn violet">Crear nuevo horario</button>
      </div>
    `,(m=c("btnCreateCustomSched"))==null||m.addEventListener("click",()=>pt(!1));return}const l=document.createElement("div");l.className="card schedule-controls",l.style="padding:12px;text-align:center;margin-bottom:10px;",!a||n==="OTRA"?l.innerHTML=`
      <button id="btnCreateCustomSched" class="btn violet" ${s?"disabled":""}>
        Crear horario personalizado
      </button>
      ${s?`
        <button id="btnEditCustomSched" class="btn violet-outline">
          Editar horario personalizado
        </button>
        <button id="btnDeleteCustomSched" class="btn red">
          Borrar horario personalizado
        </button>
      `:""}
    `:l.innerHTML=`
      <button id="btnUseDefaultSched" class="btn blue" ${s?"":"disabled"}>
        Usar horario por defecto
      </button>
      <button id="btnCreateCustomSched" class="btn violet" ${s?"disabled":""}>
        Crear horario personalizado
      </button>
      ${s?`
        <button id="btnEditCustomSched" class="btn violet-outline">
          Editar horario personalizado
        </button>
        <button id="btnDeleteCustomSched" class="btn red">
          Borrar horario personalizado
        </button>
      `:""}
    `,e.before(l),(f=c("btnCreateCustomSched"))==null||f.addEventListener("click",()=>{pt(!1)}),(p=c("btnUseDefaultSched"))==null||p.addEventListener("click",async()=>{localStorage.removeItem(r),await zn(n),alert("Se restaur√≥ el horario por defecto."),Ue=n==="USM"?me:Oe,ie()}),(g=c("btnEditCustomSched"))==null||g.addEventListener("click",async()=>{const y=localStorage.getItem(r);let h=null;if(y)try{h=JSON.parse(y)}catch{}if(!h||h.length===0){alert("No hay horario personalizado guardado para editar.");return}confirm("¬øDeseas volver a generar este horario con diferentes bloques o tiempos?")&&(alert("Ahora puedes modificar el horario. Se reemplazar√° el anterior."),await pt(!0))}),(v=c("btnDeleteCustomSched"))==null||v.addEventListener("click",async()=>{var x;if(!confirm("¬øSeguro que deseas borrar tu horario personalizado? Esta acci√≥n no se puede deshacer."))return;if(localStorage.removeItem(r),await zn(n),delete ue[n],Ue=[],alert("Horario personalizado eliminado."),!(n==="USM"||n==="UMAYOR")){const E=c("schedUSM");E&&(E.innerHTML=`
          <div class="card" style="padding:20px;text-align:center;">
            <p style="margin-bottom:15px;font-size:1.1em">
              No hay un horario definido para esta universidad.
            </p>
            <button id="btnCreateCustomSched" class="btn violet">Crear nuevo horario</button>
          </div>
        `,(x=c("btnCreateCustomSched"))==null||x.addEventListener("click",()=>pt(!1)));return}const h=n==="USM"?me:Oe;ue[n]=h,Ue=h,ie()});const u=n==="USM"?"Bloque":"M√≥dulo";e.innerHTML=`
    <div class="usm-grid2">
      <div class="cell header">${u}</div>
      ${nt.map(y=>`<div class="cell header">${y}</div>`).join("")}
      ${t.map((y,h)=>`
        <div class="cell mod ${y.lunch?"lunch":""}" data-slot="${h}">
          ${Sa(y,h,n||(a?"USM":"OTRA"))}
        </div>
        ${nt.map((x,E)=>`
          <div class="cell slot ${y.lunch?"is-lunch":""}"
               data-day="${E}" data-slot="${h}"
               ${y.lunch?'aria-disabled="true"':""}>
            ${Cr(E,h)}
          </div>
        `).join("")}
      `).join("")}
    </div>
  `,wa(),e.querySelectorAll(".placed").forEach(y=>{if(!y.querySelector(".block-del-btn")){const h=document.createElement("button");h.className="block-del-btn",h.textContent="√ó",h.dataset.id=y.dataset.id,y.appendChild(h)}})}async function pt(e=!1){const t=Yt()||"OTRA",n=parseInt(prompt(e?"Nueva cantidad de bloques por d√≠a:":"¬øCu√°ntos bloques por d√≠a tiene tu horario?"),10);if(!n||n<=0)return alert("N√∫mero inv√°lido.");const a=prompt("Hora de inicio del primer bloque (HH:MM)","08:15"),r=prompt("Hora de fin del primer bloque (HH:MM)","09:25"),s=prompt("Hora de inicio del segundo bloque (HH:MM)","09:40"),l=prompt("Hora de fin del segundo bloque (HH:MM)","10:50");if(!a||!r||!s||!l)return alert("Debes ingresar las horas correctamente.");const i=Z(a),u=Z(s);Z(r)-Z(a),u-Z(r);const d=[];let m=i;const f=Z(r)-Z(a),p=Z(s)-Z(r);for(let g=0;g<n;g++){const v=m,y=v+f,h=g+1,x=ce(v),E=ce(y);d.push({label:String(h),start:x,end:E,lines:[{n:String(h),start:x,end:E}]}),m=y+p}ue[t]=d,localStorage.setItem(`custom_slots_${t}_${o.currentUser.uid}`,JSON.stringify(d)),await Rr(t,d),alert(e?"Horario personalizado actualizado.":"Horario personalizado creado exitosamente."),ie()}function ce(e){const t=Math.floor(e/60),n=e%60;return`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}`}function Sa(e,t,n){if(e.lunch)return`
      <div class="mod-label">ALMUERZO</div>
      <div class="mod-time">${e.start}‚Äì${e.end}</div>
    `;if(en.length,n==="OTRA"||!e.label.includes("/"))return`
      <div class="mod-lines">
        <div class="line-num">${e.label}</div>
        <div class="line-time">${e.start}‚Äì${e.end}</div>
      </div>
    `;if(n==="USM"){const r=t*2+1,s=r+1;return`
      <div class="mod-lines">
        <div class="line-num">${r}</div>
        <div class="line-time">${e.lines[0].start}‚Äì${e.lines[0].end}</div>
        <div class="line-num">${s}</div>
        <div class="line-time">${e.lines[1].start}‚Äì${e.lines[1].end}</div>
      </div>
    `}return`
    <div class="mod-lines">
      <div class="line-num">${t+1}</div>
      <div class="line-time">${e.start}‚Äì${e.end}</div>
    </div>
  `}document.addEventListener("click",e=>{const t=e.target.closest(".mod-lines");if(!t)return;const n=Yt();if(!ue[n])return;const r=Array.from(t.parentNode.parentNode.querySelectorAll(".mod")).indexOf(t.parentNode);if(r<0)return;const s=ue[n],l=s[r];Z(l.start);const i=Z(l.end),u=prompt(`Inicio de ${l.label}`,l.start),d=prompt(`Fin de ${l.label}`,l.end);if(!u||!d)return;const m=Z(u),f=Z(d);if(isNaN(m)||isNaN(f)||f<=m){alert("Horas inv√°lidas.");return}l.start=ce(m),l.end=ce(f),l.lines=[{n:l.label.split("/")[0],start:ce(m),end:ce(f)}];const p=f-m;if(r<s.length-1){const g=Z(s[r+1].start)-i;let v=f+g;for(let y=r+1;y<s.length;y++){const h=s[y],x=y+1;h.start=ce(v),h.end=ce(v+p),h.lines=[{n:String(x),start:h.start,end:ce(v+p/2)},{n:String(x+1),start:ce(v+p/2),end:h.end}],v=Z(h.end)+g}}localStorage.setItem(`custom_slots_${n}_${o.currentUser.uid}`,JSON.stringify(s)),ue[n]=s,ie()});function Cr(e,t){const n=ee.filter(r=>r.day===e&&r.slot===t);if(!n.length)return"";const a=r=>{const s=n.filter(i=>(i.pos||"full")===r);return s.length?s.sort((i,u)=>{const d={left:0,single:1,right:2};return(d[i.hpos||"single"]??1)-(d[u.hpos||"single"]??1)}).map(i=>Er(i,r)).join(""):""};return`
    ${a("top")}
    ${a("full")}
    ${a("bottom")}
  `}function Er(e,t){const n=(o.courses||[]).find(m=>m.id===e.courseId),a=(n==null?void 0:n.name)||"Ramo",r=typeof e.displayName=="string"&&e.displayName.trim()?e.displayName.trim():a,s=dn(o.courses,e.courseId,Tt),l=un(s),i=typeof e.room=="string"&&e.room.trim()?e.room.trim():null,u=e.hpos||"single",d=`${r}${i?` ¬∑ Sala: ${i}`:""}`;return`
  <div class="placed pos-${t} h-${u}" data-id="${e.id}"
       draggable="true"
       title="${d}"
       style="background:${s}; border:1px solid rgba(0,0,0,0.25);">
    <div class="placed-title" style="color:${l}; font-weight:600;">${r}</div>
  </div>
`}function Lr(){window.addEventListener("dragover",yr,{passive:!0}),document.addEventListener("drop",Fn),document.addEventListener("dragend",Fn),document.addEventListener("dragstart",e=>{const t=e.target;t&&t.classList.contains("palette-chip")&&(e.dataTransfer.setData("text/plain",t.dataset.courseId),e.dataTransfer.effectAllowed="copy",Dt=!0)}),document.addEventListener("dragstart",e=>{const t=e.target.closest(".placed");t&&(e.dataTransfer.setData("text/plain",JSON.stringify({type:"move-block",id:t.dataset.id})),e.dataTransfer.effectAllowed="move",Dt=!1)}),wa()}function xr(){document.addEventListener("click",e=>{const t=e.target.closest(".placed-title");if(!t||!t.closest("#schedUSM")||document.querySelector("input.inline-rename"))return;const a=t.closest(".placed");if(!a)return;const r=a.dataset.id,s=ee.find(p=>p.id===r);if(!s)return;const l=(o.courses||[]).find(p=>p.id===s.courseId),i=(l==null?void 0:l.name)||t.textContent.trim(),u=typeof s.displayName=="string"&&s.displayName.trim()?s.displayName.trim():i,d=document.createElement("input");d.type="text",d.className="inline-rename",d.value=u;const m=Math.max(t.offsetWidth,140);d.style.width=m+"px",t.replaceWith(d),d.focus(),d.select();const f=async p=>{const g=document.createElement("div");g.className="placed-title";const v=(d.value||"").trim();if(g.textContent=p?v||i:u,d.replaceWith(g),!!p&&v!==u&&!(!o.currentUser||!o.activeSemesterId))try{const y=L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"schedule",s.id);await z(y,v?{displayName:v}:{displayName:null});const x=ee.findIndex(E=>E.id===s.id);x>=0&&(ee[x].displayName=v||null)}catch(y){console.error("rename error",y),alert("No se pudo renombrar el bloque. Intenta nuevamente."),g.textContent=u}};d.addEventListener("keydown",p=>{p.key==="Enter"&&(p.preventDefault(),f(!0)),p.key==="Escape"&&(p.preventDefault(),f(!1))}),d.addEventListener("blur",()=>f(!0))})}function Ar(){document.addEventListener("contextmenu",async e=>{const t=e.target.closest(".placed");if(!t||!t.closest("#schedUSM"))return;e.preventDefault();const a=t.dataset.id,r=ee.find(u=>u.id===a);if(!r||!o.currentUser||!o.activeSemesterId)return;const s=(r.room||"").trim(),l=prompt("Sala del ramo (deja vac√≠o para borrar):",s);if(l===null)return;const i=(l||"").trim();try{const u=L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"schedule",r.id);await z(u,{room:i||null});const d=ee.findIndex(m=>m.id===r.id);d>=0&&(ee[d].room=i||null),ie()}catch(u){console.error("room update error",u),alert("No se pudo actualizar la sala. Intenta nuevamente.")}})}function wa(){document.querySelectorAll(".cell.slot").forEach(e=>{e.classList.contains("is-lunch")||(e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect=t.dataTransfer.effectAllowed==="move"?"move":"copy";const n=e.getBoundingClientRect(),a=t.clientX-n.left,r=t.clientY-n.top,s=n.height/2;let l="full";r<s-10?l="top":r>s+10&&(l="bottom");let i="single";const u=a/n.width;u<.4?i="left":u>.6&&(i="right"),e.dataset.droppos=l,e.dataset.droph=i,e.classList.add("over"),e.classList.remove("hint-top","hint-full","hint-bottom","hint-left","hint-center","hint-right"),l==="top"&&e.classList.add("hint-top"),l==="full"&&e.classList.add("hint-full"),l==="bottom"&&e.classList.add("hint-bottom"),i==="left"&&e.classList.add("hint-left"),i==="single"&&e.classList.add("hint-center"),i==="right"&&e.classList.add("hint-right")}),e.addEventListener("dragleave",()=>be(e)),e.addEventListener("drop",async t=>{t.preventDefault();const n=t.dataTransfer.getData("text/plain");if(!n)return;const a=parseInt(e.dataset.day,10),r=parseInt(e.dataset.slot,10),s=e.dataset.droppos||"full",l=e.dataset.droph||"single";let i=null;try{i=JSON.parse(n)}catch{}if(i&&i.type==="move-block"){const p=i.id;if(!ee.find(v=>v.id===p))return;if(!o.currentUser||!o.activeSemesterId){alert("Selecciona un semestre activo antes de mover bloques."),be(e);return}try{const v=L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"schedule",p),y=(Ue||[])[r];await z(v,{day:a,slot:r,pos:s,hpos:l,start:y.start,end:y.end,updatedAt:Date.now()});const h=ee.findIndex(x=>x.id===p);h>=0&&Object.assign(ee[h],{day:a,slot:r,pos:s,hpos:l,start:y.start,end:y.end}),ie()}catch(v){console.error("move error",v),alert("No se pudo mover el bloque (error Firestore): "+((v==null?void 0:v.message)||v))}be(e);return}const u=n;if(!o.currentUser||!o.activeSemesterId){alert("Selecciona un semestre."),be(e);return}const m=ee.filter(p=>p.day===a&&p.slot===r).filter(p=>(p.pos||"full")===s);if(m.length>=2){alert("Esta zona ya tiene dos ramos (izq/der)."),be(e);return}if(m.length===1){const p=m[0],g=p.hpos||"single";if(s==="full"&&l==="single"){alert("Ya hay un ramo aqu√≠. Elige izquierda o derecha."),be(e);return}if(g==="single"){const v=l==="left"?"right":"left";try{await z(L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"schedule",p.id),{hpos:v})}catch{}}else if(g===l){alert("Ese lado ya est√° ocupado. Prueba el otro lado."),be(e);return}}const f=(Ue||[])[r];await Ae(M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"schedule"),{courseId:u,day:a,slot:r,start:f.start,end:f.end,pos:s,hpos:l,createdAt:Date.now()}),be(e)}))})}function be(e){e.classList.remove("over","hint-top","hint-full","hint-bottom","hint-left","hint-center","hint-right"),delete e.dataset.droppos,delete e.dataset.droph}let vt=null,kt=[],ht=null,Nt=[],tn=me,Pt="USM";function Mr(){const e=c("horarioCompartido");e&&(e.innerHTML=`
    <div class="card" style="margin-bottom:12px">
      <div class="row" style="align-items:flex-end;gap:12px">
        <div>
          <label>Semestre de la otra persona</label><br/>
          <select id="sh-semSel"></select>
        </div>
        <div class="muted">Elige un semestre (ej. 2025-2) para ver el horario de la otra persona en vivo.</div>
      </div>
    </div>
    <div id="schedSharedUSM" class="sched-usm card"></div>
  `,qe())}function qe(){const e=c("schedSharedUSM");if(!e)return;const t=tn||me;en=t;const n=Pt==="USM"?"Bloque":"M√≥dulo";e.innerHTML=`
    <div class="usm-grid2">
      <div class="cell header">${n}</div>
      ${nt.map(a=>`<div class="cell header">${a}</div>`).join("")}
      ${t.map((a,r)=>`
        <div class="cell mod ${a.lunch?"lunch":""}" data-slot="${r}">
          ${Sa(a,r,Pt)}
        </div>
        ${nt.map((s,l)=>`
          <div class="cell slot ${a.lunch?"is-lunch":""}"
               data-day="${l}" data-slot="${r}">
            ${Ir(l,r)}
          </div>
        `).join("")}
      `).join("")}
    </div>
  `}function Ir(e,t){const n=kt.filter(r=>r.day===e&&r.slot===t),a=r=>{const s=n.filter(i=>(i.pos||"full")===r);return s.length?s.sort((i,u)=>{const d={left:0,single:1,right:2};return(d[i.hpos||"single"]??1)-(d[u.hpos||"single"]??1)}).map(i=>Ur(i,r)).join(""):""};return`
    ${a("top")}
    ${a("full")}
    ${a("bottom")}
  `}function Ur(e,t,n,a){const r=Nt||[],s=r.find(p=>p.id===e.courseId),l=(s==null?void 0:s.name)||"Ramo",i=typeof e.displayName=="string"&&e.displayName.trim()?e.displayName.trim():l,u=dn(r,e.courseId,$t),d=un(u),m=typeof e.room=="string"&&e.room.trim()?e.room.trim():null,f=e.hpos||"single";return`
  <div class="placed pos-${t} h-${f}"
       title="${i}${m?` ¬∑ Sala: ${m}`:""}"
       style="background:${u}; border:1px solid rgba(0,0,0,0.25); margin:2px 0;">
    <div class="placed-title" style="color:${d}; font-weight:600;">${i}</div>
  </div>
`}async function Tr(e,t){var r;const n=ga(t),a=n==="USM"||n==="UMAYOR";if(e)try{const s=L(b,"users",e,"custom_schedules",n),l=await J(s);if(l.exists()){const i=((r=l.data())==null?void 0:r.slots)||[];if(Array.isArray(i)&&i.length>0)return{uni:n,slots:i}}}catch(s){console.warn("[shared] error leyendo custom_schedules del d√∫o",s)}return a?{uni:n,slots:n==="UMAYOR"?Oe:me}:{uni:n,slots:null}}async function Xe(e){var d;vt&&(vt(),vt=null),ht&&(ht(),ht=null),mt&&(mt(),mt=null),kt=[],Nt=[],tn=me,Pt="USM",qe(),Tt=((d=o.profileData)==null?void 0:d.favoriteColor)||Tt;const t=o.pairOtherUid;if(!t||!e)return;const n=L(b,"users",t,"semesters",e),a=await J(n),r=a.exists()&&a.data().universityAtThatTime||"",{uni:s,slots:l}=await Tr(t,r);Pt=s,tn=l||(s==="UMAYOR"?Oe:me),qe(),mt=Y(L(b,"users",t),m=>{$t=(m.data()||{}).favoriteColor||$t,qe()});const i=M(b,"users",t,"semesters",e,"courses");ht=Y(te(i,Pe("name")),m=>{Nt=m.docs.map(f=>({id:f.id,...f.data()})),qe()});const u=M(b,"users",t,"semesters",e,"schedule");vt=Y(te(u),m=>{kt=m.docs.map(f=>({id:f.id,...f.data()})),qe()})}let qn=0;async function nn(){var p,g;const e=c("sh-semSel");if(!e)return;const t=++qn,n=v=>String(v||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim(),a=v=>{const y=n(v),h=y.replace(/[^\d\-\/ ]+/g,"").match(/(\d{4})\D*([12])$/);return h?`${h[1]}-${h[2]}`:y.toLowerCase()},r=v=>{const y=/^(\d{4})-(1|2)$/.exec(a(v));return y?{y:parseInt(y[1],10),t:parseInt(y[2],10)}:{y:-1/0,t:-1/0}};e.innerHTML="";const s=document.createElement("option");if(s.value="",s.textContent="‚Äî seleccionar ‚Äî",e.appendChild(s),!o.pairOtherUid)return;const l=M(b,"users",o.pairOtherUid,"semesters"),i=await H(te(l));if(t!==qn)return;const u=new Map;i.forEach(v=>{const y=v.data()||{},h=n(y.label||v.id),x=a(h);if(!u.has(x)){const{y:E,t:P}=r(h);u.set(x,{id:v.id,labelToShow:h,y:E,t:P})}});const d=Array.from(u.values()).sort((v,y)=>v.y!==y.y?y.y-v.y:y.t-v.t),m=document.createDocumentFragment();for(const{id:v,labelToShow:y}of d){const h=document.createElement("option");h.value=v,h.textContent=y,m.appendChild(h)}e.appendChild(m);const f=((g=(p=o.shared)==null?void 0:p.horario)==null?void 0:g.semId)||"";if(f&&Array.from(e.options).some(v=>v.value===f))e.value=f;else{const v=Array.from(e.options).find(y=>y.value);e.value=v?v.value:"",o.shared.horario.semId=e.value||null}}async function Ke(){var t;if(!o.pairOtherUid)return;const e=((t=o.activeSemesterData)==null?void 0:t.label)||null;if(e)try{const n=M(b,"users",o.pairOtherUid,"semesters"),a=await H(n);let r=null;if(a.forEach(s=>{var i;const l=(((i=s.data())==null?void 0:i.label)||"").trim();l===e&&(r={id:s.id,label:l})}),r&&(o.shared=o.shared||{},o.shared.horario=o.shared.horario||{},o.shared.horario.semId!==r.id)){o.shared.horario.semId=r.id;const s=c("sh-semSel");s&&(s.innerHTML=`<option selected>${r.label}</option>`,s.disabled=!0,s.style.pointerEvents="none",s.style.opacity="0.7"),await Xe(r.id),document.getElementById("horarioCombinado")&&fn()}}catch(n){console.warn("autoSelectPartnerSemesterForSchedule",n)}}async function $r({course:e,day:t,slot:n,room:a}){if(!o.currentUser||!o.activeSemesterId)throw new Error("No logueado");const r=o.activeSemesterId,s=o.currentUser.uid,l=(o.courses||[]).find(m=>(m.name||"").toLowerCase().includes(String(e).toLowerCase()));if(!l)throw new Error("Curso no encontrado");const i=M(b,"users",s,"semesters",r,"schedule"),d=(await H(i)).docs.find(m=>{const f=m.data();return f.courseId===l.id&&f.day===t&&f.slot===n});if(!d)throw new Error("No encontr√© el bloque en el horario");return await z(d.ref,{room:a||null,updatedAt:Date.now()}),{ok:!0,room:a}}async function Dr(e=null){if(!o.currentUser)throw new Error("No logueado");const t=e||o.activeSemesterId;if(!t)throw new Error("No hay semestre activo");const n=M(b,"users",o.currentUser.uid,"semesters",t,"schedule");return(await H(n)).docs.map(r=>({id:r.id,...r.data()}))}async function kr(e=null){if(!o.currentUser)throw new Error("No logueado");const t=e||o.activeSemesterId;if(!t)throw new Error("No hay semestre activo");if(!o.pairOtherUid)return{items:[]};const n=M(b,"users",o.currentUser.uid,"semesters",t,"schedule"),r=(await H(n)).docs.map(d=>({...d.data()})),s=M(b,"users",o.pairOtherUid,"semesters",t,"schedule"),i=(await H(s)).docs.map(d=>({...d.data()})),u=[];for(const d of r)for(const m of i)d.day===m.day&&d.slot===m.slot&&u.push(`${["Lun","Mar","Mi√©","Jue","Vie"][d.day]} bloque ${d.slot} (${d.courseName} / ${m.courseName})`);return{items:u}}async function Nr(e,t=null){if(!o.currentUser)throw new Error("No logueado");const n=t||o.activeSemesterId;return await oe(L(b,"users",o.currentUser.uid,"semesters",n,"schedule",e)),{ok:!0}}document.addEventListener("dragstart",e=>{const t=e.target.closest(".placed");t&&t.classList.add("dragging")});document.addEventListener("dragend",e=>{const t=e.target.closest(".placed");t&&t.classList.remove("dragging")});const jn=8*60,Pr=22*60;function Z(e){const[t,n]=e.split(":").map(Number);return t*60+n}function Yn(e){return(e-jn)/(Pr-jn)*100}function fn(){const e=c("horarioCombinado");e&&(e.innerHTML=`
    <div class="timeline">
      <div class="timeline-hours">
        ${Array.from({length:15},(t,n)=>`<div class="timeline-hour">${8+n}:00</div>`).join("")}
      </div>
      ${nt.map((t,n)=>`
        <div class="timeline-day" data-day="${n}" title="${t}">
          ${Or(n)}
        </div>
      `).join("")}
    </div>
  `)}function Or(e){return[...(ee||[]).map(a=>({...a,isMine:!0})),...(kt||[]).map(a=>({...a,isMine:!1}))].filter(a=>a.day===e).map(a=>{const r=Z(a.start),s=Z(a.end),l=Yn(r),i=Yn(s)-l,u=a.isMine?o.courses:Nt,d=dn(u,a.courseId,a.isMine?Tt:$t),m=un(d),f=u.find(y=>y.id===a.courseId),p=a.displayName||(f==null?void 0:f.name)||"Ramo",g=a.room?` (${a.room})`:"",v=a.isMine?1:.6;return`
      <div class="timeline-block"
           style="top:${l}%;height:${i}%;
                  background:${d};opacity:${v};color:${m};">
        ${p}${g}
      </div>
    `}).join("")}document.addEventListener("DOMContentLoaded",()=>{const e=c("subtabCombinado"),t=c("subtabCompartido"),n=c("subtabPropio"),a=c("horarioCombinado"),r=c("horarioCompartido"),s=c("horarioPropio");e&&(e.classList.remove("hidden"),e.addEventListener("click",()=>{n==null||n.classList.remove("active"),t==null||t.classList.remove("active"),e.classList.add("active"),s==null||s.classList.add("hidden"),r==null||r.classList.add("hidden"),a==null||a.classList.remove("hidden"),fn()}))});document.addEventListener("auth:ready",()=>{setTimeout(()=>{console.log("[schedule] auth:ready ‚Üí initSchedule()"),ba(),We()},1e3)});document.addEventListener("semester:changed",()=>{console.log("[schedule] semester:changed ‚Üí onActiveSemesterChanged()"),We()});async function Rr(e,t){if(!o.currentUser)return;const n=L(b,"users",o.currentUser.uid,"custom_schedules",e);await X(n,{slots:t,updatedAt:Date.now()})}async function zn(e){if(!o.currentUser)return!1;try{const t=L(b,"users",o.currentUser.uid,"custom_schedules",e);return await oe(t),console.log(`[Firestore] Horario personalizado de ${e} eliminado correctamente`),!0}catch(t){return console.error("[Firestore] Error al eliminar horario personalizado:",t),!1}}const Gn=Object.freeze(Object.defineProperty({__proto__:null,MAYOR_SLOTS:Oe,USM_SLOTS:me,getMySchedule:Dr,initSchedule:ba,onActiveSemesterChanged:We,overlapWithPair:kr,refreshCourseOptions:wr,removeBlock:Nr,setRoom:$r},Symbol.toStringTag,{value:"Module"}));let O=new Date,Te=null,at=[],an=!1,Ze=null,Lt=null,xt=null,$e=null,rt=[],Ot=[],st="#ff69b4";function _r(e){Ze=e}function Br(){try{Ze==null||Ze()}finally{Ze=null}}function Hr(){const e=c("page-calendario");if(e){e.classList.add("hidden");const t=e.querySelector("[data-cal-grid]")||e.querySelector(".cal-grid");t&&(t.innerHTML="")}}function Fr(){var e;(e=c("page-calendario"))==null||e.classList.remove("hidden")}function pn(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function vn(e,t="#3B82F6"){const n=(o.courses||[]).find(a=>a.id===e);return pn(n==null?void 0:n.color)?n.color:t}function Ca(e,t=st){const n=(Ot||[]).find(a=>a.id===e);return pn(n==null?void 0:n.color)?n.color:t}function hn(e){try{const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return(t*299+n*587+a*114)/1e3>=160?"#111":"#fff"}catch{return"#0e0e0e"}}function Ea(){an||(an=!0,jr(),Yr(),yn(),et(),Le(),La(),xa(),document.addEventListener("pair:ready",Vn),Vn(),Rt(),zr())}function ot(){an||Ea()}function Ne(){ot(),Te&&(Te(),Te=null),La(),xa(),et(),Le(),Rt()}function qr(){ot(),_t(),it()}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",ot):ot();document.addEventListener("route:calendario",ot);function jr(){const e=c("page-calendario");e&&(e.innerHTML=`
    <div class="card">
      <div class="cal-head" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div class="cal-left" style="display:flex;align-items:center;gap:8px;">
          <button id="calPrev" class="ghost" title="Mes anterior">‚óÄ</button>
          <button id="calToday" class="ghost" title="Ir a hoy">Hoy</button>
          <button id="calNext" class="ghost" title="Mes siguiente">‚ñ∂</button>
          <h3 id="calTitle" style="margin:0 0 0 10px">Calendario</h3>
        </div>
        <div class="cal-right" style="display:flex;align-items:center;gap:10px;">
          <span class="muted">Semestre activo: <b id="calActiveSem">‚Äî</b></span>
          <button id="calImportGoogle" class="ghost" data-tooltip="Importar eventos desde tu Google Calendar">
            üì• Importar Google Calendar
          </button>
        </div>
      </div>

      <div class="subtabs" style="margin-bottom:10px; display:flex; gap:8px;">
        <button id="cal-subtab-propio" class="tab small active">Propio</button>
        <button id="cal-subtab-compartido" class="tab small">Duo</button>
        <button id="cal-subtab-combinado" class="tab small">Combinado</button>
      </div>

      <div id="cal-propio">
        <div class="cal-grid" id="calGrid" aria-live="polite"></div>
        <div class="muted" style="margin-top:8px">
          Haz clic en un d√≠a para agregar un evento.  
          Usa el bot√≥n "Importar Google Calendar" para traer eventos de tu mes actual.
        </div>
      </div>

      <div id="cal-compartido" class="hidden">
        <div class="card" style="margin-bottom:12px">
          <div class="row" style="align-items:flex-end; gap:12px;">
            <div>
              <label>Semestre de tu duo</label><br/>
              <select id="shc-semSel"></select>
            </div>
          </div>
        </div>
        <div class="cal-grid" id="calSharedGrid"></div>
        <div class="muted" id="calSharedHint" style="margin-top:8px"></div>
      </div>

      <div id="cal-combinado" class="hidden">
        <div id="calCombinedGrid" class="cal-grid"></div>
      </div>
    </div>
  `)}function Yr(){var e,t,n,a;(e=c("calPrev"))==null||e.addEventListener("click",()=>{O=Wn(O,-1),gt(),et(),Le(),At()}),(t=c("calNext"))==null||t.addEventListener("click",()=>{O=Wn(O,1),gt(),et(),Le(),At()}),(n=c("calToday"))==null||n.addEventListener("click",()=>{O=new Date,gt(),et(),Le(),At()}),(a=c("calImportGoogle"))==null||a.addEventListener("click",Vr),gt()}function gt(){const e=O.getFullYear(),t=O.getMonth(),n=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],a=c("calTitle");a&&(a.textContent=`Calendario ¬∑ ${n[t][0].toUpperCase()}${n[t].slice(1)} ${e}`)}function La(){var t;const e=c("calActiveSem");e&&(e.textContent=((t=o.activeSemesterData)==null?void 0:t.label)||"‚Äî")}function zr(){const e=c("cal-subtab-propio"),t=c("cal-subtab-compartido"),n=c("cal-subtab-combinado"),a=c("cal-propio"),r=c("cal-compartido"),s=c("cal-combinado");function l(){e.classList.add("active"),t.classList.remove("active"),n.classList.remove("active"),a.classList.remove("hidden"),r.classList.add("hidden"),s.classList.add("hidden")}async function i(){var d,m;if(t.classList.add("active"),e.classList.remove("active"),n.classList.remove("active"),r.classList.remove("hidden"),a.classList.add("hidden"),s.classList.add("hidden"),await Rt(),Le(),!o.pairOtherUid){c("calSharedHint").textContent="Empareja tu cuenta para ver el calendario de tu duo.";return}c("calSharedHint").textContent="",await Ma(),(m=(d=o.shared)==null?void 0:d.calendar)!=null&&m.semId&&gn(o.shared.calendar.semId)}async function u(){await Rt(),n.classList.add("active"),e.classList.remove("active"),t.classList.remove("active"),s.classList.remove("hidden"),a.classList.add("hidden"),r.classList.add("hidden"),At(),await Zr()}e==null||e.addEventListener("click",l),t==null||t.addEventListener("click",i),n==null||n.addEventListener("click",u),l()}function xa(){if(Te&&(Te(),Te=null),at=[],_t(),!o.currentUser||!o.activeSemesterId)return;const e=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"calendar");Te=Y(te(e,Pe("date","asc")),t=>{at=t.docs.map(n=>({id:n.id,...n.data()})),_t()})}async function Vn(){if(Aa(),rt=[],Ot=[],st="#ff69b4",Le(),!o.pairOtherUid){const e=c("shc-semSel");e&&(e.innerHTML='<option value="">‚Äî</option>'),c("calSharedHint").textContent="Empareja tu cuenta para ver el calendario de tu duo.";return}c("calSharedHint").textContent="",await Ma(),$e&&($e(),$e=null),$e=Y(L(b,"users",o.pairOtherUid),e=>{const t=e.data()||{};st=pn(t.favoriteColor)?t.favoriteColor:"#ff69b4",it()})}async function Rt(){var t;if(!o.pairOtherUid)return;const e=((t=o.activeSemesterData)==null?void 0:t.label)||null;if(e)try{const n=M(b,"users",o.pairOtherUid,"semesters"),a=await H(n);let r=null;if(a.forEach(s=>{var i;const l=(((i=s.data())==null?void 0:i.label)||"").trim();l===e&&(r={id:s.id,label:l})}),r&&(o.shared=o.shared||{},o.shared.calendar=o.shared.calendar||{},o.shared.calendar.semId!==r.id)){o.shared.calendar.semId=r.id;const s=c("shc-semSel");s&&(s.innerHTML=`<option selected>${r.label}</option>`,s.disabled=!0,s.style.pointerEvents="none",s.style.opacity="0.7"),gn(r.id)}}catch(n){console.warn("autoSelectPartnerSemesterForCalendar",n)}}function Aa(){Lt&&(Lt(),Lt=null),xt&&(xt(),xt=null),$e&&($e(),$e=null)}async function Ma(){var a;const e=c("shc-semSel");if(!e)return;e.innerHTML="<option selected disabled>Cargando‚Ä¶</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";const t=o.pairOtherUid;if(!t){e.innerHTML="<option selected>No disponible</option>";return}const n=((a=o.activeSemesterData)==null?void 0:a.label)||null;if(!n){e.innerHTML="<option selected>No disponible</option>";return}try{const r=M(b,"users",t,"semesters"),s=await H(r);let l=null;if(s.forEach(i=>{var d;const u=(((d=i.data())==null?void 0:d.label)||"").trim();u===n&&(l={id:i.id,label:u})}),l)e.innerHTML=`<option selected>${l.label}</option>`,o.shared.calendar=o.shared.calendar||{},o.shared.calendar.semId=l.id,gn(l.id),c("calSharedHint").textContent="";else{e.innerHTML="<option selected>No disponible</option>",o.shared.calendar=o.shared.calendar||{},o.shared.calendar.semId=null;const i=c("calSharedGrid");i&&(i.innerHTML=`<div class="muted">Tu d√∫o no tiene el semestre <b>${n}</b> creado.</div>`),c("calSharedHint").textContent="Sincronizado con tu semestre activo."}e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7"}catch(r){console.error("populateSharedSemesters error",r),e.innerHTML="<option selected>Error al cargar</option>"}}async function gn(e){Aa(),rt=[],Ot=[],Le();const t=o.pairOtherUid;if(!t||!e)return;const n=M(b,"users",t,"semesters",e,"courses");xt=Y(te(n,Pe("name")),r=>{Ot=r.docs.map(s=>({id:s.id,...s.data()})),it()});const a=M(b,"users",t,"semesters",e,"calendar");Lt=Y(te(a,Pe("date","asc")),r=>{rt=r.docs.map(s=>({id:s.id,...s.data()})),it()})}function yn(){if(c("calModal"))return;const e=document.createElement("div");e.id="calModal",e.className="modal",e.innerHTML=`
    <div class="modal-backdrop" id="calModalBackdrop"></div>
    <div class="modal-content">
      <h3 id="calModalTitle" style="margin-top:0">Nuevo evento</h3>

      <div class="row" style="gap:10px">
        <div style="flex:1">
          <label>T√≠tulo</label>
          <input type="text" id="calEvtTitle" placeholder="Ej. Prueba 1 ELO212"/>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Fecha</label>
          <input type="date" id="calEvtDate"/>
        </div>
        <div style="flex:1">
          <label>Ramo</label>
          <select id="calEvtCourse">
            <option value="">(Sin asignar)</option>
          </select>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Inicio</label>
          <input type="time" id="calEvtStart"/>
        </div>
        <div style="flex:1">
          <label>T√©rmino</label>
          <input type="time" id="calEvtEnd"/>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Repetir cada</label>
          <select id="calEvtRepeat">
            <option value="">(Sin repetici√≥n)</option>
            <option value="day">D√≠a</option>
            <option value="month">Mes</option>
            <option value="year">A√±o</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Persistencia</label>
          <select id="calEvtPersistent">
            <option value="">Solo este semestre</option>
            <option value="true">Mantener en semestres futuros</option>
          </select>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end; gap:10px; margin-top:16px">
        <button class="ghost" id="calEvtCancel">Cancelar</button>
        <button class="primary" id="calEvtSave">Guardar</button>
      </div>
    </div>
  `,document.body.appendChild(e);const t=()=>e.classList.remove("active");c("calModalBackdrop").addEventListener("click",t),c("calEvtCancel").addEventListener("click",t),c("calEvtSave").addEventListener("click",async()=>{if(!o.currentUser||!o.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}const n=(c("calEvtTitle").value||"").trim(),a=c("calEvtDate").value||"",r=c("calEvtStart").value||null,s=c("calEvtEnd").value||null,l=c("calEvtCourse").value||null,i=c("calEvtRepeat").value||"",u=c("calEvtPersistent").value==="true",d=l?vn(l):null;if(!n)return alert("Ingresa un t√≠tulo.");if(!a)return alert("Selecciona una fecha.");const m=e.dataset.editingId||null,f=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"calendar");try{m?(await z(L(f,m),{title:n,date:a,start:r,end:s,courseId:l,color:d,repeat:i?{every:i,interval:1}:null,persistent:u,updatedAt:Date.now()}),console.log("[Calendar] Evento actualizado:",n)):(await Ae(f,{title:n,date:a,start:r,end:s,courseId:l,color:d,repeat:i?{every:i,interval:1}:null,persistent:u,createdAt:Date.now()}),console.log("[Calendar] Evento creado:",n)),t()}catch(p){console.error(p),alert("No se pudo guardar el evento.")}finally{e.dataset.editingId=""}})}function Gr(){if(c("gcalImportModal"))return;const e=document.createElement("div");e.id="gcalImportModal",e.className="modal",e.innerHTML=`
    <div class="modal-backdrop" id="gcalImportBackdrop"></div>
    <div class="modal-content">
      <h3 style="margin-top:0">Importar desde Google Calendar</h3>
      <p class="muted">
        Elige desde qu√© fecha hasta qu√© fecha quieres importar tus eventos.
      </p>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Fecha de inicio</label>
          <input type="date" id="gcalRangeStart"/>
        </div>
        <div style="flex:1">
          <label>Fecha de t√©rmino</label>
          <input type="date" id="gcalRangeEnd"/>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end; gap:10px; margin-top:16px">
        <button class="ghost" id="gcalRangeCancel">Cancelar</button>
        <button class="primary" id="gcalRangeConfirm">Importar</button>
      </div>
    </div>
  `,document.body.appendChild(e);const t=()=>e.classList.remove("active");c("gcalImportBackdrop").addEventListener("click",t),c("gcalRangeCancel").addEventListener("click",t),c("gcalRangeConfirm").addEventListener("click",async()=>{if(!o.currentUser||!o.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres" e inicia sesi√≥n.');return}const n=c("gcalRangeStart").value,a=c("gcalRangeEnd").value;if(!n||!a){alert("Selecciona ambas fechas (inicio y t√©rmino).");return}const[r,s,l]=n.split("-").map(Number),[i,u,d]=a.split("-").map(Number),m=new Date(r,s-1,l,0,0,0),f=new Date(i,u-1,d+1,0,0,0);if(f<=m){alert("La fecha de t√©rmino debe ser posterior a la de inicio.");return}try{await fs(m,f),t()}catch(p){console.error("Error al importar rango desde Google Calendar:",p),alert("Ocurri√≥ un error al importar eventos de Google Calendar.")}})}function Vr(){if(!o.currentUser||!o.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres" e inicia sesi√≥n.');return}Gr();const e=O.getFullYear(),t=O.getMonth(),n=new Date(e,t+1,0).getDate(),a=c("gcalRangeStart"),r=c("gcalRangeEnd");a&&!a.value&&(a.value=xe(e,t+1,1)),r&&!r.value&&(r.value=xe(e,t+1,n)),c("gcalImportModal").classList.add("active")}function Wr(e){if(!o.currentUser||!o.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}yn();const t=c("calEvtDate");t&&(t.value=e);const n=c("calEvtTitle");n&&(n.value="");const a=c("calEvtStart");a&&(a.value="");const r=c("calEvtEnd");r&&(r.value="");const s=c("calEvtCourse");s&&(s.innerHTML='<option value="">(Sin asignar)</option>',(o.courses||[]).forEach(l=>{const i=document.createElement("option");i.value=l.id,i.textContent=l.name,s.appendChild(i)})),c("calModal").classList.add("active")}function et(){const e=c("calGrid");if(!e)return;const n=(new Date(O.getFullYear(),O.getMonth(),1).getDay()+6)%7,a=new Date(O.getFullYear(),O.getMonth()+1,0).getDate(),r=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${r.map(s=>`<div class="cal-cell head">${s}</div>`).join("")}
    ${Array.from({length:n}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((s,l)=>{const i=l+1,u=xe(O.getFullYear(),O.getMonth()+1,i);return`
        <div class="cal-cell day" data-date="${u}">
          <div class="cal-daynum">${i}</div>
          <div class="cal-events" id="ce-${u}"></div>
        </div>
      `}).join("")}
  `,e.querySelectorAll(".cal-cell.day").forEach(s=>{s.addEventListener("click",()=>Wr(s.dataset.date))}),_t()}function Jr(e){var s;if(!o.currentUser||!o.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}yn();const t=c("calModal"),n=c("calModalTitle"),a=c("calEvtSave");t.dataset.editingId=e.id,n.textContent="Editar evento",a.textContent="Guardar cambios",c("calEvtTitle").value=e.title||"",c("calEvtDate").value=e.date||"",c("calEvtStart").value=e.start||"",c("calEvtEnd").value=e.end||"",c("calEvtRepeat").value=((s=e.repeat)==null?void 0:s.every)||"",c("calEvtPersistent").value=e.persistent?"true":"";const r=c("calEvtCourse");r.innerHTML='<option value="">(Sin asignar)</option>',(o.courses||[]).forEach(l=>{const i=document.createElement("option");i.value=l.id,i.textContent=l.name,l.id===e.courseId&&(i.selected=!0),r.appendChild(i)}),t.classList.add("active")}function Le(){const e=c("calSharedGrid");if(!e)return;const n=(new Date(O.getFullYear(),O.getMonth(),1).getDay()+6)%7,a=new Date(O.getFullYear(),O.getMonth()+1,0).getDate(),r=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${r.map(s=>`<div class="cal-cell head">${s}</div>`).join("")}
    ${Array.from({length:n}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((s,l)=>{const i=l+1,u=xe(O.getFullYear(),O.getMonth()+1,i);return`
        <div class="cal-cell day" data-date="${u}">
          <div class="cal-daynum">${i}</div>
          <div class="cal-events" id="sce-${u}"></div>
        </div>
      `}).join("")}
  `,it()}function At(){const e=c("calCombinedGrid");if(!e)return;const n=(new Date(O.getFullYear(),O.getMonth(),1).getDay()+6)%7,a=new Date(O.getFullYear(),O.getMonth()+1,0).getDate(),r=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${r.map(s=>`<div class="cal-cell head">${s}</div>`).join("")}
    ${Array.from({length:n}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((s,l)=>{const i=l+1,u=xe(O.getFullYear(),O.getMonth()+1,i);return`
        <div class="cal-cell day" data-date="${u}">
          <div class="cal-daynum">${i}</div>
          <div class="cal-events" id="bce-${u}"></div>
        </div>
      `}).join("")}
  `,Kr()}function Kr(){document.querySelectorAll(".cal-events").forEach(n=>{var a;(a=n.id)!=null&&a.startsWith("bce-")&&(n.innerHTML="")});const e=`${O.getFullYear()}-${String(O.getMonth()+1).padStart(2,"0")}`;[...at.filter(n=>String(n.date||"").startsWith(e)).map(n=>({...n,isMine:!0})),...rt.filter(n=>String(n.date||"").startsWith(e)).map(n=>({...n,isMine:!1}))].forEach(n=>{const a=c("bce-"+n.date);if(!a)return;const r=n.color||(n.isMine?vn(n.courseId):Ca(n.courseId,st)),s=hn(r),l=n.start&&n.end?`${n.start}‚Äì${n.end} ¬∑ `:n.start?`${n.start} ¬∑ `:"",i=document.createElement("div");i.className="cal-evt",i.textContent=`${l}${n.title||"(sin t√≠tulo)"}`,i.style.background=r,i.style.color=s,i.style.opacity=n.isMine?1:.65,i.style.border="1px solid rgba(0,0,0,0.25)",a.appendChild(i)})}async function Zr(){const e=c("calCombinedRemindersList");if(e){e.innerHTML='<div class="loading"></div>';try{const t=await Ia({range:"today"}),n=o.pairOtherUid?await Ua({range:"today"}):[],a=[...t.map(r=>({...r,owner:"T√∫"})),...n.map(r=>({...r,owner:"D√∫o"}))].sort((r,s)=>(r.datetime||0)-(s.datetime||0));e.innerHTML=a.length?a.map(r=>{var s;return`
          <div class="grade-item">
            <div>
              <strong>${r.title||"(sin t√≠tulo)"}</strong>
              <div class="muted">${r.owner} ¬∑ ${((s=r.datetime)==null?void 0:s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))||""}</div>
            </div>
          </div>
        `}).join(""):'<div class="muted">Sin recordatorios para hoy.</div>'}catch(t){console.error("loadCombinedReminders",t),e.innerHTML='<div class="muted">Error al cargar recordatorios.</div>'}}}function Qr(e){var a;const t=[];for(const r of e)if(t.push(r),(a=r.repeat)!=null&&a.every){const s=new Date(r.date);for(let l=1;l<=24;l++){const i=new Date(s);r.repeat.every==="day"?i.setDate(s.getDate()+l*(r.repeat.interval||1)):r.repeat.every==="month"?i.setMonth(s.getMonth()+l*(r.repeat.interval||1)):r.repeat.every==="year"&&i.setFullYear(s.getFullYear()+l*(r.repeat.interval||1));const u=xe(i.getFullYear(),i.getMonth()+1,i.getDate());if(Math.abs(i-s)/(1e3*60*60*24)>365)break;t.push({...r,date:u})}}return t}function _t(){document.querySelectorAll(".cal-events").forEach(n=>{var a;(a=n.id)!=null&&a.startsWith("sce-")||(n.innerHTML="")});const e=`${O.getFullYear()}-${String(O.getMonth()+1).padStart(2,"0")}`;Qr(at).filter(n=>String(n.date||"").startsWith(e)).forEach(n=>{const a=c("ce-"+n.date);if(!a)return;const r=n.color||vn(n.courseId)||"#1f2937",s=hn(r),l=n.start&&n.end?`${n.start}‚Äì${n.end} ¬∑ `:n.start?`${n.start} ¬∑ `:"",i=document.createElement("div");i.className="cal-evt",i.style.background=r,i.style.color=s,i.style.border="1px solid rgba(0,0,0,0.25)",i.style.position="relative",i.style.cursor="pointer";const u=document.createElement("span");u.textContent=`${l}${n.title||"(sin t√≠tulo)"}`,i.appendChild(u);const d=document.createElement("span");d.textContent="‚úï",d.className="cal-del",d.title="Eliminar evento",d.style.position="absolute",d.style.top="2px",d.style.right="4px",d.style.fontWeight="bold",d.style.color="#fff8",d.style.cursor="pointer",d.addEventListener("click",async m=>{if(m.stopPropagation(),!(!o.currentUser||!o.activeSemesterId||!n.id)&&confirm(`¬øEliminar evento "${n.title}"?`))try{await oe(L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"calendar",n.id))}catch(f){console.error(f)}}),i.appendChild(d),i.addEventListener("click",m=>{m.stopPropagation(),Jr(n)}),a.appendChild(i)})}function it(){document.querySelectorAll(".cal-events").forEach(n=>{var a;(a=n.id)!=null&&a.startsWith("sce-")&&(n.innerHTML="")});const e=`${O.getFullYear()}-${String(O.getMonth()+1).padStart(2,"0")}`;rt.filter(n=>String(n.date||"").startsWith(e)).forEach(n=>{const a=c("sce-"+n.date);if(!a)return;const r=n.color||(n.courseId?Ca(n.courseId):st),s=hn(r),l=n.start&&n.end?`${n.start}‚Äì${n.end} ¬∑ `:n.start?`${n.start} ¬∑ `:"",i=document.createElement("div");i.className="cal-evt",i.textContent=`${l}${n.title||"(sin t√≠tulo)"}`,i.style.background=r,i.style.color=s,i.style.border="1px solid rgba(0,0,0,0.25)",a.appendChild(i)})}function Wn(e,t){const n=new Date(e.getTime());return n.setMonth(n.getMonth()+t),n}function xe(e,t,n){return`${e}-${String(t).padStart(2,"0")}-${String(n).padStart(2,"0")}`}async function Ia(e={}){if(!o.currentUser)throw new Error("No logueado");const{range:t="today",dates:n,months:a,years:r,ranges:s}=e,l=M(b,"users",o.currentUser.uid,"reminders");let u=(await H(l)).docs.map(m=>{const f=m.data();return{id:m.id,...f,datetime:Mt(f.datetime)}});if(u=u.filter(m=>!m.suspended),Array.isArray(s)&&s.length>0){const m=s.map(f=>{const p=Mt(f.start),g=Mt(f.end);return!p||!g?null:{start:p,end:g}}).filter(Boolean);return u=u.filter(f=>f.datetime&&m.some(p=>f.datetime>=p.start&&f.datetime<p.end)),u}if(Array.isArray(n)&&n.length>0){const m=new Set(n.map(f=>Zn(f)).filter(Boolean));return u=u.filter(f=>{if(!f.datetime)return!1;const p=Zn(f.datetime);return m.has(p)}),u}if(Array.isArray(a)&&a.length>0){const m=a.map(f=>{if(typeof f=="string"){const[p,g]=f.split("-").map(Number);return!p||!g?null:{year:p,month:g}}else if(f&&typeof f=="object"){const p=Number(f.year??f.y),g=Number(f.month??f.m);return!p||!g?null:{year:p,month:g}}return null}).filter(Boolean);return u=u.filter(f=>{if(!f.datetime)return!1;const p=f.datetime.getFullYear(),g=f.datetime.getMonth()+1;return m.some(v=>v.year===p&&v.month===g)}),u}if(Array.isArray(r)&&r.length>0){const m=new Set(r.map(f=>Number(f)));return u=u.filter(f=>f.datetime&&m.has(f.datetime.getFullYear())),u}const d=new Date;if(t==="today"){const m=new Date(d.getFullYear(),d.getMonth(),d.getDate()),f=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1);return u.filter(p=>p.datetime&&p.datetime>=m&&p.datetime<f)}if(t==="week"){const m=new Date(d.getFullYear(),d.getMonth(),d.getDate()-d.getDay()),f=new Date(m);return f.setDate(m.getDate()+7),u.filter(p=>p.datetime&&p.datetime>=m&&p.datetime<f)}if(t==="month"){const m=new Date(d.getFullYear(),d.getMonth(),1),f=new Date(d.getFullYear(),d.getMonth()+1,1);return u.filter(p=>p.datetime&&p.datetime>=m&&p.datetime<f)}return u}async function Xr(e){if(!o.currentUser)throw new Error("No logueado");const t=L(b,"users",o.currentUser.uid,"reminders",e);return await z(t,{suspended:!1,updatedAt:Date.now()}),{ok:!0}}async function es(){if(!o.currentUser)throw new Error("No logueado");const e=M(b,"users",o.currentUser.uid,"reminders"),t=te(e,ma("suspended","==",!0));return(await H(t)).docs.map(a=>({id:a.id,...a.data()}))}async function ts({reminderId:e}){if(!o.currentUser)throw new Error("No logueado");if(!e)throw new Error("Falta ID");const t=L(b,"users",o.currentUser.uid,"reminders",e);return await z(t,{suspended:!0,updatedAt:Date.now()}),{ok:!0}}async function Ua({range:e="today"}={}){if(!o.pairOtherUid)throw new Error("No tienes d√∫o");const t=M(b,"users",o.pairOtherUid,"reminders"),n=await H(t),a=l=>l?typeof l=="number"?new Date(l):l.toDate?l.toDate():new Date(l):null,r=n.docs.map(l=>{const i=l.data();return{id:l.id,...i,datetime:a(i.datetime)}}),s=new Date;if(e==="today"){const l=new Date(s.getFullYear(),s.getMonth(),s.getDate()),i=new Date(s.getFullYear(),s.getMonth(),s.getDate()+1);return r.filter(u=>u.datetime&&u.datetime>=l&&u.datetime<i)}if(e==="week"){const l=new Date(s.getFullYear(),s.getMonth(),s.getDate()-s.getDay()),i=new Date(l);return i.setDate(l.getDate()+7),r.filter(u=>u.datetime&&u.datetime>=l&&u.datetime<i)}return r}const ns="489697428786-m2hkvn9ohor0unrhk6g5i3g7vqla86c4.apps.googleusercontent.com",as="AIzaSyA6M73T0k3yPyseAZnkPxBO5GYXPeL8dlQ",rs=["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],ss="https://www.googleapis.com/auth/calendar.readonly";let Jn=!1,Kn=!1,Bt=null;function os(){return new Promise((e,t)=>{if(window.gapi&&window.gapi.load)return e();const n=document.createElement("script");n.src="https://apis.google.com/js/api.js",n.async=!0,n.defer=!0,n.onload=()=>e(),n.onerror=()=>t(new Error("No se pudo cargar gapi")),document.head.appendChild(n)})}function is(){return new Promise((e,t)=>{if(window.google&&window.google.accounts)return e();const n=document.createElement("script");n.src="https://accounts.google.com/gsi/client",n.async=!0,n.defer=!0,n.onload=()=>e(),n.onerror=()=>t(new Error("No se pudo cargar Google Identity Services")),document.head.appendChild(n)})}async function cs(){Jn||(await os(),await new Promise(e=>{window.gapi.load("client",e)}),await window.gapi.client.init({apiKey:as,discoveryDocs:rs}),Jn=!0)}async function ls(){Kn&&Bt||(await is(),Bt=window.google.accounts.oauth2.initTokenClient({client_id:ns,scope:ss,callback:()=>{}}),Kn=!0)}async function ds(){return await ls(),new Promise((e,t)=>{Bt.callback=n=>{if(n.error){console.error("[OAuth error]",n),t(n);return}e(n.access_token)},Bt.requestAccessToken({prompt:""})})}async function us(e,t){await cs();const n=await ds();window.gapi.client.setToken({access_token:n});const a=await window.gapi.client.calendar.events.list({calendarId:"primary",timeMin:e.toISOString(),timeMax:t.toISOString(),showDeleted:!1,singleEvents:!0,orderBy:"startTime"});return console.log("[Calendar] Respuesta completa de Google:",a),a.result.items||[]}function ms(e){var i,u,d,m;if(e.start&&e.start.date&&!e.start.dateTime)return{date:e.start.date,startTime:null,endTime:null,allDay:!0};const t=new Date(((i=e.start)==null?void 0:i.dateTime)||((u=e.start)==null?void 0:u.date)),n=new Date(((d=e.end)==null?void 0:d.dateTime)||((m=e.end)==null?void 0:m.date)||t),a=xe(t.getFullYear(),t.getMonth()+1,t.getDate()),r=f=>String(f).padStart(2,"0"),s=`${r(t.getHours())}:${r(t.getMinutes())}`,l=`${r(n.getHours())}:${r(n.getMinutes())}`;return{date:a,startTime:s,endTime:l,allDay:!1}}function Mt(e){if(!e)return null;if(e instanceof Date)return e;if(typeof e=="number")return new Date(e);if(typeof e=="string"){const t=new Date(e);return isNaN(t)?null:t}return e.toDate?e.toDate():null}function Zn(e){const t=Mt(e);return t?xe(t.getFullYear(),t.getMonth()+1,t.getDate()):null}async function fs(e,t){if(!o.currentUser||!o.activeSemesterId)throw new Error("Sin usuario o semestre activo");try{const n=await us(e,t);if(!n.length){alert("No se encontraron eventos en tu Google Calendar para el rango seleccionado.");return}const a=new Set((at||[]).filter(i=>i.gcalId).map(i=>i.gcalId)),r=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"calendar");let s=0;const l=[];for(const i of n){if(a.has(i.id))continue;const{date:u,startTime:d,endTime:m,allDay:f}=ms(i);if(!u)continue;const p={title:i.summary||"(sin t√≠tulo)",date:u,start:f?null:d,end:f?null:m,allDay:!!f,courseId:null,color:null,source:"google",gcalId:i.id,createdAt:Date.now()};l.push(Ae(r,p)),s++}if(!l.length){alert("Los eventos de ese rango ya estaban importados.");return}await Promise.all(l),alert(`Se importaron ${s} evento(s) desde tu Google Calendar para el rango seleccionado.`)}catch(n){console.error("Error al importar Google Calendar:",n),alert("Ocurri√≥ un error al importar eventos de Google Calendar. Revisa la consola para m√°s detalles.")}}const Qn=Object.freeze(Object.defineProperty({__proto__:null,clearCalendarUI:Hr,initCalendar:Ea,listPairReminders:Ua,listReminders:Ia,listSuspendedReminders:es,onActiveSemesterChanged:Ne,onCoursesChanged:qr,registerCalendarUnsub:_r,resumeReminder:Xr,showCalendarUI:Fr,stopCalendarSub:Br,suspendReminder:ts},Symbol.toStringTag,{value:"Module"}));let yt=null;function bn(){if(!o.currentUser||!o.activeSemesterId)return;const e=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses");Y(e,t=>{const n=t.docs.filter(r=>r.data().asistencia),a=c("attCourseSel");a&&(a.innerHTML='<option value="" disabled selected>Elige un ramo‚Ä¶</option>',n.forEach(r=>{a.innerHTML+=`<option value="${r.id}">${r.data().name}</option>`})),a==null||a.addEventListener("change",()=>{const r=a.value,s=n.find(l=>l.id===r);ps(s?[s]:[])})})}function ps(e){const t=c("asistenciaList");t&&(t.innerHTML="",e.forEach(n=>{const a=n.data(),r=document.createElement("div");r.className="card",r.innerHTML=`
      <h4>${a.name}</h4>
      <div class="att-days" data-id="${n.id}"></div>
      <div class="muted">Asistencia actual: <span class="att-percent" data-id="${n.id}">0%</span></div>
      <button class="btn btn-secondary add-att-btn" data-id="${n.id}" style="margin-top:8px;">+ Agregar asistencia</button>
    `,t.appendChild(r),vs(n.id)}),t.querySelectorAll(".add-att-btn").forEach(n=>{n.addEventListener("click",()=>gs(n.dataset.id))}))}async function vs(e){const t=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",e,"attendance");Y(t,n=>{const a=n.docs.map(r=>({id:r.id,...r.data()}));hs(e,a)})}async function hs(e,t){const n=document.querySelector(`.att-days[data-id="${e}"]`);if(!n)return;n.innerHTML=t.map(i=>`
    <div class="att-record">
      <span>${new Date(i.date+"T00:00:00").toLocaleDateString("es-CL",{timeZone:"America/Santiago"})} :

        ${i.present?"‚úî Presente":i.absent?"‚úò Ausente":i.justified?"üü° Justificado":"‚Äî Sin clase"}

      </span>
      <button class="btn btn-secondary btn-del-att" data-cid="${e}" data-id="${i.id}">‚ùå</button>
    </div>
  `).join(""),n.querySelectorAll(".btn-del-att").forEach(i=>{i.addEventListener("click",()=>ys(i.dataset.cid,i.dataset.id))});const a=t.filter(i=>!i.noClass),r=a.filter(i=>i.present||i.justified).length,s=a.length?Math.round(r/a.length*100):0,l=document.querySelector(`.att-percent[data-id="${e}"]`);l&&(l.textContent=s+"%"),window.courseAttendance||(window.courseAttendance={}),window.courseAttendance[e]=s}let Ht=null;function gs(e){Ht=e;const t=new Date,n=new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().split("T")[0];c("attDate").value=n,c("attModal").classList.add("active")}function Ta(){c("attModal").classList.remove("active"),Ht=null}document.addEventListener("DOMContentLoaded",()=>{var e,t,n,a,r;(e=c("attCancel"))==null||e.addEventListener("click",Ta),(t=c("attPresente"))==null||t.addEventListener("click",()=>bt("present")),(n=c("attAusente"))==null||n.addEventListener("click",()=>bt("absent")),(a=c("attJustificado"))==null||a.addEventListener("click",()=>bt("justified")),(r=c("attNoClass"))==null||r.addEventListener("click",()=>bt("noClass"))});async function bt(e){if(!Ht)return;const t=c("attDate").value;if(!t){alert("Selecciona una fecha");return}const[n,a,r]=t.split("-").map(Number),l=new Date(n,a-1,r).toISOString().split("T")[0],i=L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",Ht,"attendance",l);await X(i,{date:l,present:e==="present",absent:e==="absent",justified:e==="justified",noClass:e==="noClass"}),Ta()}async function ys(e,t){const n=L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",e,"attendance",t);await oe(n)}async function $a(){if(!o.currentUser||!o.activeSemesterId)return;if(yt){try{yt()}catch{}yt=null}window.courseAttendance||(window.courseAttendance={});const e=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses");try{const t=await H(e);for(const n of t.docs){if(!(n.data()||{}).asistencia)continue;const r=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",n.id,"attendance"),i=(await H(r)).docs.map(m=>m.data()).filter(m=>!m.noClass),u=i.filter(m=>m.present||m.justified).length,d=i.length?Math.round(u/i.length*100):0;window.courseAttendance[n.id]=d}console.log("‚ö° Precarga inicial de asistencia:",window.courseAttendance),document.dispatchEvent(new CustomEvent("attendance:ready",{detail:{preload:!0}}))}catch(t){console.error("Error en precarga r√°pida de asistencia:",t)}return yt=Y(e,t=>{t.docs.filter(a=>{var r;return(r=a.data())==null?void 0:r.asistencia}).forEach(a=>{const r=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",a.id,"attendance");Y(r,s=>{const i=s.docs.map(m=>m.data()).filter(m=>!m.noClass),u=i.filter(m=>m.present||m.justified).length,d=i.length?Math.round(u/i.length*100):0;window.courseAttendance[a.id]=d,document.dispatchEvent(new CustomEvent("attendance:ready",{detail:{courseId:a.id,percent:d}}))})})}),!0}document.addEventListener("auth:ready",()=>{setTimeout(()=>bn(),1e3)});document.addEventListener("semester:changed",()=>{bn()});const Xn=Object.freeze(Object.defineProperty({__proto__:null,initAttendance:bn,preloadAttendanceData:$a},Symbol.toStringTag,{value:"Module"}));let V=null,St=null,le=[],k={scale:"USM",finalExpr:"",rulesText:""},ge={byName:{},byCode:{},byId:{}},he=null,ne=null;function ct(){return L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",V,"groups","meta")}async function Da(){if(ne=null,!!fe())try{const e=await J(ct());ne=e.exists()?e.data()||{}:{}}catch(e){console.error("Error cargando nombres de grupos:",e),ne={}}}async function bs(e,t){if(fe())try{await X(ct(),{[e]:t},{merge:!0}),ne={...ne||{},[e]:t}}catch(n){throw console.error("Error guardando nombre de grupo:",n),n}}function ea(){const e=ne||{};return Array.isArray(e.__custom)?e.__custom:[]}function Ss(e){return(e||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"")||"g"}async function ws(){if(!fe())return;const e=prompt('Nombre de la carpeta (ej.: "Quices", "Trabajos", "Controles cortos"):');if(!e)return;const t=e.trim();if(!t)return;const n=prompt(`Palabra clave que deben contener las evaluaciones para ir a esta carpeta.
Ej.: "quiz" agrupa todo lo que tenga "quiz" en el nombre.`);if(!n)return;const a=n.trim();if(!a)return;const r=ne||{},s=Array.isArray(r.__custom)?[...r.__custom]:[],l=Ss(t),i=new Set(["certamenes","controles","tareas","proyecto","evaluaciones","experiencias","preinformes","informes","laboratorios","otros",...s.map(f=>f.key)]);let u=l,d=2;for(;i.has(u);)u=`${l}${d++}`;s.push({key:u,label:t,keyword:a});const m={...r,[u]:t,__custom:s};await X(ct(),m,{merge:!0}),ne=m}async function Cs(e){if(!fe())return;const t=ne||{},n=Array.isArray(t.__custom)?t.__custom.filter(r=>r.key!==e):[],a={...t};delete a[e],a.__custom=n,await X(ct(),a,{merge:!0}),ne=a}function Es(e){he=e,o.unsubscribeGrades=()=>{try{he==null||he()}finally{he=null,o.unsubscribeGrades=null}}}function Ls(){try{he==null||he()}finally{he=null}o.unsubscribeGrades=null}function xs(){const e=c("gr-courseSel");e&&(e.innerHTML='<option value="" disabled selected>Selecciona un ramo‚Ä¶</option>');const t=c("gr-evalsList");t&&(t.innerHTML="");const n=c("gr-finalExpr");n&&(n.value="");const a=c("gr-rulesError");a&&(a.textContent="");const r=c("gr-currentAvg");r&&(r.textContent="‚Äî");const s=c("gr-neededToPass");s&&(s.textContent="‚Äî");const l=c("gr-status");l&&(l.textContent="‚Äî");const i=c("gr-partnerView");i&&i.classList.add("hidden");const u=c("gr-sh-semSel");u&&(u.innerHTML="");const d=c("gr-sh-list");d&&(d.innerHTML="")}function As(){Us()}document.addEventListener("attendance:ready",e=>{console.log("üîÅ Asistencia actualizada para:",e.detail),ae()});document.addEventListener("route:notas",()=>{setTimeout(()=>{const e=c("gr-courseSel"),t=c("gr-evalsCard"),n=c("gr-calcCard"),a=c("gr-summaryCard"),r=c("gr-rulesCard");(!e||!e.value)&&(t&&t.classList.add("hidden"),n&&n.classList.add("hidden"),a&&a.classList.add("hidden"),r&&r.classList.add("hidden"))},50)});function It(){ka()}function Ms(){var n,a;const e=c("gr-activeSemLabel");e&&(e.textContent=((n=o.activeSemesterData)==null?void 0:n.label)||"‚Äî"),ka();const t=document.getElementById("gr-sh-semSel");t&&((a=o.activeSemesterData)!=null&&a.label)&&(t.innerHTML=`<option selected>${o.activeSemesterData.label}</option>`,t.disabled=!0,t.style.pointerEvents="none",t.style.opacity="0.7"),(async()=>{try{await $a(),console.log("‚úÖ Asistencia precargada, ahora s√≠ recalculamos notas"),ae()}catch(r){console.warn("‚ö†Ô∏è Error precargando asistencia:",r),ae()}})()}function Is(){return(le||[]).map(e=>({code:e.key,name:e.name||e.key,grade:typeof e.score=="number"?e.score:null}))}function Us(){var n,a,r,s;Ts(),(n=c("gr-saveExpr"))==null||n.addEventListener("click",Je),(a=c("gr-finalExpr"))==null||a.addEventListener("keydown",l=>{l.key==="Enter"&&(l.preventDefault(),Je())}),(r=c("gr-courseSel"))==null||r.addEventListener("change",Ds),(s=c("gr-addEvalBtn"))==null||s.addEventListener("click",Rs),$s();function e(){var f;const l=c("page-notas");if(!l)return;const i=(f=Array.from(l.querySelectorAll(".card h3")).find(p=>/c[a√°]lculo de notas/i.test(p.textContent)))==null?void 0:f.closest(".card");if(!i||(i.id||(i.id="gr-calcCard"),i.querySelector("#gr-openSim")))return;const u=i.querySelector("h3"),d=document.createElement("button");d.id="gr-openSim",d.className="ghost",d.textContent="Simulador de notas";let m=u==null?void 0:u.closest(".row");m?m.classList.add("gr-calcHeader"):(m=document.createElement("div"),m.className="row gr-calcHeader",u&&m.appendChild(u),i.insertBefore(m,i.firstChild)),d.style.marginLeft="auto",m.appendChild(d),d.addEventListener("click",()=>{const p=Ys();if(!p){alert("Primero define la F√≥rmula final.");return}const g=Is();if(!g.length){alert("Agrega al menos una evaluaci√≥n.");return}Ks({formula:p,evals:g})})}e(),document.addEventListener("pair:ready",rn);const t=c("gr-finalExpr");if(t){const l=zs(async()=>{await Je()},600);t.addEventListener("input",()=>{k.finalExpr=ze(t.value||""),ae(),l()}),t.addEventListener("blur",()=>Je()),t.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),Je())})}}function Ts(){var n;const e=c("gr-passThreshold");e&&((n=e.closest("div"))==null||n.classList.add("hidden"));const t=c("gr-saveHeader");t&&t.classList.add("hidden")}function $s(){var a,r;if(c("gr-rulesCard"))return;const e=c("page-notas");if(!e)return;const t=document.createElement("div");t.className="card",t.id="gr-rulesCard",t.style.marginTop="12px",t.innerHTML=`
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Reglas</h3>
      <div class="muted" id="gr-rulesHint">Una por l√≠nea. Ej.: <code>C1>=50</code>, <code>avg(Q1,Q2,Q3)>=60</code>,</code> finalCode("Codigo del ramo") >= 50</code>,</code>Asistencia >= 55%</code></div>
    </div>
    <div class="row" style="align-items:flex-start;margin-top:8px">
      <textarea id="gr-rulesText" rows="4" style="flex:1 1 520px;min-height:86px;background:#0e1120;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px"></textarea>
      <div id="gr-formulaError" class="muted" style="margin-top:6px;color:#fca5a5"></div>
      <button id="gr-saveRules" class="primary">Guardar reglas</button>
    </div>
    <div id="gr-rulesStatus" class="muted" style="margin-top:6px"></div>
  `;const n=(a=Array.from(e.querySelectorAll(".card h3")).find(s=>/c[a√°]lculo de notas/i.test(s.textContent)))==null?void 0:a.closest(".card");n?e.insertBefore(t,n):e.appendChild(t),(r=c("gr-saveRules"))==null||r.addEventListener("click",Ps)}async function ka(){var t,n,a;const e=c("gr-courseSel");if(e){if(e.innerHTML="",!o.courses||o.courses.length===0){e.innerHTML='<option value="">‚Äî</option>',V=null,de(),Pa(null);return}o.courses.forEach(r=>{const s=document.createElement("option");s.value=r.id,s.textContent=r.name,e.appendChild(s)}),V=null,e.value="",e.selectedIndex=0,o.editingCourseId=null,(t=c("gr-evalsCard"))==null||t.classList.add("hidden"),(n=c("gr-calcCard"))==null||n.classList.add("hidden"),(a=c("gr-summaryCard"))==null||a.classList.add("hidden")}}async function Ds(e){var t,n,a,r,s,l,i,u;if(V=e.target.value||null,o.editingCourseId=V,!V){(t=c("gr-evalsCard"))==null||t.classList.add("hidden"),(n=c("gr-calcCard"))==null||n.classList.add("hidden"),(a=c("gr-summaryCard"))==null||a.classList.add("hidden"),(r=c("gr-rulesCard"))==null||r.classList.add("hidden");return}(s=c("gr-evalsCard"))==null||s.classList.remove("hidden"),(l=c("gr-calcCard"))==null||l.classList.remove("hidden"),(i=c("gr-summaryCard"))==null||i.classList.remove("hidden"),(u=c("gr-rulesCard"))==null||u.classList.remove("hidden"),await Ns(),await Da(),await Os(),await lt(),ae(),await ks(V)}async function ks(e){try{const t=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",e,"attendance"),r=(await H(t)).docs.map(i=>i.data()).filter(i=>!i.noClass),s=r.filter(i=>i.present||i.justified).length,l=r.length?Math.round(s/r.length*100):0;window.courseAttendance||(window.courseAttendance={}),window.courseAttendance[e]=l,console.log(`‚úÖ Sincronizada asistencia directa de ${e}: ${l}%`),ae()}catch(t){console.warn("‚ö†Ô∏è No se pudo sincronizar asistencia directa:",t)}}function zt(){return L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",V,"grading","meta")}function Ce(){return M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",V,"grading","meta","components")}async function Ns(){var p,g,v;if(!fe())return;const e=zt(),t=L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",V),n=await J(t),a=n.exists()&&n.data().scale||null,r=((p=o.activeSemesterData)==null?void 0:p.gradeScale)||null,s=((g=o.activeSemesterData)==null?void 0:g.universityAtThatTime)||"";let l=null;if(r)l=r==="1-7"||r==="2-7"||r==="0-7"?"MAYOR":"USM";else{const y=localStorage.getItem(`scale_${s}`);y?l=y.includes("7")?"MAYOR":"USM":l=/mayor/i.test(s)?"MAYOR":(/usm|utfsm|santa\s*mar/i.test(s),"USM")}const i=await J(e);i.exists()?k={finalExpr:"",rulesText:"",...i.data()}:(k={scale:a||l,finalExpr:"",rulesText:""},await X(e,k));let u=a||l;k.scale!==u&&(k.scale=u,await z(e,{scale:k.scale})),c("gr-activeSemLabel")&&(c("gr-activeSemLabel").textContent=((v=o.activeSemesterData)==null?void 0:v.label)||"‚Äî");const d=c("gr-scaleSel");d&&(d.value=k.scale||"USM");const m=c("gr-finalExpr");m&&(m.value=k.finalExpr||"");const f=c("gr-rulesText");f&&(f.value=k.rulesText||""),k.scale,de(),ae()}async function Je(){if(!fe())return;const e=c("gr-finalExpr"),n=((e?e.value:"")||"").trim(),a=ze(n)||null;k.finalExpr=a,await z(zt(),{finalExpr:a}),await lt(),ae()}async function Ps(){if(!fe())return;const e=(c("gr-rulesText").value||"").trim()||null;k.rulesText=e,await z(zt(),{rulesText:e}),await lt(),ae()}async function Os(){if(St&&(St(),St=null),!fe()){de([]);return}const e=Ce();St=Y(te(e,Pe("createdAt","asc")),async t=>{let n=t.docs.map(r=>({id:r.id,...r.data()}));const a=n.filter(r=>typeof r.order!="number");if(a.length){const{writeBatch:r}=await Q(async()=>{const{writeBatch:i}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");return{writeBatch:i}},[]),s=r(b),l=Date.now();a.forEach((i,u)=>{s.update(L(Ce(),i.id),{order:l+u})});try{await s.commit()}catch{}}n.sort((r,s)=>{var m,f,p,g;const l=typeof r.order=="number"?r.order:9e15,i=typeof s.order=="number"?s.order:9e15;if(l!==i)return l-i;const u=((f=(m=r.createdAt)==null?void 0:m.toMillis)==null?void 0:f.call(m))??0,d=((g=(p=s.createdAt)==null?void 0:p.toMillis)==null?void 0:g.call(p))??0;return u-d}),le=n,await de(n),ae(),lt().then(()=>ae())},t=>{console.error("watchComponents error:",t),de([])})}async function Rs(){if(!fe()){alert("Selecciona un semestre y un ramo.");return}const e=c("gr-evalName"),t=c("gr-evalCode"),n=c("gr-evalScore"),a=((e==null?void 0:e.value)||"").trim();let r=((t==null?void 0:t.value)||"").trim();const s=(n==null?void 0:n.value)??"";if(!a){alert("Escribe un nombre.");return}if(!r){alert("Escribe un c√≥digo (ej: C1, T1...).");return}if(r=r.replace(/\s+/g,"").replace(/[^A-Za-z0-9_]/g,"").slice(0,16),!r){alert("C√≥digo inv√°lido.");return}r=_s(r,le);const l=k.scale==="MAYOR",i=l?1:0,u=l?7:100,d=parseFloat(String(s).replace(",",".")),m=isNaN(d)?null:wn(d,i,u);await Ae(Ce(),{key:r,name:a,score:m,createdAt:fa(),order:Date.now()}),e&&(e.value=""),t&&(t.value=""),n&&(n.value="")}function Na(e){return(e||"").replace(/\s+/g,"").replace(/[^A-Za-z0-9_]/g,"").slice(0,16)}function _s(e,t){const n=new Set((t||[]).map(s=>(s.key||"").toLowerCase()));let a=Na(e)||"X";if(!n.has(a.toLowerCase()))return a;let r=2;for(;n.has((a+r).toLowerCase());)r++;return a+r}async function de(e=[]){const t=c("gr-evalsList");if(!t)return;const n={};t.querySelectorAll(".grade-item").forEach(S=>{var U,w;const N=(w=(U=S.querySelector("code"))==null?void 0:U.textContent)==null?void 0:w.trim(),I=S.querySelector('[data-f="score"]');N&&I&&I.value&&(n[N]=I.value)});const a=new Set(Array.from(t.querySelectorAll("details.grade-group[open]")).map(S=>S.dataset.key));if(t.innerHTML="",!V){t.innerHTML='<div class="muted">Selecciona un ramo.</div>';return}if(!e.length){t.innerHTML='<div class="muted">A√∫n no hay evaluaciones. Usa ‚ÄúAgregar evaluaci√≥n‚Äù.</div>';return}const r=k.scale==="MAYOR",s=r?1:0,l=r?7:100,i=r?.1:1,u=document.createElement("div");u.className="row",u.style.justifyContent="space-between",u.style.alignItems="center",u.style.marginBottom="6px";const d=document.createElement("div");d.className="muted",d.textContent="Carpetas de evaluaciones";const m=document.createElement("button");m.id="gr-addGroup",m.className="ghost",m.textContent="Agregar carpeta",m.addEventListener("click",()=>{ws().then(()=>de(le))}),u.appendChild(d),u.appendChild(m),t.appendChild(u);const f=ne||{},p=ea(),g=new Set(p.map(S=>S.key)),v={certamenes:"Cert√°menes",controles:"Controles",tareas:"Tareas",proyecto:"Proyecto",evaluaciones:"Evaluaciones",experiencias:"Experiencias",preinformes:"Pre-informes",informes:"Informes",laboratorios:"Laboratorios",otros:"Otros"};p.forEach(S=>{v[S.key]=S.label||S.key});const y={...v,...f},h={},x=new Set,E=S=>(S.name||"").toString();p.forEach(S=>{const N=(S.keyword||S.pattern||S.label||"").trim();if(!N)return;const I=N.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),U=new RegExp(I,"i"),w=e.filter(C=>!x.has(C.id)&&U.test(E(C)));w.length&&(h[S.key]=w,w.forEach(C=>x.add(C.id)))});const P={certamenes:S=>/certamen/i.test(E(S)),controles:S=>/control/i.test(E(S)),tareas:S=>/tarea/i.test(E(S)),proyecto:S=>/proy|proyecto/i.test(E(S)),evaluaciones:S=>/evaluaci[o√≥]n/i.test(E(S)),experiencias:S=>/experien/i.test(E(S)),preinformes:S=>/pre[\s-]?informe/i.test(E(S)),informes:S=>/\binforme/i.test(E(S))&&!/pre[\s-]?informe/i.test(E(S)),laboratorios:S=>/laboratorio|\blab/i.test(E(S))};for(const[S,N]of Object.entries(P)){const I=e.filter(U=>!x.has(U.id)&&N(U));I.length&&(h[S]=I,I.forEach(U=>x.add(U.id)))}const _=e.filter(S=>!x.has(S.id));_.length&&(h.otros=_);for(const[S,N]of Object.entries(h)){if(!N.length)continue;const I=document.createElement("details");I.className="grade-group",I.dataset.key=S,a.has(S)&&(I.open=!0);const U=document.createElement("summary");U.style.display="flex",U.style.alignItems="center",U.style.justifyContent="space-between",U.style.width="100%",U.style.cursor="pointer";const w=y[S]||v[S]||S,C=document.createElement("span");C.style.fontWeight="700",C.textContent=`${w} (${N.length})`;const A=document.createElement("div");A.style.display="flex",A.style.alignItems="center",A.style.gap="4px";const $=document.createElement("button");if($.dataset.rename=S,$.className="ghost",$.textContent="‚úé",Object.assign($.style,{fontSize:"0.9em",opacity:"0.8",flexShrink:"0"}),A.appendChild($),g.has(S)){const T=document.createElement("button");T.dataset.deleteGroup=S,T.className="ghost",T.textContent="üóë",Object.assign(T.style,{fontSize:"0.9em",opacity:"0.8",flexShrink:"0"}),T.addEventListener("click",async R=>{R.preventDefault(),R.stopPropagation();const G=y[S]||S;if(confirm(`¬øEliminar la carpeta ‚Äú${G}‚Äù y TODAS las evaluaciones que contiene? Esta acci√≥n no se puede deshacer.`))try{const{writeBatch:F}=await Q(async()=>{const{writeBatch:q}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");return{writeBatch:q}},[]),D=F(b);N.forEach(q=>{D.delete(L(Ce(),q.id))}),await D.commit(),await Cs(S),await Da(),de(le)}catch(F){console.error("Error borrando carpeta y evaluaciones:",F),alert("No se pudo borrar la carpeta. Int√©ntalo de nuevo.")}}),A.appendChild(T)}U.appendChild(C),U.appendChild(A),I.appendChild(U);const B=document.createElement("div");N.forEach(T=>{const R=document.createElement("div");R.className="grade-item",R.dataset.id=T.id,R.draggable=!0,R.innerHTML=`
        <div style="flex:1">
          <div class="gr-name" style="font-weight:700">${K(T.name||T.key)}</div>
          <div class="muted">C√≥digo: <code class="gr-code">${K(T.key)}</code></div>
        </div>
        <div style="display:flex;align-items:center;gap:.5rem">
          <input data-f="score" type="number" step="${i}" min="${s}" max="${l}"
                 value="${n[T.key]??T.score??""}" style="width:110px"/>
          <button data-act="save" class="btn btn-secondary">Guardar</button>
          <button data-act="edit" class="btn btn-secondary">Editar</button>
          <button data-act="cancelEdit" class="btn btn-secondary" style="display:none">Cancelar</button>
          <button data-act="del"  class="btn btn-secondary">Eliminar</button>
        </div>
      `,R.querySelectorAll("input,button,select,textarea").forEach(G=>{G.setAttribute("draggable","false")}),R.addEventListener("click",async G=>{var D,q;const F=G.target;if(F instanceof HTMLElement){if(F.dataset.act==="edit"){const W=R.querySelector(".gr-name"),se=R.querySelector(".gr-code"),_e=((D=W==null?void 0:W.textContent)==null?void 0:D.trim())||T.name||"",Me=((q=se==null?void 0:se.textContent)==null?void 0:q.trim())||T.key||"";W.innerHTML=`<input data-f="edit-name" type="text" value="${K(_e)}"
                               style="width:100%;max-width:320px">`,se.parentElement.innerHTML=`C√≥digo: <input data-f="edit-code" type="text" value="${K(Me)}"
                            style="width:120px">`,R.querySelector('[data-act="edit"]').style.display="none",R.querySelector('[data-act="cancelEdit"]').style.display="";return}if(F.dataset.act==="cancelEdit"){de(le);return}if(F.dataset.act==="save"){const W=R.querySelector('[data-f="edit-name"]'),se=R.querySelector('[data-f="edit-code"]');if(W||se){const Za=W?W.value:T.name||T.key,Qa=se?se.value:T.key,Un=(Za||"").trim();let pe=(Qa||"").trim();if(!Un){alert("Escribe un nombre.");return}if(pe=Na(pe),!pe){alert("C√≥digo inv√°lido. Usa A‚ÄìZ, 0‚Äì9 o _.");return}if(new Set(le.filter(Be=>Be.id!==T.id).map(Be=>(Be.key||"").toLowerCase())).has(pe.toLowerCase())){alert(`El c√≥digo ${pe} ya existe en este ramo.`);return}const Xa=L(Ce(),T.id);if(pe!==T.key){const Be=ta(k.finalExpr||"",T.key,pe),Tn=ta(k.rulesText||"",T.key,pe);await z(zt(),{finalExpr:Be||null,rulesText:Tn||null}),k.finalExpr=Be||"",k.rulesText=Tn||""}await z(Xa,{name:Un,key:pe}),await lt(),ae(),de(le);return}const _e=R.querySelector('[data-f="score"]');let Me=parseFloat(_e.value);const Ka=isNaN(Me)?null:wn(Me,s,l);await z(L(Ce(),T.id),{score:Ka}),F.textContent="Guardado ‚úì",ae(),setTimeout(()=>F.textContent="Guardar",1200);return}if(F.dataset.act==="del"){if(!confirm(`Eliminar ‚Äú${T.name||T.key}‚Äù?`))return;await oe(L(Ce(),T.id));return}}}),B.appendChild(R)}),I.appendChild(B),t.appendChild(I),Oa(B),$.addEventListener("click",async T=>{T.preventDefault(),T.stopPropagation();const R=y[S]||v[S]||S,G=prompt(`Nuevo nombre para ‚Äú${R}‚Äù:`,R);if(!(!G||G.trim()===R))try{if(await bs(S,G.trim()),g.has(S)){const F=ne||{},D=ea().map(W=>W.key===S?{...W,label:G.trim()}:W),q={...F,[S]:G.trim(),__custom:D};await X(ct(),q,{merge:!0}),ne=q}de(le)}catch{alert("No se pudo guardar el nuevo nombre.")}})}}function ta(e,t,n){if(!e)return e;const a=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=new RegExp(`\\b${a(t)}\\b`,"g");return e.replace(r,n)}function ae(){const e={},t=k.scale==="MAYOR"?1:0,n=k.scale==="MAYOR"?7:100;le.forEach(m=>{typeof m.score=="number"&&(e[m.key]=wn(m.score,t,n))}),window.courseAttendance&&V in window.courseAttendance?e.Asistencia=window.courseAttendance[V]:e.Asistencia=0;let a=null,r="";if(k.finalExpr&&k.finalExpr.trim()!=="")try{a=Re(k.finalExpr,e,{avg:Ye,min:Math.min,max:Math.max,final:m=>Ft(m),finalCode:m=>qt(m),finalId:m=>Cn(m)}),typeof a=="number"&&isFinite(a)?a=Ge(a,k.scale):a=null}catch(m){r=(m==null?void 0:m.message)||String(m||""),a=null}c("gr-rulesStatus")&&(c("gr-rulesStatus").dataset.formulaError=r);const s=k.scale==="MAYOR"?3.95:54.5,l=Gt(k.rulesText||""),i=Sn(l,e);let u=null;a==null?i.allOk?u="‚Äî":u="Reprueba":u=a>=s&&i.allOk?"Aprueba":"Reprueba";let d="‚Äî";if(a==null)d="Ingresa notas o completa la f√≥rmula.";else if(u==="Aprueba")d="Nada m√°s. Ya alcanzas la nota y cumples las reglas.";else{const m=[];if(a<s){const f=s-a;m.push(k.scale==="MAYOR"?`Subir la nota final en ${f.toFixed(2)} pts.`:`Subir la nota final en ${f.toFixed(1)} pts.`)}if(!i.allOk){const f=i.unmet.map(p=>`Cumplir: ${p.text}.`);m.push(...f)}d=m.join(" ")}Fs(i),Pa({final:a,status:u,needed:d})}async function lt(){if(ge={byName:{},byCode:{},byId:{}},!o.currentUser||!o.activeSemesterId)return;const e=Array.isArray(o.courses)?o.courses:[];for(const t of e)try{const n=L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",t.id,"grading","meta"),a=await J(n),r=a.exists()?a.data():{scale:"USM",finalExpr:""},s=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",t.id,"grading","meta","components"),i=(await H(s)).docs.map(v=>({id:v.id,...v.data()})),u={},d=r.scale==="MAYOR"?1:0,m=r.scale==="MAYOR"?7:100;for(const v of i)if(typeof v.score=="number"&&isFinite(v.score)){const y=Math.max(d,Math.min(m,v.score));u[v.key]=y}let f=null;if((r.finalExpr||"").trim())try{f=Re(r.finalExpr,u,{avg:Ye,min:Math.min,max:Math.max,final:v=>NaN,finalCode:v=>NaN,finalId:v=>NaN}),typeof f=="number"&&isFinite(f)?f=Ge(f,r.scale):f=null}catch{f=null}const p=Ee(t.name),g=Ee(t.code);p&&(ge.byName[p]={final:f,scale:r.scale,id:t.id}),g&&(ge.byCode[g]={final:f,scale:r.scale,id:t.id}),ge.byId[t.id]={final:f,scale:r.scale,id:t.id}}catch{}}function Gt(e){return(e||"").split(/\r?\n/).map(n=>n.trim()).filter(Boolean)}function Sn(e,t,n){const a={allOk:!0,items:[],unmet:[]};for(const r of e){const s=Bs(r);if(!s){a.items.push({text:r,ok:!1,reason:"inv√°lida"}),a.unmet.push({text:r,kind:"invalid"}),a.allOk=!1;continue}const{left:l,op:i,right:u}=s;let d=null,m=null,f=!1;try{const g={...{avg:Ye,min:Math.min,max:Math.max,final:Ft,finalCode:qt,finalId:Cn},...n||{}};window.courseAttendance&&V in window.courseAttendance?t.Asistencia=window.courseAttendance[V]:"Asistencia"in t||(t.Asistencia=0);const v=l.replace(/%/g,""),y=u.replace(/%/g,"");d=Re(v,t,g),m=Re(y,t,g),f=Hs(d,i,m)}catch{f=!1}a.items.push({text:r,ok:f,left:d,op:i,right:m}),f||(a.unmet.push({text:r,kind:"cmp",left:d,op:i,right:m}),a.allOk=!1)}return a}function Bs(e){const t=e.match(/^(.*?)(>=|<=|==|!=|>|<)(.*)$/);return t?{left:ze(t[1].trim()),op:t[2],right:ze(t[3].trim())}:null}function Hs(e,t,n){if(!(isFinite(e)&&isFinite(n)))return!1;const a=Math.round(Math.round(e*10)/10),r=Math.round(Math.round(n*10)/10);switch(t){case">=":return a>=r;case"<=":return a<=r;case">":return a>r;case"<":return a<r;case"==":return a===r;case"!=":return a!==r;default:return!1}}function Ye(...e){const t=e.map(a=>typeof a=="number"&&isFinite(a)?a:Number(a)).filter(a=>!isNaN(a));return t.length?t.reduce((a,r)=>a+r,0)/t.length:NaN}function Fs(e){const t=c("gr-rulesStatus");if(!t)return;if(!e||!e.items.length){t.textContent="No hay reglas definidas.";return}const n=e.items.filter(r=>r.ok).length,a=e.items.map(r=>r.ok?`‚úÖ ${r.text}`:`‚ùå ${r.text}`);t.innerHTML=`<div><b>Reglas:</b> ${n}/${e.items.length} cumplidas</div><div style="margin-top:4px">${a.join("<br/>")}</div>`}function Pa(e){const t=c("gr-currentFinal")||c("gr-currentAvg"),n=c("gr-status"),a=c("gr-needed")||c("gr-neededToPass");if(!t||!n||!a)return;if(!e){t.textContent="",n.textContent="",a.textContent="",delete t.dataset.base,delete n.dataset.base;return}const r=(k==null?void 0:k.scale)||"USM",s=e.final==null?"":Ge(e.final,r).toString();t.textContent=s,n.textContent=e.status??"",a.textContent=e.needed??""}let Wt={id:null,fromIndex:-1};function Oa(e){e&&(e.querySelectorAll(".grade-item").forEach(t=>{t.draggable=!0,t.querySelectorAll("input,button,select,textarea").forEach(n=>{n.setAttribute("draggable","false")})}),e.addEventListener("dragstart",t=>{const n=t.target.closest(".grade-item");n&&(t.dataTransfer.setData("text/plain",n.dataset.id||""),t.dataTransfer.effectAllowed="move",n.classList.add("dragging"),Wt.id=n.dataset.id,Wt.fromIndex=[...e.children].indexOf(n))}),e.addEventListener("dragend",()=>{const t=e.querySelector(".grade-item.dragging");t==null||t.classList.remove("dragging"),Wt={id:null,fromIndex:-1}}),e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="move";const n=e.querySelector(".grade-item.dragging");if(!n)return;const a=qs(e,t.clientY);a==null?e.appendChild(n):e.insertBefore(n,a)},{capture:!0}),e.addEventListener("drop",async t=>{t.preventDefault();const n=[...e.querySelectorAll(".grade-item")].map(a=>a.dataset.id);await js(n)}))}function qs(e,t){return[...e.querySelectorAll(".grade-item:not(.dragging)")].reduce((a,r)=>{const s=r.getBoundingClientRect(),l=t-(s.top+s.height/2);return l<0&&l>a.offset?{offset:l,element:r}:a},{offset:Number.NEGATIVE_INFINITY,element:null}).element}async function js(e){if(!fe()||!Array.isArray(e)||!e.length)return;const{writeBatch:t}=await Q(async()=>{const{writeBatch:s}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");return{writeBatch:s}},[]),n=t(b);let a=Date.now();const r=1e3;e.forEach((s,l)=>{const i=L(Ce(),s);n.update(i,{order:a+l*r})});try{await n.commit()}catch(s){console.warn("Error al guardar orden:",s)}}function Ys(){var e;return(((e=document.getElementById("gr-finalExpr"))==null?void 0:e.value)||"").trim()}function zs(e,t){let n=null;return(...a)=>{n&&clearTimeout(n),n=setTimeout(()=>e(...a),t)}}function fe(){return!!(o.currentUser&&o.activeSemesterId&&V)}function K(e){return(e??"").toString().replace(/[<>&"]/g,t=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"})[t])}function wn(e,t,n){return Math.max(t,Math.min(n,e))}function ze(e){if(!e)return"";let t=String(e).trim();return t=t.replace(/[‚Äú‚Äù]/g,'"').replace(/[‚Äò‚Äô]/g,"'"),t=t.replace(/\s+/g," "),t}function Ra(e){return e.replace(/\b(final|finalCode|finalId)\(\s*([^)]+?)\s*\)/g,(t,n,a)=>{const r=String(a).trim();if(/^["'].*["']$/.test(r))return`${n}(${r})`;if(/[(),]/.test(r))return`${n}(${r})`;const s=r.replace(/"/g,'\\"');return`${n}("${s}")`})}function Gs(e){return e?e.replace(/(\d+(?:\.\d+)?)\s*%/g,(t,n)=>`(${n}/100)`):""}function Re(e,t,n={}){const a=ze(e),r=Ra(a),s=r.replace(/"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'/g,"0");if(!/^[\w\s\.\+\-\*\/\(\),%<>!=]+$/.test(s))throw new Error("La f√≥rmula contiene caracteres no permitidos.");const l=Gs(r),i=s.match(/\b[A-Za-z_][A-Za-z0-9_]*\b/g)||[],u=new Set(["avg","min","max","final","finalCode","finalId"]),d=new Set(["NaN","Infinity","Math","true","false"]),m=Object.keys(t),f=m.map(y=>t[y]??0),p=new Set([...m,...Object.keys(n)]);for(const y of i)u.has(y)||d.has(y)||p.has(y)||(m.push(y),f.push(0),p.add(y));const g=Object.keys(n),v=Object.values(n);return Function(...g,...m,`"use strict"; return (${l});`)(...v,...f)}function Vs(e){const t=ze(e||""),n=Ra(t),r=n.replace(/"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'/g,"0").match(/\b[A-Za-z_][A-Za-z0-9_]*\b/g)||[],s=new Set(["avg","min","max","final","finalCode","finalId","NaN","Infinity","Math","true","false"]),l=new Set((n.match(/\b[A-Za-z_][A-Za-z0-9_]*\s*\(/g)||[]).map(u=>u.replace("(","").trim())),i=r.filter(u=>!s.has(u)&&!l.has(u));return[...new Set(i)]}function Ge(e,t){return e==null||isNaN(e)?null:t==="MAYOR"?Math.trunc(e*100)/100:Math.trunc(e*10)/10}function Ee(e){return(e||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toLowerCase()}function Ft(e){const t=Ee(e);if(!t)return NaN;const n=(o.courses||[]).find(i=>i.id===V);if(t===Ee(n==null?void 0:n.name))return NaN;const a=ge.byName[t];if(a&&typeof a.final=="number")return a.final;const r=Array.isArray(o.courses)?o.courses:[],s=r.filter(i=>Ee(i.name).startsWith(t)&&i.id!==V);if(s.length===1){const i=ge.byId[s[0].id];if(i&&typeof i.final=="number")return i.final}const l=r.filter(i=>Ee(i.name).includes(t)&&i.id!==V);if(l.length===1){const i=ge.byId[l[0].id];if(i&&typeof i.final=="number")return i.final}return NaN}function qt(e){const t=Ee(e),n=(o.courses||[]).find(r=>r.id===V);if(t&&t===Ee(n==null?void 0:n.code))return NaN;const a=ge.byCode[t];return a&&typeof a.final=="number"?a.final:NaN}function Cn(e){if(!e||e===V)return NaN;const t=ge.byId[e];return t&&typeof t.final=="number"?t.final:NaN}(function(){var s,l,i,u,d;const t=c("gr-togglePartner");if(!t)return;const n=[(s=c("gr-courseSel"))==null?void 0:s.closest(".card"),(l=c("gr-evalsList"))==null?void 0:l.closest(".card"),(i=c("gr-finalExpr"))==null?void 0:i.closest(".card"),((u=c("gr-currentFinal"))==null?void 0:u.closest(".card"))||((d=c("gr-currentAvg"))==null?void 0:d.closest(".card")),c("gr-rulesCard")].filter(Boolean),a=c("gr-partnerView");function r(m){t.setAttribute("aria-pressed",m?"true":"false"),t.textContent=m?"Volver a mis notas":"Notas de mi duo",n.forEach(f=>Pn(f,m)),Pn(a,!m),m&&rn()}t.addEventListener("click",()=>{const m=t.getAttribute("aria-pressed")==="true";r(!m)}),document.addEventListener("pair:ready",rn)})();let na=0;async function rn(){var i;const e=c("gr-sh-semSel");if(!e)return;e.innerHTML="";const t=document.createElement("option");if(t.textContent="Cargando...",t.disabled=!0,t.selected=!0,e.appendChild(t),!o.pairOtherUid){e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";return}const n=++na,a=M(b,"users",o.pairOtherUid,"semesters"),r=await H(a);if(n!==na)return;const s=((i=o.activeSemesterData)==null?void 0:i.label)||null;if(!s){e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";return}let l=null;if(r.forEach(u=>{var m;const d=(((m=u.data())==null?void 0:m.label)||"").trim();d===s&&(l={id:u.id,label:d})}),l)e.innerHTML=`<option selected>${l.label}</option>`,e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7",o.shared.notas.semId=l.id,Js(l.id);else{e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7",o.shared.notas.semId=null;const u=c("gr-sh-list");u&&(u.innerHTML='<div class="muted">Tu d√∫o no tiene este semestre creado.</div>')}}let Ut=null;function Ws(){Ut&&(Ut(),Ut=null)}async function Js(e){Ws();const t=c("gr-sh-list");if(t&&(t.innerHTML=""),!o.pairOtherUid||!e)return;const n=await J(L(b,"users",o.pairOtherUid,"semesters",e)),a=n.exists()&&n.data().universityAtThatTime||"",r=/mayor/i.test(a)?"MAYOR":"USM",s=M(b,"users",o.pairOtherUid,"semesters",e,"courses");Ut=Y(te(s,Pe("name")),async l=>{if(!l.size){aa([]);return}const i={},u=[];for(const m of l.docs){const f=m.data()||{},p=m.id,g=L(b,"users",o.pairOtherUid,"semesters",e,"courses",p,"grading","meta"),v=await J(g),y=v.exists()?v.data():{scale:r,finalExpr:"",rulesText:""},h=M(b,"users",o.pairOtherUid,"semesters",e,"courses",p,"grading","meta","components"),E=(await H(h)).docs.map(U=>({id:U.id,...U.data()||{}})),P={},_=y.scale==="MAYOR",S=_?1:0,N=_?7:100;E.forEach(U=>{const w=typeof U.score=="number"?Math.max(S,Math.min(N,U.score)):null;w!=null&&U.key&&(P[U.key]=w)});let I=null;try{(y.finalExpr||"").trim()&&(I=Re(y.finalExpr,P,{avg:Ye,min:Math.min,max:Math.max,final:()=>NaN,finalCode:()=>NaN,finalId:()=>NaN}),typeof I=="number"&&isFinite(I)?I=Ge(I,y.scale):I=null)}catch{I=null}i[(f.code||"").toLowerCase()]=I,u.push({cData:f,comps:E,vals:P,meta:y,prelim:I})}const d=[];for(const m of u){let f=m.prelim;try{(m.meta.finalExpr||"").trim()&&(f=Re(m.meta.finalExpr,m.vals,{avg:Ye,min:Math.min,max:Math.max,final:()=>NaN,finalCode:h=>{const x=(h||"").toString().toLowerCase();return i[x]??NaN},finalId:()=>NaN}),typeof f=="number"&&isFinite(f)?f=Ge(f,m.meta.scale):f=null)}catch{f=null}const p=m.meta.scale==="MAYOR"?3.95:54.5,g=Gt(m.meta.rulesText||""),v=Sn(g,m.vals),y=f!=null&&f>=p&&v.allOk?"Aprobado":f==null?"‚Äî":"Reprobado";d.push({name:m.cData.name||"Ramo",code:m.cData.code||"",final:f,scale:m.meta.scale||r,status:y})}aa(d)})}function aa(e){const t=c("gr-sh-list");if(t){if(t.innerHTML="",!e.length){t.innerHTML='<div class="muted">No hay ramos en ese semestre.</div>';return}e.forEach(n=>{const a=n.final==null?"‚Äî":n.scale==="MAYOR"?(Math.trunc(n.final*100)/100).toFixed(2):(Math.trunc(n.final*10)/10).toFixed(1),r=n.status==="Aprobado"?"#22c55e":n.status==="Reprobado"?"#ef4444":"#aaa",s=document.createElement("div");s.className="grade-item",s.innerHTML=`
      <div style="flex:1">
        <div style="font-weight:700">${K(n.name)}</div>
        <div class="muted">Nota final: <b>${a}</b></div>
      </div>
      <div style="font-weight:700;color:${r}">
        ${n.status}
      </div>
    `,t.appendChild(s)})}}function Ks({formula:e,evals:t}){var S,N,I,U;(S=document.getElementById("gr-simDrawer"))==null||S.remove(),(N=document.getElementById("gr-simBackdrop"))==null||N.remove();const n=document.createElement("div");n.id="gr-simBackdrop",Object.assign(n.style,{position:"fixed",inset:"0",zIndex:9998,background:"rgba(0,0,0,0.35)",backdropFilter:"blur(1px)"}),document.body.classList.add("sim-lock");const a=document.createElement("div");a.id="gr-simDrawer",Object.assign(a.style,{position:"fixed",top:"0",right:"0",height:"100vh",width:"420px",background:"rgba(18,18,30,.98)",backdropFilter:"blur(6px)",borderLeft:"1px solid rgba(255,255,255,.08)",boxShadow:"0 0 24px rgba(0,0,0,.45)",zIndex:9999,padding:"16px 16px 90px 16px",overflowY:"auto"}),a.addEventListener("click",w=>w.stopPropagation()),a.innerHTML=`
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
      <h3 style="margin:0">Simulador de notas</h3>
      <span class="muted" style="font-size:12px;opacity:.8">(${K(e)})</span>
    </div>

    <div class="card" style="margin-top:4px">
      <h4 style="margin:0 0 6px">Evaluaciones</h4>
      <div id="gr-simForm"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 6px">Resumen de la simulaci√≥n</h4>
      <div id="gr-simSummary" class="muted">‚Äî</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 6px">Reglas del ramo (simulaci√≥n)</h4>
      <div id="gr-simRules" class="muted">‚Äî</div>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px; padding-top:12px; border-top:1px solid rgba(255,255,255,.1)">
  <button id="gr-simSave" class="primary">Guardar simulaci√≥n</button>
  <button id="gr-simClose" class="ghost">Salir</button>
</div>

  `,document.body.appendChild(n),document.body.appendChild(a);const r=async()=>{const w=_();let C=null;try{C=await sa()}catch{C=null}const A=(R={})=>{const G={};for(const[F,D]of Object.entries(R||{}))D==null||D===""||typeof D=="string"&&D.trim()===""?G[F.toUpperCase()]=null:isNaN(D)?G[F.toUpperCase()]=D:G[F.toUpperCase()]=Math.round(Number(D)*100)/100;return G},B=((R,G)=>{const F=A(R),D=A(G),q=new Set([...Object.keys(F),...Object.keys(D)]);for(const W of q)if((F[W]??null)!==(D[W]??null))return!1;return!0})(w.gradesMap,C);let T=!1;if(B||(T=confirm("¬øGuardar esta simulaci√≥n antes de salir?")),T)try{await ra(w.gradesMap,e)}catch{}n.remove(),a.remove(),document.body.classList.remove("sim-lock")};n.addEventListener("click",r),a.addEventListener("keydown",w=>{w.key==="Escape"&&r()}),(I=a.querySelector("#gr-simClose"))==null||I.addEventListener("click",r),Zs(a);const s=a.querySelector("#gr-simForm"),l=new Map((t||[]).map(w=>[w.code,w.grade])),i=Vs(e),u=new Set((t||[]).map(w=>w.code)),d=[...new Set([...u,...i])],m={certamenes:[],controles:[],tareas:[],proyecto:[],evaluaciones:[],experiencias:[],preinformes:[],informes:[],laboratorios:[],otros:[]},f={certamenes:"Cert√°menes",controles:"Controles",tareas:"Tareas",proyecto:"Proyecto",evaluaciones:"Evaluaciones",experiencias:"Experiencias",preinformes:"Pre-informes",informes:"Informes",laboratorios:"Laboratorios",otros:"Otros"};function p(w,C){const A=(C||"").toString();return/certamen/i.test(A)?"certamenes":/control/i.test(A)?"controles":/tarea/i.test(A)?"tareas":/proy|proyecto/i.test(A)?"proyecto":/evaluaci[o√≥]n/i.test(A)?"evaluaciones":/experien/i.test(A)?"experiencias":/pre[\s-]?informe/i.test(A)?"preinformes":/\binforme/i.test(A)&&!/pre[\s-]?informe/i.test(A)?"informes":/laboratorio|\blab/i.test(A)?"laboratorios":"otros"}for(const w of d){const C=(t||[]).find(B=>B.code===w)||{name:w},A=l.get(w),$=p(w,C.name||w);m[$].push({code:w,name:C.name||w,value:A})}const g=[],v=k.scale==="MAYOR",y=v?1:0,h=v?7:100,x=v?.1:1;for(const[w,C]of Object.entries(m)){if(!C.length)continue;const A=f[w]||w;g.push(`
    <details open class="sim-group" data-key="${w}"
      style="margin-top:10px;border:1px solid rgba(255,255,255,.08);
             border-radius:8px;padding:6px 8px;background:rgba(0,0,0,0.15)">
      <summary style="cursor:pointer;font-weight:700;font-size:14px;
                      margin-bottom:6px">${A} (${C.length})</summary>
      <div class="sim-group-body">
        ${C.map($=>`
          <div class="row" style="align-items:center;gap:8px;margin:4px 0"
               data-sim-code="${K($.code)}">
            <div style="min-width:76px"><b>${K($.code)}</b></div>
            <div style="flex:1">${K($.name)}</div>
            <input type="number" step="${x}" min="${y}" max="${h}"
                   style="width:110px" placeholder="‚Äî"
                   value="${$.value??""}">
          </div>
        `).join("")}
      </div>
    </details>
  `)}s.innerHTML=g.join("");const E=[...e.matchAll(/finalCode\(["'](.+?)["']\)/g)];for(const w of E){const C=w[1],A=qt(C);isFinite(A)?g.push(`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.85" data-sim-ref="${K(C)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1">Nota final de ${K(C)}</div>
        <input type="number" readonly value="${A}" style="width:110px;opacity:.7;background:#222;border:none;color:#ccc">
      </div>
    `):g.push(`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.75" data-sim-ref="${K(C)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1;color:#aaa">Nota final de ${K(C)}</div>
        <div style="width:110px;text-align:center;color:#f87171">‚Äî</div>
      </div>
    `)}s.innerHTML=g.join("");const P=[...e.matchAll(/final\(["'](.+?)["']\)/g)];for(const w of P){const C=w[1],A=Ft(C);isFinite(A)&&s.insertAdjacentHTML("beforeend",`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.85" data-sim-ref="${K(C)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1">Nota final de ${K(C)}</div>
        <input type="number" readonly value="${A}" style="width:110px;opacity:.7;background:#222;border:none;color:#ccc">
      </div>
    `)}const _=()=>{const w={};s.querySelectorAll("[data-sim-code]").forEach(D=>{var _e,Me;const q=D.getAttribute("data-sim-code"),W=(Me=(_e=D.querySelector("input"))==null?void 0:_e.value)==null?void 0:Me.trim(),se=W?Number(String(W).replace(",",".")):null;w[q]=Number.isFinite(se)?se:0});let C=null,A=null;try{C=Re(e,{...w},{avg:Ye,min:Math.min,max:Math.max,final:D=>Ft(D),finalCode:D=>qt(D),finalId:D=>Cn(D)}),typeof C=="number"&&isFinite(C)?C=Ge(C,k.scale):C=null}catch(D){A=(D==null?void 0:D.message)||String(D||""),C=null}const $=Gt(k.rulesText||""),B=Sn($,w),T=k.scale==="MAYOR"?3.95:54.5;let R="";if(A)R="";else if(C==null)R="Ingresa valores para simular.";else{const D=[];if(C<T){const q=T-C;D.push(k.scale==="MAYOR"?`Subir la nota final en ${q.toFixed(2)} pts.`:`Subir la nota final en ${q.toFixed(1)} pts.`)}if(!B.allOk){const q=B.unmet.map(W=>W.text);q.length&&D.push(`Cumplir reglas pendientes: ${q.map(K).join("; ")}.`)}R=D.length?D.join(" "):"Nada m√°s. Ya apruebas."}const G=a.querySelector("#gr-simSummary");G.innerHTML=A?`<div style="color:#f87171">Error en f√≥rmula: ${K(A)}</div>`:`
    <div>Promedio simulado: <b>${C??"‚Äî"}</b></div>
    <div class="muted" style="margin-top:6px">(Usa tu f√≥rmula final actual)</div>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:10px 0">
    <div><b>Necesitas para aprobar</b></div>
    <div style="margin-top:4px">${R}</div>
  `;const F=a.querySelector("#gr-simRules");if(!$.length)F.textContent="No hay reglas definidas.";else{const D=B.items.filter(q=>q.ok).length;F.innerHTML=`
        <div style="margin-bottom:6px">Cumplidas: <b>${D}/${$.length}</b></div>
        <ul style="margin:0 0 0 18px;padding:0;list-style:disc;">
          ${B.items.map(q=>`<li style="color:${q.ok?"#22c55e":"#ef4444"}">${K(q.text)}</li>`).join("")}
        </ul>
      `}return{gradesMap:w,result:C}};s.addEventListener("input",_),_(),(U=a.querySelector("#gr-simSave"))==null||U.addEventListener("click",async()=>{const w=_();try{const C=await ra(w.gradesMap,e);alert((C==null?void 0:C.where)==="cloud"?"Simulaci√≥n guardada en la nube.":"Simulaci√≥n guardada")}catch(C){console.error(C),alert("No se pudo guardar la simulaci√≥n.")}}),sa().then(w=>{w&&(s.querySelectorAll("[data-sim-code]").forEach(C=>{const A=C.getAttribute("data-sim-code")||"",$=C.querySelector("input");if(!$)return;const B=w[A]??w[A.toUpperCase()]??w[A.toLowerCase()];B!=null&&($.value=String(B))}),_())}).catch(()=>{})}function Zs(e){const t=()=>Array.from(e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(r=>!r.hasAttribute("disabled")&&r.tabIndex!==-1),n=()=>t()[0],a=()=>t().slice(-1)[0];setTimeout(()=>{var r;return(r=n())==null?void 0:r.focus()},0),e.addEventListener("keydown",r=>{var i,u;if(r.key!=="Tab")return;const s=t();if(!s.length)return;const l=document.activeElement;r.shiftKey?l===s[0]&&(r.preventDefault(),(i=a())==null||i.focus()):l===s[s.length-1]&&(r.preventDefault(),(u=n())==null||u.focus())})}async function ra(e,t){const n={};Object.keys(e||{}).forEach(s=>{n[String(s).toUpperCase()]=e[s]});const a={formula:t,grades:n,rules:Gt(k.rulesText||""),semId:o.activeSemesterId||null,courseId:o.editingCourseId||null,createdAt:fa()};if(o.currentUser&&o.activeSemesterId&&o.editingCourseId)try{const s=["users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",o.editingCourseId,"simulations"];return await Ae(M(b,...s),a),await X(L(b,...s,"__last__"),a),{ok:!0,where:"cloud"}}catch(s){console.warn("Fallo Firestore, usando localStorage:",s)}const r=`sim:last:${o.activeSemesterId||"SEM"}:${o.editingCourseId||"COURSE"}`;return localStorage.setItem(r,JSON.stringify(a)),{ok:!0,where:"local"}}async function sa(){var t;const e=`sim:last:${o.activeSemesterId||"SEM"}:${o.editingCourseId||"COURSE"}`;if(o.currentUser&&o.activeSemesterId&&o.editingCourseId)try{const n=L(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses",o.editingCourseId,"simulations","__last__"),a=await J(n);if(a.exists()){const r=((t=a.data())==null?void 0:t.grades)||null;return r&&typeof r=="object"?r:null}}catch{}try{const n=localStorage.getItem(e);if(!n)return null;const a=JSON.parse(n),r=(a==null?void 0:a.grades)||null;return r&&typeof r=="object"?r:null}catch{return null}}function Qs(e){if(!e||!o.courses)return null;const t=a=>String(a||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),n=t(e);return o.courses.find(a=>t(a.name).includes(n)||t(a.code||"").includes(n))||null}async function _a(e){const t=M(e.ref,"rules"),n=await H(t);let a=0,r=0;for(const s of n.docs){const l=s.data(),i=Number(l.peso)||0,u=M(s.ref,"grades"),m=(await H(u)).docs.map(f=>Number(f.data().valor)).filter(f=>!isNaN(f));if(m.length>0){const f=m.reduce((p,g)=>p+g,0)/m.length;a+=f*(i/100),r+=i}}return r>0?+a.toFixed(2):null}async function Xs(e){if(!o.currentUser)return null;const t=M(b,"users",o.currentUser.uid,"semesters",e,"courses"),n=await H(t);let a=0,r=0;for(const s of n.docs){const l=await _a(s);l!=null&&(a+=l,r++)}return r>0?+(a/r).toFixed(2):null}function eo(e){var l;const n=(e.scale||"USM")==="MAYOR"?4:55;let a=0,r=0;for(const i of e.rules||[]){const u=Number(i.peso)||0;if(i.tipo.toLowerCase().includes("examen")){r=u;continue}if((l=i.notas)!=null&&l.length){const d=i.notas.reduce((m,f)=>m+f,0)/i.notas.length;a+=d*(u/100)}}return r===0?null:+((n-a)/(r/100)).toFixed(2)}function to(e){const n=(e.scale||"USM")==="MAYOR"?4:55;return e.promedio>=n}function no(e){const n=(e.scale||"USM")==="MAYOR"?4:55;return+Math.max(0,n-(e.promedio||0)).toFixed(2)}async function ao(e){if(!o.currentUser)return{best:null,worst:null};const t=M(b,"users",o.currentUser.uid,"semesters",e,"courses"),n=await H(t),a=[];for(const r of n.docs){const s=await _a(r);a.push({id:r.id,name:r.data().name,promedio:s})}return a.length?(a.sort((r,s)=>(s.promedio||0)-(r.promedio||0)),{best:a[0],worst:a[a.length-1]}):{best:null,worst:null}}document.addEventListener("route:change",e=>{var r;const t=((r=e.detail)==null?void 0:r.route)||"",n=document.getElementById("gr-courseSel");function a(){if(n)if(n.value="",n.querySelector('option[value=""]'))n.selectedIndex=0;else{const i=document.createElement("option");i.value="",i.textContent="Selecciona un ramo‚Ä¶",i.disabled=!0,i.selected=!0,n.insertBefore(i,n.firstChild),n.selectedIndex=0}window.currentCourseId=null,window.state&&(window.state.editingCourseId=null);const s=(i,u="‚Äî")=>{const d=document.getElementById(i);d&&(d.textContent=u)};s("gr-currentAvg"),s("gr-neededToPass"),s("gr-status");const l=document.getElementById("gr-evalsList");l&&(l.innerHTML='<div class="muted">Selecciona un ramo.</div>'),["gr-evalsCard","gr-calcCard","gr-summaryCard","gr-rulesCard"].forEach(i=>{var u;return(u=document.getElementById(i))==null?void 0:u.classList.add("hidden")})}t!=="#/notas"&&a(),t==="#/notas"&&setTimeout(a,120)});const oa=Object.freeze(Object.defineProperty({__proto__:null,bestWorst:ao,calcBrecha:no,calcNotaMinima:eo,calcPromedioSemestre:Xs,clearGradesUI:xs,enableDnDForGrades:Oa,findCourse:Qs,initGrades:As,isPassing:to,onActiveSemesterChanged:Ms,onCoursesChanged:It,registerGradesUnsub:Es,stopGradesSub:Ls},Symbol.toStringTag,{value:"Module"}));let Jt="USM";function En(){ro()}function ye(){oo()}function Ln(e){var s;Jt=e==="UMAYOR"?"MAYOR":"USM";const t=c("sectParLabel");t&&(t.textContent=e==="USM"?"Paralelo":"Secci√≥n/Paralelo");const n=c("courseScale"),a=(s=n==null?void 0:n.closest)==null?void 0:s.call(n,".form-field");a&&a.classList.add("hidden"),n&&(n.value=Jt,n.disabled=!0);const r=c("scaleHint");r&&(r.textContent=Jt==="MAYOR"?"Escala: UMayor (1‚Äì7) ¬∑ tomada desde tu Perfil":"Escala: USM (0‚Äì100) ¬∑ tomada desde tu Perfil")}let wt=null;function ro(){if(wt&&(wt(),wt=null),!o.currentUser||!o.activeSemesterId){o.courses=[],document.dispatchEvent(new Event("courses:changed"));return}const e=M(b,"users",o.currentUser.uid,"semesters",o.activeSemesterId,"courses");function t(n,a){let r;return(...s)=>{clearTimeout(r),r=setTimeout(()=>n(...s),a)}}wt=Y(e,t(n=>{const a=n.docs.map(r=>{const s=r.data()||{};return{id:r.id,...s,createdAtMs:s.createdAt instanceof lr?s.createdAt.toMillis():typeof s.createdAt=="number"?s.createdAt:0}});a.sort((r,s)=>s.createdAtMs-r.createdAtMs),o.courses=a,so(n),It==null||It(),document.dispatchEvent(new Event("courses:changed"))},300))}function so(e){const t=c("coursesList");t&&(t.innerHTML="",e.forEach(n=>{const a=n.data(),r=document.createElement("div");r.className="course-item",r.innerHTML=`
      <div>
        <div><b>${Kt(a.name||"Sin nombre")}</b> <span class="course-meta">¬∑ ${Kt(a.code||"")}</span></div>
        <div class="course-meta">${Kt(a.professor||"")}</div>
      </div>
      <div class="inline">
        <button class="ghost course-edit" data-id="${n.id}">Editar</button>
        <button class="danger course-del"  data-id="${n.id}">Eliminar</button>
      </div>
    `,t.appendChild(r)}))}function oo(){var i;o.editingCourseId=null;const e=c("courseName");e&&(e.value="");const t=c("courseCode");t&&(t.value="");const n=c("courseProfessor");n&&(n.value="");const a=c("courseSectPar");a&&(a.value="");const r=c("courseColor");r&&(r.value="#3B82F6");const s=c("courseColorCode");s&&(s.textContent="#3B82F6");const l=c("saveCourseBtn");l&&(l.textContent="Agregar ramo"),(i=c("cancelEditBtn"))==null||i.classList.add("hidden")}function Kt(e){return String(e).replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}let De=null,ia=!1;function io(){ia||(ia=!0,co())}function Zt(){De&&(De(),De=null);const e=c("semestersList");e&&(e.innerHTML=""),Ve()}function co(){const e=c("createSemesterBtn");e&&e.addEventListener("click",async()=>{var u;if(!o.currentUser){alert("Debes iniciar sesi√≥n.");return}const t=uo();if(!t){alert("Completa tu universidad en Perfil.");return}const n=(((u=c("semesterLabel"))==null?void 0:u.value)||"").trim();if(!lo(n)){alert("Formato de semestre inv√°lido. Usa AAAA-1 o AAAA-2 (ej. 2025-2).");return}const a=M(b,"users",o.currentUser.uid,"semesters");if(!(await H(te(a,ma("label","==",n)))).empty){alert("Ya existe un semestre con ese nombre.");return}let s=localStorage.getItem(`scale_${t}`);if(!s){const d=await new Promise(m=>{const f=document.getElementById("scaleModal"),p=document.getElementById("scaleSelect"),g=document.getElementById("scaleSave"),v=document.getElementById("scaleCancel");f.classList.add("active"),p.value="";const y=E=>{f.classList.remove("active"),g.removeEventListener("click",h),v.removeEventListener("click",x),m(E)},h=()=>{const E=p.value;if(!E)return alert("Selecciona una escala antes de continuar.");localStorage.setItem(`scale_${t}`,E),y(E)},x=()=>{y(null)};g.addEventListener("click",h),v.addEventListener("click",x)});if(!d){console.log("‚ùå Creaci√≥n de semestre cancelada por el usuario.");return}s=d}const l=await Ae(a,{label:n,universityAtThatTime:t,gradeScale:s||"0-100",createdAt:Date.now()});c("semesterLabel")&&(c("semesterLabel").value="");const i=o.activeSemesterId||null;if(i&&await Ha(i,l.id),await sn(l.id),await new Promise(d=>setTimeout(d,400)),o.activeSemesterId){console.log(`‚úÖ Semestre ${n} activado (${o.activeSemesterId}), preparando interfaz de ramos...`);const d=xn(t);Ln(d),ye(),En();const m=c("coursesSection");m&&m.classList.remove("hidden")}else console.warn("‚ö†Ô∏è No se estableci√≥ correctamente el semestre activo tras la creaci√≥n.");tt(),Fa()}),document.addEventListener("click",async t=>{const n=t.target;if(n instanceof HTMLElement){if(n.matches(".sem-activate")){if(!o.currentUser){alert("Debes iniciar sesi√≥n.");return}const a=n.dataset.id;await sn(a)}if(n.matches(".sem-delete")){if(!o.currentUser){alert("Debes iniciar sesi√≥n.");return}const a=n.dataset.id;if(!confirm("¬øEliminar este semestre?"))return;await oe(L(b,"users",o.currentUser.uid,"semesters",a)),o.activeSemesterId===a&&Ve()}}})}async function Ba(){var p,g,v,y,h,x;if(De&&(De(),De=null),!o.currentUser)return;const e=o.profileData||{},t=((p=e.university)==null?void 0:p.trim())||"",n=((g=e.career)==null?void 0:g.trim())||"",a=((v=e.customUniversity)==null?void 0:v.trim())||"",r=((y=e.customCareer)==null?void 0:y.trim())||"",s=t&&t!=="OTRA"||a&&a!=="",l=n&&n!=="OTRA"||r&&r!=="",i=c("semestersList");if(!s||!l){i&&(i.innerHTML=`
        <div class="card" style="padding:20px; text-align:center;">
          <h3>‚ö†Ô∏è Antes de agregar semestres necesitas configurar tu perfil</h3>
          <p>Completa tu <b>universidad</b> y <b>carrera</b> para poder crear y visualizar semestres.</p>
          <button id="goToProfileBtn" class="btn-primary" style="margin-top:10px;">
            Ir a Perfil ahora ‚Üí
          </button>
        </div>
      `,(h=c("goToProfileBtn"))==null||h.addEventListener("click",()=>{const E=c("subtabPerfil")||document.querySelector('[data-tab="perfil"]'),P=c("perfilContainer")||document.getElementById("perfilContainer");E&&P&&(document.querySelectorAll(".subtab").forEach(_=>_.classList.remove("active")),document.querySelectorAll(".page").forEach(_=>_.classList.add("hidden")),E.classList.add("active"),P.classList.remove("hidden"))}));return}const u=o.currentUser.uid,d=await J(L(b,"users",u)),m=d.exists()&&((x=d.data())==null?void 0:x.activeSemester)||null;if(m){o.activeSemesterId=m;const E=await J(L(b,"users",u,"semesters",m));o.activeSemesterData=E.exists()?E.data():null}if(o.activeSemesterId&&o.activeSemesterData){console.log("[Semesters] Restaurando semestre activo tras recarga:",o.activeSemesterData.label);const E=c("coursesSection");E&&E.classList.remove("hidden");const P=xn(o.activeSemesterData.universityAtThatTime);Ln(P),ye(),En(),tt(),Fa();const _=c("activeSemesterLabel");_&&(_.textContent=o.activeSemesterData.label||"‚Äî");const S=c("activeSemesterUni");S&&(S.textContent=o.activeSemesterData.universityAtThatTime||"‚Äî");const N=c("gr-activeSemLabel");N&&(N.textContent=o.activeSemesterData.label||"‚Äî");const I=c("gr-scaleSel"),U=c("gr-passThreshold");I&&(I.value=P==="UMAYOR"?"MAYOR":"USM",I.disabled=!0),U&&(U.value=P==="UMAYOR"?4:55),We(),Ne==null||Ne(),re(),document.dispatchEvent(new Event("semester:changed"))}const f=M(b,"users",u,"semesters");De=Y(te(f,Pe("createdAt","desc")),E=>{const P=c("semestersList");if(!P)return;if(P.innerHTML="",E.empty){Ve();return}if(E.forEach(S=>{const N=S.data(),I=document.createElement("div");I.className="course-item";const U=o.activeSemesterId===S.id;I.innerHTML=`
        <div>
          <div><b>${N.label}</b> <span class="course-meta">¬∑ ${N.universityAtThatTime}</span></div>
        </div>
        <div class="inline">
          ${U?'<span class="course-meta">Activo</span>':`<button class="ghost sem-activate" data-id="${S.id}">Activar</button>`}
          <button class="danger sem-delete" data-id="${S.id}">Eliminar</button>
        </div>
      `,P.appendChild(I)}),E.docs.some(S=>S.id===o.activeSemesterId)||Ve(),!o.activeSemesterId&&!E.empty){const S=E.docs[0].id;console.log("[Semesters] No hab√≠a activo guardado, usando el m√°s reciente:",S),sn(S)}})}async function Ha(e,t){var a;const n=(a=o.currentUser)==null?void 0:a.uid;if(!(!n||!e||!t))try{const r=M(b,"users",n,"semesters",e,"calendar"),s=M(b,"users",n,"semesters",t,"calendar"),l=await H(r);let i=0;for(const u of l.docs){const d=u.data();d.persistent&&(await Ae(s,{...d,createdAt:Date.now()}),i++)}console.log(`üîÅ [Semesters] ${i} eventos persistentes copiados de ${e} a ${t}`)}catch(r){console.error("‚ùå Error copiando eventos persistentes:",r)}}async function sn(e){var d,m,f,p;if(!o.currentUser||!e)return;o.activeSemesterId=e;const t=await J(L(b,"users",o.currentUser.uid,"semesters",e));o.activeSemesterData=t.exists()?t.data():null,await X(L(b,"users",o.currentUser.uid),{activeSemester:e},{merge:!0}),o.lastActiveSemesterId&&o.lastActiveSemesterId!==e&&await Ha(o.lastActiveSemesterId,e),o.lastActiveSemesterId=e;const n=c("activeSemesterLabel");n&&(n.textContent=((d=o.activeSemesterData)==null?void 0:d.label)||"‚Äî");const a=c("activeSemesterUni");a&&(a.textContent=((m=o.activeSemesterData)==null?void 0:m.universityAtThatTime)||"‚Äî");const r=c("gr-activeSemLabel");r&&(r.textContent=((f=o.activeSemesterData)==null?void 0:f.label)||"‚Äî");const s=xn((p=o.activeSemesterData)==null?void 0:p.universityAtThatTime),l=c("gr-scaleSel"),i=c("gr-passThreshold");l&&(l.value=s==="UMAYOR"?"MAYOR":"USM",l.disabled=!0),i&&(i.value=s==="UMAYOR"?4:55);const u=c("coursesSection");u&&u.classList.remove("hidden"),Ln(s),ye(),En(),We(),Ne==null||Ne(),re(),Ba(),document.dispatchEvent(new Event("semester:changed"))}function Ve(){o.activeSemesterId=null,o.activeSemesterData=null;const e=c("activeSemesterLabel");e&&(e.textContent="‚Äî");const t=c("activeSemesterUni");t&&(t.textContent="‚Äî");const n=c("coursesSection");n&&n.classList.add("hidden");const a=c("gr-activeSemLabel");a&&(a.textContent="‚Äî");const r=c("gr-scaleSel");r&&(r.value="USM",r.disabled=!0);const s=c("gr-passThreshold");s&&(s.value=""),We(),re()}function lo(e){return/^\d{4}-(1|2)$/.test(e||"")}function uo(){const e=o.profileData;return!e||!e.university?null:e.university==="OTRA"?(e.customUniversity||"").trim()||null:e.university==="UMAYOR"?"Universidad Mayor":e.university==="USM"?"UTFSM":e.university}function xn(e){if(!e)return"";const t=e.toLowerCase();return t.includes("mayor")?"UMAYOR":t.includes("utfsm")||t.includes("santa mar√≠a")||t.includes("santa maria")?"USM":"OTRA"}async function mo(){if(!o.currentUser)return;const e=o.currentUser.uid,t=M(b,"users",e,"semesters"),n=await H(t);if(o.semesters=n.docs.map(a=>({id:a.id,...a.data()})),o.activeSemesterId){const a=M(b,"users",e,"semesters",o.activeSemesterId,"courses"),r=await H(a);o.courses=r.docs.map(s=>({id:s.id,...s.data()}))}console.log("üìö preloadCourses:",o.semesters,o.courses)}function tt(){const e=c("saveCourseBtn");e&&e.dataset.bound!=="1"&&(e.dataset.bound="1",e.addEventListener("click",async()=>{var t,n,a,r,s,l;try{if(!o.currentUser)return alert("Debes iniciar sesi√≥n.");const i=o.activeSemesterId;if(!i)return alert("No hay semestre activo.");const u=(t=c("courseName"))==null?void 0:t.value.trim();if(!u)return alert("Ingresa el nombre del ramo.");const d={name:u,code:((n=c("courseCode"))==null?void 0:n.value.trim())||"",professor:((a=c("courseProfessor"))==null?void 0:a.value.trim())||"",section:((r=c("courseSectPar"))==null?void 0:r.value.trim())||"",color:((s=c("courseColor"))==null?void 0:s.value)||"#3B82F6",asistencia:!!((l=document.getElementById("courseAsistencia"))!=null&&l.checked),createdAt:Date.now()};await Ae(M(b,"users",o.currentUser.uid,"semesters",i,"courses"),d),ye==null||ye(),console.log("[Courses] ‚úÖ Ramo agregado en",i,d)}catch(i){console.error("‚ùå Error agregando ramo:",i),alert("No se pudo agregar el ramo. Revisa la consola.")}}))}function Fa(){const e=document.getElementById("coursesList");e&&e.dataset.bound!=="1"&&(e.dataset.bound="1",e.addEventListener("click",async t=>{const n=t.target;if(!(n instanceof HTMLElement))return;const a=o.activeSemesterId;if(!(!o.currentUser||!a)){if(n.matches(".course-del")){const r=n.dataset.id;if(!r||!confirm("¬øSeguro que quieres eliminar este ramo?"))return;try{await oe(L(b,"users",o.currentUser.uid,"semesters",a,"courses",r)),console.log(`[Courses] Ramo eliminado: ${r}`)}catch(s){console.error("‚ùå Error eliminando ramo:",s),alert("No se pudo eliminar el ramo.")}}if(n.matches(".course-edit")){const r=n.dataset.id;if(!r)return;try{const s=L(b,"users",o.currentUser.uid,"semesters",a,"courses",r),l=await J(s);if(l.exists()){const i=l.data();c("courseName").value=i.name||"",c("courseCode").value=i.code||"",c("courseProfessor").value=i.professor||"",c("courseSectPar").value=i.section||"",c("courseColor").value=i.color||"#3B82F6",c("courseColorCode").textContent=(i.color||"#3B82F6").toUpperCase(),c("courseAsistencia").checked=!!i.asistencia;const u=c("saveCourseBtn"),d=c("cancelEditBtn");d.classList.remove("hidden"),u.textContent="Guardar cambios";const m=c("saveCourseBtn").cloneNode(!1);m.textContent="Guardar cambios",u.replaceWith(m);const f=async()=>{try{const p={name:c("courseName").value.trim(),code:c("courseCode").value.trim(),professor:c("courseProfessor").value.trim(),section:c("courseSectPar").value.trim(),color:c("courseColor").value,asistencia:!!c("courseAsistencia").checked};await z(s,p),console.log(`[Courses] ‚úÖ Ramo actualizado: ${r}`),ye(),d.classList.add("hidden"),m.textContent="Agregar ramo",tt()}catch(p){console.error("‚ùå Error actualizando ramo:",p),alert("No se pudo guardar el ramo editado.")}};m.addEventListener("click",f),d.onclick=()=>{ye(),d.classList.add("hidden"),m.textContent="Agregar ramo",tt()},d.onclick=()=>{ye(),d.classList.add("hidden"),newSaveBtn.textContent="Agregar ramo",tt()}}}catch(s){console.error("‚ùå Error al editar ramo:",s),alert("No se pudo cargar el ramo para editar.")}}}}))}let we=null;function fo(){we&&(we(),we=null),o.unsubscribeProfile=null}function po(e){if(!e)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=/^(\d{2})-(\d{2})$/.exec(e);if(t){const n=t[1];return`2000-${t[2]}-${n}`}return""}async function ca(e){const t=await new Promise((a,r)=>{const s=new FileReader;s.onload=()=>a(s.result),s.onerror=r,s.readAsDataURL(e)});return await new Promise((a,r)=>{const s=new Image;s.onload=()=>a(s),s.onerror=r,s.src=t})}function la(e,t=256,n=.82){const a=document.createElement("canvas"),r=Math.min(e.width,e.height),s=(e.width-r)/2,l=(e.height-r)/2;return a.width=t,a.height=t,a.getContext("2d").drawImage(e,s,l,r,r,0,0,t,t),a.toDataURL("image/jpeg",n)}function Qe(e){const t=document.getElementById("pfAvatarCircle");t&&(e&&!e.startsWith("emoji:")?(t.textContent="",t.style.backgroundImage=`url("${e}")`):(t.style.backgroundImage="none",t.textContent="üë®‚Äçüéì"))}function vo(e,t){if(e&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const n=/^(\d{2})-(\d{2})$/.exec(t||"");if(n){const a=n[1];return`2000-${n[2]}-${a}`}return null}let Ct=null;const An={UMAYOR:[{value:"MEDVET",label:"Medicina Veterinaria"}],USM:[{value:"ICTEL",label:"Ing. Civil Telem√°tica"}]};function qa(){var u;we&&(we(),we=null);const e=(u=o.currentUser)==null?void 0:u.uid;if(!e)return;const t=L(b,"users",e),n=L(b,"users",e,"profile","profile"),a=(d,m)=>{const f=(d==null?void 0:d.data())||{},p=(m==null?void 0:m.data())||{};o.profileData={...f,...p,name:(p==null?void 0:p.name)||(f==null?void 0:f.name)||(f==null?void 0:f.fullName)||(p==null?void 0:p.fullName)||""},delete o.profileData.fullName,f!=null&&f.name&&!o.profileData.name&&(o.profileData.name=f.name),f!=null&&f.fullName&&!o.profileData.name&&(o.profileData.name=f.fullName),p!=null&&p.name&&(o.profileData.name=p.name),p!=null&&p.fullName&&(o.profileData.name=p.fullName),Mn(o.profileData),jt(),re(),document.dispatchEvent(new Event("profile:changed"))};let r=null,s=null;const l=Y(t,d=>{r=d,a(r,s)}),i=Y(n,d=>{s=d,a(r,s)});we=()=>{l(),i()},o.unsubscribeProfile=we}function ja(){var l;const e=(i,u="")=>{const d=c(i);d&&(d.value=u)};e("pfName"),e("pfGoogleEmail"),e("pfBirthday"),e("pfFavoriteColor","#22c55e");const t=c("pfColorPreview");t&&(t.style.background="#22c55e");const n=c("pfColorCode");n&&(n.textContent="#22C55E");const a=c("pfUniversity")||c("uniSel");a&&(a.value="");const r=c("pfCareer")||c("careerSel");r&&(r.value="",r.disabled=!0),e("pfEmailUni"),e("pfPhone"),Qe(null);const s=c("pfBirthday");s&&((l=s.dataset)==null||delete l.dirty)}function Mn(e){var U;const t=c("pfName"),n=c("pfBirthday"),a=c("pfUniversity")||c("uniSel"),r=c("pfCustomUniWrap"),s=c("pfCustomUniversity"),l=c("pfCareer")||c("careerSel"),i=c("pfFavoriteColor"),u=c("pfColorPreview"),d=c("pfColorCode"),m=c("pfEmailUni")||c("pfEmail"),f=c("pfPhone")||c("pfTelefono"),p=c("pfGoogleEmail"),g=c("pfCancelBtn"),v=(w,C)=>{if(!l)return;l.innerHTML='<option value="">Selecciona tu carrera‚Ä¶</option>';const A=An[w]||[];for(const{value:$,label:B}of A){const T=document.createElement("option");T.value=$,T.textContent=B,l.appendChild(T)}l.disabled=A.length===0,C&&A.some($=>$.value===C)?l.value=C:l.value=""};if(g&&!g.dataset.bound&&(g.onclick=()=>Mn(o.profileData||null),g.dataset.bound="1"),p&&((U=o.currentUser)!=null&&U.email)&&(p.value=o.currentUser.email),m&&(m.value=(e==null?void 0:e.uniEmail)||""),f&&(f.value=(e==null?void 0:e.phone)||""),t&&(t.value=(e==null?void 0:e.fullName)||(e==null?void 0:e.name)||""),n){const w=po((e==null?void 0:e.birthday)||""),C=document.activeElement===n,A=n.dataset.dirty==="1";!C&&!A&&(n.value=w||"",w?n.setAttribute("value",w):n.removeAttribute("value")),n.dataset.bound||(n.addEventListener("change",$=>{const B=$.target.value||"";n.dataset.dirty="1",n.value=B,B?n.setAttribute("value",B):n.removeAttribute("value"),o.profileData={...o.profileData||{},birthday:B}}),n.addEventListener("paste",$=>$.preventDefault()),n.addEventListener("drop",$=>$.preventDefault()),n.dataset.bound="1")}if(a){const w=(e==null?void 0:e.university)||"";w==="Universidad Mayor"?a.value="UMAYOR":w==="UTFSM"||w==="USM"?a.value="USM":a.value=w}if(a&&(e!=null&&e.customUniversity)){if(!Array.from(a.options).some(C=>C.value===e.customUniversity)){const C=document.createElement("option");C.value=e.customUniversity,C.textContent=e.customUniversity,a.appendChild(C)}a.value=e.customUniversity}r&&r.classList.add("hidden"),s&&(s.value="");const y=(a==null?void 0:a.value)==="OTRA";r&&r.classList.toggle("hidden",!y),y&&s&&(s.value=(e==null?void 0:e.customUniversity)||"");const h=c("pfCustomCareerWrap"),x=c("pfCustomCareer");h&&h.classList.add("hidden"),x&&(x.value="");const E=(l==null?void 0:l.value)==="OTRA";h&&h.classList.toggle("hidden",!E),E&&x&&(x.value=(e==null?void 0:e.customCareer)||""),l&&!l.dataset.bound&&(l.addEventListener("change",()=>{const w=l.value==="OTRA";h&&h.classList.toggle("hidden",!w),!w&&x&&(x.value="")}),l.dataset.bound="1");const P=on(e==null?void 0:e.favoriteColor)?e.favoriteColor:"#22c55e";if(i&&(i.value=P),u&&(u.style.background=P),d&&(d.textContent=P.toUpperCase()),v(a==null?void 0:a.value,(e==null?void 0:e.career)||""),a&&(a.onchange=()=>{const w=a.value==="OTRA";r&&r.classList.toggle("hidden",!w),!w&&s&&(s.value=""),v(a.value,null)}),l&&(e!=null&&e.customCareer)){if(!Array.from(l.options).some(C=>C.value===e.customCareer)){const C=document.createElement("option");C.value=e.customCareer,C.textContent=e.customCareer,l.appendChild(C)}l.value=e.customCareer}i&&!i.dataset.bound&&(i.addEventListener("input",w=>{const C=w.target.value;on(C)&&(u&&(u.style.background=C),d&&(d.textContent=C.toUpperCase()))}),i.dataset.bound="1");const _=c("pfAvatarBtn"),S=c("pfAvatarFile");Qe((e==null?void 0:e.avatarData)||"emoji:üë®‚Äçüéì");let N=document.getElementById("pfDeleteAvatarBtn");N||(N=document.createElement("button"),N.id="pfDeleteAvatarBtn",N.className="btn btn-secondary",N.textContent="Eliminar foto de perfil",_.insertAdjacentElement("afterend",N)),S&&!S.dataset.bound&&(S.addEventListener("change",async w=>{var A;const C=(A=w.target.files)==null?void 0:A[0];if(C){if(!/^image\//.test(C.type)){alert("Elige una imagen v√°lida.");return}try{const $=await ca(C),B=la($,256,.82);if(Qe(B),!o.currentUser)return;await z(L(b,"users",o.currentUser.uid),{avatarData:B,avatarUpdatedAt:Date.now()}),_.textContent="Avatar actualizado ‚úì",setTimeout(()=>_.textContent="Cambiar avatar",1500)}catch($){console.error($),alert("No se pudo procesar la imagen.")}finally{w.target.value=""}}}),S.dataset.bound="1"),N.dataset.bound||(N.addEventListener("click",async()=>{if(o.currentUser&&confirm("¬øSeguro que deseas eliminar tu foto de perfil?"))try{await z(L(b,"users",o.currentUser.uid),{avatarData:null,avatarUrl:null,avatarUpdatedAt:Date.now()}),Qe("emoji:üë®‚Äçüéì"),alert("Avatar eliminado. Se restaur√≥ el emoji predeterminado üë®‚Äçüéì.")}catch(w){console.error(w),alert("No se pudo eliminar el avatar.")}}),N.dataset.bound="1"),S&&!S.dataset.bound&&(S.addEventListener("change",async w=>{var A;const C=(A=w.target.files)==null?void 0:A[0];if(C){if(!/^image\//.test(C.type)){alert("Elige una imagen.");return}try{const $=await ca(C),B=la($,256,.82);if(Qe(B),!o.currentUser)return;await z(L(b,"users",o.currentUser.uid),{avatarData:B,avatarUpdatedAt:Date.now()}),_&&(_.textContent="Avatar actualizado ‚úì",setTimeout(()=>_.textContent="Cambiar avatar",1500))}catch($){console.error($),alert("No se pudo procesar la imagen.")}finally{w.target.value=""}}}),S.dataset.bound="1");const I=c("pfSaveBtn");I&&!I.dataset.bound&&(I.onclick=()=>Ya(),I.dataset.bound="1")}async function Ya(){var E,P,_,S,N,I,U;if(!o.currentUser)return;const e=c("pfUniversity")||c("uniSel"),t=c("pfCareer")||c("careerSel"),n=((E=c("pfFavoriteColor"))==null?void 0:E.value)||null,a=(((P=c("pfEmailUni")||c("pfEmail"))==null?void 0:P.value)||"").trim(),r=(((_=c("pfPhone")||c("pfTelefono"))==null?void 0:_.value)||"").trim(),s=o.currentUser.uid,l=(e==null?void 0:e.value)||null;if(!(!a||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))){alert("Email universitario no es v√°lido.");return}if(!(!r||/^[+()\s0-9-]{6,}$/.test(r))){alert("Tel√©fono no es v√°lido.");return}const d=t&&((S=An[l])!=null&&S.some(w=>w.value===t.value))?t.value:null,m=((N=c("pfBirthday"))==null?void 0:N.value)||null,f=((I=o.profileData)==null?void 0:I.birthday)||null,p=vo(m,f),v={name:((U=c("pfName"))==null?void 0:U.value.trim())||null,birthday:p??null,university:l,customUniversity:l==="OTRA"&&c("pfCustomUniversity")?c("pfCustomUniversity").value.trim()||null:l&&!["UMAYOR","USM","OTRA"].includes(l)?l:null,career:d||((t==null?void 0:t.value)==="OTRA"?"OTRA":(t==null?void 0:t.value)||null),customCareer:(t==null?void 0:t.value)==="OTRA"&&c("pfCustomCareer")?c("pfCustomCareer").value.trim()||null:t!=null&&t.value&&!["MEDVET","ICTEL","OTRA"].includes(t.value)?t.value:null,favoriteColor:on(n)?n:null,uniEmail:a||null,phone:r||null,updatedAt:Date.now()},y=L(b,"users",s,"profile","profile");await X(y,v,{merge:!0}),o.profileData={...o.profileData||{},...v};const h=document.getElementById("pfSaveBtn");if(h){const w=h.textContent;h.textContent="Guardado ‚úì",h.disabled=!0,setTimeout(()=>{h.textContent=w,h.disabled=!1},1800)}const x=document.getElementById("pfBirthday");x&&delete x.dataset.dirty}function jt(){var t,n;const e=!!(o.profileData&&o.profileData.university&&(o.profileData.university!=="OTRA"||o.profileData.university==="OTRA"&&((t=o.profileData.customUniversity)!=null&&t.trim())));(n=c("semNoticeNoUni"))==null||n.classList.toggle("hidden",e),c("createSemesterBtn")&&(c("createSemesterBtn").disabled=!e||!o.currentUser),c("semesterLabel")&&(c("semesterLabel").disabled=!e),c("semesterUniFromProfile")&&(c("semesterUniFromProfile").value=e?ho(o.profileData):""),c("createPairBtn")&&(c("createPairBtn").disabled=!o.currentUser)}function ho(e){return!e||!e.university?"":e.university==="OTRA"?e.customUniversity||"Otra":e.university==="UMAYOR"?"Universidad Mayor":e.university==="USM"?"UTFSM":e.university}function go(e){return!e||!e.career?"":e.career==="OTRA"?e.customCareer||"Otra":e.career==="ICTEL"?"Ing. Civil Telem√°tica":e.career==="MEDVET"?"Medicina Veterinaria":e.career}function on(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function za(){const e=c("page-perfil");if(!e)return;let t=c("partnerProfileCard");t||(t=document.createElement("div"),t.className="card",t.id="partnerProfileCard",t.innerHTML=`
      <h3 style="margin-top:0">Perfil de la otra persona</h3>
      <div id="pp-avatar" style="width:64px;height:64px;border-radius:50%;
        background:#444;background-size:cover;background-position:center;margin-bottom:8px;"></div>
      <div id="pp-name"><b>Nombre:</b> ‚Äî</div>
      <div id="pp-uni"><b>Universidad:</b> ‚Äî</div>
      <div id="pp-career"><b>Carrera:</b> ‚Äî</div>
      <div id="pp-bday" class="muted"><b>Nacimiento:</b> ‚Äî</div>
      <div id="pp-color"><b>Color favorito:</b>
        <span id="pp-color-swatch"
          style="display:inline-block;width:16px;height:16px;border-radius:4px;vertical-align:middle;margin:0 6px;background:#ff69b4;border:1px solid rgba(255,255,255,.25)">
        </span>
        <span id="pp-color-code">‚Äî</span>
      </div>
      <div id="pp-email"><b>Email universitario:</b> ‚Äî</div>
      <div id="pp-phone"><b>Tel√©fono:</b> ‚Äî</div>
    `,t.classList.add("hidden"),e.appendChild(t));const n=()=>{c("pp-name").innerHTML="<b>Nombre:</b> ‚Äî",c("pp-uni").innerHTML="<b>Universidad:</b> ‚Äî",c("pp-career").innerHTML="<b>Carrera:</b> ‚Äî",c("pp-bday").innerHTML="<b>Fecha de nacimiento:</b> ‚Äî",c("pp-email").innerHTML="<b>Email universitario:</b> ‚Äî",c("pp-phone").innerHTML="<b>Tel√©fono:</b> ‚Äî",c("pp-color-code").textContent="‚Äî";const p=c("pp-color-swatch");p&&(p.style.background="transparent",p.style.border="1px solid rgba(255,255,255,.25)")};if(Ct&&(Ct(),Ct=null),!o.pairOtherUid){n(),t&&t.classList.add("hidden");return}const a=L(b,"users",o.pairOtherUid),r=L(b,"users",o.pairOtherUid,"profile","profile");t.classList.remove("hidden");let s=null,l=null;const i=()=>{const p={...(s==null?void 0:s.data())||{},...(l==null?void 0:l.data())||{}},g=c("pp-avatar");g&&(p.avatarData?(g.style.backgroundImage=`url("${p.avatarData}")`,g.textContent=""):(g.style.backgroundImage="none",g.textContent="üë®‚Äçüéì",g.style.display="flex",g.style.alignItems="center",g.style.justifyContent="center",g.style.fontSize="2rem")),c("pp-name").innerHTML=`<b>Nombre:</b> ${p.name||"‚Äî"}`,c("pp-uni").innerHTML=`<b>Universidad:</b> ${d(p)}`,c("pp-career").innerHTML=`<b>Carrera:</b> ${go(p)||"‚Äî"}`,c("pp-bday").innerHTML=`<b>Fecha de nacimiento:</b> ${u(p.birthday)}`,c("pp-email").innerHTML=`<b>Email universitario:</b> ${p.uniEmail||"‚Äî"}`,c("pp-phone").innerHTML=`<b>Tel√©fono:</b> ${p.phone||"‚Äî"}`;const v=typeof p.favoriteColor=="string"&&/^#[0-9A-Fa-f]{6}$/.test(p.favoriteColor)?p.favoriteColor:"#ff69b4",y=c("pp-color-swatch");y&&(y.style.background=v);const h=c("pp-color-code");h&&(h.textContent=v.toUpperCase())},u=p=>{if(!p)return"‚Äî";const g=/^(\d{4})-(\d{2})-(\d{2})$/.exec(p);return g?`${g[3]}/${g[2]}/${g[1]}`:p},d=p=>p!=null&&p.university?p.university==="UMAYOR"?"Universidad Mayor":p.university==="USM"?"UTFSM":p.university==="OTRA"?p.customUniversity||"Otra":p.university:"‚Äî",m=Y(a,p=>{s=p,i()}),f=Y(r,p=>{l=p,i()});Ct=()=>{m(),f()}}document.addEventListener("pair:ready",()=>{za()});function yo(){const e=document.getElementById("pfUniversity")||document.getElementById("uniSel"),t=document.getElementById("pfCareer")||document.getElementById("careerSel");if(!e||!t)return;const n=()=>{const a=An[e.value]||[];t.innerHTML='<option value="">Selecciona tu carrera‚Ä¶</option>';for(const{value:r,label:s}of a){const l=document.createElement("option");l.value=r,l.textContent=s,t.appendChild(l)}t.disabled=a.length===0};e.addEventListener("change",n),n()}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("uniSel"),t=document.getElementById("careerSel");function n(h,x,E){if(document.getElementById(h))return document.getElementById(h);const P=document.createElement("div");return P.id=h,P.className="modal",P.innerHTML=`
      <div class="modal-content" style="max-width:400px;text-align:center;">
        <h3>${x}</h3>
        <input id="${h}Input" type="text" placeholder="${E}" 
          style="width:100%;margin-top:1rem;padding:.8rem;border-radius:8px;
          border:none;background:rgba(255,255,255,0.1);color:white;">
        <div style="margin-top:1rem;display:flex;justify-content:center;gap:1rem;">
          <button id="${h}Save" class="btn">Guardar</button>
          <button id="${h}Cancel" class="btn btn-secondary">Cancelar</button>
        </div>
      </div>`,document.body.appendChild(P),P}const a=n("uniModal","Agregar nueva universidad","Escribe el nombre..."),r=n("careerModal","Agregar nueva carrera","Escribe el nombre...");function s(h){h.classList.add("active");const x=h.querySelector("input");x.value="",x.focus()}function l(h){h.classList.remove("active")}e&&e.addEventListener("change",()=>{e.value==="OTRA"?s(a):t&&(t.disabled=!1,y())});const i=a.querySelector("#uniModalSave"),u=a.querySelector("#uniModalCancel"),d=a.querySelector("#uniModalInput");i.addEventListener("click",m),u.addEventListener("click",()=>l(a)),a.addEventListener("click",h=>{h.target===a&&l(a)}),d.addEventListener("keydown",h=>{h.key==="Enter"&&(h.preventDefault(),m())});function m(){const h=d.value.trim();if(!h)return;if(!Array.from(e.options).find(E=>E.value===h)){const E=document.createElement("option");E.value=h,E.textContent=h,e.appendChild(E)}e.value=h,t&&(t.disabled=!1,y()),l(a)}t&&t.addEventListener("change",()=>{t.value==="OTRA"&&s(r)});const f=r.querySelector("#careerModalSave"),p=r.querySelector("#careerModalCancel"),g=r.querySelector("#careerModalInput");f.addEventListener("click",v),p.addEventListener("click",()=>l(r)),r.addEventListener("click",h=>{h.target===r&&l(r)}),g.addEventListener("keydown",h=>{h.key==="Enter"&&(h.preventDefault(),v())});function v(){const h=g.value.trim();if(!h)return;if(!Array.from(t.options).find(E=>E.value===h)){const E=document.createElement("option");E.value=h,E.textContent=h,t.appendChild(E)}t.value=h,l(r)}function y(){if(!t)return;if(!Array.from(t.options).some(x=>x.value==="OTRA")){const x=document.createElement("option");x.value="OTRA",x.textContent="Otra",t.appendChild(x)}}y()});const bo=Object.freeze(Object.defineProperty({__proto__:null,clearProfileUI:ja,ensureCareerBindingOnLoad:yo,fillProfileForm:Mn,listenProfile:qa,mountPartnerProfileCard:za,reflectProfileInSemestersUI:jt,saveProfile:Ya,stopProfileListener:fo},Symbol.toStringTag,{value:"Module"}));let ke=null;new URLSearchParams(location.search).has("debug")||(window==null||window.PartyPlannerDebug);function Vt(){const e={otherUid:o.pairOtherUid||null};try{document.dispatchEvent(new CustomEvent("pair:ready",{detail:e})),document.dispatchEvent(new CustomEvent("pair:changed",{detail:e}))}catch{}}function So(){const e=c("createPairBtn"),t=c("copyInviteBtn"),n=c("joinByCodeBtn"),a=c("joinCode"),r=c("deletePairBtn");e==null||e.addEventListener("click",Co),t==null||t.addEventListener("click",Eo);const s=async()=>{const l=((a==null?void 0:a.value)||"").trim(),i=Ao(l);i?await Mo(i):alert("Pega un ID v√°lido (o un link con ?pair=ID)."),a&&(a.value="")};n==null||n.addEventListener("click",s),a==null||a.addEventListener("keydown",l=>{l.key==="Enter"&&s()}),r==null||r.addEventListener("click",Io)}async function wo(){if(!o.currentUser)return;const e=te(M(b,"pairs")),t=await H(e),n=[];t.forEach(l=>{const i=l.data()||{};Array.isArray(i.members)&&i.members.includes(o.currentUser.uid)&&n.push({id:l.id,...i})}),n.sort((l,i)=>(Number(i.createdAt)||0)-(Number(l.createdAt)||0));const a=n[0]||null;o.currentPairId=(a==null?void 0:a.id)||null,o.pairOtherUid=a&&(a.members||[]).find(l=>l!==o.currentUser.uid)||null;const r=c("pairId"),s=c("copyInviteBtn");r&&(r.textContent=o.currentPairId||"‚Äî"),s&&(s.disabled=!o.currentPairId),dt(),re(),Vt(),In(o.currentPairId)}async function Co(){if(!o.currentUser)return;const e=L(M(b,"pairs"));await X(e,{members:[o.currentUser.uid],createdAt:Date.now(),visibility:{showCourseNames:!0,showOnlyBusyFree:!1}}),await Ga(e.id),o.currentPairId=e.id,o.pairOtherUid=null;const t=c("pairId"),n=c("copyInviteBtn");t&&(t.textContent=e.id),n&&(n.disabled=!1),dt(),re(),Vt(),In(e.id)}async function Eo(){if(!o.currentPairId)return;const e=o.currentPairId,t=c("copyInviteBtn");if(await Lo(e)||xo(e),t){const a=t.textContent;t.textContent="¬°ID copiado!",setTimeout(()=>{t.textContent=a||"Copiar ID"},1800)}}async function Lo(e){try{return await navigator.clipboard.writeText(e),!0}catch{return!1}}function xo(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch{}document.body.removeChild(t)}function Ao(e){if(!e)return"";const t=String(e).trim();try{const s=new URL(t).searchParams.get("pair");if(s)return s.trim()}catch{}const n=t.match(/[?&]pair=([A-Za-z0-9_-]+)/);return n?n[1]:t.replace(/[^A-Za-z0-9_-]/g,"")||""}async function Mo(e){if(!o.currentUser)return;const t=L(b,"pairs",e),n=await J(t);if(!n.exists()){alert("El ID de party no existe");return}const a=n.data()||{},r=Array.isArray(a.members)?a.members:[];if(!r.includes(o.currentUser.uid)&&r.length>=2){alert("Esta party ya tiene 2 miembros.");return}r.includes(o.currentUser.uid)||await z(t,{members:ur(o.currentUser.uid),updatedAt:Date.now()}),await Ga(e);const l=(await J(t)).data()||{};o.currentPairId=e,o.pairOtherUid=(l.members||[]).find(f=>f!==o.currentUser.uid)||null;const i=L(b,"users",o.currentUser.uid),u={pairUid:o.pairOtherUid||null,currentPairId:e};try{await z(i,u)}catch{await X(i,u,{merge:!0})}const d=c("pairId"),m=c("copyInviteBtn");d&&(d.textContent=e),m&&(m.disabled=!1),dt(),re(),Vt(),In(e)}function In(e){var a;if(ke&&(ke(),ke=null),!e)return;const t=L(b,"pairs",e),n=((a=o.currentUser)==null?void 0:a.uid)||null;ke=Y(t,async r=>{if(!r.exists()){Va();return}const s=r.data()||{},i=(Array.isArray(s.members)?s.members:[]).find(m=>m!==n)||null;o.currentPairId=e,o.pairOtherUid=i;try{const m=L(b,"users",n);await X(m,{pairUid:i||null,currentPairId:e},{merge:!0})}catch{}const u=c("pairId"),d=c("copyInviteBtn");u&&(u.textContent=e),d&&(d.disabled=!1),dt(),re(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:o.pairOtherUid}}))})}async function Io(){if(!o.currentUser||!o.currentPairId)return;const e=o.currentPairId,t=L(b,"pairs",e);if(confirm("¬øQuieres eliminar la party para ambos? La otra persona tambi√©n se saldr√°.")){try{await oe(t)}catch{try{await z(t,{members:[]}),await oe(t)}catch{}}Va(),alert("Party eliminada para ambos.")}}async function Ga(e){const t=te(M(b,"pairs")),n=await H(t),a=o.currentUser.uid,r=[];n.forEach(s=>{const l=s.data()||{};s.id!==e&&Array.isArray(l.members)&&l.members.includes(a)&&r.push(z(L(b,"pairs",s.id),{members:dr(a)}).then(async()=>{const i=await J(L(b,"pairs",s.id));if((i.exists()?i.data().members||[]:[]).length===0)try{await oe(L(b,"pairs",s.id))}catch{}}))}),await Promise.all(r)}function Va(){ke&&(ke(),ke=null),o.currentPairId=null,o.pairOtherUid=null;const e=c("pairId"),t=c("copyInviteBtn");e&&(e.textContent="‚Äî"),t&&(t.disabled=!0),dt(),re(),Vt()}function dt(){const e=!!(o.currentPairId&&o.pairOtherUid),t=c("subtabCompartido"),n=c("horarioCompartido");t==null||t.setAttribute("aria-disabled",e?"false":"true"),t&&(t.disabled=!e),n&&(e?n.classList.remove("disabled"):(n.classList.add("disabled"),n.innerHTML='<div class="muted">Horario de la otra persona (debes emparejarte primero).</div>'))}function da(e){document.querySelectorAll(".nav-tab[data-route]").forEach(t=>{t.dataset.route!=="#/perfil"&&(t.toggleAttribute("disabled",e),t.setAttribute("aria-disabled",String(e)))})}function Uo(){if(window.__PartyPlannerAuthInit)return;window.__PartyPlannerAuthInit=!0;const e=c("signInBtn"),t=c("signOutBtn"),n=c("switchAccountBtn"),a=c("userBadge"),r=c("userName"),s=u=>{e&&(e.disabled=u),t&&(t.disabled=u),n&&(n.disabled=u)},l=u=>{a&&(a.classList.remove("hidden"),a.style.display="inline-flex"),e&&(e.classList.add("hidden"),e.style.display="none"),r&&(r.textContent=u||"‚Äî");const d=c("createPairBtn"),m=c("copyInviteBtn");d&&(d.disabled=!1),m&&(m.disabled=!1),da(!1)},i=()=>{a&&(a.classList.add("hidden"),a.style.display="none"),e&&(e.classList.remove("hidden"),e.style.display="inline-block");const u=c("pairId"),d=c("copyInviteBtn"),m=c("createPairBtn");u&&(u.textContent="‚Äî"),d&&(d.disabled=!0),m&&(m.disabled=!0),o.profileData=null,jt(),Ve();const f=c("semestersList");f&&(f.innerHTML=""),da(!0),location.hash="#/perfil"};e&&e.addEventListener("click",async()=>{s(!0);const u=new $n;u.setCustomParameters({prompt:"select_account"});try{await Dn(Fe,u)}catch(d){const m=(d==null?void 0:d.code)||"";m==="auth/popup-blocked"||(m==="auth/popup-closed-by-user"||m==="auth/cancelled-popup-request"||m==="auth/user-cancelled"?console.log("Login cancelado por el usuario."):alert(`No se pudo iniciar sesi√≥n: ${m||d.message||d}`))}finally{s(!1)}}),n&&n.addEventListener("click",async()=>{s(!0);const u=new $n;u.setCustomParameters({prompt:"select_account"});try{await kn(Fe),await Dn(Fe,u)}catch(d){const m=(d==null?void 0:d.code)||"";m==="auth/popup-blocked"||(m==="auth/popup-closed-by-user"||m==="auth/cancelled-popup-request"||m==="auth/user-cancelled"?console.log("Cambio de cuenta cancelado por el usuario."):alert(`No se pudo cambiar de cuenta: ${m||d.message||d}`))}finally{s(!1)}}),t&&t.addEventListener("click",async()=>{var u;s(!0);try{await kn(Fe),o.currentUser=null,o.profileData=null,(u=o.unsubscribeProfile)==null||u.call(o),o.unsubscribeProfile=null,Zt==null||Zt(),Ve(),ja(),i(),re()}catch(d){console.error(d),alert(`No se pudo cerrar sesi√≥n: ${d.code||d.message||d}`)}finally{s(!1)}}),or(Fe,async u=>{if(o.currentUser=u||null,s(!1),u){l(u.displayName||u.email||u.uid);try{await To(u)}catch(d){console.error("ensureUserDoc failed:",d)}try{await mo(),console.log("‚úÖ Semestres y cursos precargados")}catch(d){console.warn("‚ö†Ô∏è Error precargando cursos:",d)}try{qa(),jt()}catch(d){console.error("profile listen failed:",d)}setTimeout(()=>{wo().catch(d=>console.error("loadMyPair failed:",d))},800),setTimeout(()=>{Ba().catch(d=>console.error("refreshSemestersSub failed:",d))},1500),setTimeout(()=>{Q(()=>Promise.resolve().then(()=>bo),void 0).then(d=>{var m;return(m=d.mountPartnerProfileCard)==null?void 0:m.call(d)}).catch(()=>{})},2500),re()}else i(),re()})}async function To(e){var a,r,s,l;const t=L(b,"users",e.uid);(await J(t)).exists()?await X(t,{email:e.email||null,displayName:e.displayName||null,photoURL:e.photoURL||null,providerId:((l=(s=e.providerData)==null?void 0:s[0])==null?void 0:l.providerId)||"google",lastLoginAt:Date.now()},{merge:!0}):await X(t,{createdAt:Date.now(),email:e.email||null,displayName:e.displayName||null,photoURL:e.photoURL||null,providerId:((r=(a=e.providerData)==null?void 0:a[0])==null?void 0:r.providerId)||"google",preferences:{showNamesInShared:!0,theme:"dark"},lastLoginAt:Date.now()},{merge:!0})}let j={},cn=[];function Wa(e){const t=(e||"#/perfil").trim();return new Set(["#/perfil","#/semestres","#/horario","#/notas","#/malla","#/calendario","#/progreso","#/asistencia","#/party","#/ayuda"]).has(t)?t:"#/perfil"}function $o(e){const t=Wa(e);location.hash!==t&&(location.hash=t),ln(t)}function ln(e){const t=Wa(e),n=document.getElementById("pfActions");n&&n.classList.toggle("hidden",t!=="#/perfil"),cn.forEach(a=>a.classList.toggle("active",a.dataset.route===t)),Object.values(j).forEach(a=>a&&a.classList.add("hidden")),t==="#/perfil"&&j.perfil&&j.perfil.classList.remove("hidden"),t==="#/semestres"&&j.semestres&&j.semestres.classList.remove("hidden"),t==="#/horario"&&j.horario&&j.horario.classList.remove("hidden"),t==="#/notas"&&j.notas&&(j.notas.classList.remove("hidden"),document.dispatchEvent(new Event("route:notas"))),t==="#/malla"&&j.malla&&j.malla.classList.remove("hidden"),t==="#/progreso"&&j.progreso&&j.progreso.classList.remove("hidden"),t==="#/calendario"&&j.calendario&&(j.calendario.classList.remove("hidden"),document.dispatchEvent(new Event("route:calendario"))),t==="#/asistencia"&&j.asistencia&&j.asistencia.classList.remove("hidden"),t==="#/party"&&j.party&&j.party.classList.remove("hidden"),t==="#/ayuda"&&j.ayuda&&j.ayuda.classList.remove("hidden"),document.dispatchEvent(new CustomEvent("route:change",{detail:{route:t}}))}function Do(){j={perfil:c("page-perfil"),semestres:c("page-semestres"),horario:c("page-horario"),notas:c("page-notas"),malla:c("page-malla"),calendario:c("page-calendario"),progreso:c("page-progreso"),asistencia:c("page-asistencia"),party:c("page-party"),ayuda:c("page-ayuda")},cn=Array.from(document.querySelectorAll(".tab[data-route]"))||[],cn.forEach(e=>e.addEventListener("click",()=>$o(e.dataset.route))),window.addEventListener("hashchange",()=>ln(location.hash)),ln(location.hash||"#/perfil")}async function ko(){const e=await fetch("data/medvet_malla.csv").then(n=>n.text()).catch(()=>""),t=await fetch("data/ictel_malla.csv").then(n=>n.text()).catch(()=>"");return{MEDVET:e?No(e):[],ICTEL:t?Po(t):[]}}function Ja(e){const t=e.trim().split(/\r?\n/).filter(Boolean);if(!t.length)return[];const n=t[0],a=n.split(";").length>=n.split(",").length?";":",",r=n.split(a).map(s=>s.trim().replace(/^['\"]|['\"]$/g,""));return t.slice(1).map(s=>{const l=s.split(a).map(u=>u.trim().replace(/^['\"]|['\"]$/g,"")),i={};return r.forEach((u,d)=>i[u]=l[d]??""),i})}function No(e){return Ja(e).map(n=>{let a=n["C√≥digo Asignatura"]||n["Codigo Asignatura"]||"";return a.includes(".")&&(a=a.split(".")[0]),{codigo:a,nivel:(n.Nivel||"").trim()}})}function Po(e){return Ja(e).map(n=>{const a={};for(const[l,i]of Object.entries(n)){const u=l.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();a[u]=(i||"").trim()}const r=(...l)=>{for(const i of l){const u=i.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();if(u in a&&a[u])return a[u]}return""};let s=r("Sigla","C√≥digo","Codigo","C√≥digo Asignatura","Codigo Asignatura");return s||(s=r("C√≥digo Asignatura","Codigo Asignatura","C√≥digo","Codigo")),{codigo:s||"",nivel:(r("Nivel","Semestre")||"").toUpperCase()}})}function Oo(){var n,a;const e=((n=o.profileData)==null?void 0:n.university)||"GEN",t=((a=o.profileData)==null?void 0:a.career)||"GEN";try{return JSON.parse(localStorage.getItem(`mallaAprobados:${e}:${t}`)||"[]")}catch{return[]}}function Qt(e,t){return t?e/t*100:0}function Xt(e){return`${(Math.round(e*10)/10).toFixed(1)}%`}let Se=null,Et=null;async function Ro(){Se=await ko(),document.addEventListener("profile:changed",Ie),document.addEventListener("malla:updated",Ie),document.addEventListener("courses:changed",Ie),document.addEventListener("pair:ready",Ie),document.addEventListener("route:change",e=>{var t;((t=e.detail)==null?void 0:t.route)==="#/progreso"&&Ie()})}async function Ie(){var i;const e=c("prog-combinado");if(!e)return;e.classList.remove("hidden"),e.innerHTML='<h3 style="margin:0 0 8px">Progreso combinado</h3><div class="muted">Conectando‚Ä¶</div>';const t=((i=o.profileData)==null?void 0:i.career)||null;if(!t||!Se){e.innerHTML=`<h3 style="margin:0 0 8px">Progreso combinado</h3>
    <div class="muted">Completa tu perfil antes de ver el progreso. üå±</div>`;return}const n=Se&&Se[t]?Se[t].length:0,a=Oo(),r=n?Qt(a.length,n):0;Et&&(Et(),Et=null);const s=o.pairOtherUid||null;if(!s){e.innerHTML=`<h3 style="margin:0 0 8px">Progreso combinado</h3>
    <div class="muted">A√∫n no est√°s conectado a un d√∫o. Crea o √∫nete a una party. üë•</div>`;return}const l=L(b,"users",s,"malla","state");Et=Y(l,async u=>{const d=u.data()||{};let m=d.career||null;if((m==="UMAYOR"||m==="USM")&&(m=null),!m)try{const v=await J(L(b,"users",s));if(v.exists()){const y=v.data()||{};y.career&&(m=y.career)}}catch{}const f=Array.isArray(d.approved)?d.approved.length:0,p=m&&Se&&Se[m]?Se[m].length:0,g=n+p?Qt(a.length+f,n+p):0;e.innerHTML=`
      <h3 style="margin:0 0 8px">üèÅ Progreso combinado</h3>
      <div style="font-weight:600; margin-bottom:4px">Juntos llevan ${Xt(g)}</div>
      <div class="progress-outer small"><div class="progress-inner" style="width:${g}%;"></div></div>
      <div class="muted" style="margin-top:6px">T√∫: ${Xt(r)} ¬∑ Duo: ${Xt(Qt(f,p))}</div>
    `},u=>{e.innerHTML='<div class="muted">Error al conectar con el progreso del d√∫o.</div>'})}(function(){const t="prog-inline-styles";if(document.getElementById(t))return;const n=document.createElement("style");n.id=t,n.textContent=`
    .progress-outer{background:rgba(255,255,255,.08); border:1px solid rgba(0,0,0,.25);
      border-radius:10px; height:14px; margin-top:8px; overflow:hidden}
    .progress-outer.small{height:10px}
    .progress-inner{height:100%; background:linear-gradient(90deg, var(--primary), var(--accent));}
  `,document.head.appendChild(n)})();document.addEventListener("route:change",e=>{var t;((t=e.detail)==null?void 0:t.route)==="#/party"&&Ie()});const ua=Object.freeze(Object.defineProperty({__proto__:null,initProgreso:Ro,refreshProgreso:Ie},Symbol.toStringTag,{value:"Module"}));window.addEventListener("DOMContentLoaded",async()=>{await Promise.all([Uo(),Do(),So(),io()]);const e=location.hash;e.startsWith("#/malla")?Q(()=>import("./malla-BIt3SnAH.js"),[]).then(t=>{var n;return(n=t.initMallaOnRoute)==null?void 0:n.call(t)}):e.startsWith("#/notas")?Q(()=>Promise.resolve().then(()=>oa),void 0).then(t=>{var n;return(n=t.initGrades)==null?void 0:n.call(t)}):e.startsWith("#/asistencia")?Q(()=>Promise.resolve().then(()=>Xn),void 0).then(t=>{var n;return(n=t.initAttendance)==null?void 0:n.call(t)}):e.startsWith("#/horario")?Q(()=>Promise.resolve().then(()=>Gn),void 0).then(t=>{var n;return(n=t.initSchedule)==null?void 0:n.call(t)}):e.startsWith("#/calendario")?Q(()=>Promise.resolve().then(()=>Qn),void 0).then(t=>{var n;return(n=t.initCalendar)==null?void 0:n.call(t)}):e.startsWith("#/progreso")&&Q(()=>Promise.resolve().then(()=>ua),void 0).then(t=>{var n;return(n=t.initProgreso)==null?void 0:n.call(t)}),document.addEventListener("route:change",async t=>{var a,r,s,l,i,u;const n=t.detail.route;if(n.startsWith("#/notas")){const d=await Q(()=>Promise.resolve().then(()=>oa),void 0);(a=d.initGrades)==null||a.call(d)}else if(n.startsWith("#/malla")){const d=await Q(()=>import("./malla-BIt3SnAH.js"),[]);(r=d.initMallaOnRoute)==null||r.call(d)}else if(n.startsWith("#/asistencia")){const d=await Q(()=>Promise.resolve().then(()=>Xn),void 0);(s=d.initAttendance)==null||s.call(d)}else if(n.startsWith("#/horario")){const d=await Q(()=>Promise.resolve().then(()=>Gn),void 0);(l=d.initSchedule)==null||l.call(d)}else if(n.startsWith("#/calendario")){const d=await Q(()=>Promise.resolve().then(()=>Qn),void 0);(i=d.initCalendar)==null||i.call(d)}else if(n.startsWith("#/progreso")){const d=await Q(()=>Promise.resolve().then(()=>ua),void 0);(u=d.initProgreso)==null||u.call(d)}})});export{c as $,b as d,o as s};
