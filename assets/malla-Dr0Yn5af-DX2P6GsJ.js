import{i as c,o as u,h as U}from"./index-gbohjx09.js";import{doc as F,setDoc as J,onSnapshot as Q,getDoc as X}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";const V={MEDVET:"Medicina Veterinaria",ICTEL:"Ing. Civil Telemática"},j={UMAYOR:["MEDVET"],USM:["ICTEL"]};let S={},b="";const O=["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"],D=a=>O.indexOf(a);z();window.addEventListener("hashchange",z);document.addEventListener("profile:changed",()=>{if(location.hash!=="#/malla")return;const a=u("malla-host");a&&(async()=>(a.dataset.ready||(R(a),await $(),a.dataset.ready="1"),k?.(),c.shared?.malla?.enabled&&c.pairOtherUid?M():(b="",I())))()});document.addEventListener("pair:ready",()=>{Y()});async function z(){if(location.hash!=="#/malla")return;const a=u("malla-host");if(!a)return;a.dataset.ready||(R(a),await $(),a.dataset.ready="1"),k?.();const e=u("malla-view-partner");if(e&&(c.shared.malla.enabled=!!e.checked),!c.profileData){c.shared?.malla?.enabled&&c.pairOtherUid&&M();return}c.shared?.malla?.enabled&&c.pairOtherUid?M():(b="",I())}async function Y(){if(location.hash!=="#/malla")return;const a=u("malla-host");a&&(a.dataset.ready||(R(a),await $(),a.dataset.ready="1"),k?.(),c.shared?.malla?.enabled&&c.pairOtherUid?M():(w(!1),b="",c.profileData&&I()))}function L(){return!!(c.shared?.malla?.enabled&&c.pairOtherUid)}function w(a){const e=u("malla-wrapper");e&&(e.dataset.readonly=a?"1":"0",e.style.cursor=a?"not-allowed":"")}function R(a){a.innerHTML=`
    <div id="malla-wrapper" class="malla-wrapper">
      <div class="grid-header" style="display:none"></div>
      <div class="malla-grid"></div>
    </div>

    <div id="malla-info" style="display:none">
      <div id="malla-caption" class="muted" style="text-align:center;margin:6px 0 2px"></div>
      <div id="malla-percentage" class="percentage-display"></div>
      <div class="legend"></div>
    </div>
  `,a.addEventListener("click",e=>{const n=e.target.closest(".grid-item");n&&(L()||u("malla-wrapper")?.dataset.readonly==="1"||(n.classList.toggle("aprobado"),N(a),x(a),A(a)))})}async function $(){if(S.MEDVET&&S.ICTEL)return;const a=await fetch("/data/medvet_malla.csv").then(e=>e.text());S.MEDVET=K(a);try{const e=await fetch("/data/ictel_malla.csv").then(n=>n.text());S.ICTEL=Z(e)}catch{S.ICTEL=[]}}function K(a){const e=G(a),n=[1,16,36,43,45,51,54,55,56,58,60],s=[2,3,4,5,6,9,10,11,17,18,24,30,49],i=[12,19,25,31,37],l=[7,13,15,20,21,22,28,32,33,34,39,40,41,42,44,46,47,48,52,53],r=[8,14,26,38],d=[23,29],m=[27,35,50,57],g=e.map(t=>parseInt(t["Código Asignatura"],10)).filter(t=>![...n,...s,...i,...l,...r,...d,...m].includes(t));return e.map(t=>{let o=t["Código Asignatura"];o.includes(".")&&(o=o.split(".")[0]);const C=["Prerrequisito 01 (Código)","Prerrequisito 02 (Código)","Prerrequisito 03 (Código)"].map(h=>t[h]).filter(h=>h&&h.toLowerCase()!=="ingreso").map(h=>h.includes(".")?h.split(".")[0]:h),p=parseInt(o,10);let f="";return n.includes(p)?f="integrativa":s.includes(p)?f="formacion-basica":i.includes(p)?f="electiva":l.includes(p)?f="salud-animal":r.includes(p)?f="produccion-animal":d.includes(p)?f="medio-ambiente":m.includes(p)?f="salud-publica":g.includes(p)&&(f="transversal"),{codigo:o,sigla:"",numero:null,creditos:null,nombre:t.Asignatura,nivel:t.Nivel.trim(),prerrequisitos:C,area:f}})}function Z(a){const e=G(a),n=i=>{const l=parseInt((i||"").trim(),10);return Number.isFinite(l)&&l>=1&&l<=O.length?O[l-1]:String(i||"").toUpperCase()},s=(i,l)=>{const r=(i||"").split("-")[0].toUpperCase(),d=(l||"").toLowerCase();return r==="MAT"||r==="QUI"?"Ciencias Básicas":r==="FIS"?"Física":r==="ELO"?"Electrónica":r==="HCW"?"Inglés":r==="DEW"?"Deportes":r==="INF"?"Software":r==="TEL"?d.includes("red")?"Redes":(d.includes("telecom"),"Telecomunicaciones"):r==="IWN"?"Formación General":r==="IWG"?"Industrias":""};return e.map(i=>{const l={};for(const[E,v]of Object.entries(i)){const y=E.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();l[y]=(v||"").trim()}const r=(...E)=>{for(const v of E){const y=v.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();if(y in l&&l[y])return l[y]}return""},d=r("Número","Numero","Nº","N°","num","n"),m=parseInt(d,10)||null;let g=r("Sigla","Código","Codigo","Código Asignatura","Codigo Asignatura"),t=r("Código Asignatura","Codigo Asignatura","Código","Codigo","Sigla");g||(g=t),t||(t=g);const o=r("Asignatura","Nombre","Nombre Asignatura","Ramo"),C=n(r("Nivel","Semestre","Periodo","Período","Romano"));let p=r("Área","Area","Línea","Linea","Linea/Área","Linea Area");p||(p=s(g,o));const f=parseInt(r("Créditos","Creditos","SCT","Créditos SCT","Sct","Cred"),10)||0,h=Object.keys(l).filter(E=>E.startsWith("prerrequisito")).flatMap(E=>String(l[E]||"").replace(/\b(ingreso|sin|na|n\/a|none)\b/ig,"").split(/[^\w-]+/g).map(v=>v.trim()).filter(Boolean).filter(v=>v!=="0"&&v!=="-"));return{codigo:t,sigla:g,numero:m,creditos:f,nombre:o,nivel:C,prerrequisitos:h,area:p}})}function G(a){const e=a.trim().split(/\r?\n/).filter(Boolean),n=(r,d)=>r.split(d).length,s=e[0],i=n(s,";")>=n(s,",")?";":",",l=s.split(i).map(r=>r.trim().replace(/^["']|["']$/g,""));return e.slice(1).map(r=>{const d=r.split(i).map(g=>g.trim().replace(/^["']|["']$/g,"")),m={};return l.forEach((g,t)=>{m[g]=d[t]??""}),m})}function I(){const a=c.profileData?.university||"",e=c.profileData?.career||"",n=document.querySelector("#page-malla .grid-header"),s=document.querySelector("#page-malla .malla-grid"),i=u("malla-info"),l=u("malla-caption");if(w(!1),!a||!e||!(j[a]||[]).includes(e)){b="",n.style.display="none",s.innerHTML='<div class="muted">Completa tu <b>Universidad</b> y <b>Carrera</b> en <b>Perfil</b> para ver la malla.</div>',i.style.display="none";return}const r=`${a}:${e}`;if(r===b){A(document.getElementById("malla-wrapper"));return}b=r,l.textContent=`${ee(a)} · ${V[e]||e}`,_(e)}function ee(a){return a==="UMAYOR"?"Universidad Mayor":a==="USM"?"UTFSM":a||"—"}function _(a){const e=u("page-malla");e.dataset.career=a;const n=e.querySelector(".grid-header"),s=e.querySelector(".malla-grid"),i=u("malla-info");if(s.innerHTML="",!a){n.style.display="none",i.style.display="none";return}const l=S[a]||[];if(!l.length){s.innerHTML='<div class="muted">Malla en preparación.</div>',n.style.display="none",i.style.display="none";return}const r=Array.from(new Set(l.map(t=>t.nivel))).sort((t,o)=>D(t)-D(o)),d=Math.ceil(r.length/2);n.style.gridTemplateColumns=`repeat(${r.length}, 1fr)`,s.style.gridTemplateColumns=`repeat(${r.length}, 1fr)`,n.innerHTML="";for(let t=1;t<=d;t++){const o=document.createElement("div");o.className="year",o.dataset.year=String(t),o.title=`Marcar Año ${t}`,o.style.cursor="pointer",o.textContent=`Año ${t}`,o.style.gridColumn=`${(t-1)*2+1} / span 2`,n.appendChild(o)}r.forEach(t=>{const o=document.createElement("div");o.className="sem",o.dataset.sem=t,o.title=`Marcar semestre ${t}`,o.style.cursor="pointer",o.textContent=t,n.appendChild(o)}),n.style.display="grid",n.querySelectorAll(".year").forEach(t=>{t.addEventListener("click",()=>{L()||u("malla-wrapper")?.dataset.readonly==="1"||ae(parseInt(t.dataset.year,10))})}),n.querySelectorAll(".sem").forEach(t=>{t.addEventListener("click",()=>{L()||u("malla-wrapper")?.dataset.readonly==="1"||te(t.dataset.sem)})});const m=e.querySelector(".legend");a==="ICTEL"?m.innerHTML=`
      <span><span class="legend-color cb"></span>Ciencias Básicas</span>
      <span><span class="legend-color software"></span>Software</span>
      <span><span class="legend-color fisica"></span>Física</span>
      <span><span class="legend-color transversal"></span>Transversal e Integración</span>
      <span><span class="legend-color fg"></span>Formación General</span>
      <span><span class="legend-color deportes"></span>Deportes</span>
      <span><span class="legend-color redes"></span>Redes</span>
      <span><span class="legend-color ingles"></span>Inglés</span>
      <span><span class="legend-color electronica"></span>Electrónica</span>
      <span><span class="legend-color telecom"></span>Telecomunicaciones</span>
      <span><span class="legend-color industrias"></span>Industrias</span>
      <span><span class="legend-color complementarios"></span>Complementarios</span>
    `:m.innerHTML=`
      <span><span class="legend-color integrativa"></span>Formación Integrativa</span>
      <span><span class="legend-color salud-animal"></span>Formación Salud Animal</span>
      <span><span class="legend-color produccion-animal"></span>Formación Producción Animal</span>
      <span><span class="legend-color salud-publica"></span>Formación Salud Pública</span>
      <span><span class="legend-color medio-ambiente"></span>Formación Medio Ambiente</span>
      <span><span class="legend-color formacion-basica"></span>Formación Básica</span>
      <span><span class="legend-color electiva"></span>Formación Electiva</span>
    `,i.style.display="block";const g=new Map;if(l.forEach(t=>{t.numero!=null&&g.set(String(t.numero),t.area),t.codigo&&g.set(String(t.codigo),t.area),t.sigla&&g.set(String(t.sigla),t.area)}),s.innerHTML="",l.forEach(t=>{let o=D(t.nivel);o<0&&(o=0);const C=o+1,p=document.createElement("div");p.className="grid-item"+(t.area?" area-"+B(t.area):""),p.style.gridColumn=String(C),p.dataset.codigo=t.codigo,p.dataset.key=String(t.numero??t.codigo),p.dataset.prereqs=JSON.stringify(t.prerrequisitos),p.dataset.sem=t.nivel,p.dataset.year=String(Math.ceil(C/2));const f=document.createElement("div");if(f.className="top-bar",p.appendChild(f),t.sigla){const y=document.createElement("span");y.className="sigla-label",y.textContent=t.sigla,f.appendChild(y)}const h=document.createElement("span");h.className="code-label",h.textContent=t.numero??t.codigo,f.appendChild(h);const E=document.createElement("div");E.className="course-name",E.textContent=t.nombre,p.appendChild(E);const v=document.createElement("div");if(v.className="bottom-bar",p.appendChild(v),(t.prerrequisitos||[]).forEach((y,W)=>{const P=String(y),q=document.createElement("span");q.className="prereq-label",q.textContent=P,q.style.left=`${4+W*22}px`;const H=g.get(P);H&&q.classList.add("area-"+B(H)),v.appendChild(q)}),t.creditos){const y=document.createElement("span");y.className="credits-badge",y.textContent=t.creditos,v.appendChild(y)}s.appendChild(p)}),ne(e,a),N(e),A(e),!L())try{x(e)}catch{}}function B(a){const e=(a||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[-_]+/g," ").replace(/\s+/g," ").trim();return e.includes("integrativ")?"integrativa":e.includes("formacion basica")?"formacion-basica":e.includes("electiva")?"electiva":e.includes("salud animal")?"salud-animal":e.includes("produccion animal")?"produccion-animal":e.includes("medio ambiente")?"medio-ambiente":e.includes("salud publica")?"salud-publica":e.includes("ciencias basicas")?"cb":e.includes("software")?"software":e.includes("fisica")?"fisica":e.includes("transversal")?"transversal":e.includes("formacion general")?"fg":e.includes("deporte")?"deportes":e.includes("redes")?"redes":e.includes("ingles")?"ingles":e.includes("electronica")?"electronica":e.includes("telecom")?"telecom":e.includes("industri")?"industrias":e.includes("complement")?"complementarios":"transversal"}function ae(a){const e=u("malla-wrapper");if(!e||L()||e.dataset.readonly==="1")return;const n=e.querySelectorAll(`.grid-item[data-year="${a}"]`),s=Array.from(n).every(i=>i.classList.contains("aprobado"));n.forEach(i=>i.classList.toggle("aprobado",!s)),N(e),x(e),A(e)}function te(a){const e=u("malla-wrapper");if(!e||L()||e.dataset.readonly==="1")return;const n=e.querySelectorAll(`.grid-item[data-sem="${a}"]`),s=Array.from(n).every(i=>i.classList.contains("aprobado"));n.forEach(i=>i.classList.toggle("aprobado",!s)),N(e),x(e),A(e)}function N(a){const e=a.querySelectorAll(".grid-item"),n=document.getElementById("page-malla")?.dataset.career||"";let s=!0;if(n==="MEDVET"){const l=Array.from(e).filter(r=>{const d=parseInt(r.dataset.year||"0",10);return Number.isFinite(d)&&d>=1&&d<=4});s=l.length>0&&l.every(r=>r.classList.contains("aprobado"))}const i=l=>String(l||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");e.forEach(l=>{const r=JSON.parse(l.dataset.prereqs||"[]").every(m=>{const g=CSS.escape(String(m)),t=a.querySelector(`.grid-item[data-key="${g}"]`),o=a.querySelector(`.grid-item[data-codigo="${g}"]`),C=Array.from(a.querySelectorAll(".grid-item")).find(f=>f.querySelector(".sigla-label")?.textContent===String(m)),p=t||o||C;return p&&p.classList.contains("aprobado")});let d=!0;if(n==="MEDVET"){const m=i(l.querySelector(".course-name")?.textContent||"");m.includes("practica")&&m.includes("profesional")&&(d=s)}r&&d?l.classList.remove("bloqueado"):l.classList.add("bloqueado")})}async function x(a){const e=c.profileData?.university||"GEN",n=c.profileData?.career||"GEN",s=Array.from(a.querySelectorAll(".grid-item.aprobado")).map(i=>i.dataset.codigo);localStorage.setItem(`mallaAprobados:${e}:${n}`,JSON.stringify(s));try{document.dispatchEvent(new Event("malla:updated"))}catch{}if(c.currentUser){const i=F(U,"users",c.currentUser.uid,"malla","state");await J(i,{career:n,approved:s,updatedAt:Date.now()},{merge:!0});try{document.dispatchEvent(new Event("malla:updated"))}catch{}}}function ne(a,e){const n=c.profileData?.university||"GEN";JSON.parse(localStorage.getItem(`mallaAprobados:${n}:${e}`)||"[]").forEach(s=>{const i=a.querySelector(`.grid-item[data-codigo="${CSS.escape(String(s))}"]`);i&&i.classList.add("aprobado")})}function A(a){const e=a.querySelectorAll(".grid-item").length,n=a.querySelectorAll(".grid-item.aprobado").length,s=e?(n/e*100).toFixed(1):"0.0";u("malla-percentage").textContent=`Total de ramos: ${s}%`}function k(){const a=u("malla-host");if(!a||u("malla-partner-toggle"))return;const e=document.createElement("div");e.id="malla-partner-toggle",e.className="row",e.style.margin="10px 0",e.innerHTML=`
    <label class="pill">
      <input type="checkbox" id="malla-view-partner" style="margin-right:8px"/>
      Ver malla de la otra persona
    </label>
  `,a.prepend(e);const n=u("malla-view-partner");n.checked=!!c.shared?.malla?.enabled,n.addEventListener("change",()=>{c.shared.malla.enabled=n.checked,I(),M()})}let T=null;function M(){if(T&&(T(),T=null),!document.getElementById("malla-wrapper"))return;if(!c.shared?.malla?.enabled||!c.pairOtherUid){w(!1),b="",c.profileData&&I();return}w(!0);const a=F(U,"users",c.pairOtherUid,"malla","state");T=Q(a,async e=>{const n=e.data()||{};let s=n.career||null;const i=Array.isArray(n.approved)?n.approved:[];if((s==="UMAYOR"||s==="USM")&&(s=null),!s&&c.pairOtherUid)try{const d=await X(F(U,"users",c.pairOtherUid));if(d.exists()){const m=d.data()||{};m?.career&&(s=m.career)}}catch{}s&&await re(s);const l=u("malla-wrapper");if(!l)return;l.querySelectorAll(".grid-item.aprobado").forEach(d=>d.classList.remove("aprobado")),i.forEach(d=>{const m=l.querySelector(`.grid-item[data-codigo="${CSS.escape(String(d))}"]`);m&&m.classList.add("aprobado")}),N(l),A(l);const r=u("malla-caption");r&&s&&!r.textContent.includes("vista de la otra persona")&&(r.textContent=`${V[s]||s} · (vista de la otra persona)`)},e=>{w(!1),b="",c.profileData&&I()})}async function re(a){const e=u("page-malla");if(!e)return;await $(),e.dataset.career=a,b=`FORCED:${a}`;const n=u("malla-caption");n.textContent=`${V[a]||a} · (vista de la otra persona)`,w(!0),_(a)}function ce(a){const e={};a.forEach(n=>{const s=n.codigo.trim(),i=(n.prerequisitos||"").split(/[,;]/).map(l=>l.trim()).filter(Boolean);e[s]=i}),c.malla={prereqMap:e,rows:a}}function de(a){const e=String(a||"").toUpperCase().trim();return window.MALLA_PREREQS&&window.MALLA_PREREQS[e]||[]}export{de as getPrereqs,ce as parseMalla};
