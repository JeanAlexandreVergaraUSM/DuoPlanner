import{getApps as xa,getApp as Aa,initializeApp as Ma}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth as Ua,setPersistence as Ia,browserLocalPersistence as Ta,GoogleAuthProvider as ln,signInWithPopup as dn,signOut as un,onAuthStateChanged as $a}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{initializeFirestore as Da,persistentLocalCache as ka,collection as x,getDocs as O,updateDoc as R,deleteDoc as te,doc as E,onSnapshot as F,query as Z,addDoc as Pe,getDoc as Y,orderBy as Ce,where as Rn,setDoc as ee,serverTimestamp as _n,Timestamp as Na,arrayRemove as Pa,arrayUnion as Oa}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const Ra="modulepreload",_a=function(e){return"/DuoPlanner/"+e},mn={},G=function(t,n,a){let r=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),o=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));r=Promise.allSettled(n.map(u=>{if(u=_a(u),u in mn)return;mn[u]=!0;const d=u.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${m}`))return;const f=document.createElement("link");if(f.rel=d?"stylesheet":Ra,d||(f.as="script"),f.crossOrigin="",f.href=u,o&&f.setAttribute("nonce",o),document.head.appendChild(f),d)return new Promise((p,h)=>{f.addEventListener("load",p),f.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${u}`)))})}))}function s(l){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=l,window.dispatchEvent(o),!o.defaultPrevented)throw l}return r.then(l=>{for(const o of l||[])o.status==="rejected"&&s(o.reason);return t().catch(s)})},Fa={apiKey:"AIzaSyB45g_2KRGlXH0iAPyBGuCnrFkhxCHadKs",authDomain:"nacholo.firebaseapp.com",projectId:"nacholo",storageBucket:"nacholo.appspot.com",messagingSenderId:"924503328068",appId:"1:924503328068:web:1f753ced7f47ec36750311"},Fn=xa().length?Aa():Ma(Fa),g=Da(Fn,{localCache:ka()}),Me=Ua(Fn);Ia(Me,Ta).catch(()=>{});const i={currentUser:null,currentPairId:null,profileData:null,activeSemesterId:null,activeSemesterData:null,unsubscribeCourses:null,editingCourseId:null,pairOtherUid:null,shared:{horario:{semId:null},notas:{semId:null},malla:{enabled:!1},calendar:{semId:null}},DEBUG:(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&(new URLSearchParams(location.search).has("debug")||((window==null?void 0:window.duoplannerDebug)??!1))},c=e=>typeof e=="string"?document.getElementById(e):null;function K(){var t;if(!i.DEBUG)return;const e=c("state");e&&(e.textContent=JSON.stringify({uid:((t=i.currentUser)==null?void 0:t.uid)||null,pairId:i.currentPairId,pairOtherUid:i.pairOtherUid||null,profileData:i.profileData,activeSemesterId:i.activeSemesterId,editingCourseId:i.editingCourseId},null,2))}function fn(e,t){e&&(t?e.classList.add("hidden"):e.classList.remove("hidden"))}let pt="#22c55e",vt="#ff69b4",Ke=null,pn=!1,ht=!1,Ue=null;const Ae=80,vn=28;let Bn=[],Rt=[];const Ye=["Lun","Mar","Mi√©","Jue","Vie"];function Ba(e){if(!ht)return;const t=e.clientY,n=window.innerHeight;let a=0;if(t<Ae){const r=(Ae-t)/Ae;a=-Math.ceil(vn*r)}else if(t>n-Ae){const r=(t-(n-Ae))/Ae;a=Math.ceil(vn*r)}a!==0&&Ue===null&&(Ue=requestAnimationFrame(()=>{window.scrollBy(0,a),Ue=null}))}function hn(){ht=!1,Ue&&(cancelAnimationFrame(Ue),Ue=null)}const Te=[{label:"1/2",start:"08:15",end:"09:25",lines:[{n:"1",start:"08:15",end:"08:50"},{n:"2",start:"08:50",end:"09:25"}]},{label:"3/4",start:"09:40",end:"10:50",lines:[{n:"3",start:"09:40",end:"10:15"},{n:"4",start:"10:15",end:"10:50"}]},{label:"5/6",start:"11:05",end:"12:15",lines:[{n:"5",start:"11:05",end:"11:40"},{n:"6",start:"11:40",end:"12:15"}]},{label:"7/8",start:"12:30",end:"13:40",lines:[{n:"7",start:"12:30",end:"13:05"},{n:"8",start:"13:05",end:"13:40"}]},{label:"ALMUERZO",start:"13:40",end:"14:40",lunch:!0},{label:"9/10",start:"14:40",end:"15:50",lines:[{n:"9",start:"14:40",end:"15:15"},{n:"10",start:"15:15",end:"15:50"}]},{label:"11/12",start:"16:05",end:"17:15",lines:[{n:"11",start:"16:05",end:"16:40"},{n:"12",start:"16:40",end:"17:15"}]},{label:"13/14",start:"17:30",end:"18:40",lines:[{n:"13",start:"17:30",end:"18:05"},{n:"14",start:"18:05",end:"18:40"}]},{label:"15/16",start:"18:55",end:"20:05",lines:[{n:"15",start:"18:55",end:"19:30"},{n:"16",start:"19:30",end:"20:05"}]},{label:"17/18",start:"20:20",end:"21:30",lines:[{n:"17",start:"20:20",end:"20:55"},{n:"18",start:"20:55",end:"21:30"}]},{label:"19/20",start:"21:45",end:"22:55",lines:[{n:"19",start:"21:45",end:"22:20"},{n:"20",start:"22:20",end:"22:55"}]}],zt=[re("1/2","08:30","09:40",["08:30-09:05","09:05-09:40"]),re("3/4","10:00","11:10",["10:00-10:35","10:35-11:10"]),re("5/6","11:30","12:40",["11:30-12:05","12:05-12:40"]),{label:"ALMUERZO",start:"12:40",end:"14:00",lunch:!0},re("7/8","14:00","15:10",["14:00-14:35","14:35-15:10"]),re("9/10","15:30","16:40",["15:30-16:05","16:05-16:40"]),re("11/12","17:00","18:10",["17:00-17:35","17:35-18:10"]),re("13/14","18:30","19:40",["18:30-19:05","19:05-19:40"]),re("15/16","20:00","21:10",["20:00-20:35","20:35-21:10"]),re("17/18","21:30","22:40",["21:30-22:05","22:05-22:40"])];function re(e,t,n,a){return{label:e,start:t,end:n,lines:a.map(r=>{const[s,l]=r.split("-");return{start:s,end:l}})}}function Hn(e){if(!e)return"";const t=String(e).toLowerCase();return t==="umayor"||t.includes("mayor")?"UMAYOR":t==="usm"||t==="utfsm"||t.includes("utfsm")||t.includes("santa mar√≠a")||t.includes("santa maria")?"USM":"OTRA"}function jn(){var t,n;const e=((t=i.activeSemesterData)==null?void 0:t.universityAtThatTime)||((n=i.profileData)==null?void 0:n.university)||"";return Hn(e)}function _t(){return jn()==="UMAYOR"?zt:Te}function qn(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function Gt(e,t,n){const a=(e||[]).find(r=>r.id===t);return qn(a==null?void 0:a.color)?a.color:n||"#3B82F6"}function Vt(e){try{const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return(t*299+n*587+a*114)/1e3>=160?"#111":"#fff"}catch{return"#0e0e0e"}}let Qe=null,V=[];function Yn(){var d;if(pn)return;pn=!0,Ha(),za(),Ga(),Va(),Wa(),tt(),document.addEventListener("pair:ready",m=>{var p;if((p=m.detail)==null?void 0:p.otherUid)yn(),tt();else{const h=c("sh-semSel");h&&(h.innerHTML="<option disabled selected>Sin compa√±ero</option>")}}),(d=c("sh-semSel"))==null||d.addEventListener("change",m=>{i.shared.horario.semId=m.target.value||null,lt(i.shared.horario.semId)});const e=c("subtabPropio"),t=c("subtabCompartido"),n=c("subtabCombinado"),a=c("horarioPropio"),r=c("horarioCompartido"),s=c("horarioCombinado");function l(){e.classList.add("active"),t.classList.remove("active"),n.classList.remove("active"),a.classList.remove("hidden"),r.classList.add("hidden"),s.classList.add("hidden")}function o(){var f,p;if(t.getAttribute("aria-disabled")==="true"){alert("Debes emparejarte primero para ver el horario de la otra persona.");return}t.classList.add("active"),e.classList.remove("active"),n.classList.remove("active"),r.classList.remove("hidden"),a.classList.add("hidden"),s.classList.add("hidden");const m=c("sh-semSel");if(m&&!m.value){const h=Array.from(m.options).find(v=>v.value);h&&(m.value=h.value),m!=null&&m.value&&(i.shared.horario.semId=m.value)}(p=(f=i.shared)==null?void 0:f.horario)!=null&&p.semId?lt(i.shared.horario.semId):yn().then(()=>tt())}function u(){n.classList.add("active"),e.classList.remove("active"),t.classList.remove("active"),s.classList.remove("hidden"),a.classList.add("hidden"),r.classList.add("hidden"),Zt()}e.addEventListener("click",l),t.addEventListener("click",o),n.addEventListener("click",u),l(),document.addEventListener("courses:changed",()=>{Wt(),Le()}),document.addEventListener("click",async m=>{const f=m.target.closest(".block-del-btn");if(!f)return;const p=f.dataset.id;if(!(!p||!i.currentUser||!i.activeSemesterId)&&confirm("¬øEliminar este bloque del horario?"))try{await te(E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",p))}catch(h){console.error(h),alert("No se pudo eliminar el bloque.")}}),setTimeout(async()=>{var m,f,p;i.pairOtherUid&&((m=i.activeSemesterData)!=null&&m.label)&&(await tt(),(p=(f=i.shared)==null?void 0:f.horario)!=null&&p.semId&&await lt(i.shared.horario.semId))},1500)}function Oe(){if(Qe&&(Qe(),Qe=null),V=[],Le(),!i.currentUser||!i.activeSemesterId)return;const e=x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule");Qe=F(Z(e),t=>{V=t.docs.map(n=>({id:n.id,...n.data()})),Le()})}function Ha(){const e=c("horarioPropio");e.innerHTML=`
  <div class="card" style="margin-bottom:12px">
    <h3 style="margin:0 0 10px">Paleta de ramos</h3>
    <div id="coursePalette" class="palette"></div>
    <div class="muted" style="margin-top:6px">
      <ul style="margin:4px 0 0 20px; padding:0; list-style:disc;">
        <li>Arrastra un ramo a un m√≥dulo.</li>
        <li>Puedes arrastrar ramos del mismo horario.</li>
        <li>La pre-vista indica <b>arriba</b>, <b>completo</b>, <b>abajo</b>, <b>izquierda</b> o <b>derecha</b>.</li>
        <li>Para eliminar un bloque, haz <b>click</b> en la X.</li>
        <li>Para editar un bloque, haz <b>click</b> sobre √©l.</li>
        <li>Para editar una sala, haz <b>click derecho</b> sobre √©l.</li>
        <li>Para ver su sala, pase el mouse por encima.</li>
      </ul>
    </div>
  </div>
  <div id="schedUSM" class="sched-usm card"></div>
`,Wt(),Le()}function ja(){Wt(),Le()}function Wt(){const e=c("coursePalette");if(!e)return;e.innerHTML="";const t=Array.isArray(i.courses)?i.courses:[];if(t.length===0){e.innerHTML='<div class="muted">No hay ramos en el semestre activo.</div>';return}t.forEach(n=>{const a=document.createElement("div");a.className="palette-chip",a.setAttribute("draggable","true"),a.dataset.courseId=n.id,a.textContent=n.name;const r=qn(n.color)?n.color:"#3B82F6";a.style.borderColor=r,a.style.boxShadow="inset 0 0 0 2px rgba(0,0,0,.15)",e.appendChild(a)})}function Le(){const e=c("schedUSM");if(!e)return;const t=_t();Bn=t;const n=jn()==="USM",a=n?"Bloque":"M√≥dulo";e.innerHTML=`
    <div class="usm-grid2">
      <div class="cell header">${a}</div>
      ${Ye.map(r=>`<div class="cell header">${r}</div>`).join("")}
      ${t.map((r,s)=>`
        <div class="cell mod ${r.lunch?"lunch":""}" data-slot="${s}">
          ${zn(r,s,n?"USM":"UMAYOR")}
        </div>
        ${Ye.map((l,o)=>`
          <div class="cell slot ${r.lunch?"is-lunch":""}"
               data-day="${o}" data-slot="${s}"
               ${r.lunch?'aria-disabled="true"':""}>
            ${qa(o,s)}
          </div>
        `).join("")}
      `).join("")}
    </div>
  `,Gn(),e.querySelectorAll(".placed").forEach(r=>{if(!r.querySelector(".block-del-btn")){const s=document.createElement("button");s.className="block-del-btn",s.textContent="√ó",s.dataset.id=r.dataset.id,r.appendChild(s)}})}function zn(e,t,n){if(e.lunch)return`
      <div class="mod-label">ALMUERZO</div>
      <div class="mod-time">${e.start}‚Äì${e.end}</div>
    `;const r=(Rt.length?Rt:Bn).slice(0,t).filter(s=>!s.lunch).length;if(n==="USM"){const s=r*2+1,l=s+1;return`
      <div class="mod-lines">
        <div class="line-num">${s}</div>
        <div class="line-time">${e.lines[0].start}‚Äì${e.lines[0].end}</div>
        <div class="line-num">${l}</div>
        <div class="line-time">${e.lines[1].start}‚Äì${e.lines[1].end}</div>
      </div>
    `}else return`
      <div class="mod-lines">
        <div class="line-num">${r+1}</div>
        <div class="line-time">${e.start}‚Äì${e.end}</div>
      </div>
    `}function qa(e,t){const n=V.filter(r=>r.day===e&&r.slot===t);if(!n.length)return"";const a=r=>{const s=n.filter(o=>(o.pos||"full")===r);return s.length?s.sort((o,u)=>{const d={left:0,single:1,right:2};return(d[o.hpos||"single"]??1)-(d[u.hpos||"single"]??1)}).map(o=>Ya(o,r)).join(""):""};return`
    ${a("top")}
    ${a("full")}
    ${a("bottom")}
  `}function Ya(e,t){const n=(i.courses||[]).find(m=>m.id===e.courseId),a=(n==null?void 0:n.name)||"Ramo",r=typeof e.displayName=="string"&&e.displayName.trim()?e.displayName.trim():a,s=Gt(i.courses,e.courseId,pt),l=Vt(s),o=typeof e.room=="string"&&e.room.trim()?e.room.trim():null,u=e.hpos||"single",d=`${r}${o?` ¬∑ Sala: ${o}`:""}`;return`
  <div class="placed pos-${t} h-${u}" data-id="${e.id}"
       draggable="true"
       title="${d}"
       style="background:${s}; border:1px solid rgba(0,0,0,0.25);">
    <div class="placed-title" style="color:${l}; font-weight:600;">${r}</div>
  </div>
`}function za(){window.addEventListener("dragover",Ba,{passive:!0}),document.addEventListener("drop",hn),document.addEventListener("dragend",hn),document.addEventListener("dragstart",e=>{const t=e.target;t&&t.classList.contains("palette-chip")&&(e.dataTransfer.setData("text/plain",t.dataset.courseId),e.dataTransfer.effectAllowed="copy",ht=!0)}),document.addEventListener("dragstart",e=>{const t=e.target.closest(".placed");t&&(e.dataTransfer.setData("text/plain",JSON.stringify({type:"move-block",id:t.dataset.id})),e.dataTransfer.effectAllowed="move",ht=!1)}),Gn()}function Ga(){document.addEventListener("click",e=>{const t=e.target.closest(".placed-title");if(!t||!t.closest("#schedUSM")||document.querySelector("input.inline-rename"))return;const a=t.closest(".placed");if(!a)return;const r=a.dataset.id,s=V.find(p=>p.id===r);if(!s)return;const l=(i.courses||[]).find(p=>p.id===s.courseId),o=(l==null?void 0:l.name)||t.textContent.trim(),u=typeof s.displayName=="string"&&s.displayName.trim()?s.displayName.trim():o,d=document.createElement("input");d.type="text",d.className="inline-rename",d.value=u;const m=Math.max(t.offsetWidth,140);d.style.width=m+"px",t.replaceWith(d),d.focus(),d.select();const f=async p=>{const h=document.createElement("div");h.className="placed-title";const v=(d.value||"").trim();if(h.textContent=p?v||o:u,d.replaceWith(h),!!p&&v!==u&&!(!i.currentUser||!i.activeSemesterId))try{const S=E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",s.id);await R(S,v?{displayName:v}:{displayName:null});const I=V.findIndex(D=>D.id===s.id);I>=0&&(V[I].displayName=v||null)}catch(S){console.error("rename error",S),alert("No se pudo renombrar el bloque. Intenta nuevamente."),h.textContent=u}};d.addEventListener("keydown",p=>{p.key==="Enter"&&(p.preventDefault(),f(!0)),p.key==="Escape"&&(p.preventDefault(),f(!1))}),d.addEventListener("blur",()=>f(!0))})}function Va(){document.addEventListener("contextmenu",async e=>{const t=e.target.closest(".placed");if(!t||!t.closest("#schedUSM"))return;e.preventDefault();const a=t.dataset.id,r=V.find(u=>u.id===a);if(!r||!i.currentUser||!i.activeSemesterId)return;const s=(r.room||"").trim(),l=prompt("Sala del ramo (deja vac√≠o para borrar):",s);if(l===null)return;const o=(l||"").trim();try{const u=E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",r.id);await R(u,{room:o||null});const d=V.findIndex(m=>m.id===r.id);d>=0&&(V[d].room=o||null),Le()}catch(u){console.error("room update error",u),alert("No se pudo actualizar la sala. Intenta nuevamente.")}})}function Gn(){document.querySelectorAll(".cell.slot").forEach(e=>{e.classList.contains("is-lunch")||(e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect=t.dataTransfer.effectAllowed==="move"?"move":"copy";const n=e.getBoundingClientRect(),a=t.clientX-n.left,r=t.clientY-n.top,s=n.height/2;let l="full";r<s-10?l="top":r>s+10&&(l="bottom");let o="single";const u=a/n.width;u<.4?o="left":u>.6&&(o="right"),e.dataset.droppos=l,e.dataset.droph=o,e.classList.add("over"),e.classList.remove("hint-top","hint-full","hint-bottom","hint-left","hint-center","hint-right"),l==="top"&&e.classList.add("hint-top"),l==="full"&&e.classList.add("hint-full"),l==="bottom"&&e.classList.add("hint-bottom"),o==="left"&&e.classList.add("hint-left"),o==="single"&&e.classList.add("hint-center"),o==="right"&&e.classList.add("hint-right")}),e.addEventListener("dragleave",()=>ce(e)),e.addEventListener("drop",async t=>{t.preventDefault();const n=t.dataTransfer.getData("text/plain");if(!n)return;const a=parseInt(e.dataset.day,10),r=parseInt(e.dataset.slot,10),s=e.dataset.droppos||"full",l=e.dataset.droph||"single";let o=null;try{o=JSON.parse(n)}catch{}if(o&&o.type==="move-block"){const p=o.id;if(!V.find(v=>v.id===p))return;if(!i.currentUser||!i.activeSemesterId){alert("Selecciona un semestre activo antes de mover bloques."),ce(e);return}try{const v=E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",p),S=_t()[r];await R(v,{day:a,slot:r,pos:s,hpos:l,start:S.start,end:S.end,updatedAt:Date.now()});const w=V.findIndex(I=>I.id===p);w>=0&&Object.assign(V[w],{day:a,slot:r,pos:s,hpos:l,start:S.start,end:S.end}),Le()}catch(v){console.error("move error",v),alert("No se pudo mover el bloque (error Firestore): "+((v==null?void 0:v.message)||v))}ce(e);return}const u=n;if(!i.currentUser||!i.activeSemesterId){alert("Selecciona un semestre."),ce(e);return}const m=V.filter(p=>p.day===a&&p.slot===r).filter(p=>(p.pos||"full")===s);if(m.length>=2){alert("Esta zona ya tiene dos ramos (izq/der)."),ce(e);return}if(m.length===1){const p=m[0],h=p.hpos||"single";if(s==="full"&&l==="single"){alert("Ya hay un ramo aqu√≠. Elige izquierda o derecha."),ce(e);return}if(h==="single"){const v=l==="left"?"right":"left";try{await R(E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule",p.id),{hpos:v})}catch{}}else if(h===l){alert("Ese lado ya est√° ocupado. Prueba el otro lado."),ce(e);return}}const f=_t()[r];await Pe(x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"schedule"),{courseId:u,day:a,slot:r,start:f.start,end:f.end,pos:s,hpos:l,createdAt:Date.now()}),ce(e)}))})}function ce(e){e.classList.remove("over","hint-top","hint-full","hint-bottom","hint-left","hint-center","hint-right"),delete e.dataset.droppos,delete e.dataset.droph}let Xe=null,gt=[],et=null,yt=[],Ft=Te,je="USM";function Wa(){const e=c("horarioCompartido");e&&(e.innerHTML=`
    <div class="card" style="margin-bottom:12px">
      <div class="row" style="align-items:flex-end;gap:12px">
        <div>
          <label>Semestre de la otra persona</label><br/>
          <select id="sh-semSel"></select>
        </div>
        <div class="muted">Elige un semestre (ej. 2025-2) para ver el horario de la otra persona en vivo.</div>
      </div>
    </div>
    <div id="schedSharedUSM" class="sched-usm card"></div>
  `,Fe())}function Fe(){const e=c("schedSharedUSM");if(!e)return;const t=Ft||Te;Rt=t;const n=je==="USM"?"Bloque":"M√≥dulo";e.innerHTML=`
    <div class="usm-grid2">
      <div class="cell header">${n}</div>
      ${Ye.map(a=>`<div class="cell header">${a}</div>`).join("")}
      ${t.map((a,r)=>`
        <div class="cell mod ${a.lunch?"lunch":""}" data-slot="${r}">
          ${zn(a,r,je)}
        </div>
        ${Ye.map((s,l)=>`
          <div class="cell slot ${a.lunch?"is-lunch":""}"
               data-day="${l}" data-slot="${r}">
            ${Za(l,r)}
          </div>
        `).join("")}
      `).join("")}
    </div>
  `}function Za(e,t){const n=gt.filter(r=>r.day===e&&r.slot===t),a=r=>{const s=n.filter(o=>(o.pos||"full")===r);return s.length?s.sort((o,u)=>{const d={left:0,single:1,right:2};return(d[o.hpos||"single"]??1)-(d[u.hpos||"single"]??1)}).map(o=>Ja(o,r)).join(""):""};return`
    ${a("top")}
    ${a("full")}
    ${a("bottom")}
  `}function Ja(e,t,n,a){const r=yt||[],s=r.find(p=>p.id===e.courseId),l=(s==null?void 0:s.name)||"Ramo",o=typeof e.displayName=="string"&&e.displayName.trim()?e.displayName.trim():l,u=Gt(r,e.courseId,vt),d=Vt(u),m=typeof e.room=="string"&&e.room.trim()?e.room.trim():null,f=e.hpos||"single";return`
  <div class="placed pos-${t} h-${f}"
       title="${o}${m?` ¬∑ Sala: ${m}`:""}"
       style="background:${u}; border:1px solid rgba(0,0,0,0.25); margin:2px 0;">
    <div class="placed-title" style="color:${d}; font-weight:600;">${o}</div>
  </div>
`}async function lt(e){var o;Xe&&(Xe(),Xe=null),et&&(et(),et=null),Ke&&(Ke(),Ke=null),gt=[],yt=[],Ft=Te,je="USM",Fe(),pt=((o=i.profileData)==null?void 0:o.favoriteColor)||pt;const t=i.pairOtherUid;if(!t||!e)return;const n=E(g,"users",t,"semesters",e),a=await Y(n),r=a.exists()&&a.data().universityAtThatTime||"";je=Hn(r),Ft=je==="UMAYOR"?zt:Te,Ke=F(E(g,"users",t),u=>{vt=(u.data()||{}).favoriteColor||vt,Fe()});const s=x(g,"users",t,"semesters",e,"courses");et=F(Z(s,Ce("name")),u=>{yt=u.docs.map(d=>({id:d.id,...d.data()})),Fe()});const l=x(g,"users",t,"semesters",e,"schedule");Xe=F(Z(l),u=>{gt=u.docs.map(d=>({id:d.id,...d.data()})),Fe()})}let gn=0;async function yn(){var p,h;const e=c("sh-semSel");if(!e)return;const t=++gn,n=v=>String(v||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim(),a=v=>{const S=n(v),w=S.replace(/[^\d\-\/ ]+/g,"").match(/(\d{4})\D*([12])$/);return w?`${w[1]}-${w[2]}`:S.toLowerCase()},r=v=>{const S=/^(\d{4})-(1|2)$/.exec(a(v));return S?{y:parseInt(S[1],10),t:parseInt(S[2],10)}:{y:-1/0,t:-1/0}};e.innerHTML="";const s=document.createElement("option");if(s.value="",s.textContent="‚Äî seleccionar ‚Äî",e.appendChild(s),!i.pairOtherUid)return;const l=x(g,"users",i.pairOtherUid,"semesters"),o=await O(Z(l));if(t!==gn)return;const u=new Map;o.forEach(v=>{const S=v.data()||{},w=n(S.label||v.id),I=a(w);if(!u.has(I)){const{y:D,t:P}=r(w);u.set(I,{id:v.id,labelToShow:w,y:D,t:P})}});const d=Array.from(u.values()).sort((v,S)=>v.y!==S.y?S.y-v.y:S.t-v.t),m=document.createDocumentFragment();for(const{id:v,labelToShow:S}of d){const w=document.createElement("option");w.value=v,w.textContent=S,m.appendChild(w)}e.appendChild(m);const f=((h=(p=i.shared)==null?void 0:p.horario)==null?void 0:h.semId)||"";if(f&&Array.from(e.options).some(v=>v.value===f))e.value=f;else{const v=Array.from(e.options).find(S=>S.value);e.value=v?v.value:"",i.shared.horario.semId=e.value||null}}async function tt(){var t;if(!i.pairOtherUid)return;const e=((t=i.activeSemesterData)==null?void 0:t.label)||null;if(e)try{const n=x(g,"users",i.pairOtherUid,"semesters"),a=await O(n);let r=null;if(a.forEach(s=>{var o;const l=(((o=s.data())==null?void 0:o.label)||"").trim();l===e&&(r={id:s.id,label:l})}),r&&(i.shared=i.shared||{},i.shared.horario=i.shared.horario||{},i.shared.horario.semId!==r.id)){i.shared.horario.semId=r.id;const s=c("sh-semSel");s&&(s.innerHTML=`<option selected>${r.label}</option>`,s.disabled=!0,s.style.pointerEvents="none",s.style.opacity="0.7"),await lt(r.id),document.getElementById("horarioCombinado")&&Zt()}}catch(n){console.warn("autoSelectPartnerSemesterForSchedule",n)}}async function Ka({course:e,day:t,slot:n,room:a}){if(!i.currentUser||!i.activeSemesterId)throw new Error("No logueado");const r=i.activeSemesterId,s=i.currentUser.uid,l=(i.courses||[]).find(m=>(m.name||"").toLowerCase().includes(String(e).toLowerCase()));if(!l)throw new Error("Curso no encontrado");const o=x(g,"users",s,"semesters",r,"schedule"),d=(await O(o)).docs.find(m=>{const f=m.data();return f.courseId===l.id&&f.day===t&&f.slot===n});if(!d)throw new Error("No encontr√© el bloque en el horario");return await R(d.ref,{room:a||null,updatedAt:Date.now()}),{ok:!0,room:a}}async function Qa(e=null){if(!i.currentUser)throw new Error("No logueado");const t=e||i.activeSemesterId;if(!t)throw new Error("No hay semestre activo");const n=x(g,"users",i.currentUser.uid,"semesters",t,"schedule");return(await O(n)).docs.map(r=>({id:r.id,...r.data()}))}async function Xa(e=null){if(!i.currentUser)throw new Error("No logueado");const t=e||i.activeSemesterId;if(!t)throw new Error("No hay semestre activo");if(!i.pairOtherUid)return{items:[]};const n=x(g,"users",i.currentUser.uid,"semesters",t,"schedule"),r=(await O(n)).docs.map(d=>({...d.data()})),s=x(g,"users",i.pairOtherUid,"semesters",t,"schedule"),o=(await O(s)).docs.map(d=>({...d.data()})),u=[];for(const d of r)for(const m of o)d.day===m.day&&d.slot===m.slot&&u.push(`${["Lun","Mar","Mi√©","Jue","Vie"][d.day]} bloque ${d.slot} (${d.courseName} / ${m.courseName})`);return{items:u}}async function er(e,t=null){if(!i.currentUser)throw new Error("No logueado");const n=t||i.activeSemesterId;return await te(E(g,"users",i.currentUser.uid,"semesters",n,"schedule",e)),{ok:!0}}document.addEventListener("dragstart",e=>{const t=e.target.closest(".placed");t&&t.classList.add("dragging")});document.addEventListener("dragend",e=>{const t=e.target.closest(".placed");t&&t.classList.remove("dragging")});const bn=8*60,tr=22*60;function Sn(e){const[t,n]=e.split(":").map(Number);return t*60+n}function En(e){return(e-bn)/(tr-bn)*100}function Zt(){const e=c("horarioCombinado");e&&(e.innerHTML=`
    <div class="timeline">
      <div class="timeline-hours">
        ${Array.from({length:15},(t,n)=>`<div class="timeline-hour">${8+n}:00</div>`).join("")}
      </div>
      ${Ye.map((t,n)=>`
        <div class="timeline-day" data-day="${n}" title="${t}">
          ${nr(n)}
        </div>
      `).join("")}
    </div>
  `)}function nr(e){return[...(V||[]).map(a=>({...a,isMine:!0})),...(gt||[]).map(a=>({...a,isMine:!1}))].filter(a=>a.day===e).map(a=>{const r=Sn(a.start),s=Sn(a.end),l=En(r),o=En(s)-l,u=a.isMine?i.courses:yt,d=Gt(u,a.courseId,a.isMine?pt:vt),m=Vt(d),f=u.find(S=>S.id===a.courseId),p=a.displayName||(f==null?void 0:f.name)||"Ramo",h=a.room?` (${a.room})`:"",v=a.isMine?1:.6;return`
      <div class="timeline-block"
           style="top:${l}%;height:${o}%;
                  background:${d};opacity:${v};color:${m};">
        ${p}${h}
      </div>
    `}).join("")}document.addEventListener("DOMContentLoaded",()=>{const e=c("subtabCombinado"),t=c("subtabCompartido"),n=c("subtabPropio"),a=c("horarioCombinado"),r=c("horarioCompartido"),s=c("horarioPropio");e&&(e.classList.remove("hidden"),e.addEventListener("click",()=>{n==null||n.classList.remove("active"),t==null||t.classList.remove("active"),e.classList.add("active"),s==null||s.classList.add("hidden"),r==null||r.classList.add("hidden"),a==null||a.classList.remove("hidden"),Zt()}))});document.addEventListener("auth:ready",()=>{setTimeout(()=>{console.log("[schedule] auth:ready ‚Üí initSchedule()"),Yn(),Oe()},1e3)});document.addEventListener("semester:changed",()=>{console.log("[schedule] semester:changed ‚Üí onActiveSemesterChanged()"),Oe()});const wn=Object.freeze(Object.defineProperty({__proto__:null,MAYOR_SLOTS:zt,USM_SLOTS:Te,getMySchedule:Qa,initSchedule:Yn,onActiveSemesterChanged:Oe,overlapWithPair:Xa,refreshCourseOptions:ja,removeBlock:er,setRoom:Ka},Symbol.toStringTag,{value:"Module"}));let N=new Date,ye=null,bt=[],Bt=!1,Be=null,dt=null,ut=null,be=null,ze=[],St=[],Ge="#ff69b4";function ar(e){Be=e}function rr(){try{Be==null||Be()}finally{Be=null}}function sr(){const e=c("page-calendario");if(e){e.classList.add("hidden");const t=e.querySelector("[data-cal-grid]")||e.querySelector(".cal-grid");t&&(t.innerHTML="")}}function ir(){var e;(e=c("page-calendario"))==null||e.classList.remove("hidden")}function Jt(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function Kt(e,t="#3B82F6"){const n=(i.courses||[]).find(a=>a.id===e);return Jt(n==null?void 0:n.color)?n.color:t}function Vn(e,t=Ge){const n=(St||[]).find(a=>a.id===e);return Jt(n==null?void 0:n.color)?n.color:t}function Qt(e){try{const t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return(t*299+n*587+a*114)/1e3>=160?"#111":"#fff"}catch{return"#0e0e0e"}}function Wn(){Bt||(Bt=!0,cr(),lr(),en(),qe(),fe(),Zn(),Jn(),document.addEventListener("pair:ready",Cn),Cn(),Et(),dr())}function Ve(){Bt||Wn()}function we(){Ve(),ye&&(ye(),ye=null),Zn(),Jn(),qe(),fe(),Et()}function or(){Ve(),wt(),We()}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",Ve):Ve();document.addEventListener("route:calendario",Ve);function cr(){const e=c("page-calendario");e&&(e.innerHTML=`
    <div class="card">
      <div class="cal-head">
        <div class="cal-left">
          <button id="calPrev" class="ghost" title="Mes anterior">‚óÄ</button>
          <button id="calToday" class="ghost" title="Ir a hoy">Hoy</button>
          <button id="calNext" class="ghost" title="Mes siguiente">‚ñ∂</button>
          <h3 id="calTitle" style="margin:0 0 0 10px">Calendario</h3>
        </div>
        <div class="cal-right muted">
          Semestre activo: <b id="calActiveSem">‚Äî</b>
        </div>
      </div>

      <div class="subtabs" style="margin-bottom:10px; display:flex; gap:8px;">
        <button id="cal-subtab-propio" class="tab small active">Propio</button>
        <button id="cal-subtab-compartido" class="tab small">Duo</button>
          <button id="cal-subtab-combinado" class="tab small">Combinado</button>

      </div>

      <div id="cal-propio">
        <div class="cal-grid" id="calGrid" aria-live="polite"></div>
        <div class="muted" style="margin-top:8px">
          Haz clic en un d√≠a para agregar un evento.
        </div>
      </div>

      <div id="cal-compartido" class="hidden">
        <div class="card" style="margin-bottom:12px">
          <div class="row" style="align-items:flex-end; gap:12px;">
            <div>
              <label>Semestre de tu duo</label><br/>
              <select id="shc-semSel"></select>
            </div>
         
          </div>
        </div>
        <div class="cal-grid" id="calSharedGrid"></div>
        <div class="muted" id="calSharedHint" style="margin-top:8px"></div>
      </div>

      <div id="cal-combinado" class="hidden">
  <div id="calCombinedGrid" class="cal-grid"></div>
</div>


    </div>
  `)}function lr(){var e,t,n;(e=c("calPrev"))==null||e.addEventListener("click",()=>{N=Ln(N,-1),nt(),qe(),fe()}),(t=c("calNext"))==null||t.addEventListener("click",()=>{N=Ln(N,1),nt(),qe(),fe()}),(n=c("calToday"))==null||n.addEventListener("click",()=>{N=new Date,nt(),qe(),fe()}),nt()}function nt(){const e=N.getFullYear(),t=N.getMonth(),n=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],a=c("calTitle");a&&(a.textContent=`Calendario ¬∑ ${n[t][0].toUpperCase()}${n[t].slice(1)} ${e}`)}function Zn(){var t;const e=c("calActiveSem");e&&(e.textContent=((t=i.activeSemesterData)==null?void 0:t.label)||"‚Äî")}function dr(){const e=c("cal-subtab-propio"),t=c("cal-subtab-compartido"),n=c("cal-subtab-combinado"),a=c("cal-propio"),r=c("cal-compartido"),s=c("cal-combinado");function l(){e.classList.add("active"),t.classList.remove("active"),n.classList.remove("active"),a.classList.remove("hidden"),r.classList.add("hidden"),s.classList.add("hidden")}async function o(){var d,m;if(t.classList.add("active"),e.classList.remove("active"),n.classList.remove("active"),r.classList.remove("hidden"),a.classList.add("hidden"),s.classList.add("hidden"),await Et(),fe(),!i.pairOtherUid){c("calSharedHint").textContent="Empareja tu cuenta para ver el calendario de tu duo.";return}c("calSharedHint").textContent="",await Qn(),(m=(d=i.shared)==null?void 0:d.calendar)!=null&&m.semId&&Xt(i.shared.calendar.semId)}async function u(){await Et(),n.classList.add("active"),e.classList.remove("active"),t.classList.remove("active"),s.classList.remove("hidden"),a.classList.add("hidden"),r.classList.add("hidden"),fr(),await vr()}e==null||e.addEventListener("click",l),t==null||t.addEventListener("click",o),n==null||n.addEventListener("click",u),l()}function Jn(){if(ye&&(ye(),ye=null),bt=[],wt(),!i.currentUser||!i.activeSemesterId)return;const e=x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"calendar");ye=F(Z(e,Ce("date","asc")),t=>{bt=t.docs.map(n=>({id:n.id,...n.data()})),wt()})}async function Cn(){if(Kn(),ze=[],St=[],Ge="#ff69b4",fe(),!i.pairOtherUid){const e=c("shc-semSel");e&&(e.innerHTML='<option value="">‚Äî</option>'),c("calSharedHint").textContent="Empareja tu cuenta para ver el calendario de tu duo.";return}c("calSharedHint").textContent="",await Qn(),be&&(be(),be=null),be=F(E(g,"users",i.pairOtherUid),e=>{const t=e.data()||{};Ge=Jt(t.favoriteColor)?t.favoriteColor:"#ff69b4",We()})}async function Et(){var t;if(!i.pairOtherUid)return;const e=((t=i.activeSemesterData)==null?void 0:t.label)||null;if(e)try{const n=x(g,"users",i.pairOtherUid,"semesters"),a=await O(n);let r=null;if(a.forEach(s=>{var o;const l=(((o=s.data())==null?void 0:o.label)||"").trim();l===e&&(r={id:s.id,label:l})}),r&&(i.shared=i.shared||{},i.shared.calendar=i.shared.calendar||{},i.shared.calendar.semId!==r.id)){i.shared.calendar.semId=r.id;const s=c("shc-semSel");s&&(s.innerHTML=`<option selected>${r.label}</option>`,s.disabled=!0,s.style.pointerEvents="none",s.style.opacity="0.7"),Xt(r.id)}}catch(n){console.warn("autoSelectPartnerSemesterForCalendar",n)}}function Kn(){dt&&(dt(),dt=null),ut&&(ut(),ut=null),be&&(be(),be=null)}async function Qn(){var a;const e=c("shc-semSel");if(!e)return;e.innerHTML="<option selected disabled>Cargando‚Ä¶</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";const t=i.pairOtherUid;if(!t){e.innerHTML="<option selected>No disponible</option>";return}const n=((a=i.activeSemesterData)==null?void 0:a.label)||null;if(!n){e.innerHTML="<option selected>No disponible</option>";return}try{const r=x(g,"users",t,"semesters"),s=await O(r);let l=null;if(s.forEach(o=>{var d;const u=(((d=o.data())==null?void 0:d.label)||"").trim();u===n&&(l={id:o.id,label:u})}),l)e.innerHTML=`<option selected>${l.label}</option>`,i.shared.calendar=i.shared.calendar||{},i.shared.calendar.semId=l.id,Xt(l.id),c("calSharedHint").textContent="";else{e.innerHTML="<option selected>No disponible</option>",i.shared.calendar=i.shared.calendar||{},i.shared.calendar.semId=null;const o=c("calSharedGrid");o&&(o.innerHTML=`<div class="muted">Tu d√∫o no tiene el semestre <b>${n}</b> creado.</div>`),c("calSharedHint").textContent="Sincronizado con tu semestre activo."}e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7"}catch(r){console.error("populateSharedSemesters error",r),e.innerHTML="<option selected>Error al cargar</option>"}}async function Xt(e){Kn(),ze=[],St=[],fe();const t=i.pairOtherUid;if(!t||!e)return;const n=x(g,"users",t,"semesters",e,"courses");ut=F(Z(n,Ce("name")),r=>{St=r.docs.map(s=>({id:s.id,...s.data()})),We()});const a=x(g,"users",t,"semesters",e,"calendar");dt=F(Z(a,Ce("date","asc")),r=>{ze=r.docs.map(s=>({id:s.id,...s.data()})),We()})}function en(){if(c("calModal"))return;const e=document.createElement("div");e.id="calModal",e.className="modal",e.innerHTML=`
    <div class="modal-backdrop" id="calModalBackdrop"></div>
    <div class="modal-content">
      <h3 id="calModalTitle" style="margin-top:0">Nuevo evento</h3>

      <div class="row" style="gap:10px">
        <div style="flex:1">
          <label>T√≠tulo</label>
          <input type="text" id="calEvtTitle" placeholder="Ej. Prueba 1 ELO212"/>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Fecha</label>
          <input type="date" id="calEvtDate"/>
        </div>
        <div style="flex:1">
          <label>Ramo</label>
          <select id="calEvtCourse">
            <option value="">(Sin asignar)</option>
          </select>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Inicio</label>
          <input type="time" id="calEvtStart"/>
        </div>
        <div style="flex:1">
          <label>T√©rmino</label>
          <input type="time" id="calEvtEnd"/>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:8px">
        <div style="flex:1">
          <label>Repetir cada</label>
          <select id="calEvtRepeat">
            <option value="">(Sin repetici√≥n)</option>
            <option value="day">D√≠a</option>
            <option value="month">Mes</option>
            <option value="year">A√±o</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Persistencia</label>
          <select id="calEvtPersistent">
            <option value="">Solo este semestre</option>
            <option value="true">Mantener en semestres futuros</option>
          </select>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end; gap:10px; margin-top:16px">
        <button class="ghost" id="calEvtCancel">Cancelar</button>
        <button class="primary" id="calEvtSave">Guardar</button>
      </div>
    </div>
  `,document.body.appendChild(e);const t=()=>e.classList.remove("active");c("calModalBackdrop").addEventListener("click",t),c("calEvtCancel").addEventListener("click",t),c("calEvtSave").addEventListener("click",async()=>{if(!i.currentUser||!i.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}const n=(c("calEvtTitle").value||"").trim(),a=c("calEvtDate").value||"",r=c("calEvtStart").value||null,s=c("calEvtEnd").value||null,l=c("calEvtCourse").value||null,o=c("calEvtRepeat").value||"",u=c("calEvtPersistent").value==="true",d=l?Kt(l):null;if(!n)return alert("Ingresa un t√≠tulo.");if(!a)return alert("Selecciona una fecha.");const m=e.dataset.editingId||null,f=x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"calendar");try{m?(await R(E(f,m),{title:n,date:a,start:r,end:s,courseId:l,color:d,repeat:o?{every:o,interval:1}:null,persistent:u,updatedAt:Date.now()}),console.log("[Calendar] Evento actualizado:",n)):(await Pe(f,{title:n,date:a,start:r,end:s,courseId:l,color:d,repeat:o?{every:o,interval:1}:null,persistent:u,createdAt:Date.now()}),console.log("[Calendar] Evento creado:",n)),t()}catch(p){console.error(p),alert("No se pudo guardar el evento.")}finally{e.dataset.editingId=""}})}function ur(e){if(!i.currentUser||!i.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}en();const t=c("calEvtDate");t&&(t.value=e);const n=c("calEvtTitle");n&&(n.value="");const a=c("calEvtStart");a&&(a.value="");const r=c("calEvtEnd");r&&(r.value="");const s=c("calEvtCourse");s&&(s.innerHTML='<option value="">(Sin asignar)</option>',(i.courses||[]).forEach(l=>{const o=document.createElement("option");o.value=l.id,o.textContent=l.name,s.appendChild(o)})),c("calModal").classList.add("active")}function qe(){const e=c("calGrid");if(!e)return;const n=(new Date(N.getFullYear(),N.getMonth(),1).getDay()+6)%7,a=new Date(N.getFullYear(),N.getMonth()+1,0).getDate(),r=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${r.map(s=>`<div class="cal-cell head">${s}</div>`).join("")}
    ${Array.from({length:n}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((s,l)=>{const o=l+1,u=Ut(N.getFullYear(),N.getMonth()+1,o);return`
        <div class="cal-cell day" data-date="${u}">
          <div class="cal-daynum">${o}</div>
          <div class="cal-events" id="ce-${u}"></div>
        </div>
      `}).join("")}
  `,e.querySelectorAll(".cal-cell.day").forEach(s=>{s.addEventListener("click",()=>ur(s.dataset.date))}),wt()}function mr(e){var s;if(!i.currentUser||!i.activeSemesterId){alert('Primero activa un semestre en la pesta√±a "Semestres".');return}en();const t=c("calModal"),n=c("calModalTitle"),a=c("calEvtSave");t.dataset.editingId=e.id,n.textContent="Editar evento",a.textContent="Guardar cambios",c("calEvtTitle").value=e.title||"",c("calEvtDate").value=e.date||"",c("calEvtStart").value=e.start||"",c("calEvtEnd").value=e.end||"",c("calEvtRepeat").value=((s=e.repeat)==null?void 0:s.every)||"",c("calEvtPersistent").value=e.persistent?"true":"";const r=c("calEvtCourse");r.innerHTML='<option value="">(Sin asignar)</option>',(i.courses||[]).forEach(l=>{const o=document.createElement("option");o.value=l.id,o.textContent=l.name,l.id===e.courseId&&(o.selected=!0),r.appendChild(o)}),t.classList.add("active")}function fe(){const e=c("calSharedGrid");if(!e)return;const n=(new Date(N.getFullYear(),N.getMonth(),1).getDay()+6)%7,a=new Date(N.getFullYear(),N.getMonth()+1,0).getDate(),r=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${r.map(s=>`<div class="cal-cell head">${s}</div>`).join("")}
    ${Array.from({length:n}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((s,l)=>{const o=l+1,u=Ut(N.getFullYear(),N.getMonth()+1,o);return`
        <div class="cal-cell day" data-date="${u}">
          <div class="cal-daynum">${o}</div>
          <div class="cal-events" id="sce-${u}"></div>
        </div>
      `}).join("")}
  `,We()}function fr(){const e=c("calCombinedGrid");if(!e)return;const n=(new Date(N.getFullYear(),N.getMonth(),1).getDay()+6)%7,a=new Date(N.getFullYear(),N.getMonth()+1,0).getDate(),r=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];e.innerHTML=`
    ${r.map(s=>`<div class="cal-cell head">${s}</div>`).join("")}
    ${Array.from({length:n}).map(()=>'<div class="cal-cell empty"></div>').join("")}
    ${Array.from({length:a}).map((s,l)=>{const o=l+1,u=Ut(N.getFullYear(),N.getMonth()+1,o);return`
        <div class="cal-cell day" data-date="${u}">
          <div class="cal-daynum">${o}</div>
          <div class="cal-events" id="bce-${u}"></div>
        </div>
      `}).join("")}
  `,pr()}function pr(){document.querySelectorAll(".cal-events").forEach(n=>{var a;(a=n.id)!=null&&a.startsWith("bce-")&&(n.innerHTML="")});const e=`${N.getFullYear()}-${String(N.getMonth()+1).padStart(2,"0")}`;[...bt.filter(n=>String(n.date||"").startsWith(e)).map(n=>({...n,isMine:!0})),...ze.filter(n=>String(n.date||"").startsWith(e)).map(n=>({...n,isMine:!1}))].forEach(n=>{const a=c("bce-"+n.date);if(!a)return;const r=n.color||(n.isMine?Kt(n.courseId):Vn(n.courseId,Ge)),s=Qt(r),l=n.start&&n.end?`${n.start}‚Äì${n.end} ¬∑ `:n.start?`${n.start} ¬∑ `:"",o=document.createElement("div");o.className="cal-evt",o.textContent=`${l}${n.title||"(sin t√≠tulo)"}`,o.style.background=r,o.style.color=s,o.style.opacity=n.isMine?1:.65,o.style.border="1px solid rgba(0,0,0,0.25)",a.appendChild(o)})}async function vr(){const e=c("calCombinedRemindersList");if(e){e.innerHTML='<div class="loading"></div>';try{const t=await Xn({range:"today"}),n=i.pairOtherUid?await ea({range:"today"}):[],a=[...t.map(r=>({...r,owner:"T√∫"})),...n.map(r=>({...r,owner:"D√∫o"}))].sort((r,s)=>(r.datetime||0)-(s.datetime||0));e.innerHTML=a.length?a.map(r=>{var s;return`
          <div class="grade-item">
            <div>
              <strong>${r.title||"(sin t√≠tulo)"}</strong>
              <div class="muted">${r.owner} ¬∑ ${((s=r.datetime)==null?void 0:s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))||""}</div>
            </div>
          </div>
        `}).join(""):'<div class="muted">Sin recordatorios para hoy.</div>'}catch(t){console.error("loadCombinedReminders",t),e.innerHTML='<div class="muted">Error al cargar recordatorios.</div>'}}}function hr(e){var a;const t=[];for(const r of e)if(t.push(r),(a=r.repeat)!=null&&a.every){const s=new Date(r.date);for(let l=1;l<=24;l++){const o=new Date(s);r.repeat.every==="day"?o.setDate(s.getDate()+l*(r.repeat.interval||1)):r.repeat.every==="month"?o.setMonth(s.getMonth()+l*(r.repeat.interval||1)):r.repeat.every==="year"&&o.setFullYear(s.getFullYear()+l*(r.repeat.interval||1));const u=Ut(o.getFullYear(),o.getMonth()+1,o.getDate());if(Math.abs(o-s)/(1e3*60*60*24)>365)break;t.push({...r,date:u})}}return t}function wt(){document.querySelectorAll(".cal-events").forEach(n=>{var a;(a=n.id)!=null&&a.startsWith("sce-")||(n.innerHTML="")});const e=`${N.getFullYear()}-${String(N.getMonth()+1).padStart(2,"0")}`;hr(bt).filter(n=>String(n.date||"").startsWith(e)).forEach(n=>{const a=c("ce-"+n.date);if(!a)return;const r=n.color||Kt(n.courseId)||"#1f2937",s=Qt(r),l=n.start&&n.end?`${n.start}‚Äì${n.end} ¬∑ `:n.start?`${n.start} ¬∑ `:"",o=document.createElement("div");o.className="cal-evt",o.style.background=r,o.style.color=s,o.style.border="1px solid rgba(0,0,0,0.25)",o.style.position="relative",o.style.cursor="pointer";const u=document.createElement("span");u.textContent=`${l}${n.title||"(sin t√≠tulo)"}`,o.appendChild(u);const d=document.createElement("span");d.textContent="‚úï",d.className="cal-del",d.title="Eliminar evento",d.style.position="absolute",d.style.top="2px",d.style.right="4px",d.style.fontWeight="bold",d.style.color="#fff8",d.style.cursor="pointer",d.addEventListener("click",async m=>{if(m.stopPropagation(),!(!i.currentUser||!i.activeSemesterId||!n.id)&&confirm(`¬øEliminar evento "${n.title}"?`))try{await te(E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"calendar",n.id))}catch(f){console.error(f)}}),o.appendChild(d),o.addEventListener("click",m=>{m.stopPropagation(),mr(n)}),a.appendChild(o)})}function We(){document.querySelectorAll(".cal-events").forEach(n=>{var a;(a=n.id)!=null&&a.startsWith("sce-")&&(n.innerHTML="")});const e=`${N.getFullYear()}-${String(N.getMonth()+1).padStart(2,"0")}`;ze.filter(n=>String(n.date||"").startsWith(e)).forEach(n=>{const a=c("sce-"+n.date);if(!a)return;const r=n.color||(n.courseId?Vn(n.courseId):Ge),s=Qt(r),l=n.start&&n.end?`${n.start}‚Äì${n.end} ¬∑ `:n.start?`${n.start} ¬∑ `:"",o=document.createElement("div");o.className="cal-evt",o.textContent=`${l}${n.title||"(sin t√≠tulo)"}`,o.style.background=r,o.style.color=s,o.style.border="1px solid rgba(0,0,0,0.25)",a.appendChild(o)})}function Ln(e,t){const n=new Date(e.getTime());return n.setMonth(n.getMonth()+t),n}function Ut(e,t,n){return`${e}-${String(t).padStart(2,"0")}-${String(n).padStart(2,"0")}`}async function Xn({range:e="today"}){if(!i.currentUser)throw new Error("No logueado");const t=x(g,"users",i.currentUser.uid,"reminders"),n=await O(t),a=new Date;let r=n.docs.map(s=>({id:s.id,...s.data()}));return r=r.filter(s=>!s.suspended),e==="today"?r=r.filter(s=>isToday(s.datetime,a)):e==="week"?r=r.filter(s=>isThisWeek(s.datetime,a)):e==="month"&&(r=r.filter(s=>isThisMonth(s.datetime,a))),r}async function gr(e){if(!i.currentUser)throw new Error("No logueado");const t=E(g,"users",i.currentUser.uid,"reminders",e);return await R(t,{suspended:!1,updatedAt:Date.now()}),{ok:!0}}async function yr(){if(!i.currentUser)throw new Error("No logueado");const e=x(g,"users",i.currentUser.uid,"reminders"),t=Z(e,Rn("suspended","==",!0));return(await O(t)).docs.map(a=>({id:a.id,...a.data()}))}async function br({reminderId:e}){if(!i.currentUser)throw new Error("No logueado");if(!e)throw new Error("Falta ID");const t=E(g,"users",i.currentUser.uid,"reminders",e);return await R(t,{suspended:!0,updatedAt:Date.now()}),{ok:!0}}async function ea({range:e="today"}={}){if(!i.pairOtherUid)throw new Error("No tienes d√∫o");const t=x(g,"users",i.pairOtherUid,"reminders"),n=await O(t),a=l=>l?typeof l=="number"?new Date(l):l.toDate?l.toDate():new Date(l):null,r=n.docs.map(l=>{const o=l.data();return{id:l.id,...o,datetime:a(o.datetime)}}),s=new Date;if(e==="today"){const l=new Date(s.getFullYear(),s.getMonth(),s.getDate()),o=new Date(s.getFullYear(),s.getMonth(),s.getDate()+1);return r.filter(u=>u.datetime&&u.datetime>=l&&u.datetime<o)}if(e==="week"){const l=new Date(s.getFullYear(),s.getMonth(),s.getDate()-s.getDay()),o=new Date(l);return o.setDate(l.getDate()+7),r.filter(u=>u.datetime&&u.datetime>=l&&u.datetime<o)}return r}const xn=Object.freeze(Object.defineProperty({__proto__:null,clearCalendarUI:sr,initCalendar:Wn,listPairReminders:ea,listReminders:Xn,listSuspendedReminders:yr,onActiveSemesterChanged:we,onCoursesChanged:or,registerCalendarUnsub:ar,resumeReminder:gr,showCalendarUI:ir,stopCalendarSub:rr,suspendReminder:br},Symbol.toStringTag,{value:"Module"}));let at=null;function tn(){if(!i.currentUser||!i.activeSemesterId)return;const e=x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses");F(e,t=>{const n=t.docs.filter(r=>r.data().asistencia),a=c("attCourseSel");a&&(a.innerHTML='<option value="" disabled selected>Elige un ramo‚Ä¶</option>',n.forEach(r=>{a.innerHTML+=`<option value="${r.id}">${r.data().name}</option>`})),a==null||a.addEventListener("change",()=>{const r=a.value,s=n.find(l=>l.id===r);Sr(s?[s]:[])})})}function Sr(e){const t=c("asistenciaList");t&&(t.innerHTML="",e.forEach(n=>{const a=n.data(),r=document.createElement("div");r.className="card",r.innerHTML=`
      <h4>${a.name}</h4>
      <div class="att-days" data-id="${n.id}"></div>
      <div class="muted">Asistencia actual: <span class="att-percent" data-id="${n.id}">0%</span></div>
      <button class="btn btn-secondary add-att-btn" data-id="${n.id}" style="margin-top:8px;">+ Agregar asistencia</button>
    `,t.appendChild(r),Er(n.id)}),t.querySelectorAll(".add-att-btn").forEach(n=>{n.addEventListener("click",()=>Cr(n.dataset.id))}))}async function Er(e){const t=x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",e,"attendance");F(t,n=>{const a=n.docs.map(r=>({id:r.id,...r.data()}));wr(e,a)})}async function wr(e,t){const n=document.querySelector(`.att-days[data-id="${e}"]`);if(!n)return;n.innerHTML=t.map(o=>`
    <div class="att-record">
      <span>${new Date(o.date+"T00:00:00").toLocaleDateString("es-CL",{timeZone:"America/Santiago"})} :

        ${o.present?"‚úî Presente":o.absent?"‚úò Ausente":o.justified?"üü° Justificado":"‚Äî Sin clase"}

      </span>
      <button class="btn btn-secondary btn-del-att" data-cid="${e}" data-id="${o.id}">‚ùå</button>
    </div>
  `).join(""),n.querySelectorAll(".btn-del-att").forEach(o=>{o.addEventListener("click",()=>Lr(o.dataset.cid,o.dataset.id))});const a=t.filter(o=>!o.noClass),r=a.filter(o=>o.present||o.justified).length,s=a.length?Math.round(r/a.length*100):0,l=document.querySelector(`.att-percent[data-id="${e}"]`);l&&(l.textContent=s+"%"),window.courseAttendance||(window.courseAttendance={}),window.courseAttendance[e]=s}let Ct=null;function Cr(e){Ct=e;const t=new Date,n=new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().split("T")[0];c("attDate").value=n,c("attModal").classList.add("active")}function ta(){c("attModal").classList.remove("active"),Ct=null}document.addEventListener("DOMContentLoaded",()=>{var e,t,n,a,r;(e=c("attCancel"))==null||e.addEventListener("click",ta),(t=c("attPresente"))==null||t.addEventListener("click",()=>rt("present")),(n=c("attAusente"))==null||n.addEventListener("click",()=>rt("absent")),(a=c("attJustificado"))==null||a.addEventListener("click",()=>rt("justified")),(r=c("attNoClass"))==null||r.addEventListener("click",()=>rt("noClass"))});async function rt(e){if(!Ct)return;const t=c("attDate").value;if(!t){alert("Selecciona una fecha");return}const[n,a,r]=t.split("-").map(Number),l=new Date(n,a-1,r).toISOString().split("T")[0],o=E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",Ct,"attendance",l);await ee(o,{date:l,present:e==="present",absent:e==="absent",justified:e==="justified",noClass:e==="noClass"}),ta()}async function Lr(e,t){const n=E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",e,"attendance",t);await te(n)}async function na(){if(!i.currentUser||!i.activeSemesterId)return;if(at){try{at()}catch{}at=null}window.courseAttendance||(window.courseAttendance={});const e=x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses");try{const t=await O(e);for(const n of t.docs){if(!(n.data()||{}).asistencia)continue;const r=x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",n.id,"attendance"),o=(await O(r)).docs.map(m=>m.data()).filter(m=>!m.noClass),u=o.filter(m=>m.present||m.justified).length,d=o.length?Math.round(u/o.length*100):0;window.courseAttendance[n.id]=d}console.log("‚ö° Precarga inicial de asistencia:",window.courseAttendance),document.dispatchEvent(new CustomEvent("attendance:ready",{detail:{preload:!0}}))}catch(t){console.error("Error en precarga r√°pida de asistencia:",t)}return at=F(e,t=>{t.docs.filter(a=>{var r;return(r=a.data())==null?void 0:r.asistencia}).forEach(a=>{const r=x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",a.id,"attendance");F(r,s=>{const o=s.docs.map(m=>m.data()).filter(m=>!m.noClass),u=o.filter(m=>m.present||m.justified).length,d=o.length?Math.round(u/o.length*100):0;window.courseAttendance[a.id]=d,document.dispatchEvent(new CustomEvent("attendance:ready",{detail:{courseId:a.id,percent:d}}))})})}),!0}document.addEventListener("auth:ready",()=>{setTimeout(()=>tn(),1e3)});document.addEventListener("semester:changed",()=>{tn()});const An=Object.freeze(Object.defineProperty({__proto__:null,initAttendance:tn,preloadAttendanceData:na},Symbol.toStringTag,{value:"Module"}));let B=null,st=null,ue=[],U={scale:"USM",finalExpr:"",rulesText:""},oe={byName:{},byCode:{},byId:{}},se=null,Ie=null;function aa(){return E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",B,"groups","meta")}async function xr(){if(Ie=null,!!ve())try{const e=await Y(aa());Ie=e.exists()?e.data()||{}:{}}catch(e){console.error("Error cargando nombres de grupos:",e),Ie={}}}async function Ar(e,t){if(ve())try{await ee(aa(),{[e]:t},{merge:!0}),Ie={...Ie||{},[e]:t}}catch(n){throw console.error("Error guardando nombre de grupo:",n),n}}function Mr(e){se=e,i.unsubscribeGrades=()=>{try{se==null||se()}finally{se=null,i.unsubscribeGrades=null}}}function Ur(){try{se==null||se()}finally{se=null}i.unsubscribeGrades=null}function Ir(){const e=c("gr-courseSel");e&&(e.innerHTML='<option value="" disabled selected>Selecciona un ramo‚Ä¶</option>');const t=c("gr-evalsList");t&&(t.innerHTML="");const n=c("gr-finalExpr");n&&(n.value="");const a=c("gr-rulesError");a&&(a.textContent="");const r=c("gr-currentAvg");r&&(r.textContent="‚Äî");const s=c("gr-neededToPass");s&&(s.textContent="‚Äî");const l=c("gr-status");l&&(l.textContent="‚Äî");const o=c("gr-partnerView");o&&o.classList.add("hidden");const u=c("gr-sh-semSel");u&&(u.innerHTML="");const d=c("gr-sh-list");d&&(d.innerHTML="")}function Tr(){kr()}document.addEventListener("attendance:ready",e=>{console.log("üîÅ Asistencia actualizada para:",e.detail),W()});document.addEventListener("route:notas",()=>{setTimeout(()=>{const e=c("gr-courseSel"),t=c("gr-evalsCard"),n=c("gr-calcCard"),a=c("gr-summaryCard"),r=c("gr-rulesCard");(!e||!e.value)&&(t&&t.classList.add("hidden"),n&&n.classList.add("hidden"),a&&a.classList.add("hidden"),r&&r.classList.add("hidden"))},50)});function mt(){ra()}function $r(){var n,a;const e=c("gr-activeSemLabel");e&&(e.textContent=((n=i.activeSemesterData)==null?void 0:n.label)||"‚Äî"),ra();const t=document.getElementById("gr-sh-semSel");t&&((a=i.activeSemesterData)!=null&&a.label)&&(t.innerHTML=`<option selected>${i.activeSemesterData.label}</option>`,t.disabled=!0,t.style.pointerEvents="none",t.style.opacity="0.7"),(async()=>{try{await na(),console.log("‚úÖ Asistencia precargada, ahora s√≠ recalculamos notas"),W()}catch(r){console.warn("‚ö†Ô∏è Error precargando asistencia:",r),W()}})()}function Dr(){return(ue||[]).map(e=>({code:e.key,name:e.name||e.key,grade:typeof e.score=="number"?e.score:null}))}function kr(){var n,a,r,s;Nr(),(n=c("gr-saveExpr"))==null||n.addEventListener("click",_e),(a=c("gr-finalExpr"))==null||a.addEventListener("keydown",l=>{l.key==="Enter"&&(l.preventDefault(),_e())}),(r=c("gr-courseSel"))==null||r.addEventListener("change",Or),(s=c("gr-addEvalBtn"))==null||s.addEventListener("click",Hr),Pr();function e(){var f;const l=c("page-notas");if(!l)return;const o=(f=Array.from(l.querySelectorAll(".card h3")).find(p=>/c[a√°]lculo de notas/i.test(p.textContent)))==null?void 0:f.closest(".card");if(!o||(o.id||(o.id="gr-calcCard"),o.querySelector("#gr-openSim")))return;const u=o.querySelector("h3"),d=document.createElement("button");d.id="gr-openSim",d.className="ghost",d.textContent="Simulador de notas";let m=u==null?void 0:u.closest(".row");m?m.classList.add("gr-calcHeader"):(m=document.createElement("div"),m.className="row gr-calcHeader",u&&m.appendChild(u),o.insertBefore(m,o.firstChild)),d.style.marginLeft="auto",m.appendChild(d),d.addEventListener("click",()=>{const p=Wr();if(!p){alert("Primero define la F√≥rmula final.");return}const h=Dr();if(!h.length){alert("Agrega al menos una evaluaci√≥n.");return}es({formula:p,evals:h})})}e(),document.addEventListener("pair:ready",Ht);const t=c("gr-finalExpr");if(t){const l=Zr(async()=>{await _e()},600);t.addEventListener("input",()=>{U.finalExpr=De(t.value||""),W(),l()}),t.addEventListener("blur",()=>_e()),t.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),_e())})}}function Nr(){var n;const e=c("gr-passThreshold");e&&((n=e.closest("div"))==null||n.classList.add("hidden"));const t=c("gr-saveHeader");t&&t.classList.add("hidden")}function Pr(){var a,r;if(c("gr-rulesCard"))return;const e=c("page-notas");if(!e)return;const t=document.createElement("div");t.className="card",t.id="gr-rulesCard",t.style.marginTop="12px",t.innerHTML=`
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Reglas</h3>
      <div class="muted" id="gr-rulesHint">Una por l√≠nea. Ej.: <code>C1>=50</code>, <code>avg(Q1,Q2,Q3)>=60</code>,</code> finalCode("Codigo del ramo") >= 50</code>,</code>Asistencia >= 55%</code></div>
    </div>
    <div class="row" style="align-items:flex-start;margin-top:8px">
      <textarea id="gr-rulesText" rows="4" style="flex:1 1 520px;min-height:86px;background:#0e1120;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px"></textarea>
      <div id="gr-formulaError" class="muted" style="margin-top:6px;color:#fca5a5"></div>
      <button id="gr-saveRules" class="primary">Guardar reglas</button>
    </div>
    <div id="gr-rulesStatus" class="muted" style="margin-top:6px"></div>
  `;const n=(a=Array.from(e.querySelectorAll(".card h3")).find(s=>/c[a√°]lculo de notas/i.test(s.textContent)))==null?void 0:a.closest(".card");n?e.insertBefore(t,n):e.appendChild(t),(r=c("gr-saveRules"))==null||r.addEventListener("click",Fr)}async function ra(){var t,n,a;const e=c("gr-courseSel");if(e){if(e.innerHTML="",!i.courses||i.courses.length===0){e.innerHTML='<option value="">‚Äî</option>',B=null,pe(),ia(null);return}i.courses.forEach(r=>{const s=document.createElement("option");s.value=r.id,s.textContent=r.name,e.appendChild(s)}),B=null,e.value="",e.selectedIndex=0,i.editingCourseId=null,(t=c("gr-evalsCard"))==null||t.classList.add("hidden"),(n=c("gr-calcCard"))==null||n.classList.add("hidden"),(a=c("gr-summaryCard"))==null||a.classList.add("hidden")}}async function Or(e){var t,n,a,r,s,l,o,u;if(B=e.target.value||null,i.editingCourseId=B,!B){(t=c("gr-evalsCard"))==null||t.classList.add("hidden"),(n=c("gr-calcCard"))==null||n.classList.add("hidden"),(a=c("gr-summaryCard"))==null||a.classList.add("hidden"),(r=c("gr-rulesCard"))==null||r.classList.add("hidden");return}(s=c("gr-evalsCard"))==null||s.classList.remove("hidden"),(l=c("gr-calcCard"))==null||l.classList.remove("hidden"),(o=c("gr-summaryCard"))==null||o.classList.remove("hidden"),(u=c("gr-rulesCard"))==null||u.classList.remove("hidden"),await _r(),await xr(),await Br(),await Ze(),W(),await Rr(B)}async function Rr(e){try{const t=x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",e,"attendance"),r=(await O(t)).docs.map(o=>o.data()).filter(o=>!o.noClass),s=r.filter(o=>o.present||o.justified).length,l=r.length?Math.round(s/r.length*100):0;window.courseAttendance||(window.courseAttendance={}),window.courseAttendance[e]=l,console.log(`‚úÖ Sincronizada asistencia directa de ${e}: ${l}%`),W()}catch(t){console.warn("‚ö†Ô∏è No se pudo sincronizar asistencia directa:",t)}}function It(){return E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",B,"grading","meta")}function ie(){return x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",B,"grading","meta","components")}async function _r(){var f,p;if(!ve())return;const e=It(),t=E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",B),n=await Y(t),a=n.exists()&&n.data().scale||null,r=((f=i.activeSemesterData)==null?void 0:f.universityAtThatTime)||"",s=/mayor/i.test(r)?"MAYOR":(/usm|utfsm|santa\s*mar/i.test(r),"USM"),l=await Y(e);l.exists()?U={finalExpr:"",rulesText:"",...l.data()}:(U={scale:a||s,finalExpr:"",rulesText:""},await ee(e,U));let o=a||s;U.scale!==o&&(U.scale=o,await R(e,{scale:U.scale})),c("gr-activeSemLabel")&&(c("gr-activeSemLabel").textContent=((p=i.activeSemesterData)==null?void 0:p.label)||"‚Äî");const u=c("gr-scaleSel");u&&(u.value=U.scale||"USM");const d=c("gr-finalExpr");d&&(d.value=U.finalExpr||"");const m=c("gr-rulesText");m&&(m.value=U.rulesText||""),U.scale,pe(),W()}async function _e(){if(!ve())return;const e=c("gr-finalExpr"),n=((e?e.value:"")||"").trim(),a=De(n)||null;U.finalExpr=a,await R(It(),{finalExpr:a}),await Ze(),W()}async function Fr(){if(!ve())return;const e=(c("gr-rulesText").value||"").trim()||null;U.rulesText=e,await R(It(),{rulesText:e}),await Ze(),W()}async function Br(){if(st&&(st(),st=null),!ve()){pe([]);return}const e=ie();st=F(Z(e,Ce("createdAt","asc")),async t=>{let n=t.docs.map(r=>({id:r.id,...r.data()}));const a=n.filter(r=>typeof r.order!="number");if(a.length){const{writeBatch:r}=await G(async()=>{const{writeBatch:o}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");return{writeBatch:o}},[]),s=r(g),l=Date.now();a.forEach((o,u)=>{s.update(E(ie(),o.id),{order:l+u})});try{await s.commit()}catch{}}n.sort((r,s)=>{var m,f,p,h;const l=typeof r.order=="number"?r.order:9e15,o=typeof s.order=="number"?s.order:9e15;if(l!==o)return l-o;const u=((f=(m=r.createdAt)==null?void 0:m.toMillis)==null?void 0:f.call(m))??0,d=((h=(p=s.createdAt)==null?void 0:p.toMillis)==null?void 0:h.call(p))??0;return u-d}),ue=n,await pe(n),W(),Ze().then(()=>W())},t=>{console.error("watchComponents error:",t),pe([])})}async function Hr(){if(!ve()){alert("Selecciona un semestre y un ramo.");return}const e=c("gr-evalName"),t=c("gr-evalCode"),n=c("gr-evalScore"),a=((e==null?void 0:e.value)||"").trim();let r=((t==null?void 0:t.value)||"").trim();const s=(n==null?void 0:n.value)??"";if(!a){alert("Escribe un nombre.");return}if(!r){alert("Escribe un c√≥digo (ej: C1, T1...).");return}if(r=r.replace(/\s+/g,"").replace(/[^A-Za-z0-9_]/g,"").slice(0,16),!r){alert("C√≥digo inv√°lido.");return}r=jr(r,ue);const l=U.scale==="MAYOR",o=l?1:0,u=l?7:100,d=parseFloat(String(s).replace(",",".")),m=isNaN(d)?null:Lt(d,o,u);await Pe(ie(),{key:r,name:a,score:m,createdAt:_n(),order:Date.now()}),e&&(e.value=""),t&&(t.value=""),n&&(n.value="")}function sa(e){return(e||"").replace(/\s+/g,"").replace(/[^A-Za-z0-9_]/g,"").slice(0,16)}function jr(e,t){const n=new Set((t||[]).map(s=>(s.key||"").toLowerCase()));let a=sa(e)||"X";if(!n.has(a.toLowerCase()))return a;let r=2;for(;n.has((a+r).toLowerCase());)r++;return a+r}async function pe(e=[]){const t=c("gr-evalsList");if(!t)return;const n={};t.querySelectorAll(".grade-item").forEach(f=>{var v,S;const p=(S=(v=f.querySelector("code"))==null?void 0:v.textContent)==null?void 0:S.trim(),h=f.querySelector('[data-f="score"]');p&&h&&h.value&&(n[p]=h.value)});const a=new Set(Array.from(t.querySelectorAll("details.grade-group[open]")).map(f=>f.dataset.key));if(t.innerHTML="",!B){t.innerHTML='<div class="muted">Selecciona un ramo.</div>';return}if(!e.length){t.innerHTML='<div class="muted">A√∫n no hay evaluaciones. Usa ‚ÄúAgregar evaluaci√≥n‚Äù.</div>';return}const r=U.scale==="MAYOR",s=r?1:0,l=r?7:100,o=r?.1:1,u={certamenes:e.filter(f=>/^C\d*/i.test(f.key)||/certamen/i.test(f.name)),controles:e.filter(f=>/^CTRL/i.test(f.key)||/control/i.test(f.name)),tareas:e.filter(f=>/^T\d*/i.test(f.key)||/tarea/i.test(f.name)),proyecto:e.filter(f=>/proy/i.test(f.key)||/proyecto/i.test(f.name)),evaluaciones:e.filter(f=>/evaluaci[o√≥]n/i.test(f.name)),experiencias:e.filter(f=>/experien/i.test(f.name)),preinformes:e.filter(f=>/pre[\s-]?informe/i.test(f.name)),informes:e.filter(f=>/\binforme/i.test(f.name)&&!/pre[\s-]?informe/i.test(f.name)),laboratorios:e.filter(f=>/\blab/i.test(f.key)||/laboratorio/i.test(f.name)),otros:e.filter(f=>!(/^(C\d*|CTRL|T\d*|LAB)/i.test(f.key)||/certamen|control|tarea|proy|evaluaci[o√≥]n|experien|informe|laboratorio/i.test(f.name)))},d={certamenes:"Cert√°menes",controles:"Controles",tareas:"Tareas",proyecto:"Proyecto",evaluaciones:"Evaluaciones",experiencias:"Experiencias",preinformes:"Pre-informes",informes:"Informes",laboratorios:"Laboratorios",otros:"Otros"},m={...d,...Ie||{}};for(const[f,p]of Object.entries(u)){let P=function(L,$,A){if(!L)return L;const C=y=>y.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),k=new RegExp(`\\b${C($)}\\b`,"g");return L.replace(k,A)};if(!p.length)continue;const h=document.createElement("details");h.className="grade-group",h.dataset.key=f,a.has(f)&&(h.open=!0);const v=document.createElement("summary");v.style.display="flex",v.style.alignItems="center",v.style.justifyContent="space-between",v.style.width="100%",v.style.cursor="pointer";const S=m[f]||d[f]||f,w=document.createElement("span");w.style.fontWeight="700",w.textContent=`${S} (${p.length})`;const I=document.createElement("button");I.dataset.rename=f,I.className="ghost",I.textContent="‚úé",Object.assign(I.style,{fontSize:"0.9em",opacity:"0.8",marginLeft:"8px",flexShrink:"0"}),v.appendChild(w),v.appendChild(I),h.appendChild(v);const D=document.createElement("div");p.forEach(L=>{const $=document.createElement("div");$.className="grade-item",$.setAttribute("draggable","true"),$.dataset.id=L.id,$.draggable=!0,$.innerHTML=`
  <div style="flex:1">
    <div class="gr-name" style="font-weight:700">${j(L.name||L.key)}</div>
    <div class="muted">C√≥digo: <code class="gr-code">${j(L.key)}</code></div>
  </div>
  <div style="display:flex;align-items:center;gap:.5rem">
    <input data-f="score" type="number" step="${o}" min="${s}" max="${l}"
           value="${n[L.key]??L.score??""}" style="width:110px"/>
    <button data-act="save" class="btn btn-secondary">Guardar</button>
    <button data-act="edit" class="btn btn-secondary">Editar</button>
    <button data-act="cancelEdit" class="btn btn-secondary" style="display:none">Cancelar</button>
    <button data-act="del"  class="btn btn-secondary">Eliminar</button>
  </div>
`,$.addEventListener("click",async A=>{const C=A.target;if(C instanceof HTMLElement){if(C.dataset.act==="save"){const k=$.querySelector('[data-f="score"]');let y=parseFloat(k.value);const b=isNaN(y)?null:Lt(y,s,l);await R(E(ie(),L.id),{score:b}),C.textContent="Guardado ‚úì",W(),setTimeout(()=>C.textContent="Guardar",1200)}if(C.dataset.act==="del"){if(!confirm(`Eliminar ‚Äú${L.name||L.key}‚Äù?`))return;await te(E(ie(),L.id))}}}),$.addEventListener("click",async A=>{var k,y;const C=A.target;if(C instanceof HTMLElement){if(C.dataset.act==="edit"){const b=$.querySelector(".gr-name"),T=$.querySelector(".gr-code"),H=((k=b==null?void 0:b.textContent)==null?void 0:k.trim())||L.name||"",q=((y=T==null?void 0:T.textContent)==null?void 0:y.trim())||L.key||"";b.innerHTML=`<input data-f="edit-name" type="text" value="${j(H)}"
                         style="width:100%;max-width:320px">`,T.parentElement.innerHTML=`C√≥digo: <input data-f="edit-code" type="text" value="${j(q)}"
                      style="width:120px">`,$.querySelector('[data-act="edit"]').style.display="none",$.querySelector('[data-act="cancelEdit"]').style.display="";return}if(C.dataset.act==="cancelEdit"){pe(ue);return}if(C.dataset.act==="save"){const b=$.querySelector('[data-f="edit-name"]'),T=$.querySelector('[data-f="edit-code"]');if(b||T){const Q=b?b.value:L.name||L.key,X=T?T.value:L.key,J=(Q||"").trim();let M=(X||"").trim();if(!J){alert("Escribe un nombre.");return}if(M=sa(M),!M){alert("C√≥digo inv√°lido. Usa A‚ÄìZ, 0‚Äì9 o _.");return}if(new Set(ue.filter(ae=>ae.id!==L.id).map(ae=>(ae.key||"").toLowerCase())).has(M.toLowerCase())){alert(`El c√≥digo ${M} ya existe en este ramo.`);return}const ne=E(ie(),L.id);if(M!==L.key){const ae=P(U.finalExpr||"",L.key,M),Re=P(U.rulesText||"",L.key,M);await R(It(),{finalExpr:ae||null,rulesText:Re||null}),U.finalExpr=ae||"",U.rulesText=Re||""}await R(ne,{name:J,key:M}),await Ze(),W(),pe(ue);return}const H=$.querySelector('[data-f="score"]');let q=parseFloat(H.value);const he=isNaN(q)?null:Lt(q,s,l);await R(E(ie(),L.id),{score:he}),C.textContent="Guardado ‚úì",W(),setTimeout(()=>C.textContent="Guardar",1200);return}if(C.dataset.act==="del"){if(!confirm(`Eliminar ‚Äú${L.name||L.key}‚Äù?`))return;await te(E(ie(),L.id));return}}}),D.appendChild($)}),h.appendChild(D),t.appendChild(h),oa(D),I.addEventListener("click",async L=>{L.preventDefault(),L.stopPropagation();const $=m[f]||d[f]||f,A=prompt(`Nuevo nombre para ‚Äú${$}‚Äù:`,$);if(!(!A||A.trim()===$))try{await Ar(f,A.trim()),pe(ue)}catch{alert("No se pudo guardar el nuevo nombre.")}})}}function W(){const e={},t=U.scale==="MAYOR"?1:0,n=U.scale==="MAYOR"?7:100;ue.forEach(m=>{typeof m.score=="number"&&(e[m.key]=Lt(m.score,t,n))}),window.courseAttendance&&B in window.courseAttendance?e.Asistencia=window.courseAttendance[B]:e.Asistencia=0;let a=null,r="";if(U.finalExpr&&U.finalExpr.trim()!=="")try{a=xe(U.finalExpr,e,{avg:$e,min:Math.min,max:Math.max,final:m=>xt(m),finalCode:m=>At(m),finalId:m=>an(m)}),typeof a=="number"&&isFinite(a)?a=ke(a,U.scale):a=null}catch(m){r=(m==null?void 0:m.message)||String(m||""),a=null}c("gr-rulesStatus")&&(c("gr-rulesStatus").dataset.formulaError=r);const s=U.scale==="MAYOR"?3.95:54.5,l=Tt(U.rulesText||""),o=nn(l,e);let u=null;a==null?o.allOk?u="‚Äî":u="Reprueba":u=a>=s&&o.allOk?"Aprueba":"Reprueba";let d="‚Äî";if(a==null)d="Ingresa notas o completa la f√≥rmula.";else if(u==="Aprueba")d="Nada m√°s. Ya alcanzas la nota y cumples las reglas.";else{const m=[];if(a<s){const f=s-a;m.push(U.scale==="MAYOR"?`Subir la nota final en ${f.toFixed(2)} pts.`:`Subir la nota final en ${f.toFixed(1)} pts.`)}if(!o.allOk){const f=o.unmet.map(p=>`Cumplir: ${p.text}.`);m.push(...f)}d=m.join(" ")}zr(o),ia({final:a,status:u,needed:d})}async function Ze(){if(oe={byName:{},byCode:{},byId:{}},!i.currentUser||!i.activeSemesterId)return;const e=Array.isArray(i.courses)?i.courses:[];for(const t of e)try{const n=E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",t.id,"grading","meta"),a=await Y(n),r=a.exists()?a.data():{scale:"USM",finalExpr:""},s=x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",t.id,"grading","meta","components"),o=(await O(s)).docs.map(v=>({id:v.id,...v.data()})),u={},d=r.scale==="MAYOR"?1:0,m=r.scale==="MAYOR"?7:100;for(const v of o)if(typeof v.score=="number"&&isFinite(v.score)){const S=Math.max(d,Math.min(m,v.score));u[v.key]=S}let f=null;if((r.finalExpr||"").trim())try{f=xe(r.finalExpr,u,{avg:$e,min:Math.min,max:Math.max,final:v=>NaN,finalCode:v=>NaN,finalId:v=>NaN}),typeof f=="number"&&isFinite(f)?f=ke(f,r.scale):f=null}catch{f=null}const p=me(t.name),h=me(t.code);p&&(oe.byName[p]={final:f,scale:r.scale,id:t.id}),h&&(oe.byCode[h]={final:f,scale:r.scale,id:t.id}),oe.byId[t.id]={final:f,scale:r.scale,id:t.id}}catch{}}function Tt(e){return(e||"").split(/\r?\n/).map(n=>n.trim()).filter(Boolean)}function nn(e,t,n){const a={allOk:!0,items:[],unmet:[]};for(const r of e){const s=qr(r);if(!s){a.items.push({text:r,ok:!1,reason:"inv√°lida"}),a.unmet.push({text:r,kind:"invalid"}),a.allOk=!1;continue}const{left:l,op:o,right:u}=s;let d=null,m=null,f=!1;try{const h={...{avg:$e,min:Math.min,max:Math.max,final:xt,finalCode:At,finalId:an},...n||{}};window.courseAttendance&&B in window.courseAttendance?t.Asistencia=window.courseAttendance[B]:"Asistencia"in t||(t.Asistencia=0);const v=l.replace(/%/g,""),S=u.replace(/%/g,"");d=xe(v,t,h),m=xe(S,t,h),f=Yr(d,o,m)}catch{f=!1}a.items.push({text:r,ok:f,left:d,op:o,right:m}),f||(a.unmet.push({text:r,kind:"cmp",left:d,op:o,right:m}),a.allOk=!1)}return a}function qr(e){const t=e.match(/^(.*?)(>=|<=|==|!=|>|<)(.*)$/);return t?{left:De(t[1].trim()),op:t[2],right:De(t[3].trim())}:null}function Yr(e,t,n){if(!(isFinite(e)&&isFinite(n)))return!1;const a=Math.round(Math.round(e*10)/10),r=Math.round(Math.round(n*10)/10);switch(t){case">=":return a>=r;case"<=":return a<=r;case">":return a>r;case"<":return a<r;case"==":return a===r;case"!=":return a!==r;default:return!1}}function $e(...e){const t=e.map(a=>typeof a=="number"&&isFinite(a)?a:Number(a)).filter(a=>!isNaN(a));return t.length?t.reduce((a,r)=>a+r,0)/t.length:NaN}function zr(e){const t=c("gr-rulesStatus");if(!t)return;if(!e||!e.items.length){t.textContent="No hay reglas definidas.";return}const n=e.items.filter(r=>r.ok).length,a=e.items.map(r=>r.ok?`‚úÖ ${r.text}`:`‚ùå ${r.text}`);t.innerHTML=`<div><b>Reglas:</b> ${n}/${e.items.length} cumplidas</div><div style="margin-top:4px">${a.join("<br/>")}</div>`}function ia(e){const t=c("gr-currentFinal")||c("gr-currentAvg"),n=c("gr-status"),a=c("gr-needed")||c("gr-neededToPass");if(!t||!n||!a)return;if(!e){t.textContent="",n.textContent="",a.textContent="",delete t.dataset.base,delete n.dataset.base;return}const r=(U==null?void 0:U.scale)||"USM",s=e.final==null?"":ke(e.final,r).toString();t.textContent=s,n.textContent=e.status??"",a.textContent=e.needed??""}let $t={id:null,fromIndex:-1};function oa(e){e&&(e.querySelectorAll(".grade-item").forEach(t=>{t.draggable=!0,t.querySelectorAll("input,button,select,textarea").forEach(n=>{n.setAttribute("draggable","false")})}),e.addEventListener("dragstart",t=>{const n=t.target.closest(".grade-item");n&&(t.dataTransfer.setData("text/plain",n.dataset.id||""),t.dataTransfer.effectAllowed="move",n.classList.add("dragging"),$t.id=n.dataset.id,$t.fromIndex=[...e.children].indexOf(n))}),e.addEventListener("dragend",()=>{const t=e.querySelector(".grade-item.dragging");t==null||t.classList.remove("dragging"),$t={id:null,fromIndex:-1}}),e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="move";const n=e.querySelector(".grade-item.dragging");if(!n)return;const a=Gr(e,t.clientY);a==null?e.appendChild(n):e.insertBefore(n,a)},{capture:!0}),e.addEventListener("drop",async t=>{t.preventDefault();const n=[...e.querySelectorAll(".grade-item")].map(a=>a.dataset.id);await Vr(n)}))}function Gr(e,t){return[...e.querySelectorAll(".grade-item:not(.dragging)")].reduce((a,r)=>{const s=r.getBoundingClientRect(),l=t-(s.top+s.height/2);return l<0&&l>a.offset?{offset:l,element:r}:a},{offset:Number.NEGATIVE_INFINITY,element:null}).element}async function Vr(e){if(!ve()||!Array.isArray(e)||!e.length)return;const{writeBatch:t}=await G(async()=>{const{writeBatch:s}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");return{writeBatch:s}},[]),n=t(g);let a=Date.now();const r=1e3;e.forEach((s,l)=>{const o=E(ie(),s);n.update(o,{order:a+l*r})});try{await n.commit()}catch(s){console.warn("Error al guardar orden:",s)}}function Wr(){var e;return(((e=document.getElementById("gr-finalExpr"))==null?void 0:e.value)||"").trim()}function Zr(e,t){let n=null;return(...a)=>{n&&clearTimeout(n),n=setTimeout(()=>e(...a),t)}}function ve(){return!!(i.currentUser&&i.activeSemesterId&&B)}function j(e){return(e??"").toString().replace(/[<>&"]/g,t=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"})[t])}function Lt(e,t,n){return Math.max(t,Math.min(n,e))}function De(e){if(!e)return"";let t=String(e).trim();return t=t.replace(/[‚Äú‚Äù]/g,'"').replace(/[‚Äò‚Äô]/g,"'"),t=t.replace(/\s+/g," "),t}function ca(e){return e.replace(/\b(final|finalCode|finalId)\(\s*([^)]+?)\s*\)/g,(t,n,a)=>{const r=String(a).trim();if(/^["'].*["']$/.test(r))return`${n}(${r})`;if(/[(),]/.test(r))return`${n}(${r})`;const s=r.replace(/"/g,'\\"');return`${n}("${s}")`})}function Jr(e){return e?e.replace(/(\d+(?:\.\d+)?)\s*%/g,(t,n)=>`(${n}/100)`):""}function xe(e,t,n={}){const a=De(e),r=ca(a),s=r.replace(/"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'/g,"0");if(!/^[\w\s\.\+\-\*\/\(\),%<>!=]+$/.test(s))throw new Error("La f√≥rmula contiene caracteres no permitidos.");const l=Jr(r),o=s.match(/\b[A-Za-z_][A-Za-z0-9_]*\b/g)||[],u=new Set(["avg","min","max","final","finalCode","finalId"]),d=new Set(["NaN","Infinity","Math","true","false"]),m=Object.keys(t),f=m.map(S=>t[S]??0),p=new Set([...m,...Object.keys(n)]);for(const S of o)u.has(S)||d.has(S)||p.has(S)||(m.push(S),f.push(0),p.add(S));const h=Object.keys(n),v=Object.values(n);return Function(...h,...m,`"use strict"; return (${l});`)(...v,...f)}function Kr(e){const t=De(e||""),n=ca(t),r=n.replace(/"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'/g,"0").match(/\b[A-Za-z_][A-Za-z0-9_]*\b/g)||[],s=new Set(["avg","min","max","final","finalCode","finalId","NaN","Infinity","Math","true","false"]),l=new Set((n.match(/\b[A-Za-z_][A-Za-z0-9_]*\s*\(/g)||[]).map(u=>u.replace("(","").trim())),o=r.filter(u=>!s.has(u)&&!l.has(u));return[...new Set(o)]}function ke(e,t){return e==null||isNaN(e)?null:t==="MAYOR"?Math.trunc(e*100)/100:Math.trunc(e*10)/10}function me(e){return(e||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toLowerCase()}function xt(e){const t=me(e);if(!t)return NaN;const n=(i.courses||[]).find(o=>o.id===B);if(t===me(n==null?void 0:n.name))return NaN;const a=oe.byName[t];if(a&&typeof a.final=="number")return a.final;const r=Array.isArray(i.courses)?i.courses:[],s=r.filter(o=>me(o.name).startsWith(t)&&o.id!==B);if(s.length===1){const o=oe.byId[s[0].id];if(o&&typeof o.final=="number")return o.final}const l=r.filter(o=>me(o.name).includes(t)&&o.id!==B);if(l.length===1){const o=oe.byId[l[0].id];if(o&&typeof o.final=="number")return o.final}return NaN}function At(e){const t=me(e),n=(i.courses||[]).find(r=>r.id===B);if(t&&t===me(n==null?void 0:n.code))return NaN;const a=oe.byCode[t];return a&&typeof a.final=="number"?a.final:NaN}function an(e){if(!e||e===B)return NaN;const t=oe.byId[e];return t&&typeof t.final=="number"?t.final:NaN}(function(){var s,l,o,u,d;const t=c("gr-togglePartner");if(!t)return;const n=[(s=c("gr-courseSel"))==null?void 0:s.closest(".card"),(l=c("gr-evalsList"))==null?void 0:l.closest(".card"),(o=c("gr-finalExpr"))==null?void 0:o.closest(".card"),((u=c("gr-currentFinal"))==null?void 0:u.closest(".card"))||((d=c("gr-currentAvg"))==null?void 0:d.closest(".card")),c("gr-rulesCard")].filter(Boolean),a=c("gr-partnerView");function r(m){t.setAttribute("aria-pressed",m?"true":"false"),t.textContent=m?"Volver a mis notas":"Notas de mi duo",n.forEach(f=>fn(f,m)),fn(a,!m),m&&Ht()}t.addEventListener("click",()=>{const m=t.getAttribute("aria-pressed")==="true";r(!m)}),document.addEventListener("pair:ready",Ht)})();let Mn=0;async function Ht(){var o;const e=c("gr-sh-semSel");if(!e)return;e.innerHTML="";const t=document.createElement("option");if(t.textContent="Cargando...",t.disabled=!0,t.selected=!0,e.appendChild(t),!i.pairOtherUid){e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";return}const n=++Mn,a=x(g,"users",i.pairOtherUid,"semesters"),r=await O(a);if(n!==Mn)return;const s=((o=i.activeSemesterData)==null?void 0:o.label)||null;if(!s){e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7";return}let l=null;if(r.forEach(u=>{var m;const d=(((m=u.data())==null?void 0:m.label)||"").trim();d===s&&(l={id:u.id,label:d})}),l)e.innerHTML=`<option selected>${l.label}</option>`,e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7",i.shared.notas.semId=l.id,Xr(l.id);else{e.innerHTML="<option selected>No disponible</option>",e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.7",i.shared.notas.semId=null;const u=c("gr-sh-list");u&&(u.innerHTML='<div class="muted">Tu d√∫o no tiene este semestre creado.</div>')}}let ft=null;function Qr(){ft&&(ft(),ft=null)}async function Xr(e){Qr();const t=c("gr-sh-list");if(t&&(t.innerHTML=""),!i.pairOtherUid||!e)return;const n=await Y(E(g,"users",i.pairOtherUid,"semesters",e)),a=n.exists()&&n.data().universityAtThatTime||"",r=/mayor/i.test(a)?"MAYOR":"USM",s=x(g,"users",i.pairOtherUid,"semesters",e,"courses");ft=F(Z(s,Ce("name")),async l=>{if(!l.size){Un([]);return}const o={},u=[];for(const m of l.docs){const f=m.data()||{},p=m.id,h=E(g,"users",i.pairOtherUid,"semesters",e,"courses",p,"grading","meta"),v=await Y(h),S=v.exists()?v.data():{scale:r,finalExpr:"",rulesText:""},w=x(g,"users",i.pairOtherUid,"semesters",e,"courses",p,"grading","meta","components"),D=(await O(w)).docs.map(k=>({id:k.id,...k.data()||{}})),P={},L=S.scale==="MAYOR",$=L?1:0,A=L?7:100;D.forEach(k=>{const y=typeof k.score=="number"?Math.max($,Math.min(A,k.score)):null;y!=null&&k.key&&(P[k.key]=y)});let C=null;try{(S.finalExpr||"").trim()&&(C=xe(S.finalExpr,P,{avg:$e,min:Math.min,max:Math.max,final:()=>NaN,finalCode:()=>NaN,finalId:()=>NaN}),typeof C=="number"&&isFinite(C)?C=ke(C,S.scale):C=null)}catch{C=null}o[(f.code||"").toLowerCase()]=C,u.push({cData:f,comps:D,vals:P,meta:S,prelim:C})}const d=[];for(const m of u){let f=m.prelim;try{(m.meta.finalExpr||"").trim()&&(f=xe(m.meta.finalExpr,m.vals,{avg:$e,min:Math.min,max:Math.max,final:()=>NaN,finalCode:w=>{const I=(w||"").toString().toLowerCase();return o[I]??NaN},finalId:()=>NaN}),typeof f=="number"&&isFinite(f)?f=ke(f,m.meta.scale):f=null)}catch{f=null}const p=m.meta.scale==="MAYOR"?3.95:54.5,h=Tt(m.meta.rulesText||""),v=nn(h,m.vals),S=f!=null&&f>=p&&v.allOk?"Aprobado":f==null?"‚Äî":"Reprobado";d.push({name:m.cData.name||"Ramo",code:m.cData.code||"",final:f,scale:m.meta.scale||r,status:S})}Un(d)})}function Un(e){const t=c("gr-sh-list");if(t){if(t.innerHTML="",!e.length){t.innerHTML='<div class="muted">No hay ramos en ese semestre.</div>';return}e.forEach(n=>{const a=n.final==null?"‚Äî":n.scale==="MAYOR"?(Math.trunc(n.final*100)/100).toFixed(2):(Math.trunc(n.final*10)/10).toFixed(1),r=n.status==="Aprobado"?"#22c55e":n.status==="Reprobado"?"#ef4444":"#aaa",s=document.createElement("div");s.className="grade-item",s.innerHTML=`
      <div style="flex:1">
        <div style="font-weight:700">${j(n.name)}</div>
        <div class="muted">Nota final: <b>${a}</b></div>
      </div>
      <div style="font-weight:700;color:${r}">
        ${n.status}
      </div>
    `,t.appendChild(s)})}}function es({formula:e,evals:t}){var $,A,C,k;($=document.getElementById("gr-simDrawer"))==null||$.remove(),(A=document.getElementById("gr-simBackdrop"))==null||A.remove();const n=document.createElement("div");n.id="gr-simBackdrop",Object.assign(n.style,{position:"fixed",inset:"0",zIndex:9998,background:"rgba(0,0,0,0.35)",backdropFilter:"blur(1px)"}),document.body.classList.add("sim-lock");const a=document.createElement("div");a.id="gr-simDrawer",Object.assign(a.style,{position:"fixed",top:"0",right:"0",height:"100vh",width:"420px",background:"rgba(18,18,30,.98)",backdropFilter:"blur(6px)",borderLeft:"1px solid rgba(255,255,255,.08)",boxShadow:"0 0 24px rgba(0,0,0,.45)",zIndex:9999,padding:"16px 16px 90px 16px",overflowY:"auto"}),a.addEventListener("click",y=>y.stopPropagation()),a.innerHTML=`
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
      <h3 style="margin:0">Simulador de notas</h3>
      <span class="muted" style="font-size:12px;opacity:.8">(${j(e)})</span>
    </div>

    <div class="card" style="margin-top:4px">
      <h4 style="margin:0 0 6px">Evaluaciones</h4>
      <div id="gr-simForm"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 6px">Resumen de la simulaci√≥n</h4>
      <div id="gr-simSummary" class="muted">‚Äî</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 6px">Reglas del ramo (simulaci√≥n)</h4>
      <div id="gr-simRules" class="muted">‚Äî</div>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px; padding-top:12px; border-top:1px solid rgba(255,255,255,.1)">
  <button id="gr-simSave" class="primary">Guardar simulaci√≥n</button>
  <button id="gr-simClose" class="ghost">Salir</button>
</div>

  `,document.body.appendChild(n),document.body.appendChild(a);const r=async()=>{const y=L();let b=null;try{b=await Tn()}catch{b=null}const T=(Q={})=>{const X={};for(const[J,M]of Object.entries(Q||{}))M==null||M===""||typeof M=="string"&&M.trim()===""?X[J.toUpperCase()]=null:isNaN(M)?X[J.toUpperCase()]=M:X[J.toUpperCase()]=Math.round(Number(M)*100)/100;return X},q=((Q,X)=>{const J=T(Q),M=T(X),z=new Set([...Object.keys(J),...Object.keys(M)]);for(const ne of z)if((J[ne]??null)!==(M[ne]??null))return!1;return!0})(y.gradesMap,b);let he=!1;if(q||(he=confirm("¬øGuardar esta simulaci√≥n antes de salir?")),he)try{await In(y.gradesMap,e)}catch{}n.remove(),a.remove(),document.body.classList.remove("sim-lock")};n.addEventListener("click",r),a.addEventListener("keydown",y=>{y.key==="Escape"&&r()}),(C=a.querySelector("#gr-simClose"))==null||C.addEventListener("click",r),ts(a);const s=a.querySelector("#gr-simForm"),l=new Map((t||[]).map(y=>[y.code,y.grade])),o=Kr(e),u=new Set((t||[]).map(y=>y.code)),d=[...new Set([...u,...o])],m={certamenes:[],controles:[],tareas:[],proyecto:[],evaluaciones:[],experiencias:[],preinformes:[],informes:[],laboratorios:[],otros:[]},f={certamenes:"Cert√°menes",controles:"Controles",tareas:"Tareas",proyecto:"Proyecto",evaluaciones:"Evaluaciones",experiencias:"Experiencias",preinformes:"Pre-informes",informes:"Informes",laboratorios:"Laboratorios",otros:"Otros"};function p(y,b){return/^C\d*/i.test(y)||/certamen/i.test(b)?"certamenes":/^Q\d*/i.test(y)||/control/i.test(b)?"controles":/^T\d*/i.test(y)||/tarea/i.test(b)?"tareas":/PF|PROY/i.test(y)||/proy/i.test(b)?"proyecto":/evaluaci[o√≥]n/i.test(b)?"evaluaciones":/experien/i.test(b)?"experiencias":/pre[\s-]?informe/i.test(b)?"preinformes":/\binforme/i.test(b)&&!/pre[\s-]?informe/i.test(b)?"informes":/^L\d*/i.test(y)||/laboratorio/i.test(b)?"laboratorios":"otros"}for(const y of d){const b=(t||[]).find(q=>q.code===y)||{name:y},T=l.get(y),H=p(y,b.name||y);m[H].push({code:y,name:b.name||y,value:T})}const h=[],v=U.scale==="MAYOR",S=v?1:0,w=v?7:100,I=v?.1:1;for(const[y,b]of Object.entries(m)){if(!b.length)continue;const T=f[y]||y;h.push(`
    <details open class="sim-group" data-key="${y}"
      style="margin-top:10px;border:1px solid rgba(255,255,255,.08);
             border-radius:8px;padding:6px 8px;background:rgba(0,0,0,0.15)">
      <summary style="cursor:pointer;font-weight:700;font-size:14px;
                      margin-bottom:6px">${T} (${b.length})</summary>
      <div class="sim-group-body">
        ${b.map(H=>`
          <div class="row" style="align-items:center;gap:8px;margin:4px 0"
               data-sim-code="${j(H.code)}">
            <div style="min-width:76px"><b>${j(H.code)}</b></div>
            <div style="flex:1">${j(H.name)}</div>
            <input type="number" step="${I}" min="${S}" max="${w}"
                   style="width:110px" placeholder="‚Äî"
                   value="${H.value??""}">
          </div>
        `).join("")}
      </div>
    </details>
  `)}s.innerHTML=h.join("");const D=[...e.matchAll(/finalCode\(["'](.+?)["']\)/g)];for(const y of D){const b=y[1],T=At(b);isFinite(T)?h.push(`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.85" data-sim-ref="${j(b)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1">Nota final de ${j(b)}</div>
        <input type="number" readonly value="${T}" style="width:110px;opacity:.7;background:#222;border:none;color:#ccc">
      </div>
    `):h.push(`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.75" data-sim-ref="${j(b)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1;color:#aaa">Nota final de ${j(b)}</div>
        <div style="width:110px;text-align:center;color:#f87171">‚Äî</div>
      </div>
    `)}s.innerHTML=h.join("");const P=[...e.matchAll(/final\(["'](.+?)["']\)/g)];for(const y of P){const b=y[1],T=xt(b);isFinite(T)&&s.insertAdjacentHTML("beforeend",`
      <div class="row" style="align-items:center;gap:8px;margin:6px 0;opacity:.85" data-sim-ref="${j(b)}">
        <div style="min-width:76px"><b>NF</b></div>
        <div style="flex:1">Nota final de ${j(b)}</div>
        <input type="number" readonly value="${T}" style="width:110px;opacity:.7;background:#222;border:none;color:#ccc">
      </div>
    `)}const L=()=>{const y={};s.querySelectorAll("[data-sim-code]").forEach(M=>{var Re,cn;const z=M.getAttribute("data-sim-code"),ne=(cn=(Re=M.querySelector("input"))==null?void 0:Re.value)==null?void 0:cn.trim(),ae=ne?Number(String(ne).replace(",",".")):null;y[z]=Number.isFinite(ae)?ae:0});let b=null,T=null;try{b=xe(e,{...y},{avg:$e,min:Math.min,max:Math.max,final:M=>xt(M),finalCode:M=>At(M),finalId:M=>an(M)}),typeof b=="number"&&isFinite(b)?b=ke(b,U.scale):b=null}catch(M){T=(M==null?void 0:M.message)||String(M||""),b=null}const H=Tt(U.rulesText||""),q=nn(H,y),he=U.scale==="MAYOR"?3.95:54.5;let Q="";if(T)Q="";else if(b==null)Q="Ingresa valores para simular.";else{const M=[];if(b<he){const z=he-b;M.push(U.scale==="MAYOR"?`Subir la nota final en ${z.toFixed(2)} pts.`:`Subir la nota final en ${z.toFixed(1)} pts.`)}if(!q.allOk){const z=q.unmet.map(ne=>ne.text);z.length&&M.push(`Cumplir reglas pendientes: ${z.map(j).join("; ")}.`)}Q=M.length?M.join(" "):"Nada m√°s. Ya apruebas."}const X=a.querySelector("#gr-simSummary");X.innerHTML=T?`<div style="color:#f87171">Error en f√≥rmula: ${j(T)}</div>`:`
    <div>Promedio simulado: <b>${b??"‚Äî"}</b></div>
    <div class="muted" style="margin-top:6px">(Usa tu f√≥rmula final actual)</div>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:10px 0">
    <div><b>Necesitas para aprobar</b></div>
    <div style="margin-top:4px">${Q}</div>
  `;const J=a.querySelector("#gr-simRules");if(!H.length)J.textContent="No hay reglas definidas.";else{const M=q.items.filter(z=>z.ok).length;J.innerHTML=`
        <div style="margin-bottom:6px">Cumplidas: <b>${M}/${H.length}</b></div>
        <ul style="margin:0 0 0 18px;padding:0;list-style:disc;">
          ${q.items.map(z=>`<li style="color:${z.ok?"#22c55e":"#ef4444"}">${j(z.text)}</li>`).join("")}
        </ul>
      `}return{gradesMap:y,result:b}};s.addEventListener("input",L),L(),(k=a.querySelector("#gr-simSave"))==null||k.addEventListener("click",async()=>{const y=L();try{const b=await In(y.gradesMap,e);alert((b==null?void 0:b.where)==="cloud"?"Simulaci√≥n guardada en la nube.":"Simulaci√≥n guardada")}catch(b){console.error(b),alert("No se pudo guardar la simulaci√≥n.")}}),Tn().then(y=>{y&&(s.querySelectorAll("[data-sim-code]").forEach(b=>{const T=b.getAttribute("data-sim-code")||"",H=b.querySelector("input");if(!H)return;const q=y[T]??y[T.toUpperCase()]??y[T.toLowerCase()];q!=null&&(H.value=String(q))}),L())}).catch(()=>{})}function ts(e){const t=()=>Array.from(e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(r=>!r.hasAttribute("disabled")&&r.tabIndex!==-1),n=()=>t()[0],a=()=>t().slice(-1)[0];setTimeout(()=>{var r;return(r=n())==null?void 0:r.focus()},0),e.addEventListener("keydown",r=>{var o,u;if(r.key!=="Tab")return;const s=t();if(!s.length)return;const l=document.activeElement;r.shiftKey?l===s[0]&&(r.preventDefault(),(o=a())==null||o.focus()):l===s[s.length-1]&&(r.preventDefault(),(u=n())==null||u.focus())})}async function In(e,t){const n={};Object.keys(e||{}).forEach(s=>{n[String(s).toUpperCase()]=e[s]});const a={formula:t,grades:n,rules:Tt(U.rulesText||""),semId:i.activeSemesterId||null,courseId:i.editingCourseId||null,createdAt:_n()};if(i.currentUser&&i.activeSemesterId&&i.editingCourseId)try{const s=["users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",i.editingCourseId,"simulations"];return await Pe(x(g,...s),a),await ee(E(g,...s,"__last__"),a),{ok:!0,where:"cloud"}}catch(s){console.warn("Fallo Firestore, usando localStorage:",s)}const r=`sim:last:${i.activeSemesterId||"SEM"}:${i.editingCourseId||"COURSE"}`;return localStorage.setItem(r,JSON.stringify(a)),{ok:!0,where:"local"}}async function Tn(){var t;const e=`sim:last:${i.activeSemesterId||"SEM"}:${i.editingCourseId||"COURSE"}`;if(i.currentUser&&i.activeSemesterId&&i.editingCourseId)try{const n=E(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses",i.editingCourseId,"simulations","__last__"),a=await Y(n);if(a.exists()){const r=((t=a.data())==null?void 0:t.grades)||null;return r&&typeof r=="object"?r:null}}catch{}try{const n=localStorage.getItem(e);if(!n)return null;const a=JSON.parse(n),r=(a==null?void 0:a.grades)||null;return r&&typeof r=="object"?r:null}catch{return null}}function ns(e){if(!e||!i.courses)return null;const t=a=>String(a||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),n=t(e);return i.courses.find(a=>t(a.name).includes(n)||t(a.code||"").includes(n))||null}async function la(e){const t=x(e.ref,"rules"),n=await O(t);let a=0,r=0;for(const s of n.docs){const l=s.data(),o=Number(l.peso)||0,u=x(s.ref,"grades"),m=(await O(u)).docs.map(f=>Number(f.data().valor)).filter(f=>!isNaN(f));if(m.length>0){const f=m.reduce((p,h)=>p+h,0)/m.length;a+=f*(o/100),r+=o}}return r>0?+a.toFixed(2):null}async function as(e){if(!i.currentUser)return null;const t=x(g,"users",i.currentUser.uid,"semesters",e,"courses"),n=await O(t);let a=0,r=0;for(const s of n.docs){const l=await la(s);l!=null&&(a+=l,r++)}return r>0?+(a/r).toFixed(2):null}function rs(e){var l;const n=(e.scale||"USM")==="MAYOR"?4:55;let a=0,r=0;for(const o of e.rules||[]){const u=Number(o.peso)||0;if(o.tipo.toLowerCase().includes("examen")){r=u;continue}if((l=o.notas)!=null&&l.length){const d=o.notas.reduce((m,f)=>m+f,0)/o.notas.length;a+=d*(u/100)}}return r===0?null:+((n-a)/(r/100)).toFixed(2)}function ss(e){const n=(e.scale||"USM")==="MAYOR"?4:55;return e.promedio>=n}function is(e){const n=(e.scale||"USM")==="MAYOR"?4:55;return+Math.max(0,n-(e.promedio||0)).toFixed(2)}async function os(e){if(!i.currentUser)return{best:null,worst:null};const t=x(g,"users",i.currentUser.uid,"semesters",e,"courses"),n=await O(t),a=[];for(const r of n.docs){const s=await la(r);a.push({id:r.id,name:r.data().name,promedio:s})}return a.length?(a.sort((r,s)=>(s.promedio||0)-(r.promedio||0)),{best:a[0],worst:a[a.length-1]}):{best:null,worst:null}}document.addEventListener("route:change",e=>{var r;const t=((r=e.detail)==null?void 0:r.route)||"",n=document.getElementById("gr-courseSel");function a(){if(n)if(n.value="",n.querySelector('option[value=""]'))n.selectedIndex=0;else{const o=document.createElement("option");o.value="",o.textContent="Selecciona un ramo‚Ä¶",o.disabled=!0,o.selected=!0,n.insertBefore(o,n.firstChild),n.selectedIndex=0}window.currentCourseId=null,window.state&&(window.state.editingCourseId=null);const s=(o,u="‚Äî")=>{const d=document.getElementById(o);d&&(d.textContent=u)};s("gr-currentAvg"),s("gr-neededToPass"),s("gr-status");const l=document.getElementById("gr-evalsList");l&&(l.innerHTML='<div class="muted">Selecciona un ramo.</div>'),["gr-evalsCard","gr-calcCard","gr-summaryCard","gr-rulesCard"].forEach(o=>{var u;return(u=document.getElementById(o))==null?void 0:u.classList.add("hidden")})}t!=="#/notas"&&a(),t==="#/notas"&&setTimeout(a,120)});const $n=Object.freeze(Object.defineProperty({__proto__:null,bestWorst:os,calcBrecha:is,calcNotaMinima:rs,calcPromedioSemestre:as,clearGradesUI:Ir,enableDnDForGrades:oa,findCourse:ns,initGrades:Tr,isPassing:ss,onActiveSemesterChanged:$r,onCoursesChanged:mt,registerGradesUnsub:Mr,stopGradesSub:Ur},Symbol.toStringTag,{value:"Module"}));let Dt="USM";function da(){cs()}function ua(){ds()}function ma(e){var s;Dt=e==="UMAYOR"?"MAYOR":"USM";const t=c("sectParLabel");t&&(t.textContent=e==="USM"?"Paralelo":"Secci√≥n/Paralelo");const n=c("courseScale"),a=(s=n==null?void 0:n.closest)==null?void 0:s.call(n,".form-field");a&&a.classList.add("hidden"),n&&(n.value=Dt,n.disabled=!0);const r=c("scaleHint");r&&(r.textContent=Dt==="MAYOR"?"Escala: UMayor (1‚Äì7) ¬∑ tomada desde tu Perfil":"Escala: USM (0‚Äì100) ¬∑ tomada desde tu Perfil")}let it=null;function cs(){if(it&&(it(),it=null),!i.currentUser||!i.activeSemesterId){i.courses=[],document.dispatchEvent(new Event("courses:changed"));return}const e=x(g,"users",i.currentUser.uid,"semesters",i.activeSemesterId,"courses");function t(n,a){let r;return(...s)=>{clearTimeout(r),r=setTimeout(()=>n(...s),a)}}it=F(e,t(n=>{const a=n.docs.map(r=>{const s=r.data()||{};return{id:r.id,...s,createdAtMs:s.createdAt instanceof Na?s.createdAt.toMillis():typeof s.createdAt=="number"?s.createdAt:0}});a.sort((r,s)=>s.createdAtMs-r.createdAtMs),i.courses=a,ls(n),mt==null||mt(),document.dispatchEvent(new Event("courses:changed"))},300))}function ls(e){const t=c("coursesList");t&&(t.innerHTML="",e.forEach(n=>{const a=n.data(),r=document.createElement("div");r.className="course-item",r.innerHTML=`
      <div>
        <div><b>${kt(a.name||"Sin nombre")}</b> <span class="course-meta">¬∑ ${kt(a.code||"")}</span></div>
        <div class="course-meta">${kt(a.professor||"")}</div>
      </div>
      <div class="inline">
        <button class="ghost course-edit" data-id="${n.id}">Editar</button>
        <button class="danger course-del"  data-id="${n.id}">Eliminar</button>
      </div>
    `,t.appendChild(r)}))}function ds(){var o;i.editingCourseId=null;const e=c("courseName");e&&(e.value="");const t=c("courseCode");t&&(t.value="");const n=c("courseProfessor");n&&(n.value="");const a=c("courseSectPar");a&&(a.value="");const r=c("courseColor");r&&(r.value="#3B82F6");const s=c("courseColorCode");s&&(s.textContent="#3B82F6");const l=c("saveCourseBtn");l&&(l.textContent="Agregar ramo"),(o=c("cancelEditBtn"))==null||o.classList.add("hidden")}function kt(e){return String(e).replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}let Se=null,Dn=!1;function us(){Dn||(Dn=!0,ms())}function Nt(){Se&&(Se(),Se=null);const e=c("semestersList");e&&(e.innerHTML=""),Ne()}function ms(){const e=c("createSemesterBtn");e&&e.addEventListener("click",async()=>{var o;if(!i.currentUser){alert("Debes iniciar sesi√≥n.");return}const t=ps();if(!t){alert("Completa tu universidad en Perfil.");return}const n=(((o=c("semesterLabel"))==null?void 0:o.value)||"").trim();if(!fs(n)){alert("Formato de semestre inv√°lido. Usa AAAA-1 o AAAA-2 (ej. 2025-2).");return}const a=x(g,"users",i.currentUser.uid,"semesters");if(!(await O(Z(a,Rn("label","==",n)))).empty){alert("Ya existe un semestre con ese nombre.");return}const s=await Pe(a,{label:n,universityAtThatTime:t,createdAt:Date.now()});c("semesterLabel")&&(c("semesterLabel").value="");const l=i.activeSemesterId||null;l&&await pa(l,s.id)}),document.addEventListener("click",async t=>{const n=t.target;if(n instanceof HTMLElement){if(n.matches(".sem-activate")){if(!i.currentUser){alert("Debes iniciar sesi√≥n.");return}const a=n.dataset.id;await va(a)}if(n.matches(".sem-delete")){if(!i.currentUser){alert("Debes iniciar sesi√≥n.");return}const a=n.dataset.id;if(!confirm("¬øEliminar este semestre?"))return;await te(E(g,"users",i.currentUser.uid,"semesters",a)),i.activeSemesterId===a&&Ne()}}})}async function fa(){var o,u,d,m,f,p;if(Se&&(Se(),Se=null),!i.currentUser)return;const e=((u=(o=i.profileData)==null?void 0:o.university)==null?void 0:u.trim())||"",t=((m=(d=i.profileData)==null?void 0:d.career)==null?void 0:m.trim())||"",n=c("semestersList");if(!e||!t){n&&(n.innerHTML=`
        <div class="card" style="padding:20px; text-align:center;">
          <h3>‚ö†Ô∏è Antes de agregar semestres necesitas configurar tu perfil</h3>
          <p>Completa tu <b>universidad</b> y <b>carrera</b> para poder crear y visualizar semestres.</p>
          <button id="goToProfileBtn" class="btn-primary" style="margin-top:10px;">
            Ir a Perfil ahora ‚Üí
          </button>
        </div>
      `,(f=c("goToProfileBtn"))==null||f.addEventListener("click",()=>{const h=c("subtabPerfil")||document.querySelector('[data-tab="perfil"]'),v=c("perfilContainer")||document.getElementById("perfilContainer");h&&v&&(document.querySelectorAll(".subtab").forEach(S=>S.classList.remove("active")),document.querySelectorAll(".page").forEach(S=>S.classList.add("hidden")),h.classList.add("active"),v.classList.remove("hidden"))}));return}const a=i.currentUser.uid,r=await Y(E(g,"users",a)),s=r.exists()&&((p=r.data())==null?void 0:p.activeSemester)||null;if(s){i.activeSemesterId=s;const h=await Y(E(g,"users",a,"semesters",s));i.activeSemesterData=h.exists()?h.data():null}if(i.activeSemesterId&&i.activeSemesterData){console.log("[Semesters] Restaurando semestre activo tras recarga:",i.activeSemesterData.label);const h=c("coursesSection");h&&h.classList.remove("hidden");const v=ha(i.activeSemesterData.universityAtThatTime);ma(v),ua(),da();const S=c("activeSemesterLabel");S&&(S.textContent=i.activeSemesterData.label||"‚Äî");const w=c("activeSemesterUni");w&&(w.textContent=i.activeSemesterData.universityAtThatTime||"‚Äî");const I=c("gr-activeSemLabel");I&&(I.textContent=i.activeSemesterData.label||"‚Äî");const D=c("gr-scaleSel"),P=c("gr-passThreshold");D&&(D.value=v==="UMAYOR"?"MAYOR":"USM",D.disabled=!0),P&&(P.value=v==="UMAYOR"?4:55),Oe(),we==null||we(),K(),document.dispatchEvent(new Event("semester:changed"))}const l=x(g,"users",a,"semesters");Se=F(Z(l,Ce("createdAt","desc")),h=>{const v=c("semestersList");if(!v)return;if(v.innerHTML="",h.empty){Ne();return}if(h.forEach(w=>{const I=w.data(),D=document.createElement("div");D.className="course-item";const P=i.activeSemesterId===w.id;D.innerHTML=`
        <div>
          <div><b>${I.label}</b> <span class="course-meta">¬∑ ${I.universityAtThatTime}</span></div>
        </div>
        <div class="inline">
          ${P?'<span class="course-meta">Activo</span>':`<button class="ghost sem-activate" data-id="${w.id}">Activar</button>`}
          <button class="danger sem-delete" data-id="${w.id}">Eliminar</button>
        </div>
      `,v.appendChild(D)}),h.docs.some(w=>w.id===i.activeSemesterId)||Ne(),!i.activeSemesterId&&!h.empty){const w=h.docs[0].id;console.log("[Semesters] No hab√≠a activo guardado, usando el m√°s reciente:",w),va(w)}})}async function pa(e,t){var a;const n=(a=i.currentUser)==null?void 0:a.uid;if(!(!n||!e||!t))try{const r=x(g,"users",n,"semesters",e,"calendar"),s=x(g,"users",n,"semesters",t,"calendar"),l=await O(r);let o=0;for(const u of l.docs){const d=u.data();d.persistent&&(await Pe(s,{...d,createdAt:Date.now()}),o++)}console.log(`üîÅ [Semesters] ${o} eventos persistentes copiados de ${e} a ${t}`)}catch(r){console.error("‚ùå Error copiando eventos persistentes:",r)}}async function va(e){var d,m,f,p;if(!i.currentUser||!e)return;i.activeSemesterId=e;const t=await Y(E(g,"users",i.currentUser.uid,"semesters",e));i.activeSemesterData=t.exists()?t.data():null,await ee(E(g,"users",i.currentUser.uid),{activeSemester:e},{merge:!0}),i.lastActiveSemesterId&&i.lastActiveSemesterId!==e&&await pa(i.lastActiveSemesterId,e),i.lastActiveSemesterId=e;const n=c("activeSemesterLabel");n&&(n.textContent=((d=i.activeSemesterData)==null?void 0:d.label)||"‚Äî");const a=c("activeSemesterUni");a&&(a.textContent=((m=i.activeSemesterData)==null?void 0:m.universityAtThatTime)||"‚Äî");const r=c("gr-activeSemLabel");r&&(r.textContent=((f=i.activeSemesterData)==null?void 0:f.label)||"‚Äî");const s=ha((p=i.activeSemesterData)==null?void 0:p.universityAtThatTime),l=c("gr-scaleSel"),o=c("gr-passThreshold");l&&(l.value=s==="UMAYOR"?"MAYOR":"USM",l.disabled=!0),o&&(o.value=s==="UMAYOR"?4:55);const u=c("coursesSection");u&&u.classList.remove("hidden"),ma(s),ua(),da(),Oe(),we==null||we(),K(),fa(),document.dispatchEvent(new Event("semester:changed"))}function Ne(){i.activeSemesterId=null,i.activeSemesterData=null;const e=c("activeSemesterLabel");e&&(e.textContent="‚Äî");const t=c("activeSemesterUni");t&&(t.textContent="‚Äî");const n=c("coursesSection");n&&n.classList.add("hidden");const a=c("gr-activeSemLabel");a&&(a.textContent="‚Äî");const r=c("gr-scaleSel");r&&(r.value="USM",r.disabled=!0);const s=c("gr-passThreshold");s&&(s.value=""),Oe(),K()}function fs(e){return/^\d{4}-(1|2)$/.test(e||"")}function ps(){const e=i.profileData;return!e||!e.university?null:e.university==="OTRA"?(e.customUniversity||"").trim()||null:e.university==="UMAYOR"?"Universidad Mayor":e.university==="USM"?"UTFSM":e.university}function ha(e){if(!e)return"";const t=e.toLowerCase();return t.includes("mayor")?"UMAYOR":t.includes("utfsm")||t.includes("santa mar√≠a")||t.includes("santa maria")?"USM":"OTRA"}async function vs(){if(!i.currentUser)return;const e=i.currentUser.uid,t=x(g,"users",e,"semesters"),n=await O(t);if(i.semesters=n.docs.map(a=>({id:a.id,...a.data()})),i.activeSemesterId){const a=x(g,"users",e,"semesters",i.activeSemesterId,"courses"),r=await O(a);i.courses=r.docs.map(s=>({id:s.id,...s.data()}))}console.log("üìö preloadCourses:",i.semesters,i.courses)}let de=null;function hs(){de&&(de(),de=null),i.unsubscribeProfile=null}function gs(e){if(!e)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=/^(\d{2})-(\d{2})$/.exec(e);if(t){const n=t[1];return`2000-${t[2]}-${n}`}return""}async function kn(e){const t=await new Promise((a,r)=>{const s=new FileReader;s.onload=()=>a(s.result),s.onerror=r,s.readAsDataURL(e)});return await new Promise((a,r)=>{const s=new Image;s.onload=()=>a(s),s.onerror=r,s.src=t})}function Nn(e,t=256,n=.82){const a=document.createElement("canvas"),r=Math.min(e.width,e.height),s=(e.width-r)/2,l=(e.height-r)/2;return a.width=t,a.height=t,a.getContext("2d").drawImage(e,s,l,r,r,0,0,t,t),a.toDataURL("image/jpeg",n)}function He(e){const t=document.getElementById("pfAvatarCircle");t&&(e&&!e.startsWith("emoji:")?(t.textContent="",t.style.backgroundImage=`url("${e}")`):(t.style.backgroundImage="none",t.textContent="üë®‚Äçüéì"))}function ys(e,t){if(e&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const n=/^(\d{2})-(\d{2})$/.exec(t||"");if(n){const a=n[1];return`2000-${n[2]}-${a}`}return null}let ot=null;const rn={UMAYOR:[{value:"MEDVET",label:"Medicina Veterinaria"}],USM:[{value:"ICTEL",label:"Ing. Civil Telem√°tica"}]};function ga(){var u;de&&(de(),de=null);const e=(u=i.currentUser)==null?void 0:u.uid;if(!e)return;const t=E(g,"users",e),n=E(g,"users",e,"profile","profile"),a=(d,m)=>{const f=(d==null?void 0:d.data())||{},p=(m==null?void 0:m.data())||{};i.profileData={...f,...p,name:(p==null?void 0:p.name)||(f==null?void 0:f.name)||(f==null?void 0:f.fullName)||(p==null?void 0:p.fullName)||""},delete i.profileData.fullName,f!=null&&f.name&&!i.profileData.name&&(i.profileData.name=f.name),f!=null&&f.fullName&&!i.profileData.name&&(i.profileData.name=f.fullName),p!=null&&p.name&&(i.profileData.name=p.name),p!=null&&p.fullName&&(i.profileData.name=p.fullName),sn(i.profileData),Mt(),K(),document.dispatchEvent(new Event("profile:changed"))};let r=null,s=null;const l=F(t,d=>{r=d,a(r,s)}),o=F(n,d=>{s=d,a(r,s)});de=()=>{l(),o()},i.unsubscribeProfile=de}function ya(){var l;const e=(o,u="")=>{const d=c(o);d&&(d.value=u)};e("pfName"),e("pfGoogleEmail"),e("pfBirthday"),e("pfFavoriteColor","#22c55e");const t=c("pfColorPreview");t&&(t.style.background="#22c55e");const n=c("pfColorCode");n&&(n.textContent="#22C55E");const a=c("pfUniversity")||c("uniSel");a&&(a.value="");const r=c("pfCareer")||c("careerSel");r&&(r.value="",r.disabled=!0),e("pfEmailUni"),e("pfPhone"),He(null);const s=c("pfBirthday");s&&((l=s.dataset)==null||delete l.dirty)}function sn(e){var $;const t=c("pfName"),n=c("pfBirthday"),a=c("pfUniversity")||c("uniSel"),r=c("pfCustomUniWrap"),s=c("pfCustomUniversity"),l=c("pfCareer")||c("careerSel"),o=c("pfFavoriteColor"),u=c("pfColorPreview"),d=c("pfColorCode"),m=c("pfEmailUni")||c("pfEmail"),f=c("pfPhone")||c("pfTelefono"),p=c("pfGoogleEmail"),h=c("pfCancelBtn"),v=(A,C)=>{if(!l)return;l.innerHTML='<option value="">Selecciona tu carrera‚Ä¶</option>';const k=rn[A]||[];for(const{value:y,label:b}of k){const T=document.createElement("option");T.value=y,T.textContent=b,l.appendChild(T)}l.disabled=k.length===0,C&&k.some(y=>y.value===C)?l.value=C:l.value=""};if(h&&!h.dataset.bound&&(h.onclick=()=>sn(i.profileData||null),h.dataset.bound="1"),p&&(($=i.currentUser)!=null&&$.email)&&(p.value=i.currentUser.email),m&&(m.value=(e==null?void 0:e.uniEmail)||""),f&&(f.value=(e==null?void 0:e.phone)||""),t&&(t.value=(e==null?void 0:e.fullName)||(e==null?void 0:e.name)||""),n){const A=gs((e==null?void 0:e.birthday)||""),C=document.activeElement===n,k=n.dataset.dirty==="1";!C&&!k&&(n.value=A||"",A?n.setAttribute("value",A):n.removeAttribute("value")),n.dataset.bound||(n.addEventListener("change",y=>{const b=y.target.value||"";n.dataset.dirty="1",n.value=b,b?n.setAttribute("value",b):n.removeAttribute("value"),i.profileData={...i.profileData||{},birthday:b}}),n.addEventListener("paste",y=>y.preventDefault()),n.addEventListener("drop",y=>y.preventDefault()),n.dataset.bound="1")}if(a){const A=(e==null?void 0:e.university)||"";A==="Universidad Mayor"?a.value="UMAYOR":A==="UTFSM"||A==="USM"?a.value="USM":a.value=A}r&&r.classList.add("hidden"),s&&(s.value="");const S=(a==null?void 0:a.value)==="OTRA";r&&r.classList.toggle("hidden",!S),S&&s&&(s.value=(e==null?void 0:e.customUniversity)||"");const w=jt(e==null?void 0:e.favoriteColor)?e.favoriteColor:"#22c55e";o&&(o.value=w),u&&(u.style.background=w),d&&(d.textContent=w.toUpperCase()),v(a==null?void 0:a.value,(e==null?void 0:e.career)||""),a&&(a.onchange=()=>{const A=a.value==="OTRA";r&&r.classList.toggle("hidden",!A),!A&&s&&(s.value=""),v(a.value,null)}),o&&!o.dataset.bound&&(o.addEventListener("input",A=>{const C=A.target.value;jt(C)&&(u&&(u.style.background=C),d&&(d.textContent=C.toUpperCase()))}),o.dataset.bound="1");const I=c("pfAvatarBtn"),D=c("pfAvatarFile");He((e==null?void 0:e.avatarData)||"emoji:üë®‚Äçüéì");let P=document.getElementById("pfDeleteAvatarBtn");P||(P=document.createElement("button"),P.id="pfDeleteAvatarBtn",P.className="btn btn-secondary",P.textContent="Eliminar foto de perfil",I.insertAdjacentElement("afterend",P)),D&&!D.dataset.bound&&(D.addEventListener("change",async A=>{var k;const C=(k=A.target.files)==null?void 0:k[0];if(C){if(!/^image\//.test(C.type)){alert("Elige una imagen v√°lida.");return}try{const y=await kn(C),b=Nn(y,256,.82);if(He(b),!i.currentUser)return;await R(E(g,"users",i.currentUser.uid),{avatarData:b,avatarUpdatedAt:Date.now()}),I.textContent="Avatar actualizado ‚úì",setTimeout(()=>I.textContent="Cambiar avatar",1500)}catch(y){console.error(y),alert("No se pudo procesar la imagen.")}finally{A.target.value=""}}}),D.dataset.bound="1"),P.dataset.bound||(P.addEventListener("click",async()=>{if(i.currentUser&&confirm("¬øSeguro que deseas eliminar tu foto de perfil?"))try{await R(E(g,"users",i.currentUser.uid),{avatarData:null,avatarUrl:null,avatarUpdatedAt:Date.now()}),He("emoji:üë®‚Äçüéì"),alert("Avatar eliminado. Se restaur√≥ el emoji predeterminado üë®‚Äçüéì.")}catch(A){console.error(A),alert("No se pudo eliminar el avatar.")}}),P.dataset.bound="1"),D&&!D.dataset.bound&&(D.addEventListener("change",async A=>{var k;const C=(k=A.target.files)==null?void 0:k[0];if(C){if(!/^image\//.test(C.type)){alert("Elige una imagen.");return}try{const y=await kn(C),b=Nn(y,256,.82);if(He(b),!i.currentUser)return;await R(E(g,"users",i.currentUser.uid),{avatarData:b,avatarUpdatedAt:Date.now()}),I&&(I.textContent="Avatar actualizado ‚úì",setTimeout(()=>I.textContent="Cambiar avatar",1500))}catch(y){console.error(y),alert("No se pudo procesar la imagen.")}finally{A.target.value=""}}}),D.dataset.bound="1");const L=c("pfSaveBtn");L&&!L.dataset.bound&&(L.onclick=()=>ba(),L.dataset.bound="1")}async function ba(){var D,P,L,$,A,C,k;if(!i.currentUser)return;const e=c("pfUniversity")||c("uniSel"),t=c("pfCareer")||c("careerSel"),n=((D=c("pfFavoriteColor"))==null?void 0:D.value)||null,a=(((P=c("pfEmailUni")||c("pfEmail"))==null?void 0:P.value)||"").trim(),r=(((L=c("pfPhone")||c("pfTelefono"))==null?void 0:L.value)||"").trim(),s=i.currentUser.uid,l=(e==null?void 0:e.value)||null;if(!(!a||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))){alert("Email universitario no es v√°lido.");return}if(!(!r||/^[+()\s0-9-]{6,}$/.test(r))){alert("Tel√©fono no es v√°lido.");return}const d=t&&(($=rn[l])!=null&&$.some(y=>y.value===t.value))?t.value:null,m=((A=c("pfBirthday"))==null?void 0:A.value)||null,f=((C=i.profileData)==null?void 0:C.birthday)||null,p=ys(m,f),v={name:((k=c("pfName"))==null?void 0:k.value.trim())||null,birthday:p??null,university:l,customUniversity:l==="OTRA"&&c("pfCustomUniversity")&&c("pfCustomUniversity").value.trim()||null,career:d,favoriteColor:jt(n)?n:null,uniEmail:a||null,phone:r||null,updatedAt:Date.now()};await R(E(g,"users",i.currentUser.uid),{avatarData:null,avatarUrl:null,avatarUpdatedAt:null});const S=E(g,"users",s,"profile","profile");await ee(S,v,{merge:!0}),i.profileData={...i.profileData||{},...v};const w=document.getElementById("pfSaveBtn");if(w){const y=w.textContent;w.textContent="Guardado ‚úì",w.disabled=!0,setTimeout(()=>{w.textContent=y,w.disabled=!1},1800)}const I=document.getElementById("pfBirthday");I&&delete I.dataset.dirty}function Mt(){var t,n;const e=!!(i.profileData&&i.profileData.university&&(i.profileData.university!=="OTRA"||i.profileData.university==="OTRA"&&((t=i.profileData.customUniversity)!=null&&t.trim())));(n=c("semNoticeNoUni"))==null||n.classList.toggle("hidden",e),c("createSemesterBtn")&&(c("createSemesterBtn").disabled=!e||!i.currentUser),c("semesterLabel")&&(c("semesterLabel").disabled=!e),c("semesterUniFromProfile")&&(c("semesterUniFromProfile").value=e?bs(i.profileData):""),c("createPairBtn")&&(c("createPairBtn").disabled=!i.currentUser)}function bs(e){return!e||!e.university?"":e.university==="OTRA"?e.customUniversity||"Otra":e.university==="UMAYOR"?"Universidad Mayor":e.university==="USM"?"UTFSM":e.university}function jt(e){return typeof e=="string"&&/^#[0-9A-Fa-f]{6}$/.test(e)}function Sa(){const e=c("page-perfil");if(!e)return;let t=c("partnerProfileCard");t||(t=document.createElement("div"),t.className="card",t.id="partnerProfileCard",t.innerHTML=`
      <h3 style="margin-top:0">Perfil de la otra persona</h3>
      <div id="pp-avatar" style="width:64px;height:64px;border-radius:50%;
        background:#444;background-size:cover;background-position:center;margin-bottom:8px;"></div>
      <div id="pp-name"><b>Nombre:</b> ‚Äî</div>
      <div id="pp-uni"><b>Universidad:</b> ‚Äî</div>
      <div id="pp-career"><b>Carrera:</b> ‚Äî</div>
      <div id="pp-bday" class="muted"><b>Nacimiento:</b> ‚Äî</div>
      <div id="pp-color"><b>Color favorito:</b>
        <span id="pp-color-swatch"
          style="display:inline-block;width:16px;height:16px;border-radius:4px;vertical-align:middle;margin:0 6px;background:#ff69b4;border:1px solid rgba(255,255,255,.25)">
        </span>
        <span id="pp-color-code">‚Äî</span>
      </div>
      <div id="pp-email"><b>Email universitario:</b> ‚Äî</div>
      <div id="pp-phone"><b>Tel√©fono:</b> ‚Äî</div>
    `,t.classList.add("hidden"),e.appendChild(t));const n=()=>{c("pp-name").innerHTML="<b>Nombre:</b> ‚Äî",c("pp-uni").innerHTML="<b>Universidad:</b> ‚Äî",c("pp-career").innerHTML="<b>Carrera:</b> ‚Äî",c("pp-bday").innerHTML="<b>Fecha de nacimiento:</b> ‚Äî",c("pp-email").innerHTML="<b>Email universitario:</b> ‚Äî",c("pp-phone").innerHTML="<b>Tel√©fono:</b> ‚Äî",c("pp-color-code").textContent="‚Äî";const p=c("pp-color-swatch");p&&(p.style.background="transparent",p.style.border="1px solid rgba(255,255,255,.25)")};if(ot&&(ot(),ot=null),!i.pairOtherUid){n(),t&&t.classList.add("hidden");return}const a=E(g,"users",i.pairOtherUid),r=E(g,"users",i.pairOtherUid,"profile","profile");t.classList.remove("hidden");let s=null,l=null;const o=()=>{const p={...(s==null?void 0:s.data())||{},...(l==null?void 0:l.data())||{}},h=c("pp-avatar");h&&(p.avatarData?(h.style.backgroundImage=`url("${p.avatarData}")`,h.textContent=""):(h.style.backgroundImage="none",h.textContent="üë®‚Äçüéì",h.style.display="flex",h.style.alignItems="center",h.style.justifyContent="center",h.style.fontSize="2rem")),c("pp-name").innerHTML=`<b>Nombre:</b> ${p.name||"‚Äî"}`,c("pp-uni").innerHTML=`<b>Universidad:</b> ${d(p)}`,c("pp-career").innerHTML=`<b>Carrera:</b> ${p.career?p.career==="ICTEL"?"Ing. Civil Telem√°tica":"Medicina Veterinaria":"‚Äî"}`,c("pp-bday").innerHTML=`<b>Fecha de nacimiento:</b> ${u(p.birthday)}`,c("pp-email").innerHTML=`<b>Email universitario:</b> ${p.uniEmail||"‚Äî"}`,c("pp-phone").innerHTML=`<b>Tel√©fono:</b> ${p.phone||"‚Äî"}`;const v=typeof p.favoriteColor=="string"&&/^#[0-9A-Fa-f]{6}$/.test(p.favoriteColor)?p.favoriteColor:"#ff69b4",S=c("pp-color-swatch");S&&(S.style.background=v);const w=c("pp-color-code");w&&(w.textContent=v.toUpperCase())},u=p=>{if(!p)return"‚Äî";const h=/^(\d{4})-(\d{2})-(\d{2})$/.exec(p);return h?`${h[3]}/${h[2]}/${h[1]}`:p},d=p=>p!=null&&p.university?p.university==="UMAYOR"?"Universidad Mayor":p.university==="USM"?"UTFSM":p.university==="OTRA"?p.customUniversity||"Otra":p.university:"‚Äî",m=F(a,p=>{s=p,o()}),f=F(r,p=>{l=p,o()});ot=()=>{m(),f()}}document.addEventListener("pair:ready",()=>{Sa()});function Ss(){const e=document.getElementById("pfUniversity")||document.getElementById("uniSel"),t=document.getElementById("pfCareer")||document.getElementById("careerSel");if(!e||!t)return;const n=()=>{const a=rn[e.value]||[];t.innerHTML='<option value="">Selecciona tu carrera‚Ä¶</option>';for(const{value:r,label:s}of a){const l=document.createElement("option");l.value=r,l.textContent=s,t.appendChild(l)}t.disabled=a.length===0};e.addEventListener("change",n),n()}const Es=Object.freeze(Object.defineProperty({__proto__:null,clearProfileUI:ya,ensureCareerBindingOnLoad:Ss,fillProfileForm:sn,listenProfile:ga,mountPartnerProfileCard:Sa,reflectProfileInSemestersUI:Mt,saveProfile:ba,stopProfileListener:hs},Symbol.toStringTag,{value:"Module"}));let Ee=null;new URLSearchParams(location.search).has("debug")||(window==null||window.duoplannerDebug);function ws(){const e=c("createPairBtn"),t=c("copyInviteBtn"),n=c("joinByCodeBtn"),a=c("joinCode"),r=c("deletePairBtn");e==null||e.addEventListener("click",Ls),t==null||t.addEventListener("click",xs);const s=async()=>{const l=((a==null?void 0:a.value)||"").trim(),o=Us(l);o?await Is(o):alert("Pega un ID v√°lido (o un link con ?pair=ID)."),a&&(a.value="")};n==null||n.addEventListener("click",s),a==null||a.addEventListener("keydown",l=>{l.key==="Enter"&&s()}),r==null||r.addEventListener("click",Ts)}async function Cs(){if(!i.currentUser)return;const e=Z(x(g,"pairs")),t=await O(e),n=[];t.forEach(l=>{const o=l.data()||{};Array.isArray(o.members)&&o.members.includes(i.currentUser.uid)&&n.push({id:l.id,...o})}),n.sort((l,o)=>(Number(o.createdAt)||0)-(Number(l.createdAt)||0));const a=n[0]||null;i.currentPairId=(a==null?void 0:a.id)||null,i.pairOtherUid=a&&(a.members||[]).find(l=>l!==i.currentUser.uid)||null;const r=c("pairId"),s=c("copyInviteBtn");r&&(r.textContent=i.currentPairId||"‚Äî"),s&&(s.disabled=!i.currentPairId),Je(),K(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}})),on(i.currentPairId)}async function Ls(){if(!i.currentUser)return;const e=E(x(g,"pairs"));await ee(e,{members:[i.currentUser.uid],createdAt:Date.now(),visibility:{showCourseNames:!0,showOnlyBusyFree:!1}}),await Ea(e.id),i.currentPairId=e.id,i.pairOtherUid=null;const t=c("pairId"),n=c("copyInviteBtn");t&&(t.textContent=e.id),n&&(n.disabled=!1),Je(),K(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}})),on(e.id)}async function xs(){if(!i.currentPairId)return;const e=i.currentPairId,t=c("copyInviteBtn");if(await As(e)||Ms(e),t){const a=t.textContent;t.textContent="¬°ID copiado!",setTimeout(()=>{t.textContent=a||"Copiar ID"},1800)}}async function As(e){try{return await navigator.clipboard.writeText(e),!0}catch{return!1}}function Ms(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch{}document.body.removeChild(t)}function Us(e){if(!e)return"";const t=String(e).trim();try{const s=new URL(t).searchParams.get("pair");if(s)return s.trim()}catch{}const n=t.match(/[?&]pair=([A-Za-z0-9_-]+)/);return n?n[1]:t.replace(/[^A-Za-z0-9_-]/g,"")||""}async function Is(e){if(!i.currentUser)return;const t=E(g,"pairs",e),n=await Y(t);if(!n.exists()){alert("El ID de party no existe");return}const a=n.data()||{},r=Array.isArray(a.members)?a.members:[];if(!r.includes(i.currentUser.uid)&&r.length>=2){alert("Esta party ya tiene 2 miembros.");return}r.includes(i.currentUser.uid)||await R(t,{members:Oa(i.currentUser.uid),updatedAt:Date.now()}),await Ea(e);const l=(await Y(t)).data()||{};i.currentPairId=e,i.pairOtherUid=(l.members||[]).find(f=>f!==i.currentUser.uid)||null;const o=E(g,"users",i.currentUser.uid),u={pairUid:i.pairOtherUid||null,currentPairId:e};try{await R(o,u)}catch{await ee(o,u,{merge:!0})}const d=c("pairId"),m=c("copyInviteBtn");d&&(d.textContent=e),m&&(m.disabled=!1),Je(),K(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}})),on(e)}function on(e){var a;if(Ee&&(Ee(),Ee=null),!e)return;const t=E(g,"pairs",e),n=((a=i.currentUser)==null?void 0:a.uid)||null;Ee=F(t,async r=>{if(!r.exists()){wa();return}const s=r.data()||{},o=(Array.isArray(s.members)?s.members:[]).find(m=>m!==n)||null;i.currentPairId=e,i.pairOtherUid=o;try{const m=E(g,"users",n);await ee(m,{pairUid:o||null,currentPairId:e},{merge:!0})}catch{}const u=c("pairId"),d=c("copyInviteBtn");u&&(u.textContent=e),d&&(d.disabled=!1),Je(),K(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}}))})}async function Ts(){if(!i.currentUser||!i.currentPairId)return;const e=i.currentPairId,t=E(g,"pairs",e);if(confirm("¬øQuieres eliminar la party para ambos? La otra persona tambi√©n se saldr√°.")){try{await te(t)}catch{try{await R(t,{members:[]}),await te(t)}catch{}}wa(),alert("Party eliminada para ambos.")}}async function Ea(e){const t=Z(x(g,"pairs")),n=await O(t),a=i.currentUser.uid,r=[];n.forEach(s=>{const l=s.data()||{};s.id!==e&&Array.isArray(l.members)&&l.members.includes(a)&&r.push(R(E(g,"pairs",s.id),{members:Pa(a)}).then(async()=>{const o=await Y(E(g,"pairs",s.id));if((o.exists()?o.data().members||[]:[]).length===0)try{await te(E(g,"pairs",s.id))}catch{}}))}),await Promise.all(r)}function wa(){Ee&&(Ee(),Ee=null),i.currentPairId=null,i.pairOtherUid=null;const e=c("pairId"),t=c("copyInviteBtn");e&&(e.textContent="‚Äî"),t&&(t.disabled=!0),Je(),K(),document.dispatchEvent(new CustomEvent("pair:ready",{detail:{otherUid:i.pairOtherUid}}))}function Je(){const e=!!(i.currentPairId&&i.pairOtherUid),t=c("subtabCompartido"),n=c("horarioCompartido");t==null||t.setAttribute("aria-disabled",e?"false":"true"),t&&(t.disabled=!e),n&&(e?n.classList.remove("disabled"):(n.classList.add("disabled"),n.innerHTML='<div class="muted">Horario de la otra persona (debes emparejarte primero).</div>'))}function Pn(e){document.querySelectorAll(".nav-tab[data-route]").forEach(t=>{t.dataset.route!=="#/perfil"&&(t.toggleAttribute("disabled",e),t.setAttribute("aria-disabled",String(e)))})}function $s(){if(window.__duoplannerAuthInit)return;window.__duoplannerAuthInit=!0;const e=c("signInBtn"),t=c("signOutBtn"),n=c("switchAccountBtn"),a=c("userBadge"),r=c("userName"),s=u=>{e&&(e.disabled=u),t&&(t.disabled=u),n&&(n.disabled=u)},l=u=>{a&&(a.classList.remove("hidden"),a.style.display="inline-flex"),e&&(e.classList.add("hidden"),e.style.display="none"),r&&(r.textContent=u||"‚Äî");const d=c("createPairBtn"),m=c("copyInviteBtn");d&&(d.disabled=!1),m&&(m.disabled=!1),Pn(!1)},o=()=>{a&&(a.classList.add("hidden"),a.style.display="none"),e&&(e.classList.remove("hidden"),e.style.display="inline-block");const u=c("pairId"),d=c("copyInviteBtn"),m=c("createPairBtn");u&&(u.textContent="‚Äî"),d&&(d.disabled=!0),m&&(m.disabled=!0),i.profileData=null,Mt(),Ne();const f=c("semestersList");f&&(f.innerHTML=""),Pn(!0),location.hash="#/perfil"};e&&e.addEventListener("click",async()=>{s(!0);const u=new ln;u.setCustomParameters({prompt:"select_account"});try{await dn(Me,u)}catch(d){const m=(d==null?void 0:d.code)||"";m==="auth/popup-blocked"||(m==="auth/popup-closed-by-user"||m==="auth/cancelled-popup-request"||m==="auth/user-cancelled"?console.log("Login cancelado por el usuario."):alert(`No se pudo iniciar sesi√≥n: ${m||d.message||d}`))}finally{s(!1)}}),n&&n.addEventListener("click",async()=>{s(!0);const u=new ln;u.setCustomParameters({prompt:"select_account"});try{await un(Me),await dn(Me,u)}catch(d){const m=(d==null?void 0:d.code)||"";m==="auth/popup-blocked"||(m==="auth/popup-closed-by-user"||m==="auth/cancelled-popup-request"||m==="auth/user-cancelled"?console.log("Cambio de cuenta cancelado por el usuario."):alert(`No se pudo cambiar de cuenta: ${m||d.message||d}`))}finally{s(!1)}}),t&&t.addEventListener("click",async()=>{var u;s(!0);try{await un(Me),i.currentUser=null,i.profileData=null,(u=i.unsubscribeProfile)==null||u.call(i),i.unsubscribeProfile=null,Nt==null||Nt(),Ne(),ya(),o(),K()}catch(d){console.error(d),alert(`No se pudo cerrar sesi√≥n: ${d.code||d.message||d}`)}finally{s(!1)}}),$a(Me,async u=>{if(i.currentUser=u||null,s(!1),u){l(u.displayName||u.email||u.uid);try{await Ds(u)}catch(d){console.error("ensureUserDoc failed:",d)}try{await vs(),console.log("‚úÖ Semestres y cursos precargados")}catch(d){console.warn("‚ö†Ô∏è Error precargando cursos:",d)}try{ga(),Mt()}catch(d){console.error("profile listen failed:",d)}setTimeout(()=>{Cs().catch(d=>console.error("loadMyPair failed:",d))},800),setTimeout(()=>{fa().catch(d=>console.error("refreshSemestersSub failed:",d))},1500),setTimeout(()=>{G(()=>Promise.resolve().then(()=>Es),void 0).then(d=>{var m;return(m=d.mountPartnerProfileCard)==null?void 0:m.call(d)}).catch(()=>{})},2500),K()}else o(),K()})}async function Ds(e){var a,r,s,l;const t=E(g,"users",e.uid);(await Y(t)).exists()?await ee(t,{email:e.email||null,displayName:e.displayName||null,photoURL:e.photoURL||null,providerId:((l=(s=e.providerData)==null?void 0:s[0])==null?void 0:l.providerId)||"google",lastLoginAt:Date.now()},{merge:!0}):await ee(t,{createdAt:Date.now(),email:e.email||null,displayName:e.displayName||null,photoURL:e.photoURL||null,providerId:((r=(a=e.providerData)==null?void 0:a[0])==null?void 0:r.providerId)||"google",preferences:{showNamesInShared:!0,theme:"dark"},lastLoginAt:Date.now()},{merge:!0})}let _={},qt=[];function Ca(e){const t=(e||"#/perfil").trim();return new Set(["#/perfil","#/semestres","#/horario","#/notas","#/malla","#/calendario","#/progreso","#/asistencia","#/party","#/ayuda"]).has(t)?t:"#/perfil"}function ks(e){const t=Ca(e);location.hash!==t&&(location.hash=t),Yt(t)}function Yt(e){const t=Ca(e),n=document.getElementById("pfActions");n&&n.classList.toggle("hidden",t!=="#/perfil"),qt.forEach(a=>a.classList.toggle("active",a.dataset.route===t)),Object.values(_).forEach(a=>a&&a.classList.add("hidden")),t==="#/perfil"&&_.perfil&&_.perfil.classList.remove("hidden"),t==="#/semestres"&&_.semestres&&_.semestres.classList.remove("hidden"),t==="#/horario"&&_.horario&&_.horario.classList.remove("hidden"),t==="#/notas"&&_.notas&&(_.notas.classList.remove("hidden"),document.dispatchEvent(new Event("route:notas"))),t==="#/malla"&&_.malla&&_.malla.classList.remove("hidden"),t==="#/progreso"&&_.progreso&&_.progreso.classList.remove("hidden"),t==="#/calendario"&&_.calendario&&(_.calendario.classList.remove("hidden"),document.dispatchEvent(new Event("route:calendario"))),t==="#/asistencia"&&_.asistencia&&_.asistencia.classList.remove("hidden"),t==="#/party"&&_.party&&_.party.classList.remove("hidden"),t==="#/ayuda"&&_.ayuda&&_.ayuda.classList.remove("hidden"),document.dispatchEvent(new CustomEvent("route:change",{detail:{route:t}}))}function Ns(){_={perfil:c("page-perfil"),semestres:c("page-semestres"),horario:c("page-horario"),notas:c("page-notas"),malla:c("page-malla"),calendario:c("page-calendario"),progreso:c("page-progreso"),asistencia:c("page-asistencia"),party:c("page-party"),ayuda:c("page-ayuda")},qt=Array.from(document.querySelectorAll(".tab[data-route]"))||[],qt.forEach(e=>e.addEventListener("click",()=>ks(e.dataset.route))),window.addEventListener("hashchange",()=>Yt(location.hash)),Yt(location.hash||"#/perfil")}async function Ps(){const e=await fetch("data/medvet_malla.csv").then(n=>n.text()).catch(()=>""),t=await fetch("data/ictel_malla.csv").then(n=>n.text()).catch(()=>"");return{MEDVET:e?Os(e):[],ICTEL:t?Rs(t):[]}}function La(e){const t=e.trim().split(/\r?\n/).filter(Boolean);if(!t.length)return[];const n=t[0],a=n.split(";").length>=n.split(",").length?";":",",r=n.split(a).map(s=>s.trim().replace(/^['\"]|['\"]$/g,""));return t.slice(1).map(s=>{const l=s.split(a).map(u=>u.trim().replace(/^['\"]|['\"]$/g,"")),o={};return r.forEach((u,d)=>o[u]=l[d]??""),o})}function Os(e){return La(e).map(n=>{let a=n["C√≥digo Asignatura"]||n["Codigo Asignatura"]||"";return a.includes(".")&&(a=a.split(".")[0]),{codigo:a,nivel:(n.Nivel||"").trim()}})}function Rs(e){return La(e).map(n=>{const a={};for(const[l,o]of Object.entries(n)){const u=l.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();a[u]=(o||"").trim()}const r=(...l)=>{for(const o of l){const u=o.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim();if(u in a&&a[u])return a[u]}return""};let s=r("Sigla","C√≥digo","Codigo","C√≥digo Asignatura","Codigo Asignatura");return s||(s=r("C√≥digo Asignatura","Codigo Asignatura","C√≥digo","Codigo")),{codigo:s||"",nivel:(r("Nivel","Semestre")||"").toUpperCase()}})}function _s(){var n,a;const e=((n=i.profileData)==null?void 0:n.university)||"GEN",t=((a=i.profileData)==null?void 0:a.career)||"GEN";try{return JSON.parse(localStorage.getItem(`mallaAprobados:${e}:${t}`)||"[]")}catch{return[]}}function Pt(e,t){return t?e/t*100:0}function Ot(e){return`${(Math.round(e*10)/10).toFixed(1)}%`}let le=null,ct=null;async function Fs(){le=await Ps(),document.addEventListener("profile:changed",ge),document.addEventListener("malla:updated",ge),document.addEventListener("courses:changed",ge),document.addEventListener("pair:ready",ge),document.addEventListener("route:change",e=>{var t;((t=e.detail)==null?void 0:t.route)==="#/progreso"&&ge()})}async function ge(){var o;const e=c("prog-combinado");if(!e)return;e.classList.remove("hidden"),e.innerHTML='<h3 style="margin:0 0 8px">Progreso combinado</h3><div class="muted">Conectando‚Ä¶</div>';const t=((o=i.profileData)==null?void 0:o.career)||null;if(!t||!le){e.innerHTML=`<h3 style="margin:0 0 8px">Progreso combinado</h3>
    <div class="muted">Completa tu perfil antes de ver el progreso. üå±</div>`;return}const n=le&&le[t]?le[t].length:0,a=_s(),r=n?Pt(a.length,n):0;ct&&(ct(),ct=null);const s=i.pairOtherUid||null;if(!s){e.innerHTML=`<h3 style="margin:0 0 8px">Progreso combinado</h3>
    <div class="muted">A√∫n no est√°s conectado a un d√∫o. Crea o √∫nete a una party. üë•</div>`;return}const l=E(g,"users",s,"malla","state");ct=F(l,async u=>{const d=u.data()||{};let m=d.career||null;if((m==="UMAYOR"||m==="USM")&&(m=null),!m)try{const v=await Y(E(g,"users",s));if(v.exists()){const S=v.data()||{};S.career&&(m=S.career)}}catch{}const f=Array.isArray(d.approved)?d.approved.length:0,p=m&&le&&le[m]?le[m].length:0,h=n+p?Pt(a.length+f,n+p):0;e.innerHTML=`
      <h3 style="margin:0 0 8px">üèÅ Progreso combinado</h3>
      <div style="font-weight:600; margin-bottom:4px">Juntos llevan ${Ot(h)}</div>
      <div class="progress-outer small"><div class="progress-inner" style="width:${h}%;"></div></div>
      <div class="muted" style="margin-top:6px">T√∫: ${Ot(r)} ¬∑ Duo: ${Ot(Pt(f,p))}</div>
    `},u=>{e.innerHTML='<div class="muted">Error al conectar con el progreso del d√∫o.</div>'})}(function(){const t="prog-inline-styles";if(document.getElementById(t))return;const n=document.createElement("style");n.id=t,n.textContent=`
    .progress-outer{background:rgba(255,255,255,.08); border:1px solid rgba(0,0,0,.25);
      border-radius:10px; height:14px; margin-top:8px; overflow:hidden}
    .progress-outer.small{height:10px}
    .progress-inner{height:100%; background:linear-gradient(90deg, var(--primary), var(--accent));}
  `,document.head.appendChild(n)})();document.addEventListener("route:change",e=>{var t;((t=e.detail)==null?void 0:t.route)==="#/party"&&ge()});const On=Object.freeze(Object.defineProperty({__proto__:null,initProgreso:Fs,refreshProgreso:ge},Symbol.toStringTag,{value:"Module"}));window.addEventListener("DOMContentLoaded",async()=>{await Promise.all([$s(),Ns(),ws(),us()]);const e=location.hash;e.startsWith("#/malla")?G(()=>import("./malla-D7Sz3jhz.js"),[]).then(t=>{var n;return(n=t.initMallaOnRoute)==null?void 0:n.call(t)}):e.startsWith("#/notas")?G(()=>Promise.resolve().then(()=>$n),void 0).then(t=>{var n;return(n=t.initGrades)==null?void 0:n.call(t)}):e.startsWith("#/asistencia")?G(()=>Promise.resolve().then(()=>An),void 0).then(t=>{var n;return(n=t.initAttendance)==null?void 0:n.call(t)}):e.startsWith("#/horario")?G(()=>Promise.resolve().then(()=>wn),void 0).then(t=>{var n;return(n=t.initSchedule)==null?void 0:n.call(t)}):e.startsWith("#/calendario")?G(()=>Promise.resolve().then(()=>xn),void 0).then(t=>{var n;return(n=t.initCalendar)==null?void 0:n.call(t)}):e.startsWith("#/progreso")&&G(()=>Promise.resolve().then(()=>On),void 0).then(t=>{var n;return(n=t.initProgreso)==null?void 0:n.call(t)}),document.addEventListener("route:change",async t=>{var a,r,s,l,o,u;const n=t.detail.route;if(n.startsWith("#/notas")){const d=await G(()=>Promise.resolve().then(()=>$n),void 0);(a=d.initGrades)==null||a.call(d)}else if(n.startsWith("#/malla")){const d=await G(()=>import("./malla-D7Sz3jhz.js"),[]);(r=d.initMallaOnRoute)==null||r.call(d)}else if(n.startsWith("#/asistencia")){const d=await G(()=>Promise.resolve().then(()=>An),void 0);(s=d.initAttendance)==null||s.call(d)}else if(n.startsWith("#/horario")){const d=await G(()=>Promise.resolve().then(()=>wn),void 0);(l=d.initSchedule)==null||l.call(d)}else if(n.startsWith("#/calendario")){const d=await G(()=>Promise.resolve().then(()=>xn),void 0);(o=d.initCalendar)==null||o.call(d)}else if(n.startsWith("#/progreso")){const d=await G(()=>Promise.resolve().then(()=>On),void 0);(u=d.initProgreso)==null||u.call(d)}})});export{c as $,g as d,i as s};
